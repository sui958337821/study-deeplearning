mindDesigner.prototype.events.addEventListener("savelocal",function(){$("#savetip").text("所有更改已保存");mindUI.isOperated=true});mindDesigner.prototype.events.addEventListener("zoom",function(a){$(".mind-zoomtxt").text(a+"%")});mindDesigner.prototype.events.addEventListener("initBrash",function(){mind.operation.initBrash(mind)});mindDesigner.prototype.events.addEventListener("hideMenu",function(){mindUI.closeMenu()});mindDesigner.prototype.events.addEventListener("scrollLeft",function(b){var a=$("#mind_con").scrollLeft();$("#mind_con").scrollLeft(a+b)});mindDesigner.prototype.events.addEventListener("scrollTop",function(b){var a=$("#mind_con").scrollTop();$("#mind_con").scrollTop(a+b)});mindDesigner.prototype.events.addEventListener("initSearchEvent",function(){var a=$("#outline-dlg");if(a.length>0&&a.css("display")=="block"){publicSearchEvent.searchNode(true)}});mindDesigner.prototype.events.addEventListener("outline-select",function(b){var a=$("#outline-dlg");if(a.length>0&&a.css("display")=="block"){Outline.controller.selectNodeById(b)}});mindDesigner.prototype.events.addEventListener("outline-prebuild",function(b){var a=$("#outline-dlg");if(a.length>0&&a.css("display")=="block"){Outline.controller.updateNodeById(b)}});mindDesigner.prototype.events.addEventListener("outline-collapse",function(b){var a=$("#outline-dlg");if(a.length>0&&a.css("display")=="block"){Outline.controller.foldNodeById(b)}});mindDesigner.prototype.events.addEventListener("outline-posupdate",function(b){var a=$("#outline-dlg");if(a.length>0&&a.css("display")=="block"){Outline.controller.nodePosUpdate(b)}});mindDesigner.prototype.events.addEventListener("downloadPart",function(a){mindUI.exportFile.partId=a;mindUI.exportFileFn("image");poCollect("点击-右键菜单-导出当前主题为图片",{"来源":"思维导图","用户属性":mindUI.member?"会员用户":"普通用户"})});mindDesigner.prototype.events.addEventListener("showLink",function(){mind.operation.showLink.call(mind)});mindDesigner.prototype.events.addEventListener("changeOpStatus",function(a){mindUI.changeOpStatus(a)});mindDesigner.prototype.events.addEventListener("focus",function(a){if(a){$(".header-item[tit=themes]").addClass("mind-disable1");$(".header-item[tit=structure]").addClass("mind-disable1");poCollect("点击-右键菜单-聚焦模式",{"来源":"思维导图","用户属性":mindUI.member?"会员用户":"普通用户"})}else{$(".header-item[tit=themes]").removeClass("mind-disable1");$(".header-item[tit=structure]").removeClass("mind-disable1")}});mindDesigner.prototype.events.addEventListener("startPreview",function(){$(".mind-slider-show").removeClass("mind-disable");$(".mind-slider-show").attr("title","开始演示")});mindDesigner.prototype.events.addEventListener("tagTip",function(){Util.globalTopTip("点击选择标签后，才可以设置颜色","top_error",1000,$(".mind-right-icons"),true);Util.globalTopTip("请输入10字以内的名称","top_error",1000,$(".mind-right-icons"),true)});mindDesigner.prototype.events.addEventListener("changeHeader",function(a){});mindDesigner.prototype.events.addEventListener("showRightMenu",function(a){if(!$(".mind-right-con").is(":visible")){$(".mind-right-menu").trigger("click")}$(".mind-right-icons > [tit="+a+"]").trigger("click")});mindDesigner.prototype.events.addEventListener("savetitle",function(a){if(a!=""&&a!=null&&chartTitle=="未命名文件"){a=mindUI.restoreXss(a);$(".header-item .title").val(a);setTimeout(function(){mindUI.saveTitle(a)},800)}});mindDesigner.prototype.events.addEventListener("documentkeydown",function(){$(document).on("keydown.hotkey",".mind-corner,.mind-topic-box,.mind-image-dlg, .header-item .title,.mind-right-con, .mind-menu-list,.mind-dlg",function(a){a.stopPropagation()});$(document).on("mousemove.hotkey",".mind-corner,.mind-topic-box, .mind-image-dlg, .header-item .title,.mind-right-con, .mind-menu-list,.mind-dlg,#body-mask",function(a){a.stopPropagation()})});mindDesigner.prototype.events.addEventListener("changeHeadColor",function(a){if(a=="#ffffff"||a=="rgb(255, 255, 255)"){$("header").css({background:"#f5f5f5"})}else{$("header").css({background:"#ffffff"})}});mindDesigner.prototype.events.addEventListener("updateMargin",function(){var a=mind.util.getMargin.call(mind);$("#mind-subtopic-y").children("input").val(a.marginH+"px");$("#mind-subtopic-children-y").children("input").val(a.childMarginH+"px");$("#mind-subtopic-x").children("input").val(a.marginW+"px");$("#mind-subtopic-children-x").children("input").val(a.childMarginW+"px")});mindDesigner.prototype.events.addEventListener("setWatermark",function(a){a.operation.setWatermark.call(a,waterMark)});mindDesigner.prototype.events.addEventListener("refresh",function(a){mindColla.needToRefrsh()});mindDesigner.prototype.events.addEventListener("undoStackChanged",function(b){var a=$(".header-item.undo");if(b==0){a.addClass("mind-disable")}else{a.removeClass("mind-disable")}});mindDesigner.prototype.events.addEventListener("redoStackChanged",function(b){var a=$(".header-item.redo");if(b==0){a.addClass("mind-disable")}else{a.removeClass("mind-disable")}});mindDesigner.prototype.events.addEventListener("loadsuccess",function(b){var a=b.styles;if(a.background!="#ffffff"&&a.background!="rgb(255,255,255)"){$(".mind-dock-right").css("right","16px")}else{$(".mind-dock-right").css("right","10px")}var c=chartTitle||"中心主题";$(".header-item .title").text(c);chartTitle=c;chartId=b.opts.chartId;setTimeout(function(){$("#mind-loading").fadeOut(200,function(){$("#mind-loading").remove()});var f=b.util.getSelectedId();var e=b.model.getTopicById(f);mindUI.initDock(e)},200);if(!tutorial){Tutorial.init(tutorial)}var d=$(".mind-canvas-op");d.find(".mind-zoomtxt").text("100%");if(!b.opts.readonly){b.util.selectOne.call(b,b.model.topic)}if(b.model.topic.watermark&&b.model.topic.watermark!=""){$("#mind-topic-sy").val(b.model.topic.watermark);b.operation.setWatermark.call(b,b.model.topic.watermark)}else{if(waterMark!=null&&waterMark!=""){$("#mind-topic-sy").val(waterMark);b.operation.setWatermark.call(b,waterMark)}}setTimeout(function(){mind.plugins.navigator.init.call(mind)},500)});mindDesigner.prototype.events.addEventListener("hidepopeditor",function(){$(".pop-editor").remove()});mindDesigner.prototype.events.addEventListener("setDock",function(a){mindUI.initDock(a)});mindDesigner.prototype.events.addEventListener("openNote",function(b){var a=$(".mind-dock-right").children("div[tit=mind-dock-right-remark]");if($(".mind-dock-right-con").css("opacity")!=0){return}a.trigger("click");setTimeout(function(){$("#mind-topic-remark").focus()},3300)});mindDesigner.prototype.events.addEventListener("saveOnline",function(a){});mindDesigner.prototype.events.addEventListener("showThemeOperate",function(a){mindUI.showThemeOperate(a)});mindDesigner.prototype.events.addEventListener("toNew",function(a){mindUI.createNew()});mindDesigner.prototype.events.addEventListener("hideElements",function(){$(".mind-slide-selection").hide();$(".mind-slide-con").hide();$("header").hide();$(".mind-slider-dlg").hide()});mindDesigner.prototype.events.addEventListener("showElements",function(){$(".mind-slider-close").trigger("click")});mindDesigner.prototype.events.addEventListener("saveSliders",function(a){mindColla.saveSliders(a);if(a.length==0){$(".mind-slider-show").addClass("mind-disable");$(".mind-slider-show").attr("title","[ Ctrl + 拖拽 ] 选择并添加幻灯片")}});mindDesigner.prototype.events.addEventListener("setContextMenuGlobal",function(b){var a=$(".mind-context-global-menu").find("ul");a.find(".disable").removeClass("disable");if(b.currentRoot){a.children("[op=hideall]").addClass("disable");a.children("[op=openall]").addClass("disable")}else{a.children("[op=hideall]").removeClass("disable");a.children("[op=openall]").removeClass("disable")}});mindDesigner.prototype.events.addEventListener("setContextMenu",function(b){var a=$(".mind-context-menu-content").find("ul");a.find(".disable").removeClass("disable");var d=mind.model.clipboard.list;if(b.root){a.children("[op=insert-parent]").addClass("disable");a.children("[op=insert-siblings]").addClass("disable");a.children("[op=cut]").addClass("disable");a.children("[op=delete]").addClass("disable");a.children("[op=delete-self]").addClass("disable");a.children("[op=focus]").addClass("disable");a.children("[op=download-part]").addClass("disable");a.children("[op=expand]").addClass("disable");a.children("[op=expand-all]").addClass("disable")}if(b.collapsed){a.children("[op= insert-child]").addClass("disable");a.children("[op=focus]").addClass("disable")}if(b.pos){a.children("[op=insert-parent]").addClass("disable");a.children("[op=insert-siblings]").addClass("disable")}if(b.children.length==0){a.children("[op=expand]").addClass("disable");a.children("[op=expand-all]").addClass("disable")}if(d.length==0){a.children("[op=paste]").addClass("disable");var c=localStorage.getItem("clipboard_mind");if(c!=null&&c!=""){a.children("[op=paste]").removeClass("disable")}}if(b.summary){a.children("[op=focus]").addClass("disable");a.children("[op=insert-parent]").addClass("disable");a.children("[op=insert-siblings]").addClass("disable");a.children("[op=delete-self]").addClass("disable")}if(mindColla.collaUserCount>1){}else{}if(b.children.length==0){a.children("[op=delete-self]").addClass("disable")}if(Util.isMac()){a.children("[op=copy]").children("span").addClass("cmd").html(" + C");a.children("[op=cut]").children("span").addClass("cmd").html(" + X");a.children("[op=paste]").children("span").addClass("cmd").html(" + V");a.children("[op=delete-self]").children("span").addClass("cmd").html("+ Del")}});mindDesigner.prototype.events.addEventListener("showuploading",function(){mindUI.showUploading()});mindDesigner.prototype.events.addEventListener("hideuploading",function(){mindUI.hideUploading()});mindDesigner.prototype.events.addEventListener("showicons",function(a){mindColla.saveSliders(a)});mindDesigner.prototype.events.addEventListener("load-outline",function(a){$(".mind-corner.left").showCorner({type:"outline",pos:"left",onClose:function(){mindUI.leftFloatToolMenu.initPos()}});mindUI.closeMenu();mindUI.loadOutline();mindUI.leftFloatToolMenu.initPos()});mindDesigner.prototype.events.addEventListener("focusable",function(){var a=mindColla.collaUsers;var b=Object.keys(a);if(b.length==1){mindColla.sendDirectly({action:"disable"},function(){});return true}else{if(b.length>1){mindColla.renderTipDig("focus");return false}}return true});mindDesigner.prototype.events.addEventListener("topicsLen",function(a){return;if(a==1){if(sessionStorage.getItem("temp_topic_len")==="true"){return}if(typeof DesignerInsertTemp=="undefined"){var b={js:["/assets/js/designer_insert_temp.js"],css:["/assets/css/designer_insert_temp.css"]};bigPipe.render(b,function(){DesignerInsertTemp.init("mind")})}else{DesignerInsertTemp.init("mind")}}else{if(typeof DesignerInsertTemp!="undefined"){DesignerInsertTemp.clear();sessionStorage.setItem("temp_topic_len","false")}}});mindDesigner.prototype.events.addEventListener("poCollect",function(a){if(typeof a=="object"){mindUI.zhuge(a.name,a.paramObj)}});$(document).ready(function(){mindUI.leftFloatToolMenu.init();if(isOpenColl2Owner!="true"){$("#btn_colla").remove()}if(isOpenShare2Owner!="true"){$("#btn_share").remove()}if(isOpenPublish2Owner!="true"){$("#btn_pubpo").remove()}$(".header-item.nomargin > input").val(mindUI.restoreXss_(chartTitle));$(".header-item[tit]").on("mousedown",function(j){j.stopPropagation()});$(".header-item[tit]").on("click",function(o){var l=$(this),p=l.attr("tit"),m=l.hasClass("mind-disable"),k=l.hasClass("active");if(m){return}if(k){mindUI.closeMenu();return}if(p){switch(p){case"down":var j=$(".mind-title-menu");mindUI.showMenu(l,j);break;case"themes":var j=$(".mind-theme-dlg");mindUI.showMenu(l,j);break;case"structure":var j=$("#mind-structures");mindUI.showMenu(l,j);break;case"user":var j=$(".mind-user-menu");mindUI.showMenu(l,j);break;case"guide":Tutorial.init(false);break;case"download":var j=$(".mind-download-menu");mindUI.showMenu(l,j);mindUI.exportFile.partId=null;break;case"colla":if(typeof collaboration=="undefined"){var l={css:["/assets/css/collaboration.css"],js:["/assets/js/collaboration.js"]};bigPipe.render(l,function(){collaboration.init(chartId,"chart");$("#colla_add").dialog()})}else{collaboration.init(chartId,"chart");$("#colla_add").dialog()}break;case"preview":var j=$(".mind-slider-dlg"),q=mind.plugins.presenter;j.show();mind.opts.readonly=true;var n=q.renderSelections(mind);if(n==0){$(".mind-slider-show").attr("title","还没有幻灯片，[ Ctrl + 拖拽 ] 选择并添加")}else{$(".mind-slider-show").removeClass("mind-disable")}if($(".mind-right-con").is(":visible")){$(".mind-right-head").find(".mind-icons").trigger("click")}q.beforeSelecting=true;var r=false;$(".mind-slider-show").off().on("click",function(){var s=$(this);if(s.hasClass("mind-disable")){return}$("header").hide();$(".mind-canvas-con").hide();$(".mind-right-menu").hide();if($(".mind-right-con").is(":visible")){r=true}$(".mind-right-con").hide();q.ready(mind);q.toSlide(mind,0);$.showTip("close");$.showTip("← → 键切换，ESC退出",4500)});$(".mind-slider-close").off("click").on("click",function(){$(".mind-slider-dlg").hide();$("header").show();$(".mind-canvas-con").show();$(".mind-right-menu").show();if(r){$(".mind-right-con").show()}q.beforeSelecting=false;q.presenting=false;$(".mind-slide-selection").remove();mind.opts.readonly=false;$(".mind-slide-disable").removeClass("mind-slide-disable");var s=$("g").children("path");s.removeAttr("style");$(".mind-slide-controls").remove()});break}}});sessionStorage.removeItem("temp_topic_len");var g=sessionStorage.getItem("ur_resource_mind");if(g=="po_outline_header_right"){poCollect("页面访问",{"页面名称":"思维导图编辑器","页面来源":g});sessionStorage.removeItem("ur_resource_mind")}var e="<div id='extra-box' style='margin-top:12px'><ul class='op-menu-list'><li tit= 'shortcut'><span class='icons'>&#xe70b;</span>快捷键说明</li><li tit= 'equation'><span class='icons'>&#xe736;</span>LaTeX常用方程式</li><li tit= 'guide'><span class='icons'>&#xe712;</span>新用户指引</li><li tit= 'mind_book'><span class='icons'>&#xe711;</span>详细使用手册</li><li tit= 'feedback'><span class='icons'>&#xe759;</span>意见反馈</li></div>";var c={themes:".header-item[tit=themes]",undo:".header-item[tit=undo]",redo:".header-item[tit=redo]",brash:".header-item[tit=brash]",icon_conn:".header-item[tit=icon_conn]",summary:".header-item[tit=summary]",boundary:".header-item[tit=boundary]",structure:".header-item[tit=structure]",download:".header-item[tit=download]",colla:".header-item[tit=colla]",btn_share:".header-item[tit=btn_share]",preview:".header-item[tit=outline]",outline:".header-item[tit=outline]",outline:{trigger_btn:".header-item[tit=down]",tag:".dropdown-item[tp=outline]",ponalign:"12px"},btn_pubpo:{trigger_btn:".header-item[tit=down]",tag:"#btn_pubpo",ponalign:"12px"},history:{trigger_btn:".header-item[tit=down]",tag:".dropdown-item[tp=history]",ponalign:"12px"},newFile:{trigger_btn:".header-item[tit=down]",tag:"#newFile",ponalign:"12px"},btn_clone:{trigger_btn:".header-item[tit=down]",tag:"#btn_clone",ponalign:"12px"},style:{trigger_btn:".mind-right-menu",tag:".mind-right-con a[tit=style]"},icon:{trigger_btn:".mind-right-menu",tag:".mind-right-con a[tit=icon]"},image:{trigger_btn:".mind-right-menu",tag:".mind-right-con a[tit=image]"},remark:{trigger_btn:".mind-right-menu",tag:".mind-right-con a[tit=remark]"},link:{trigger_btn:".mind-right-menu",tag:".mind-right-con a[tit=link]"},task:{trigger_btn:".mind-right-menu",tag:".mind-right-con a[tit=task]"},tag:{trigger_btn:".mind-right-menu",tag:".mind-right-con a[tit=tag]"}};if(typeof c=="undefined"||c==""){$("#brain-power").remove()}$("#btn_brain_power").off("click").on("click",function(){poCollect("思维导图编辑页-点击左下功能查找按钮",{"来源":"官网项目"});var k=$("header"),m=k.outerHeight()+20;if($("#right-help-con").length<1){var l=0,j=1;smartAiHelpCon.init({bottom:56,right:10,height:"560px",designerType:j,channel:l,subUnit:[e],ai_class:"design_mind",ai_tag_list:c,extra:false,comm_question:true});f()}else{smartAiHelpCon.spread()}$(".mind-designer").off("mousedown.clsoeAi").on("mousedown.clsoeAi",function(n){smartAiHelpCon.close()})});function f(){$("#extra-box").off("mousedown.power").on("mousedown.power","li[tit]",function(){var k=$(this),j=k.attr("tit");smartAiHelpCon.close();if(j){switch(j){case"shortcut":$('.corner-item[tp="shortcut"]').trigger("click");break;case"equation":$('.corner-item[tp="equation"]').trigger("click");break;case"guide":Tutorial.init(false);break;case"mind_book":window.open("/support");break;case"feedback":$("#btn_callback").trigger("mousedown");break}return}});return e}$(".mind-right-menu").on("click",function(k){var j=$(this),l=$(".mind-right-con");l.show();j.find("span").html("&#xe622;")});$(".mind-right-head > .mind-icons").on("click",function(){var j=$(this),k=$(".mind-right-con");k.hide();$(".mind-right-menu").find("span").html("&#xe726;")});$("#btn-insert-img").off("click").on("click",function(){var l=$("#text-insert-img"),k=$(this).parent();var j=/(http[s]?:\/\/.*\.(png|jpg|gif|svg|jpeg)$)/i;if($.trim(l.val())==""||!j.test(l.val())){k.find(".text-tip").text("请检查输入的url是否合法");l.select();return}k.find(".text-tip").text("");mindUI.insertUserImage($.trim(l.val()));l.val("")});$("#text-search-img").on("keyup",function(j){if(j.keyCode==13){$(".search-con").children(".mind-button").trigger("click")}});$(".search-con").children(".mind-button").on("click",function(l){var k=$("#text-search-img");if($.trim(k.val())==""){return}var j=$.trim(k.val());mindUI.searchImages(j)});$(".mind-right-icons").children("a").on("click",function(o){var n=$(this),l=n.attr("tit");n.addClass("active").siblings().removeClass("active");var j=$(".mind-right-detail");j.children("[tit="+l+"]").show().siblings().hide();if(l!="task"){j.children("[tit="+l+"]").find("input:first,textarea:last").focus()}if(l=="link"){var m=$("#remove_link");var k=$("#mind-topic-link");k.off("blur").on("blur",function(){var r=$.trim($(this).val());if(r!=""&&!mind.util.isUrl(r)&&r.length<200){$(this).val("http://"+r)}q()});$("#mind-topic-linktitle").off("blur").on("blur",function(){var r=mindUI.filterXss($.trim($(this).val()));if(r!=""&&r.length<50){q()}});k.off("focus").on("focus",function(){b=mind.util.getSelectedId()});$("#mind-topic-linktitle").off("focus").on("focus",function(){b=mind.util.getSelectedId()});k.off("keyup").on("keyup",function(r){if(r.keyCode==13){q()}});m.off().on("click",function(){p()});function q(){var t=mindUI.filterXss($.trim($("#mind-topic-link").val()));if(t!=""&&mind.util.isUrl(t)){var r=mindUI.filterXss($.trim($("#mind-topic-linktitle").val()));var s={value:t,title:r,type:"url"};mind.operation.setLink.call(mind,s,b)}else{p()}}function p(){$("#mind-topic-link").val("");$("#mind-topic-linktitle").val("");mind.operation.removeLink.call(mind)}}else{if(l=="task"){}}});$(".mind-right-detail .mind-group-button").children("a").on("click",function(m){var l=$(this),k=l.attr("tit");l.addClass("active").siblings().removeClass("active");var j=$(".mind-image-detail");j.children("[tit="+k+"]").show().siblings().hide();if(k=="history"){mindUI.loadUserImages()}});$("#mind-designer-back").on("click",function(){window.location.href="/diagraming/back?id="+chartId});$("#mind-help").on("click",function(){var j=$(this);mindUI.showLeft("shortcut",j)});$("#history").on("click",function(){var j=$(this);mindUI.showLeft("history",j)});window.onbeforeunload=function(j){mindColla.stop();if(mindColla.isOffLine){mindColla.saveVersion();return"当前处于离线模式，退出前请保存"}};var i="";$(".header-item .title").off("focus").on("focus",function(k){var j=$(this);j.select();i=j.val();k.stopPropagation()});$(".header-item .title").off("keydown").on("keydown",function(k){if(k.keyCode==13){var j=$(this),l=$.trim(j.val());if(l!=""){mindUI.saveTitle(l)}j.removeAttr("contenteditable");k.preventDefault()}});$(".header-item .title").off("blur").on("blur",function(k){k.stopPropagation();var j=$(this),l=$.trim(j.val());if(l!=""){mindUI.saveTitle(l)}});$("#newFile").off("click").on("click",function(){mindUI.createNew("new")});$("#btn_clone").off("click").on("click",function(){mindUI.createNew("clone")});$(".header-item.undo").off("click").on("click",function(){var j=mind;j.messageSource.undo(j)});$(".header-item.redo").off("click").on("click",function(){var j=mind;j.messageSource.redo(j)});$(".header-item.brash").off("click").on("click",function(){var j=mind;j.operation.initBrash(j)});$(".header-item.outline").off("click").on("click",function(){mindUI.outlineEdit()});$(".corner-item").on("click",function(){var j=$(this),k=j.attr("tp");$(".mind-corner.left").showCorner({type:k,pos:"left",onClose:function(){mindUI.leftCornerDisplayCallback()}});mindUI.closeMenu();mindUI.leftCornerDisplayCallback();if(k=="history"){mindUI.loadHistorys()}else{if(k=="outline"){mindUI.loadOutline()}else{if(k=="equation"){poCollect("点击-方程式编辑器-常用方程式帮助手册",{"来源":"思维导图","用户属性":mindUI.member?"会员用户":"普通用户"});mindUI.loadEquation()}}}});$("#btn_pubpo").on("click",function(k){sessionStorage.removeItem("published");poCollect("发布模版-点击",{"渠道记录":"编辑器内","来源记录":"","用户属性":mindUI.member?"会员用户":"普通用户"});mind.util.clearSelect();var j=$("#mind-publish-dlg");j.find(".mind-dlg-content").html(mindShare.publish.source);mindShare.publish.execute(chartId);j.dialog({onClose:function(){$("#TencentCaptcha").appendTo("body").hide();if(sessionStorage.getItem("published")){sessionStorage.removeItem("published");$.ajax({url:"/templates/template_talent_check",success:function(l){if(!l.isTalent&&l.satisfy){a({content:'恭喜您，根据您的内容贡献，您已经获得模板"达人"申请资格，<br/>是否立即加入达人？获得更多官方加持。了解更多<a style="color:#4386F5" href="/ac/210319" target="_blank" onclick="zhuge.track(\'达人申请弹窗\',{\'渠道记录\':\'编辑器内\'});">"达人"权益。</a>',okval:"立即加入",cancelval:"暂不加入",width:"410px",title:'ProcessOn邀请您加入"达人"',onConfirm:function(){zhuge.track("达人申请弹窗",{"渠道记录":"编辑器内"});window.open("/ac/210319?from=editorPub")}})}}})}}});k.stopPropagation()});function a(k){var l=$("#global_confirm_window");var j="确定";if(k.okval){j=k.okval}var m="取消";if(k.cancelval){m=k.cancelval}var n="请确认";if(k.title){n=k.title}if(!l.length){l=$("<div id='global_confirm_window' tabindex='-1' class='confirm-box mind-dlg'><h3>"+n+"</h3><div class='mind-dlg-content'>"+k.content+"</div><div class='mind-dlg-buttons' style='padding:20px 20px;'><span class='okbtn mind-button'>"+j+"</span>&nbsp;&nbsp;<span class='cancelbtn mind-button gray'>"+m+"</span></div></div>").appendTo("body")}else{l.find(".dlg-content").html(k.content);l.find(".okbtn").html(j)}if(k.width){l.css("width",k.width)}if(k.height){l.css("height",k.height)}if(k.hiddenOK){l.find(".okbtn").css("visibility","hidden")}else{l.find(".okbtn").css("visibility","visible")}if(k.hiddenCancel){l.find(".cancelbtn").css("display","none")}else{l.find(".cancelbtn").css("visibility","inline-block")}l.dialog();$(document).off("keyup.confirm").on("keyup.confirm",function(o){if(o.keyCode==13){l.find(".okbtn").trigger("click")}});l.find(".okbtn").off().on("click",function(){l.dialog("close");if(k.onConfirm){k.onConfirm()}$(document).off("keyup.confirm")});l.find(".cancelbtn").off("click.cancel").on("click.cancel",function(){l.dialog("close");if(k.onCancel){k.onCancel()}$(document).off("keyup.confirm")})}$("#btn_share").on("click",function(n){mind.util.clearSelect();var j=$(".mind-share-dlg");j.dialog();zhuge.track("点击分享按钮",{"触发位置":"思维导图-分享"});var m=j.find(".mind-dialog-left"),k=j.find(".mind-dialog-right"),l=j.outerWidth();m.find("li").off("click").on("click",function(){var o=$(this).attr("tit");$(this).addClass("active").siblings().removeClass("active");k.empty();k.html(mindShare[o].source);mindShare[o].execute(chartId)});m.find("li:eq(0)").trigger("click");n.stopPropagation()});$(".mind-download-menu").children("div").off("mousedown").on("mousedown",function(l){var k=$(this);var j=k.attr("tit");mindUI.exportFileFn(j)});$(".mind-zoomin").off().on("click",function(){mind.operation.zoomIn.call(mind,mind.designer);var j=mind.operation.zoomVal;$(".mind-zoomtxt").text(j)});$(".mind-zoomout").off().on("click",function(){mind.operation.zoomOut.call(mind,mind.designer);var j=mind.operation.zoomVal;$(".mind-zoomtxt").text(j)});$("#mind-theme-customise").on("click",function(){var j=$(".mind-theme-customise-dlg");j.dialog();var k=mind.style.themes.theme3;mindUI.initCustomise(k)});$("#callback_dlg_cancel").on("click",function(){$(".mind-callback-dlg").dialog("close")});$("#callback_dlg_save").on("click",function(){var j=$(this);mindUI.saveFeedBack(function(){var k=$(".mind-callback-dlg").dialog("close");$.showTip("谢谢您的反馈，我们将尽快解决。",1000)})});$("#btn_callback").on("mousedown",function(k){var j=$(".mind-callback-dlg");j.dialog();j.find("textarea").focus();k.stopPropagation()});$("#btn_ai_power").on("mousedown",function(j){$("#brain-power").trigger("click");j.stopPropagation()});$("#btn_onlinedoc").on("mousedown",function(j){j.stopPropagation()});$("#btn-history-add").on("click",function(){var j=$("#area-history-add"),k=$(this);j.show();j.find("textarea").focus()});$("#btn-histoty-add-cancel").on("click",function(){var j=$("#area-history-add"),k=$("#btn-history-add");j.hide();k.show();j.find("textarea").val("")});$("#btn-histoty-save").on("click",function(){var j=$("#area-history-add"),l=$("#btn-history-add"),k=$(this);var m=$("#history_remark").val();if(!m.trim()||m.length>20){$("#history_remark").focus();return false}k.addClass("mind-disable");l.hide();mindColla.saveVersion(m)});$("#mind-select-font").on("click",function(){var j=$(this);$("#mind-font-list").dropdown({target:j,onSelect:function(l){var k=l.text();j.children("span").text(k);mind.operation.setStyle.call(mind,{"font-family":k});j.removeClass("selected")},onClose:function(){j.removeClass("selected")}});j.addClass("selected")});$("#mind-font-b").on("click",function(){var l=$(this),k=l.children("label"),j=l.hasClass("selected");if(j){l.removeClass("selected");mind.operation.setStyle.call(mind,{"font-weight":"normal"})}else{l.addClass("selected");mind.operation.setStyle.call(mind,{"font-weight":"bold"})}});$("#mind-font-i").on("click",function(){var l=$(this),k=l.children("label"),j=l.hasClass("selected");if(j){l.removeClass("selected");mind.operation.setStyle.call(mind,{"font-style":"normal"})}else{l.addClass("selected");mind.operation.setStyle.call(mind,{"font-style":"italic"})}});$("#mind-font-ul").on("click",function(){var l=$(this),k=l.children("label"),j=l.hasClass("selected");if(j){l.removeClass("selected");mind.operation.setStyle.call(mind,{"text-decoration":"none"})}else{l.addClass("selected");mind.operation.setStyle.call(mind,{"text-decoration":"underline"});l.siblings("[line]").removeClass("selected")}});$("#mind-font-ml").on("click",function(){var l=$(this),k=l.children("label"),j=l.hasClass("selected");if(j){l.removeClass("selected");mind.operation.setStyle.call(mind,{"text-decoration":"none"})}else{l.addClass("selected");mind.operation.setStyle.call(mind,{"text-decoration":"line-through"});l.siblings("[line]").removeClass("selected")}});$("#mind-font-left").on("click",function(){var j=$(this);mind.operation.setStyle.call(mind,{"text-align":"left"});j.addClass("selected");j.siblings("[align]").removeClass("selected")});$("#mind-font-center").on("click",function(){var j=$(this);mind.operation.setStyle.call(mind,{"text-align":"center"});j.addClass("selected");j.siblings("[align]").removeClass("selected")});$("#mind-font-right").on("click",function(){var j=$(this);mind.operation.setStyle.call(mind,{"text-align":"right"});j.addClass("selected");j.siblings("[align]").removeClass("selected")});$("#mind-customise-bc_").off().on("click",function(){var l=$(this);var l=$(this),j=l.css("color");var k=mind.util.getHexColor(j);$.colorpicker({target:l,color:j,onSelect:function(m){if(m==null){m="transparent"}l.children(".color_line").css("background",m);mind.operation.setStyle.call(mind,{"border-color":m});l.removeClass("selected")},onClose:function(){l.removeClass("selected")}});if(k!=null){$("#color-hex-value").val(k.hex)}l.addClass("selected")});$("#mind-customise-bw_").off().on("click",function(){var j=$(this);$("#mind-customise-borderw").dropdown({target:j,onSelect:function(l){var m=l.attr("tp");var k=l.text();j.children("span").text(k);mind.operation.setStyle.call(mind,{"border-width":m});j.removeClass("selected")},onClose:function(){j.removeClass("selected")}});j.addClass("selected")});$("#mind-customise-bst_").off().on("click",function(){var j=$(this);$("#mind-customise-borderst").dropdown({target:j,onSelect:function(m){var k=m.text();j.children("span").text(k);var l=m.attr("tp");mind.operation.setStyle.call(mind,{"border-style":l});j.removeClass("selected")},onClose:function(){j.removeClass("selected")}});j.addClass("selected")});$("#mind-customise-bs1_").on("click",function(){var j=$(this);mind.operation.setStyle.call(mind,{"border-radius":"0px"});j.addClass("selected");j.siblings().removeClass("selected")});$("#mind-customise-bs2_").on("click",function(){var j=$(this);mind.operation.setStyle.call(mind,{"border-radius":"5px"});j.addClass("selected");j.siblings().removeClass("selected")});$("#mind-customise-bs3_").on("click",function(){var j=$(this);mind.operation.setStyle.call(mind,{"border-radius":"30px"});j.addClass("selected");j.siblings().removeClass("selected")});$("#clear-style-btn").on("click",function(){mind.operation.clearStyle.call(mind)});$("#upload_file").on("click",function(){var j=mind.util.selectedIds;if(j.length==0){return}mindUI.uploadFile(j[0])});$("#mind-customise-linec_").off().on("click",function(){var l=$(this);var l=$(this),j=l.children(".color_line").css("background-color");var k=mind.util.getHexColor(j);$.colorpicker({target:l,color:j,onSelect:function(m){if(m==null){m="transparent"}l.children(".color_line").css("background",m);mind.operation.setStyle.call(mind,{"line-color":m});l.removeClass("selected")},onClose:function(){l.removeClass("selected")}});$("#color-hex-value").val(k.hex);l.addClass("selected")});$("#mind-customise-linew_").off().on("click",function(){var j=$(this);$("#mind-customise-linew-list").css("z-index",10).dropdown({target:j,onSelect:function(k){var l=k.attr("tp");j.children("span").text(l+"px");mind.operation.setStyle.call(mind,{"line-width":l})},onClose:function(){j.removeClass("selected")}})});$("#mind-topic-bg").on("click",function(){var l=$(this),j=l.children(".color_line").css("background-color");var k=mind.util.getHexColor(j);$.colorpicker({target:l,color:j,onSelect:function(m){if(m==null||m=="transparent"){var n=mind.designer.css("background-color");l.css("background-color",n);mind.operation.setStyle.call(mind,{"background-color":n})}else{l.children(".color_line").css("background",m);mind.operation.setStyle.call(mind,{"background-color":m})}l.removeClass("selected")},onClose:function(){l.removeClass("selected")}});if(k!=null){$("#color-hex-value").val(k.hex)}l.addClass("selected")});$("#mind-canvas-bg").on("click",function(){var k=$(this),j=k.children(".color_line").css("background-color");$.colorpicker({target:k,color:j,trans:true,onSelect:function(l){k.children(".color_line").css("background",l);mind.operation.setBackground.call(mind,l,true);k.removeClass("selected");var m=$("#mind-topic-sy").val();if($.trim(m)!=""){mind.operation.setWatermark.call(mind,m)}},onClose:function(){k.removeClass("selected")}});k.addClass("selected")});$("#mind-background-img").on("mousedown",function(j){j.stopPropagation();backgroundImage.init();$("#mind-color-picker").dropdown("close");$(".mind-background-img-dlg").dialog()});$("#mind-font-color").on("click",function(){var k=$(this),j=k.children(".color_line").css("background-color");$.colorpicker({target:k,color:j,onSelect:function(l){k.children(".color_line").css("background",l);mind.operation.setStyle.call(mind,{color:l});k.removeClass("selected")},onClose:function(){k.removeClass("selected")}});k.addClass("selected")});$("#mind-number-size").numberBox({callback:function(j){if(j<12){$.showTip("字号不能小于12px",1000);return}mind.operation.setStyle.call(mind,{"font-size":j})}});$("#mind-task-priority").on("click",function(){var j=$(this);$("#mind-icons-priority-list").dropdown({target:j,position:"right",width:80,onSelect:function(p){var q=p.clone();q.find("span").remove();var m=q.text(),n=q.attr("priority"),o=q.attr("ico");var l=p.find(".mind-icons").css("color");var k=$(".mind-right-detail > [tit=icon]").find("[ico="+o+"]");if(n==null){mind.icons.removeIcon.call(mind,"priority")}else{mind.icons.setIcon.call(mind,k,{priority:n},l)}j.children("span").text(m);j.removeClass("selected");q.remove()},onClose:function(){j.removeClass("selected")}});j.addClass("selected")});$("#mind-task-completion").on("click",function(){var j=$(this);$("#mind-icons-completion-list").dropdown({target:j,position:"right",width:80,onSelect:function(p){var q=p.clone();q.find("span").remove();var n=q.text(),m=q.attr("completion"),o=q.attr("ico");var l=p.find(".mind-icons").css("color");j.children("span").text(n);var k=$(".mind-right-detail > [tit=icon]").find("[ico="+o+"]");if(m==null){mind.icons.removeIcon.call(mind,"completion")}else{mind.icons.setIcon.call(mind,k,{completion:m},l)}j.removeClass("selected");q.remove()},onClose:function(){j.removeClass("selected")}});j.addClass("selected")});$("#mind-task-end").off("click").on("click",function(k){var j=$(this);$("#mind-task-end").datePicker({dateFormat:"yyyy-MM-dd",selected:function(m){var n=$("#mind-task-start").find("span:first").text();if(n!="无"){var o=new Date(n);var l=new Date(m);if(l<o){m=n}}j.find("span").text(m);mind.task.setTask.call(mind,{end:m})}});k.stopPropagation()});$("#mind-task-start").off("click").on("click",function(k){var j=$(this);$("#mind-task-start").datePicker({dateFormat:"yyyy-MM-dd",selected:function(m){var n=$("#mind-task-end").find("span:first").text();if(n!="无"){var l=new Date(n);var o=new Date(m);if(l<o){m=n}}j.find("span").text(m);mind.task.setTask.call(mind,{start:m})}});k.stopPropagation()});var b=null;$("#mind-task-assigned").on("blur",function(k){var j=$(this),l=$.trim(j.val());if(l!=""&&l.length<20){mind.task.setTask.call(mind,{assigned:l},b)}else{if(l==""){mind.task.setTask.call(mind,{assigned:null},b)}}k.stopPropagation()}).on("keyup",function(k){if(k.keyCode==13){var j=$(this),l=$.trim(j.val());if(l!=""&&l.length<20){mind.task.setTask.call(mind,{assigned:l},b)}else{if(l==""){mind.task.setTask.call(mind,{assigned:null},b)}}}}).off("focus").on("focus",function(){var j=mind.util.getSelectedId();b=j});$("#remove_task").off().on("click",function(){mind.task.removeTask.call(mind);$("#mind-task-assigned").val("");$(".mind-right-detail > [tit=task]").find(".mind-select-box > span").text("无")});$(document).on("mousedown.titlemenu",".mind-right-con,.mind-dlg,.mind-corner,.header-item .title,.mind-title-menu,.mind-user-menu, .mind-theme-dlg,.mind-image-dlg,.header-item.icon.down,.header-item.icon.theme,.header-item.icon.image",function(j){j.stopPropagation()});$(".header-item.icon.icon_conn").on("click",function(k){var j=mind.util.getSelectedId();if(j==""){$.showTip("请先选择一个主题",1000);return}mind.connection.render.call(mind,k)});$(".header-item.icon.summary").on("click",function(k){var j=mind.util.selectedIds;if(j.length==0){$.showTip("请先选择一个主题",1000);return}mind.summary.addSummary.call(mind,j)});$(".header-item.icon.boundary").on("click",function(k){var j=mind.util.selectedIds;if(j.length==0){$.showTip("请先选择一个主题",1000);return}mind.boundary.addBoundary.call(mind,j)});$("input[name=mind_upload_img_file]").off("change").on("change",function(k){var j=this.files[0].type;if($.trim($(this).val())==""){return}if(j.indexOf("image")>=0){mindUI.showUploading();$("#upload_mind_img").submitForm({success:function(l){if(l.result=="size_wrong"){$.showTip("图片大小不能超过2M",2500);mindUI.hideUploading();return}if(l.result=="type_wrong"){$.showTip("@i18n resource='oin.profile.upload_image_type_siz'/>",2500);mindUI.hideUploading();return}mindUI.loadUserImages(true);if(l.userImage!=null){mindUI.insertUserImage(l)}$("input[name=mind_upload_img_file]").val("")},error:function(){mindUI.hideUploading()}})}else{$.showTip("上传失败，不支持的文件格式",1000)}});var d=null;$("#mind-topic-remark").on("blur",function(j){var k=$(this).val();mind.remark.setRemark.call(mind,k,d)});$("#mind-topic-remark").on("focus",function(j){d=mind.util.getSelectedId()});var h=false;$("#mind-topic-sy").on("blur",function(){var j=$(this),k=$.trim(j.val());if(h){return}h=true;if(k!=""){if(k.length>15){$.showTip("最多支持15个字符",2000);$("#mind-topic-sy").select();h=false;return}if(waterMark!=null&&waterMark==k){h=false;return}if(!mindUI.member&&k.length>0){$.showTip("会员专属功能，升级后可以使用",2000);$("#mind-topic-sy").select();h=false;return}mind.operation.setConfig("watermark",k,function(l){if(l!=null&&l.result=="length"){$.showTip("最多支持15个字符",2000);$("#mind-topic-sy").select()}else{if(l!=null&&l.result=="error_text"){$.showTip("文本中包含敏感字符，请重新输入",2000);$("#mind-topic-sy").select()}else{if(l!=null&&l.result=="memberlength"){$.showTip("会员专属功能，升级后可以使用",2000);$("#mind-topic-sy").select()}else{mind.operation.setWatermark.call(mind,k);if(waterMark!=null){waterMark=k}mindColla.sendDirectly({action:"watermark",val:waterMark})}}}h=false})}else{mind.operation.setConfig("watermark","");mind.operation.clearWatermark();if(waterMark!=null){waterMark=""}h=false}});$("#mind-subtopic-y").numberBox({variable:10,width:60,inputWidth:36,callback:function(k){if(k<10){k=10;$.showTip("分支主题垂直间距不可小于10px",1000)}else{if(k>200){k=200;$.showTip("分支主题垂直间距不可大于200px",1000)}}$("#mind-subtopic-y").children("input").val(k+"px");var j=mind.util.getMargin.call(mind);if(k==j.marginH){return}mind.operation.setMargin.call(mind,{marginH:k})}});$("#mind-subtopic-children-y").numberBox({variable:10,width:60,inputWidth:36,callback:function(k){if(k<5){k=5;$.showTip("子主题垂直间距不可小于5px",1000)}else{if(k>100){k=100;$.showTip("子主题垂直间距不可大于100px",1000)}}$("#mind-subtopic-children-y").children("input").val(k+"px");var j=mind.util.getMargin.call(mind);if(k==j.childMarginH){return}mind.operation.setMargin.call(mind,{childMarginH:k})}});$("#mind-subtopic-x").numberBox({variable:10,width:60,inputWidth:36,callback:function(k){if(k<20){k=20;$.showTip("分支主题水平间距不可小于20px",1000)}else{if(k>200){k=200;$.showTip("分支主题水平间距不可大于200px",1000)}}$("#mind-subtopic-x").children("input").val(k+"px");var j=mind.util.getMargin.call(mind);if(k==j.marginW){return}mind.operation.setMargin.call(mind,{marginW:k})}});$("#mind-subtopic-children-x").numberBox({variable:10,width:60,inputWidth:36,callback:function(o){var n=mind.model.topic.theme||"";var k=n.indexOf("mindmap")>-1||n.indexOf("caihongthinner")>-1||n.indexOf("caihong")>-1;var m=n.indexOf("simple")>-1;var j=k?20:m?14:10;if(o<j){o=j;$.showTip("子主题水平间距不可小于"+j+"px",1000)}else{if(o>100){o=100;$.showTip("子主题水平间距不可大于100px",1000)}}$("#mind-subtopic-children-x").children("input").val(o+"px");var l=mind.util.getMargin.call(mind);if(o==l.childMarginW){return}mind.operation.setMargin.call(mind,{childMarginW:o})}});$("#reset-subtopic-margin").off().on("click",function(){mind.operation.setMargin.call(mind,{})});$(".mind-tab-line > label").on("click",function(){var l=$(this);if(l.hasClass("active")){return}var j=l.attr("tit");var k=$("#"+j);k.show();if(j=="mind-style-topic"){$("#mind-style-page").hide()}else{$("#mind-style-topic").hide()}l.addClass("active").siblings().removeClass("active")});$(".mind-right-detail > [tit=icon]").find(".mind-icons").on("click",function(k){var l=$(this);if(l.attr("remove")){mind.icons.removeIcon.call(mind)}else{var m=l.attr("n");var j=null;if(m=="flag"){j=l.css("color")}mind.icons.setIcon.call(mind,l,null,j)}});setTimeout(function(){mindUI.loadThemes(mind);mindColla.getSliders()},1500);setTimeout(function(){mindUI.initStructure();mindUI.isMember()},600);window.setInterval(function(){if(mindColla.version!=mindColla.versionNow){mindColla.versionNow=mindColla.version;mindColla.saveVersion()}},mindColla.versionSaveTime)});var mindColla={isOffLine:false,isSending:false,mess:[],tempMess:[],versionSaveTime:180000,versionNow:0,version:0,send:function(d){$("#savetip").text("正在保存...");mindColla.version++;if(mindColla.isOffLine){mindColla.showTip();mind.messageSource.saveLocal(mind);return}if(this.isSending){this.tempMess=this.tempMess.concat(d);return}var a=this.collaClient;this.mess=this.tempMess.concat(d);mindColla.checkMsgs();this.isSending=true;this.tempMess=[];var b=JSON.stringify(this.mess);var c={msgStr:b,ignore:"msgStr",chartId:chartId,uk:userId,client:a,fullName:fullName};$.ajax({url:"/mindmap/msg",data:c,cache:false,type:"post",success:function(h){if(h.error=="error_text"){$.showTip("文件标题保存失败，涉及敏感字符，请重新输入",2000)}else{if(h.error){mindColla.doSync(chartId,function(i){if(i){mindColla.isSending=false;mindColla.mess=[];$("#savetip").text("所有更改已保存");var j={type:"forceRefresh",content:{client:MindWebsocketUtil.clientId,source:"mind",msg:"refresh"}};MindWebsocketUtil.deliverMsg(j)}})}else{setTimeout(function(){$("#savetip").text("所有更改已保存");mind.plugins.navigator.init.call(mind)},100);try{var e=mind.util.copyArray(mindColla.mess);mindColla.mess=[];if(typeof MindWebsocketUtil!="undefined"&&MindWebsocketUtil){var g={type:"_s@deliver",content:{client:MindWebsocketUtil.clientId,source:"mind",msg:e}};MindWebsocketUtil.deliverMsg(g)}}catch(f){mindColla.mess=[]}}}mindColla.isSending=false;mindColla.mess=[]},error:function(f){mindColla.isOffLine=true;mindColla.showTip();mindColla.isSending=false;mindColla.mess=[]}})},sendDirectly:function(a,d){var b=this;var c={msgstr:JSON.stringify(a),ignore:"msgstr",chartId:chartId,uk:userId,client:b.collaClient,fullName:fullName};$.ajax({url:"/mindmap/msg_directly",data:c,cache:false,type:"post",success:function(e){if(d){d(e)}}})},checkMsgs:function(){var a=mind.util.copyArray(this.mess);var d={};for(var f=0;f<a.length;f++){var b=a[f];var c=b.action;if(c=="create"){var h=b.content;var g=h.length-1;for(var e=g;e>=0;e--){var k=h[e];if(d[k.id]){h.splice(e,1)}else{d[k.id]=true}}}}this.mess=a},isConnection:false,connected:function(){var a=$(".mind-connecting-dlg");if(a.length==0){return}a.dialog("close");a.remove();this.isConnection=false;if(this.isSync){this.isOffLine=false;$("#savetip").text("所有更改已保存")}},connecting:function(){if(this.isConnection){return}this.isConnection=true;var a=$(".mind-connecting-dlg");if(a.length==0){var c='<div class="mind-connecting-dlg mind-dlg"><h4>重新连接</h4><div class="mind-dlg-content"><div tit><span class="mind-icons">&#xe614;</span> <span>检测网络连接</span><label></label></div><div tit><span class="mind-icons">&#xe614;</span> <span>等待服务器响应</span><label></label></div><div tit><span class="mind-icons">&#xe614;</span> <span>同步成功</span></div><div class="mind-dlg-buttons"><span onclick="mindColla.connected()" class="mind-button gray">关闭</span></div><div style="height:15px;"></div></div></div>';$(".mind-util-container").append(c);a=$(".mind-connecting-dlg")}a.dialog();var e=new Date().valueOf();var b="http://cdn.processon.com/logo_on.png?_="+new Date().valueOf();var d=new Image();d.src=b;d.onload=function(){var f=$(".mind-connecting-dlg").find("div[tit]:first");var g=new Date().valueOf();f.find("label").text((g-e)+"ms");f.css("color","#50c28b");$.ajax({url:"/mindmap/connecting",success:function(i){g=new Date().valueOf();var h=$(".mind-connecting-dlg").find("div[tit]").eq(1);if(i.result=="success"){h.css("color","#50c28b");mindColla.doSync(chartId)}else{h.css("color","#f60");h.find(".mind-icons").html("&#xe622;")}h.find("label").text((g-e)+"ms")},error:function(i){g=new Date().valueOf();var h=$(".mind-connecting-dlg").find("div[tit]").eq(1);h.css("color","#f60");h.find(".mind-icons").html("&#xe622;")}})};d.onerror=function(){var g=new Date().valueOf();var f=$(".mind-connecting-dlg").find("div[tit]:first");f.css("color","#f60");f.find(".mind-icons").html("&#xe622;");f.find("label").text((g-e)+"ms")}},isSync:false,doSync:function(h,g){var c=JSON.stringify(mind.model.topic);if(c==""){return}var a=false;if(mind.currentRoot!=null){var f=mind.currentRoot.id;mind.currentRoot=null;var e=mind.model.getTopicById(f);delete e.root;delete e.structure;c=JSON.stringify(mind.model.topic);a=true}var b=this;var d=new Date().valueOf();$.ajax({url:"/mindmap/saveonline",type:"post",cache:false,data:{id:h,def:c,shapecount:c.split('"children":[').length,ignore:"def"},success:function(i){var k=new Date().valueOf();var j=$(".mind-connecting-dlg").find("div[tit]").eq(2);if(i.result=="success"){j.css("color","#50c28b");b.isSync=true;if(a){mind.operation.focusTopic.call(mind,mind.model.topic.id);mind.operation.exitFocus.call(mind)}setTimeout(function(){mindColla.connected()},3000);if(g!=null){g(true)}}else{if(i.result=="nologin"){$.showTip("还未登录，无法同步，请打开新选项卡登录后返回重试",8500)}else{j.css("color","#f60");j.find(".mind-icons").html("&#xe622;");mind.messageSource.saveLocal(mind);b.isSync=false;mindColla.showTip()}}j.find("label").text((k-d)+"ms")},error:function(j){var k=new Date().valueOf();var i=$(".mind-connecting-dlg").find("div[tit]").eq(2);i.css("color","#f60");i.find(".mind-icons").html("&#xe622;");i.find("label").text((k-d)+"ms");mind.messageSource.saveLocal(mind);b.isSync=false;mindColla.showTip()}})},showTip:function(){if(mindColla.collaUsers.length>1){this.renderOff()}else{$("#savetip").html("已保存到本地，<a href='javascript:void(0)' onclick='mindColla.connecting()' style='color:#63abf7;text-decoration:underline;'>重连并同步</a>")}},closeTip:function(){var a=$("#mind-error-tip");a.fadeOut(function(){a.remove()})},saveSliders:function(a){$.ajax({url:"/mindmap/savesliders",type:"post",data:{id:mindUI.chartId(),def:JSON.stringify(a),ignore:"def"},success:function(b){}})},getSliders:function(){$.ajax({url:"/mindmap/getsliders",data:{id:mindUI.chartId()},success:function(a){if(a.slider!=null&&"[]"!=a.slider.def){mind.plugins.presenter.sliders=JSON.parse(a.slider.def)}}})},collaClient:null,collaUk:null,collaItv:null,collaUsers:{},collaUserClient:{},baseUrl:window.location.host.indexOf("processon.com")>=0?"https://cb.processon.com/":"/",collaStart:function(){var c=sessionStorage.getItem("mindclient_"+chartId);var b=mindColla,a="";if(c==null){a=new Date().valueOf()+mindUI.newId();sessionStorage.setItem("mindclient_"+chartId,a)}else{a=c}$.ajax({url:"/mindmap/listen",type:"post",data:{subject:chartId,client:a},success:function(d){mindColla.collaUserCount=d.users.length;mindColla.collaClient=a;mindColla.collaUk=d.uk;if(mindColla.collaUserCount>1){mindColla.collaItv=window.setInterval(mindColla.poll,mindColla.collaPollTime)}else{mindColla.collaItv=window.setInterval(mindColla.poll,mindColla.collaPollTimeSingle)}},error:function(){}})},collaCount:0,collaPollTimeSingle:9000,collaPollTime:1500,collaUserCount:1,poll:function(){mindColla.collaCount++;if(mindColla.collaCount>5000){mindColla.stop();return}var a=mindColla.collaClient,b=mindColla.collaUk;$.getJSON(mindColla.baseUrl+"mindmap/poll",{subject:chartId,client:a,uk:b},function(g){var h=g.users;if(h==null){return}if(h.length>1&&mindColla.collaUserCount!=h.length){window.clearInterval(mindColla.collaItv);mindColla.collaItv=null;mindColla.collaItv=window.setInterval(mindColla.poll,mindColla.collaPollTime)}else{if(h.length==1){window.clearInterval(mindColla.collaItv);mindColla.collaItv=null;mindColla.collaItv=window.setInterval(mindColla.poll,mindColla.collaPollTimeSingle)}}mindColla.collaUserCount=h.length;mindColla.renderUsers(h);var f=g.msgs;for(var e=0;e<f.length;e++){var c=JSON.parse(f[e]);if(c.client==a){continue}if(c.msg!=null&&c.msg.length>0){var j=c.msg[0];if(j!=null&&"disable"==j.action){mindColla.stop();mindColla.renderOff("focus");mind.operation.setDisable.call(mind);break}else{if(j!=null&&"focus"==j.action){}}}try{mind.messageSource.excuteMsgDirect.call(mind,c,function(k,i){mindColla.showUserOp(k,i)})}catch(d){continue}}})},saveVersion:function(c){var f=userName;var b=JSON.stringify(mind.model.topic),e="自动存储";if(c!=null&&c!=""){e=c}if(mind.currentRoot!=null){var g=mind.currentRoot.id;var d=mind.model.getTopicById(g);var a=d.structure;delete d.root;delete d.structure;b=JSON.stringify(mind.model.topic);d.root=true;d.structure=a}$.ajax({url:"/diagraming/add_version",data:{chartId:chartId,userId:userId,fullName:f,def:b,remark:e,ignore:"def"},type:"post",success:function(h){mindUI.loadHistorys();$("#area-history-add").hide();$("#btn-history-add").show();$("#history_remark").val("");$("#area-history-add").find("textarea").val("");$("#btn-histoty-save").removeClass("mind-disable")}})},collaUsers:[],renderUsers:function(h,e){var f=this;var b=$("#colla-users-con"),d=b.find(".colla-users-list");if(e=="ONLINE_USER"){var a=h.length;d.empty();for(var c=0;c<a;c++){var g=h[c];if(d.find("[userid="+g.userId+"]").length<1){f.renderUserPhoto(d,g)}}f.collaUsers=h}if(e=="LEAVE_OUT"){d.find("[clientid="+h.clientId+"]").remove();for(var c=0;c<f.collaUsers.length;c++){if(f.collaUsers[c].clientId==h.clientId){f.collaUsers.splice(c,1);break}}}if(e=="JOIN_IN"){if(d.find("[userid="+h.userId+"]").length<1){f.renderUserPhoto(d,h)}f.collaUsers.push(h)}if(f.collaUsers.length>1){$("#colla-users-con").css("display","block")}else{$("#colla-users-con").css("display","none")}},renderUserPhoto:function(a,b){var c="/photo/"+b.userId+".png";if(window.location.host.indexOf("processon.com")>=0){c="https://accounts.processon.com/photo/"+b.userId+".png"}a.append("<div class='colla-user' clientid= "+b.clientId+"  userid= "+b.userId+"  title_pos='top' title='"+decodeURIComponent(b.userName)+"'><a href='/u/profile/"+b.userId+"' target='_blank'><img src='"+c+"'/></a></div>")},userOpCount:{},showUserOp:function(e,d){var b=mindColla.collaUserClient[d];if(b==null){return}if(e.length==0){return}var h=e[0];var g=$("#"+h);if(g!=null){var f=g.offset();var a=$(".colla-user-tip-con[uk="+d+"]");if(a.length==0){var c="/photo/"+b.userId+".png";if(window.location.host.indexOf("processon.com")>=0){c="https://accounts.processon.com/photo/"+b.userId+".png"}a=$("<div uk='"+d+"' class='colla-user-tip-con'><img src='"+c+"'/> <span>"+decodeURIComponent(b.userName)+"</span>正在编辑此文件</div>").appendTo("body");if(mindColla.userOpCount[d]!=null){window.clearTimeout(mindColla.userOpCount[d])}mindColla.userOpCount[d]=setTimeout(function(){a.fadeOut().remove()},2000)}a.css({left:f.left+g.outerWidth()+12,top:f.top+g.outerHeight()/2-a.outerHeight()/2}).show()}},stm:null,showCollaTip:function(d,a,m){var l=this,f="",j="",e=[];var k=(m=="leave")?"离开":"加入";for(var h=0;h<a.length;h++){var c=a[h];var g=l.collaUsers[c];if(m=="join"){var b="/photo/"+g.userId+".png";if(window.location.host.indexOf("processon.com")>=0){b="https://accounts.processon.com/photo/"+g.userId+".png"}if(e.indexOf(g.userId)<0){j="<div uid='"+c+"' class='colla-user' title_pos='top' title='"+g.name+"'><a target='_blank' href='/u/"+g.uname+"/profile'><img src='"+b+"'/></a></div>";d.append(j);e.push(g.userId)}}else{d.find("[uid="+c+"]").remove()}if(g==null||g.client==mindColla.collaClient){continue}if(f!=""){f+=","}f+=g.name}if(f!=""){}},stop:function(c){var a=mindColla.collaClient,b=mindColla.collaUk;window.clearInterval(mindColla.collaItv);mindColla.collaUserCount--;mindColla.collaCount=1;$.ajax({url:"/mindmap/stop",type:"post",cache:false,data:{subject:chartId,client:a,uk:b},success:function(d){},error:function(){}})},needToRefrsh:function(b){if($("#stop_listen_tip").length>0){$("#stop_listen_tip").dialog();$("#stop_listen_tip").find(".mind-dlog-close").remove();return}var c='检测到更新的版本，您需要刷新后才可以继续编辑，您当前的操作已经保存成功。<br><br><div><a class="button" onclick="location.reload();">刷新</a></div>';var a='<div id="stop_listen_tip" class="mind-dlg"><h3>温馨提示</h3><div class="mind-dlg-content">'+c+"<br><br></div></div>";$(a).appendTo("body").dialog();$("#stop_listen_tip").find(".mind-dlog-close").remove()},renderOff:function(b){if($("#stop_listen_tip").length>0){$("#stop_listen_tip").dialog();$("#stop_listen_tip").find(".mind-dlog-close").remove();return}mindColla.saveVersion();var c='当前存在多个终端正在编辑文件<br><br>无法离线，系统已自动为您存储历史版<br><br><div>点击 <a style="color:#63abf7;cursor:pointer" onclick="location.reload();">刷新恢复</a></div>';if(b=="focus"){c="其他浏览器已经进入聚焦模式<br><br>只允许一端存在编辑操作，防止数据出现覆盖或者丢失，您可以关闭此页面<br><br></div>"}else{if(b=="colla"){c='协作服务器连接断开，多人协作状态下<br><br>无法进行编辑操作，可以点击<br><br><div><a class="button" onclick="location.reload();">刷新恢复</a></div>'}}var a='<div id="stop_listen_tip" class="mind-dlg"><h3>提示</h3><div class="mind-dlg-content">'+c+"<br><br></div></div>";$(a).appendTo("body").dialog();$("#stop_listen_tip").find(".mind-dlog-close").remove()},renderTipDig:function(b){if($("#focus_dlg_tip").length>0){$("#focus_dlg_tip").dialog();return}var c='暂时无法进入聚焦模式<br><br>因为当前存在多人同时编辑脑图，进入聚焦模式会影响其他人正常操作。<br><br><br><div><a style="color:#63abf7;cursor:pointer" onclick="mindColla.renderTipDigClose();">放弃聚焦</a></div>';if(b=="revert"){c="暂时无法恢复历史版本<br><br>因为当前存在多人同时编辑脑图，恢复历史版本会影响其他人正常操作。<br><br><br><div><a style='color:#63abf7;cursor:pointer' onclick='mindColla.renderTipDigClose();'>放弃恢复</a></div>"}var a='<div id="focus_dlg_tip" style="width:466px;height:208px;" class="mind-dlg"><h3>提示</h3><div class="mind-dlg-content">'+c+"<br><br></div></div>";$(a).appendTo("body").dialog()},renderTipDigClose:function(){$("#focus_dlg_tip").dialog("close")}};var mindUI={member:false,fileCount:0,usedFileCount:0,chartId:function(){return chartId},newId:function(){return(this.newIdS4()+this.newIdS4()+this.newIdS4())},newIdS4:function(){return(((1+Math.random())*65536)|0).toString(16).substring(1)},saveTamp:0,getRandomColor:function(){var b=["rgb(255, 244, 179)","rgb(179, 229, 255)","rgb(196, 179, 255)","rgb(236, 255, 179)","rgb(216, 210, 210)"];var a=parseInt(Math.random()*5);return b[a]},filterXss:function(a){if(a==null||a==""){return""}a=a.toString();a=a.replace(/</g,"&lt;");a=a.replace(/%3C/g,"&lt;");a=a.replace(/>/g,"&gt;");a=a.replace(/%3E/g,"&gt;");a=a.replace(/'/g,"&#39;");a=a.replace(/"/g,"&quot;");return a},restoreXss:function(a){if(a==null||a==""){return""}a=a.replace(/&lt;/g,"<");a=a.replace(/&gt;/g,">");a=a.replace(/&#39;/g,"'");a=a.replace(/&quot;/g,'"');return a},restoreXss_:function(a){if(a==null||a==""){return""}a=a.replace(/&lt;/g,"<");a=a.replace(/&gt;/g,">");a=a.replace(/&#39;/g,"'");a=a.replace(/&amp;lt;/g,"<");a=a.replace(/&amp;gt;/g,">");return a},leftCornerDisplayCallback:function(){mindUI.leftFloatToolMenu.initPos()},leftFloatToolMenu:{init:function(){var a=$("#left-float-tool-menu");if(a.length==0){a=$('<ul id="left-float-tool-menu" class="left-float-menu"><li class="menu-item" tp="quick_to_outline" title="切换为思维笔记模式" title_pos="right"><span  class="mind-icons">&#xe7ef;</span></li><li class="menu-item" tp="left-corner-in"  title="目录" title_pos="right"><span class="mind-icons">&#xe7f0;</span></li></ul>').appendTo($("body"))}this.initEvent()},initEvent:function(){var b=this,a=$("#left-float-tool-menu");a.off("click").on("click",".menu-item",function(f){var d=$(this),g=d.attr("tp");switch(g){case"quick_to_outline":sessionStorage.setItem("ur_resource_outline","po_mind_left_tool_menu");location.href="/outline/"+chartId;break;case"left-corner-in":var c=$(".mind-corner.left");if(c.hasClass("active")&&c.children("[tit=outline]").css("display")=="block"){$(".mind-corner.left").showCorner("close")}else{$(".mind-corner.left").showCorner({type:"outline",pos:"left",onClose:function(){b.initPos()}});mindUI.loadOutline()}b.initPos();break}})},initPos:function(){var c=$("#left-float-tool-menu");var b=$(".mind-corner.left");if(b.hasClass("active")){var a=b.outerWidth();c.css({left:a-0+3})}else{c.css({left:"20px"})}}},changeOpStatus:function(h){var a=h.util.selectedIds;if(a.length==0){f()}else{var j=h.currentRoot||h.model.topic;g();if(a.length>1){b("image");b("remark");b("tag");b("link");b("task");$(".header-item.brash").addClass("mind-disable1")}for(var e=0;e<a.length;e++){var c=a[e];if(c==j.id){$(".header-item.summary,.header-item.boundary").addClass("mind-disable1");break}else{if($("#"+c).hasClass("summary")){$(".header-item.summary,.header-item.boundary").addClass("mind-disable1");break}}}}function f(){$(".header-item.brash,.header-item.icon_conn,.header-item.summary,.header-item.boundary").addClass("mind-disable1");var i=$(".mind-right-detail");i.children("[tit]").each(function(){var k=$(this);if(k.attr("tit")=="style"){$("#mind-style-topic").addClass("mind-disable1")}else{k.addClass("mind-disable1")}});i.find("input[type=text]:not(#mind-topic-sy)").attr("disabled",true);i.find("#mind-subtopic-y").children("input").attr("disabled",false);i.find("#mind-subtopic-children-y").children("input").attr("disabled",false);i.find("#mind-subtopic-x").children("input").attr("disabled",false);i.find("#mind-subtopic-children-x").children("input").attr("disabled",false);i.find("textarea").attr("disabled",true);$(".mind-tab-line > label[tit=mind-style-page]").trigger("click")}function g(){var i=$(".mind-right-detail");$(".header-item.brash,.header-item.icon_conn,.header-item.summary,.header-item.boundary").removeClass("mind-disable1");i.children(".mind-disable1").removeClass("mind-disable1");i.find("input[type=text]").removeAttr("disabled");i.find("textarea").removeAttr("disabled");$(".mind-tab-line > label[tit=mind-style-topic]").trigger("click");$("#mind-style-topic").removeClass("mind-disable1")}function b(k){var i=$(".mind-right-detail");i.children("[tit="+k+"]").addClass("mind-disable1");i.find("input[type=text]").attr("disabled",true);i.find("textarea").attr("disabled",true)}function d(k){var i=$(".mind-right-detail");i.children("[tit="+k+"]").removeClass("mind-disable1");i.find("input[type=text]").removeAttr("disabled");i.find("textarea").removeAttr("disabled")}},initDock:function(s){if(s==null){return}var p=mind.currentRoot||mind.model.topic;if(!s.root){$(".brash").removeClass("mind-disable")}var w=mind.style.getStyle.call(mind,s);var e,o,H,x,t,l,L,k;k=p.background||mind.styles.background;if(s.style!=null){var G=s.style;o=G["font-size"];e=G["font-family"];H=G.color;x=G["font-weight"];t=G["font-style"];l=G["text-align"];L=G["background-color"]}if((x||w["font-weight"])=="bold"){$("#mind-font-b").addClass("selected")}else{$("#mind-font-b").removeClass("selected")}if((t||w["font-style"])=="italic"){$("#mind-font-i").addClass("selected")}else{$("#mind-font-i").removeClass("selected")}if(w["text-decoration"]=="underline"){$("#mind-font-ul").addClass("selected")}else{$("#mind-font-ul").removeClass("selected")}if(w["text-decoration"]=="line-through"){$("#mind-font-ml").addClass("selected")}else{$("#mind-font-ml").removeClass("selected")}var h=w["border-width"],I=w.border;var y=w["border-style"];if((h!=null)||I){var F=$("#"+s.id);var C=F.css("border-width")||F.css("border-left-width");var E=F.css("border-style")||F.css("border-left-style");var N=F.css("border-color")||F.css("border-left-color");if(C.length>5){C=C.replace("px","");C=Math.round(C)+"px"}$("#mind-customise-bw_").children("span").text(C);var q=$("#mind-customise-borderst").children("[tp="+E+"]").text();if(q!=""){$("#mind-customise-bst_").children("span").text(q)}$("#mind-customise-bc_").children(".color_line").css("background",N)}else{$("#mind-customise-bw_").children("span").text("0px");$("#mind-customise-bst_").children("span").text("无")}if(y!=null){var q=$("#mind-customise-borderst").children("[tp="+y+"]").text();if(q!=""){$("#mind-customise-bst_").children("span").text(q)}}else{$("#mind-customise-bst_").children("span").text("无")}var f=w.lineStyle;if(f!=null){$("#mind-customise-linew_").children("span:first").text((f.lineWidth||2)+"px");$("#mind-customise-linec_").children(".color_line").css("background",f.lineColor)}var a=w["border-radius"];if(a!=null){a=parseInt(a);if(a==5){$("#mind-customise-bs2_").addClass("selected").siblings().removeClass("selected")}else{if(a==0){$("#mind-customise-bs1_").addClass("selected").siblings().removeClass("selected")}else{if(a==30){$("#mind-customise-bs3_").addClass("selected").siblings().removeClass("selected")}}}}else{$(".mind-color-box[bdr=true]").removeClass("selected")}$("#mind-select-font").children("span").text(e||w["font-family"]);$("#mind-number-size").children("input").val(o==null?w["font-size"]:(parseInt(o)+"px"));$("#mind-font-color").find(".color_line").css("background",H||w.color);$(".mind-color-box[align="+(l||w["text-align"])+"]").addClass("selected").siblings("[align]").removeClass("selected");if(L!=null||w.backgroundColor!=null){$("#mind-topic-bg").find(".color_line").css({"background-color":L||w.backgroundColor,color:H||w.color})}else{$("#mind-topic-bg").find(".color_line").css({"background-color":"#fff",color:"#333"})}$("#mind-canvas-bg").find(".color_line").css("background",k);var n=s.note,v=s.tags,d=s.link,B=s.task,K=s.icons;if(n){$("#mind-topic-remark").val(n)}else{$("#mind-topic-remark").val("")}if(K&&K.length>0){var A=$(".mind-right-detail > [tit=icon]");A.find(".selected").removeClass("selected");for(var J=0,m=K.length;J<m;J++){var g=K[J];A.find("[ico="+g.index+"]").addClass("selected")}}else{var A=$(".mind-right-detail > [tit=icon]");A.find(".selected").removeClass("selected")}var r=mind.tags.renderTagColors(mind);$(".mind-tags-color").children().eq(1).html(r);mind.tags.renderTags(mind,s.id);if(d){$("#mind-topic-link").val(d.value);$("#mind-topic-linktitle").val(d.title)}else{$("#mind-topic-link").val("");$("#mind-topic-linktitle").val("")}if(B){var D=$("#mind-icons-priority-list"),b=$("#mind-icons-completion-list");var u=D.find("li[priority="+B.priority+"]").clone(),z=b.find("li[completion="+B.completion+"]").clone();u.find("span").remove();z.find("span").remove();var j=u.text();var M=z.text();if(j!=""){$("#mind-task-priority").children("span").text(j)}else{$("#mind-task-priority").children("span").text("无")}if(M!=""){$("#mind-task-completion").children("span").text(M)}else{$("#mind-task-completion").children("span").text("无")}z.remove();u.remove();$("#mind-task-start").children("span").text(B.start||"无");$("#mind-task-end").children("span").text(B.end||"无");$("#mind-task-assigned").val(B.assigned)}else{$("#mind-task-priority").children("span").text("无");$("#mind-task-completion").children("span").text("无");$("#mind-task-start").children("span").text("无");$("#mind-task-end").children("span").text("无");$("#mind-task-assigned").val("")}var c=mind.util.getMargin.call(mind);$("#mind-subtopic-y").children("input").val(c.marginH+"px");$("#mind-subtopic-children-y").children("input").val(c.childMarginH+"px");$("#mind-subtopic-x").children("input").val(c.marginW+"px");$("#mind-subtopic-children-x").children("input").val(c.childMarginW+"px");if(p.structure=="mind_org"||p.structure=="mind_tree"){$(".topic-margin-wrap").addClass("mind-disable1")}else{$(".topic-margin-wrap").removeClass("mind-disable1")}mindUI.initStyleEvent()},getFile:function(b){var a=localStorage;return a.getItem("def_"+b)},saveFile:function(b,c){var a=localStorage;a.setItem("def_"+b,c)},removeFile:function(b){var a=localStorage;a.removeItem("def_"+b)},setLocalFiles:function(){var e=localStorage,b=[],j=e.getItem("localFiles")||"[]";var h=JSON.parse(j);for(var f in e){if(f=="currentId"||f=="currentTitle"||f.indexOf("def_local")>=0){continue}else{if(f.indexOf("def_")<0){continue}}var d=e[f];var i=JSON.parse(d);var a=f.substring(4);if(!g(a,h)){var c={id:a,title:i.title,localId:localId};b.push(c)}}h=h.concat(b);e.setItem("localFiles",JSON.stringify(h));function g(p,o){if(o.length==0){return false}var n=false;for(var m=0,k=o.length;m<k;m++){var l=o[m];if(l.id==p){n=true;break}}return n}},loadRecentFiles:function(){if(chartId==""){return}$.ajax({url:"/mindmap/getrecentfiles",data:{team_id:teamId},success:function(f){var b=$(".mind-title-menu-con");b.html("");if(f.charts!=null){var e=f.charts;for(var d=0,a=e.length;d<a;d++){var c=e[d];var g=$('<div id="title_'+c.chartId+'" class="dropdown-item"><a href="/mindmap/'+c.chartId+'">'+c.title+'</a><span style="color:#aaa;margin-left:10px;display:inline-block;">'+mindUI.splitDate(c.lastModify)+"</span></div>");if(c.chartId==mindUI.chartId()){g.addClass("active")}b.append(g)}}}})},loadLocalFiles:function(){var f=localStorage,c=f.getItem("localFiles");var b=$(".mind-title-menu-con");$(".mind-title-menu-item").remove();if(c==null){return}var g=JSON.parse(c);for(var e=0,a=g.length;e<a;e++){var d=g[e];if(d.localId!=localId){continue}var h=$('<div id="title_'+d.id+'" class="mind-title-menu-item"><a>'+d.title+'</a><span class="mind-icons">&#xe622;</span></div>');if(d.id==mindUI.chartId()){h.addClass("active")}b.append(h)}$(".mind-title-menu-item").on("click",function(j){var i=$(this),l=i.attr("id");var m=l.replace("title_",""),k=i.find("a").text();mindUI.openFile(m)});$(".mind-title-menu-item .mind-icons").on("click",function(k){var j=$(this),i=j.parent(),m=i.attr("id");i.parent().find(".mind-file-delete").remove();var l=$("<div class='mind-file-delete'><span class='delete'>删除</span> <span class='cancel'>取消</span></div>");l.appendTo(i);l.animate({left:0},50);$(".mind-title-menu-item .delete").on("click",function(n){if(m.indexOf("title_")>=0){m=m.substring(6)}mindUI.deleteLocalFile(m);i.remove();n.stopPropagation()});$(".mind-title-menu-item .cancel").on("click",function(n){var p=$(this),o=p.parent();o.parent().find(".mind-file-delete").remove();n.stopPropagation()});k.stopPropagation()})},deleteLocalFile:function(g){var d=localStorage.getItem("localFiles");var c=JSON.parse(d),e=[];for(var b in c){var a=c[b];if(a.id!=g){e.push(a)}}var f=e[0];localStorage.setItem("localFiles",JSON.stringify(e));localStorage.removeItem("def_"+g);if(g==chartId){if(f!=null){$(".mind-title-menu-item:first").trigger("click")}else{localStorage.removeItem("localFiles");localStorage.removeItem("currentId");localStorage.removeItem("currentTitle");$(".header-item .title").text("");mind.operation.clearCanvas.call(mind);window.location.hash=""}}},currentDef:null,currentDefId:null,splitDate:function(b){if(b==""){return}var d="";var a=b.split(" ");if(a[0].indexOf("-")>=0){var c=a[0].split("-");if(new Date().getFullYear()==c[0]){d=c[1]+"-"+c[2]}else{d=c}}if(a[1].indexOf(":")>=0){var c=a[1].split(":");d+=" "+c[0]+":"+c[1]}return d},renderHistory:function(f){if(f==null){return}var g="";for(var e=0,b=f.length;e<b;e++){var d=f[e],h=d._id.$oid;var a="";if(d.remark=="自动存储"){a="auto=true"}g+="<li "+a+' vid="'+h+'" def="'+d.definitionId+'"><div class="history_remark">'+d.createDate+'<span class="mind-icons revert" title="还原至此版本">&#xe6e9;</span><span class="mind-icons del" title="删除">&#xe622;</span></div><div class="history_info"><span class="version_time">'+d.fullName+"</span><span>"+d.remark+"</span></div></div></li>"}var c=$("#history-container");c.html(g);if(g==""){c.html('<div id="history-none-tip" style="text-align:center;"><img style="width:110px;" src="/assets/images/icon/empty_version.svg"/><div style="font-size:14px;">未找到手动创建的历史版本</div></div>')}else{$("#history-none-tip").hide()}$(".mind-corner.left").find(".showmycreate").off("click").on("click",function(j){var i=$(this);if(i.hasClass("active")){i.removeClass("active");mindUI.loadHistorys();i.attr("title","我创建的")}else{i.addClass("active");i.attr("title","全部");$("#history-container").find("[auto]").remove();if($("#history-container").text()==""){$("#history-container").html('<div id="history-none-tip" style="text-align:center;"><img style="width:110px;" src="/assets/images/icon/empty_version.svg"/><div style="font-size:14px;">未找到手动创建的历史版本</div></div>')}}});$("#history-container li").off("click").on("click",function(){var j=$(this),i=j.attr("def");if(i==mindUI.currentDefId){return}mindUI.currentDefId=i;mindUI.getHistory(i);j.addClass("active").siblings().removeClass("active")});$("#history-container").find(".del").off("click").on("click",function(m){var l=$(this),k=l.parent().parent();var j=k.attr("def");var i=k.attr("vid");if(i!=null){l.confirm({content:"确定要删除当前历史记录？",width:168,height:45,onConfirm:function(){mindUI.removeHistory(i);if(j==mindUI.currentDefId){mindUI.closeHistory()}}})}m.stopPropagation()});$("#history-container").find(".revert").off("click").on("click",function(m){var l=$(this),k=l.parent().parent();var j=k.attr("def");var i=k.attr("vid");if(i!=null){l.confirm({content:"确认要还原至该版本？",width:168,height:45,onConfirm:function(){var n=mindColla.collaUsers;var o=Object.keys(n);if(o.length>1){mindColla.renderTipDig("revert");return}$.ajax({url:"/diagraming/get_versiondef",data:{id:j},success:function(p){if(p.def==null){return}mindUI.revertHistory(p.def);$.showTip("历史版本还原成功",1500)}})}})}m.stopPropagation()})},loadHistorys:function(){if(chartId==""){return}var a=$("#history-container");$.ajax({url:"/diagraming/get_versions",data:{chartId:chartId},cache:false,success:function(c){var b=c.list;mindUI.renderHistory(b)}})},loadEquation:function(){var c={"上标、下标及积分等":["a^2","a_2","a^{2+2}","a_{i,j}","{}_1^2\\!X_3^4","\\overset{\\frown} {AB}","\\overline{hij}","\\underline{klm}","\\overbrace{1+2+\\cdots+100}","\\begin{matrix} 5050 \\\\ \\overbrace{ 1+2+\\cdots+100 }\\end{matrix}","\\underbrace{a+b+\\cdots+z}","\\sum_{k=1}^N k^2","\\begin{matrix} \\sum_{k=1}^N k^2 \\end{matrix}","\\prod_{i=1}^N x_i","\\begin{matrix} \\prod_{i=1}^N x_i \\end{matrix}","\\coprod_{i=1}^N x_i","\\begin{matrix} \\coprod_{i=1}^N x_i \\end{matrix}","\\lim_{n \\to \\infty}x_n","\\begin{matrix} \\ lim_{n \\to \\infty}x_n \\end{matrix}","\\int_{-N}^{N} e^x\\, \\mathrm{d}x","\\begin{matrix} \\int_{_N}^{N} e^x\\, \\mathrm{d}x \\end{matrix}","\\iint_{D}^{W} \\, \\mathrm{d}x\\,\\mathrm{d}y","\\iiint_{E}^{V} \\,\\mathrm{d}x\\,\\mathrm{d}y,\\mathrm{d}z","\\oint_{C} x^3\\, \\mathrm{d}x + 4y^2\\, \\mathrm{d}y","\\bigcap_1^{n} p","\\bigcup_1^{k} p"],"括号和分隔符":["\\left(\\frac{a}{b} \\right)","\\left[\\frac{a}{b} \\right]","\\left\\{\\frac{a}{b} \\right\\}","\\left \\langle \\frac{a}{b} \\right \\rangle","\\left|\\frac{a}{b} \\right|","\\left \\lceil \\frac{c}{d} \\right \\rceil","\\left / \\frac{a}{b} \\right \\backslash","\\left \\Uparrow \\frac{a}{b} \\right \\Downarrow","\\left \\updownarrow \\frac{a}{b} \\right \\Updownarrow","\\left [ 0,1 \\right ) \\left \\langle \\psi \\right |","\\left \\{ \\frac{a}{b} \\right.","\\left . \\frac{a}{b} \\right \\}","\\langle","\\rangle","\\lceil","\\rceil","\\lfloor","\\rfloor","\\lbrace","\\rbrace","\\lvert","\\rvert"],"根号":["\\sqrt{3}","\\sqrt[n]{3}"],"函数":["\\sin\\theta","\\cos\\theta","\\tan\\theta","\\arcsin\\frac{L}{r}","\\arccos\\frac{T}{r}","\\arctan\\frac{L}{T}","\\sinh g","\\cosh h","\\tanh i","\\coth j","\\operatorname{sh}j","\\operatorname{ch}h","\\operatorname{th}i","\\operatorname{argsh}k","\\operatorname{argch}l","\\operatorname{argth}m","\\limsup S","\\liminf I","\\max H","\\min L","\\inf s","\\sup t","\\exp\\!t","\\ln X","\\lg X","\\log X","\\log_\\alpha X","\\ker x","\\deg x","\\gcd(T,U,V,W,X)","\\Pr x","\\det x","\\hom x","\\arg x","\\dim x","\\lim_{t\\to n}T"],"微分及导数":["\\nabla\\psi","\\partial x","\\mathrm{d}x","\\dot x","\\ddot y","X^\\prime","\\backprime","f^{(3)}"],"关系运算符":["\\pm","\\times","\\div","\\mid","\\nmid","\\cdot","\\circ","\\ast","\\bigodot","\\bigotimes","\\bigoplus","\\leq","\\geq","\\leqq","\\geqq","=","\\neq","\\approx","\\equiv","\\not\\equiv","\\sum","\\prod","\\coprod","\\backslash","\\sim","\\backsim","\\simeq","\\cong","\\dot=","\\ggg","\\gg",">","<","\\ll","\\lll","\\propto"],"集合与逻辑符号":["\\emptyset","\\varnothing","\\in","\\not\\in","\\subset","\\supset","\\subseteq","\\supseteq","\\sqsubseteq","\\sqsupseteq","\\cap","\\cup","\\bigcup","\\bigcap","\\sqcap","\\sqcup","\\uplus","\\biguplus","\\bigsqcup","\\top","\\bot","\\complement","\\vee","\\wedge","\\bigvee","\\bigwedge","\\forall","\\exists","\\not\\subset","\\not=","\\not<","\\not>","\\because","\\therefore","\\neg","\\bar{q} \\to p","\\setminus","\\smallsetminus"],"几何符号":["\\Diamond","\\Box","\\triangle","\\perp","\\angle\\Alpha\\Beta\\Gamma","60^\\circ"],"戴帽符号":["\\vec{c}","\\overleftarrow{ab}","\\overrightarrow{cd}","\\overleftrightarrow{ab}","\\widehat{efg}","\\overset{\\frown} {AB}","\\hat{xyz}","\\tilde{xy}","\\bar{y}","\\widetilde{xyz}","\\acute{y}","\\breve{y}","\\check{y}","\\grave{y}"],"箭头符号":["\\to","\\mapsto","\\underrightarrow{1^\\circ/min}","\\implies","\\impliedby","\\iff","\\uparrow","\\downarrow","\\Uparrow","\\Downarrow","\\leftarrow","\\rightarrow","\\leftrightarrow","\\Leftarrow","\\Rightarrow","\\Leftrightarrow","\\longleftarrow","\\longrightarrow","\\longleftrightarrow","\\Longleftarrow","\\Longrightarrow","\\Longleftrightarrow"],"特殊符号":["\\eth","\\%","\\dagger","\\ddagger","\\star","*","\\ldots","\\smile","\\frown","\\wr"],"分数、矩阵和多行列式":["\\frac{2}{4}=0.5","{2 \\over 3}","{{a+b} \\over {a-b}}","\\tfrac{2}{4} = 0.5"],"希腊字母":["\\alpha","\\beta","\\gamma","\\delta","\\epsilon","\\zeta","\\eta","\\theta","\\iota","\\kappa","\\lambda","\\mu","\\nu","\\xi","o","\\pi","\\rho","\\sigma","\\tau","\\upsilon","\\phi","\\chi","\\psi","\\omega"]};for(var b in c){$(".eq-select ul").append("<li>"+b+"</li>");var d="<h3>"+b+'</h3><div class="table"><div class="title"><span>效果</span><span>语法</span></div>';for(var a=0;a<c[b].length;a++){d+="<div><span>"+katex.renderToString(c[b][a])+'</span><span class="copy">'+c[b][a]+"</span></div>"}d+="</div>";$("#eq-container>div").append(d)}$(".eq-select").off().on("click",function(f){f.stopPropagation();$(this).toggleClass("on")});$(".eq-select li").off().on("click",function(){var f=$(this);$(".eq-input").val(f.text());var e=document.getElementById("eq-container").getElementsByTagName("h3")[f.index()].offsetTop-108;$("#eq-container").scrollTop(e)});$(".table>div:not(.title)").off().on("click",function(j){j.stopPropagation();$(".table .tip").remove();var i=$(this);var h=document.createElement("input");h.setAttribute("value",i.find(".copy").text());document.body.appendChild(h);h.select();try{if(document.execCommand("copy",false,null)){i.append('<div class="tip">已复制到剪贴板</div>');var g=$(".notranslate");if($(".eq-editor").is(":visible")){var f=g.html()+i.find(".copy").text();g.html(f).trigger("keydown").trigger("keyup");g.textMoveToEnd()}setTimeout(function(){i.find(".tip").remove()},1000)}}catch(j){}document.body.removeChild(h)}).on("mousedown",function(f){f.stopPropagation()});$("body").off().on("click",function(){$(".eq-select").removeClass("on")})},loadOutline:function(){var c={target:"outline-container",searchTarget:"outline-container-search",line:{show:true},readOnly:true,indent:"wider"};var d=mind.util.copy(mind.model.topic);var b=Outline.init(c,d);$("#outline-dlg").parent().off("scroll").on("scroll",function(h){h.stopPropagation();var g=$(this),f=$(".outline-dragable");f.css("top",g.scrollTop())});$(".outline-dragable").off("mousedown").on("mousedown",function(i){var h=$(".mind-corner.left");var g=h.width();h.addClass("noevent");var f=i.pageX;$(document).off("mousemove.outline").on("mousemove.outline",function(j){var e=j.pageX;h.css("width",(g+e-f)+"px");$("#left-float-tool-menu").addClass("noevent");mindUI.leftFloatToolMenu.initPos()});$(document).off("mouseup.outline").on("mouseup.outline",function(){$(document).off("mousemove.outline");$(document).off("mouseup.outline");h.removeClass("noevent");$("#left-float-tool-menu").removeClass("noevent");h=null})});$(".outline-retrieval").children("div").not(":first").hide();$(".top-op-btn .change-btn:eq(0)").addClass("on").siblings().removeClass("on");$(".top-op-btn").removeClass("on");var a=mind.util.getSelectedId();if(!a){$(".outline-curt-bg").hide();return}Outline.controller.selectNodeById(a)},getHistory:function(a){if(a==null){return}$.ajax({url:"/diagraming/get_versiondef",data:{id:a},success:function(b){if(b.def==null){return}if(mind.currentRoot!=null){mind.operation.focusTopic.call(mind,mind.model.topic.id);mind.operation.exitFocus.call(mind)}mindUI.openHistory(b.def);$("#mind-history-tip").css({top:56,marginLeft:-122}).show().find(".mind-tip-text").html("您在正浏览一个历史版本<a href='javascript:' style='margin-left: 10px;color:#fff;text-decoration:underline;' onclick='mindUI.closeHistory()'>点击退出</a>")}})},removeHistory:function(a){if(a==null){return}$.ajax({url:"/diagraming/del_version",data:{vid:a},cache:false,success:function(b){$("#history-container").find("li[vid="+a+"]").remove();if($("#history-container li").length>0){$("#history-none-tip").hide()}else{$("#history-none-tip").show()}}})},openingDef:null,openHistory:function(b){if(this.currentDef==null){var d=mind.opts.chartId;var c=JSON.stringify(mind.model.topic);this.currentDef=c}this.openingDef=b;mind.operation.clearCanvas.call(mind);var a=new mindDesigner("#mind_con",{chartId:chartId,readonly:true},b);mind.operation.setDisable.call(mind);a.util.clearSelect()},closeHistory:function(a){if(a==null){a=this.currentDef}var b=mind.opts.chartId;mind.operation.clearCanvas.call(mind);mind=new mindDesigner("#mind_con",{chartId:chartId},a);mind.operation.setEnable.call(mind);this.currentDef=null;mindUI.currentDefId=null;$("#history-container").find(".active").removeClass("active");$(".mind-topic-focus").remove();mind.events.push("focus",null);$("#mind-history-tip").css({top:-56}).hide()},revertHistory:function(a){$.ajax({url:"/mindmap/restore",type:"post",data:{def:a,chart_id:chartId,ignore:"def"},success:function(){mindUI.closeHistory(a);mindUI.loadHistorys()}})},saveTitle:function(b){if(b.length>30){b=b.substring(0,30)}if(b==chartTitle){return}chartTitle=b;var a={action:"changeTitle",title:b};mindColla.send([a]);mindUI.loadRecentFiles();document.title=b},setLocalFileTitle:function(h,g){var d=window.localStorage;var e=d.getItem("localFiles");var f=JSON.parse(e);for(var c=0,a=f.length;c<a;c++){var b=f[c];if(b.localId!=localId){continue}if(b.id==h){b.title=g}}d.setItem("localFiles",JSON.stringify(f))},setLocalFileId:function(h,b){var e=window.localStorage;var f=e.getItem("localFiles");var g=JSON.parse(f);for(var d=0,a=g.length;d<a;d++){var c=g[d];if(c.localId!=localId){continue}if(c.id==h){c.id=b;break}}e.setItem("localFiles",JSON.stringify(g))},addLocalFile:function(f,e){var b=window.localStorage;var c=b.getItem("localFiles");var d=JSON.parse(c);var a={id:f,title:e,localId:localId};d.push(a);b.setItem("localFiles",JSON.stringify(d))},isMember:function(c,b,a){$.ajax({url:"/mindmap/ismember",data:{orgId:orgId,teamId:teamId},type:"post",success:function(d){mindUI.member=d.member?true:false;mindUI.fileCount=d.fileCount;mindUI.usedFileCount=d.usedFileCount;if(d.member){$("#export_form").find("[tit=member]").eq(0).remove();$("#export_form").find("[tit=member]").removeClass("mind-disable1");$(".upload_file_con").removeClass("mind-disable1");$(".uplpad_file_tip").remove();$("#mind-topic-sytip").hide()}else{$("#mind-topic-sytip").show()}typeof a==="function"&&a(mindUI.member)}})},savePublish:function(f){var b=$("#publish_category").val();var e=$("#publish_language").val();var d=$("#publish_description").val();var a=$("#publish_tags").val();var c=a.replace(/，/ig,",").split(",");c=this.removeFromArray(c,"");if(c.length==0){$("#publish_tags").attr("placeholder","请输入标签");$("#publish_tags").focus();return}$("#publish_dlg_save").addClass("mind-disable");$.ajax({url:"/folder/publish",type:"post",data:{id:chartId,status:"public",language:e,industry:b,description:d,tags:c,_public_edit:$("#public_edit").is(":checked"),_public_clone:$("#public_clone").is(":checked")},traditional:true,success:function(g){$("#publish_dlg_save").removeClass("mind-disable");f()}})},showThemeOperate:function(b){$(".mind-theme-dlg").dialog("close");$(".mind-theme-customise-dlg").dialog("close");var a=$(".mind-exists-dlg");a.dialog();$("#btn-style-overwrite").off("click").on("click",function(){mind.style.setThemeOverWrite.call(mind,b,function(){$(".mind-exists-dlg").dialog("close");if(waterMark!=null&&waterMark!=""){mind.operation.setWatermark.call(mind,waterMark)}var d=mind.util.getMargin.call(mind);$("#mind-subtopic-y").children("input").val(d.marginH+"px");$("#mind-subtopic-children-y").children("input").val(d.childMarginH+"px");$("#mind-subtopic-x").children("input").val(d.marginW+"px");$("#mind-subtopic-children-x").children("input").val(d.childMarginW+"px");var c=mind.model.topic.theme;$("#mind-themes").find("li").removeClass("selected");$("#mind-themes").find("div[tit="+c+"]").parent().addClass("selected")})});$("#btn-style-remain").off("click").on("click",function(){mind.style.setThemeDirect.call(mind,b);$(".mind-exists-dlg").dialog("close");if(waterMark!=null&&waterMark!=""){mind.operation.setWatermark.call(mind,waterMark)}var c=mind.model.topic.theme;$("#mind-themes").find("li").removeClass("selected");$("#mind-themes").find("div[tit="+c+"]").parent().addClass("selected")});$("#btn-style-cancel").off("click").on("click",function(){$(".mind-exists-dlg").dialog("close")})},renderCustomiseThemes:function(a){var f=[],b=$("#mind-customise-themes-list");if(mindUI.member||a.length>0){b.prev().hide();b.height(453)}else{b.prev().show();b.height(423)}if(a.length==0){b.html("<div style='text-align:center;width:100%;padding-top:120px;'><img style='width:140px;' src='/assets/images/icon/empty_theme.svg'/><div class='text-tip' style='margin-top:0px 8px 9px'>还没有自定义主题风格</div></div>");return}for(var e=0;e<a.length;e++){var h=a[e];var d=JSON.parse(h.theme);if(d!=null){var g=h.themeName||"未命名风格";var c=d.background;if(d.background=="#ffffff"||d.background=="rgb(255,255,255)"){c="#e7e6e5"}f.push("<div cid='"+h.id+"' themeId='"+d.id+"' style='color:"+c+"' class='theme-item'>");f.push("<span class='mind-icons icons-theme'>&#xe71b;</span>");f.push("<div class='theme-item-date'><input type='text' class='theme-item-title' value='"+g+"' /><div>"+h.updateTime.substring(0,16)+"</div></div>");f.push("<div class='theme-item-op'><span title='使用主题风格' class='mind-icons icon-button icons-use'>&#xe614;</span><span title='更改主题风格' class='mind-icons icon-button icons-edit'>&#xe651;</span><span title='删除主题风格' class='icon-button mind-icons icons-close'>&#xe618;</span></div>");f.push("</div>")}}b.html(f.join(""));b.find(".theme-item-op > .icons-use").on("click",function(){var i=$(this).parent().parent().attr("themeId");mind.style.setTheme.call(mind,i,waterMark);Util.globalTopTip("主题风格应用成功","top_success",1000,$(".mind-theme-customise-dlg"),true);setTimeout(function(){$(".mind-theme-customise-dlg").dialog("close")},1000)});b.find(".theme-item-title").off().on("blur",function(){var j=$(this).parent().parent().attr("themeId");var i=$(this).val();if(i.length>10){Util.globalTopTip("请输入10字以内的名称","top_error",1500,$(".mind-theme-customise-dlg"),true);return}mindUI.saveThemeName(j,i)});b.find(".theme-item-op > .icons-close").on("click",function(l){var k=$(this);var j=k.parent().parent();var m=j.attr("themeId");var i=$("#mind-confirm-themedel");k.confirm({content:"确定要删除当前主题？",width:140,height:40,onConfirm:function(){mindUI.removeCustomiseTheme(m,function(){mindUI.loadCustomiseThemesOn();j.remove();mindUI.editCustomiseId=null})}});l.stopPropagation()});b.find(".theme-item-op > .icons-edit").on("click",function(p){var m=$(this);var q=m.parent().parent();var r=q.attr("themeId");var k=sessionStorage.getItem("customiseThemes");var o=null;if(k!=null){var j=JSON.parse(k);for(var n=0;n<j.length;n++){var l=j[n];if(l.id==r){o=l;break}}mindUI.editCustomiseId=o.id;mindUI.customiseTheme=o;mindUI.renderTopic();$("#mind-tabs-styles").trigger("click")}p.stopPropagation()})},saveThemeName:function(b,a){$.ajax({url:"/mindmap/savethemename",data:{id:b,val:a},type:"post",success:function(c){if(c.result=="success"){Util.globalTopTip("风格名称保存成功",null,1500,$(".mind-theme-customise-dlg"),true)}}})},removeCustomiseTheme:function(b,a){$.ajax({url:"/mindmap/deletetheme",data:{id:b},success:function(c){if(c.result=="success"){a()}else{Util.globalTopTip("删除失败","top_error",1500,$(".mind-theme-customise-dlg"),true)}},error:function(){}})},loadCustomiseThemesOn:function(a){if(chartId!=""&&chartId!=null){$.ajax({url:"/mindmap/getthemes",type:"post",success:function(f){var b=f.themes;if(b==null){a()}else{var c=[];for(var e=0;e<b.length;e++){var d=b[e];c.push(JSON.parse(d.theme))}mindUI.renderCustomiseThemes(b);sessionStorage.setItem("customiseThemes",JSON.stringify(c))}},error:function(){}})}},initStructure:function(){if(mind!=null){var b=mind.model.topic.structure;a(b)}var c=$("#mind-structures");c.children().off("mousedown").on("mousedown",function(f){var d=$(this),g=d.attr("tp");mind.operation.changeStructure.call(mind,g,null,null,function(e){d.addClass("active").siblings().removeClass("active")});mindUI.closeMenu(c);a(g)});function a(e){var d=$(".header-item[tit=structure]");if(e=="mind_right"){d.find(".mind-icons").html("&#xe6fb;")}else{if(e=="mind_org"){d.find(".mind-icons").html("&#xe6fd;")}else{if(e=="mind_left"){d.find(".mind-icons").html("&#xe6fc;")}else{if(e=="mind_tree"){d.find(".mind-icons").html("&#xe6fd;")}else{if(e=="mind_free"){d.find(".mind-icons").html("&#xe6fe;")}}}}}$("#mind-structures").children("[tp="+e+"]").addClass("active")}},saveTheme:function(b,d){if(chartId!=""&&chartId!=null){var c=b.id;var a=JSON.stringify(b);$.ajax({url:"/mindmap/savetheme",type:"post",data:{id:c,theme:a,ignore:"theme"},success:function(e){if(e.result=="over"){Util.globalTopTip("免费用户最多只能新建1个自定义风格","top_error",1500,$(".mind-theme-customise-dlg"),true);return}else{if(e.result=="error"){Util.globalTopTip("保存失败","top_error",1500,$(".mind-theme-customise-dlg"),true);return}}d()},error:function(){Util.globalTopTip("保存失败","top_error",1500,$(".mind-theme-customise-dlg"),true)}})}},initCustomise:function(d){var f=$(".mind-theme-customise-dlg");mindUI.customiseTheme=mind.util.copy(d);var e=$("#previewTopic"),g="centerTopic";mindUI.loadCustomiseThemesOn();$("#mind-customise-topic").off().on("click",function(){var j=$(this);$("#mind-customise-topic-list").dropdown({target:j,width:200,onSelect:function(l){var k=l.text();j.children("span").text(k);e.text(k);g=l.attr("tp");if(mindUI.customiseTheme[g]==null){mindUI.customiseTheme[g]=$.extend({},mindUI.customiseTheme.secTopic)}if(g=="centerTopic"){$("#linestylecon").find(".mind-select-box").addClass("mind-disable");$("#linestylecon").find(".mind-color-box").addClass("mind-disable");$("#previewLine").hide()}else{$("#linestylecon").find(".mind-select-box").removeClass("mind-disable");$("#linestylecon").find(".mind-color-box").removeClass("mind-disable");$("#previewLine").show()}mindUI.renderTopic(g);j.removeClass("selected")},onClose:function(){j.removeClass("selected")}})});$("#btn-customise-close").off("click").on("click",function(){var j=$(".mind-theme-customise-dlg").dialog("close")});$("#btn-customise-restore").off().on("click",function(){var j=mind.style.themes.theme3;mindUI.editCustomiseId=null;mindUI.customiseTheme=null;g=null;mindUI.renderTopic();Util.globalTopTip("重置成功","top_success",1000,$(".mind-theme-customise-dlg"),true)});$("#btn-customise-save").off().on("click",function(){var o=mindUI.customiseTheme;if(o!=null){var j=sessionStorage.getItem("customiseThemes");var k=JSON.parse(j)||[];if(mindUI.editCustomiseId!=null){var n=0;for(var l=0;l<k.length;l++){var m=k[l];if(m.id==mindUI.editCustomiseId){n=l;break}}if(o.childTopic&&o.childTopic.lineStyle){delete o.childTopic.lineStyle.underLine}k.splice(n,n,o);sessionStorage.setItem("customiseThemes",JSON.stringify(k));mindUI.saveTheme(o,function(){var q=$(".mind-theme-customise-dlg");q.hide();$.mask("close");mind.style.setTheme.call(mind,o.id,waterMark);mindUI.customiseTheme=null});return}var p=mindUI.newId();o.id="customise_"+p;if(o.childTopic&&o.childTopic.lineStyle){delete o.childTopic.lineStyle.underLine}k.push(o);sessionStorage.setItem("customiseThemes",JSON.stringify(k));mindUI.saveTheme(o,function(){var q=$(".mind-theme-customise-dlg");q.hide();$.mask("close");mind.style.setTheme.call(mind,o.id,waterMark);mindUI.customiseTheme=null})}});$(".mind-dlg-tabs").children().off().on("click",function(){var k=$(this),l=k.attr("id");k.addClass("selected").siblings().removeClass("selected");var j=f.find("div[tit="+l+"]");j.show().siblings("[tit]").hide()});$("#mind-customise-size").numberBox({callback:function(j){if(j<12){$.showTip("字号不能小于12px",1000);return}j=j+"px";mindUI.customiseTheme[g]["font-size"]=j;mindUI.renderTopic(g)}});$("#mind-customise-paddingt").numberBox({width:60,inputWidth:36,callback:function(j){if(j<0){$.showTip("填充边距不能小于0px",1000);return}i()}});$("#mind-customise-paddingr").numberBox({width:60,inputWidth:36,callback:function(j){if(j<0){$.showTip("填充边距不能小于0px",1000);return}i()}});$("#mind-customise-paddingb").numberBox({width:60,inputWidth:36,callback:function(j){if(j<0){$.showTip("填充边距不能小于0px",1000);return}i()}});$("#mind-customise-paddingl").numberBox({width:60,inputWidth:36,callback:function(j){if(j<0){$.showTip("填充边距不能小于0px",1000);return}i()}});function i(){var j=$(".mind-number-box.padding").map(function(){return $(this).children("input").val()}).get().join(" ");mindUI.customiseTheme[g]["padding"]=j;mindUI.renderTopic(g)}$("#mind-customise-font").off().on("click",function(){var j=$(this);$("#mind-font-list").dropdown({target:j,onSelect:function(l){var k=l.text();j.children("span").text(k);mindUI.customiseTheme.common.family=k;j.removeClass("selected");mindUI.renderTopic(g)},onClose:function(){j.removeClass("selected")}})});$("#mind-customise-color").off().on("click",function(){var k=$(this);var j=k.find(".color_line").css("background-color");a(j,k,function(l){mindUI.customiseTheme[g]["color"]=l;mindUI.renderTopic(g)})});$("#mind-customise-b").off().on("click",function(){var j=$(this);if(j.hasClass("selected")){mindUI.customiseTheme.common.bold=false;j.removeClass("selected")}else{mindUI.customiseTheme.common.bold=true;j.addClass("selected")}mindUI.renderTopic(g)});$("#mind-customise-i").off().on("click",function(){var j=$(this);if(j.hasClass("selected")){mindUI.customiseTheme.common.italic=false;j.removeClass("selected")}else{mindUI.customiseTheme.common.italic=true;j.addClass("selected")}mindUI.renderTopic(g)});$("#mind-customise-bw").off().on("click",function(){var j=$(this);$("#mind-customise-borderw").dropdown({target:j,onSelect:function(l){var k=l.attr("tp");if(k==0){mindUI.customiseTheme[g]["border-width"]=0;delete mindUI.customiseTheme[g]["border-color"];delete mindUI.customiseTheme[g]["border"]}else{mindUI.customiseTheme[g]["border-width"]=k}mindUI.customiseTheme[g]["border-style"]="solid";mindUI.renderTopic(g);j.removeClass("selected")},onClose:function(){j.removeClass("selected")}})});$("#mind-customise-bc").off().on("click",function(){var k=$(this);var j=k.find(".color_line").css("background-color");a(j,k,function(l){mindUI.customiseTheme[g]["border-color"]=l;mindUI.renderTopic(g)})});$("#mind-customise-canvasbg").off().on("click",function(){var k=$(this);var j=k.find(".color_line").css("background-color");a(j,k,function(l){mindUI.customiseTheme.background=l;$(".mind-customise-prev").css("background",l)})});$("#mind-customise-linec").off().on("click",function(){var k=$(this);var j=k.find(".color_line").css("background-color");a(j,k,function(l){if(mindUI.customiseTheme[g]["lineStyle"]==null){mindUI.customiseTheme[g]["lineStyle"]={}}mindUI.customiseTheme[g]["lineStyle"]["lineColor"]=l;document.getElementById("previewLine").querySelector("path").setAttributeNS("","stroke",l)})});$("#mind-customise-linet").off().on("click",function(){var j=$(this);$("#mind-customise-linet-list").dropdown({target:j,onSelect:function(l){var k=l.attr("tp"),m=l.text();j.children("span").text(m);if(mindUI.customiseTheme[g]["lineStyle"]==null){mindUI.customiseTheme[g]["lineStyle"]={}}mindUI.customiseTheme[g]["lineStyle"]["lineType"]=k;j.removeClass("selected")},onClose:function(){j.removeClass("selected")}})});$("#mind-customise-linew").off().on("click",function(){var j=$(this);$("#mind-customise-linew-list").dropdown({target:j,onSelect:function(l){var k=l.attr("tp");j.children("span").text(k+"px");if(mindUI.customiseTheme[g]["lineStyle"]==null){mindUI.customiseTheme[g]["lineStyle"]={}}mindUI.customiseTheme[g]["lineStyle"]["lineWidth"]=k;j.removeClass("selected");document.getElementById("previewLine").querySelector("path").setAttributeNS("","stroke-width",k)},onClose:function(){j.removeClass("selected")}})});$("#mind-customise-bs1").off().on("click",function(){b("0px");$("#mind-customise-bs1").addClass("selected");$("#mind-customise-bs2").removeClass("selected");$("#mind-customise-bs3").removeClass("selected")});$("#mind-customise-bs2").off().on("click",function(){b("5px");$("#mind-customise-bs2").addClass("selected");$("#mind-customise-bs1").removeClass("selected");$("#mind-customise-bs3").removeClass("selected")});$("#mind-customise-bs3").off().on("click",function(){$("#mind-customise-bs3").addClass("selected");$("#mind-customise-bs2").removeClass("selected");$("#mind-customise-bs1").removeClass("selected");b("30px")});$("#mind-customise-fill").off().on("click",function(){var k=$(this);var j=k.find(".color_line").css("background-color");a(j,k,function(l){mindUI.customiseTheme[g]["backgroundColor"]=l;mindUI.renderTopic(g)})});$("#mind-customise-sd").off("").on("click",function(){var j=$(this),k="none";if(j.hasClass("selected")){j.removeClass("selected")}else{k="1px 2px 6px #aaa";j.addClass("selected")}h(k)});mindUI.renderTopic();function b(j){mindUI.customiseTheme[g]["border-radius"]=j;mindUI.renderTopic(g)}function h(j){if(j=="none"){delete mindUI.customiseTheme[g]["box-shadow"]}else{mindUI.customiseTheme[g]["box-shadow"]=j}mindUI.renderTopic(g)}function c(){if(g=="centerTopic"){}}function a(j,l,m){var k=mind.util.getHexColor(j);$.colorpicker({target:l,color:j,onSelect:function(n){if(n==null){if(m!=null){m("transparent")}}else{l.find(".color_line").css("background-color",n);if(m!=null){m(n)}}l.removeClass("selected")},onClose:function(){l.removeClass("selected")}});$("#color-hex-value").val(k.hex)}$("input[name=mind_upload_bg_file]").off("change").on("change",function(k){var j=this.files[0].type;if($.trim($(this).val())==""){return}if(j.indexOf("image")>=0){Util.globalTopTip("","top_error",6000,$(".mind-theme-customise-dlg"),true);$("#upload_mind_img_bg").submitForm({success:function(l){if(l.result=="size_wrong"){Util.globalTopTip("图片大小不能超过500k","top_error",1000,$(".mind-theme-customise-dlg"),true);return}if(l.result=="type_wrong"){Util.globalTopTip("只能上传图片格式","top_error",1000,$(".mind-theme-customise-dlg"),true);return}if(l.img_url==null){Util.globalTopTip("上传失败","top_error",1000,$(".mind-theme-customise-dlg"),true);return}if(l.img_url!=""){var m=new Image();m.src=l.img_url;m.onload=function(){$(".mind-customise-prev").css("background","url("+l.img_url+")");mindUI.customiseTheme.background="url("+l.img_url+")";Util.globalTopTip("close")}}},error:function(){Util.globalTopTip("close")}})}else{Util.globalTopTip("只支持图片格式，请重新选择","top_error",1500,$(".mind-theme-customise-dlg"),true)}})},customiseTheme:null,editCustomiseId:null,renderTopic:function(e){if(mindUI.customiseTheme==null){mindUI.customiseTheme=mind.util.copy(mind.style.themes.theme3)}var c={},a=mindUI.customiseTheme,d=$("#previewTopic");if(e=="centerTopic"||e==null){c=a.centerTopic}else{if(e=="secTopic"){c=a.secTopic}else{if(e=="childTopic"){c=a.childTopic}else{if(e=="freeTopic"){if(a.freeTopic){c=a.freeTopic}else{c=a.secTopic}}}}}c=$.extend(c,a.common);c["font-family"]=c.family;c["font-weight"]=c.bold?"bold":"normal";c["font-style"]=c.italic?"italic":"normal";delete c.family;delete c.bold;delete c.italic;d.removeAttr("style");d.css(c);var b=(e=="secTopic"?"分支主题":e=="childTopic"?"子主题":"中心主题");d.text(b);$("#mind-customise-topic").children("span").text(b);$(".mind-theme-customise-dlg").find(".color_line").removeAttr("style");$(".mind-customise-prev").css("background",a.background);mindUI.initStyles(c)},initStyles:function(d){var f=$("#previewTopic");$("#mind-customise-font").children("span").text(d.family);$("#mind-customise-size").children("input").val(d["font-size"]);if(d.padding!=null){var h=d.padding.split(" ");if(h.length==1){h[1]=h[0];h[2]=h[0];h[3]=h[0]}else{if(h.length==2){h[2]=h[0];h[3]=h[1]}else{if(h.length==3){h[3]=h[1]}}}$("#mind-customise-paddingt").children("input").val(h[0]);$("#mind-customise-paddingr").children("input").val(h[1]);$("#mind-customise-paddingb").children("input").val(h[2]);$("#mind-customise-paddingl").children("input").val(h[3])}if(d.lineStyle!=null){var a=d.lineStyle.lineColor,b=d.lineStyle.lineWidth,c=d.lineStyle.lineType;var k=(c=="curv"||c=="curve")?"曲线":c=="straight"?"直线":c=="roundBroken"?"圆角折线":"折线";var j=document.getElementById("previewLine").querySelector("path");j.setAttributeNS("","stroke",a);j.setAttributeNS("","stroke-width",b);$("#mind-customise-linew").children("span").text(b+"px");$("#mind-customise-linec").find(".color_line").css("background",a);$("#mind-customise-linet").children("span").text(k)}if(d["font-wdith"]=="bold"){$("#mind-customise-b").addClass("selected")}if(d["font-style"]=="italic"){$("#mind-customise-i").addClass("selected")}$("#mind-customise-color").find(".color_line").css("background",d.color);$("#mind-customise-bs1,#mind-customise-bs2,#mind-customise-bs3").removeClass("selected");if(d["border-radius"]!=null){var i=d["border-radius"].replace("px","");if(Number(i)<1){$("#mind-customise-bs1").addClass("selected")}else{if(Number(i)<10){$("#mind-customise-bs2").addClass("selected")}else{if(Number(i)>10){$("#mind-customise-bs3").addClass("selected")}}}}if((d.border==null&&d["border-width"]==null)||d["border-width"]==0){$("#mind-customise-bw").children("span").text("无");$(".customise-bdstyle").find(".mind-color-box").addClass("mind-disable")}else{if(d["border-width"]!=null){$("#mind-customise-bw").children("span").text(d["border-width"]);$(".customise-bdstyle").find(".mind-color-box").removeClass("mind-disable");$("#mind-customise-bc").find(".color_line").css("background",d["border-color"])}else{var g=f.css("border-width"),e=f.css("border-color");if(g!=null){$("#mind-customise-bw").children("span").text(g);$("#mind-customise-bc").find(".color_line").css("background",e);$(".customise-bdstyle").find(".mind-color-box").removeClass("mind-disable")}}}if(d["box-shadow"]!=null){$("#mind-customise-sd").addClass("selected")}else{$("#mind-customise-sd").removeClass("selected")}$("#mind-customise-fill").find(".color_line").css("background",d.backgroundColor)},removeFromArray:function(c,b){var a=c.indexOf(b);if(a>=0){c.splice(a,1)}return c},isOperated:false,isSaving:false,getChart:function(c){if(chartId==""||chartId==null){return}$.ajax({url:"/mindmap/getchart",type:"post",data:{id:chartId},success:function(d){if(c!=null){c(d)}},error:function(){}});var b=$("#btnsave").children(),a=0;b.addClass("rotate1").css("color","rgb(80, 194, 139)");setTimeout(function(){b.removeClass("rotate1").css("color","#666")},1000)},createNew:function(a){a=a||"new";if((mindUI.member||mindUI.usedFileCount<mindUI.fileCount)&&a=="new"){window.location.href="/mindmap/new?category=mind_right&status=private&team="+teamId+"&org="+orgId;return}if((mindUI.member||mindUI.usedFileCount<mindUI.fileCount)&&a=="clone"){window.location.href="/mindmap/new?template="+chartId+"&chart_title"+document.title+"&team="+teamId+"&org="+orgId;return}$("#mind-fileover-dlg").dialog()},outlineEdit:function(){window.location.href="/outline/"+chartId},openFile:function(b){if(chartId==b){return}$.loading();chartId=b;mind.operation.clearCanvas.call(mind);mind.model.groupList.clearData();mind=null;mind=new mindDesigner("#mind_con",{chartId:chartId},null);var a=$(".mind-title-menu");mindUI.closeMenu(a);mindUI.loadHistorys()},saveFeedBack:function(b){var a=$.trim($("#feedback_message").val());if(a==""||a.length>1500){$("#feedback_message").val("").focus();return}$.ajax({url:"/support/save_ask",data:{content:a,url:location.href},success:function(c){if(b!=null){b()}}})},opening:false,showMenu:function(b,c,d){if(mindUI.opening){return}mindUI.opening=true;$(".mind-dropdown").removeClass("visible").hide();if(b.hasClass("active")){this.closeMenu();return}c.css("display","block");$(".header-item.active").removeClass("active");b.addClass("active");var a=b.offset().left+(b.outerWidth()-c.outerWidth())/2;if(a+c.width()>$(window).width()){a=$(window).width()-c.width()-17}c.addClass("visible");c.css({left:a,top:b.outerHeight()+17,zIndex:9});if(d!=null){d()}setTimeout(function(){mindUI.opening=false},300)},closeMenu:function(b){$(".mind-dropdown").removeClass("visible");$(".header-item.active").removeClass("active");setTimeout(function(){$(".mind-dropdown").css("z-index",-1);mindUI.opening=false},300);var a=document.activeElement;if(a!=null&&$(a).length>0){if($(a).hasClass("mind-topic-remark")){$(a).trigger("blur")}}},loadThemes:function(e){if(e==null){return}var a=e.style.themes;var b=$("#mind-themes");var d=["<ul>"];$.each(a,function(f,i){var h="";if(i.show==false){return true}if(i.member){h+='<img class="theme_vip" src="/assets/images/po_theme_vip.svg" />'}if(i.newTheme){h+='<img class="theme_new" src="/assets/images/po_theme_new.svg" />'}var g="<li><div tit='"+f+"'><img src='"+i.thumbUrl+"'/></div>"+h+"</li>";d.push(g)});d.push("</ul>");b.prepend(d.join(""));var c=e.model.topic.theme;if(c&&$("div[tit="+c+"]").length){$("div[tit="+c+"]").parent().addClass("selected")}$("#mind-themes").find("div[tit]").off("click").on("click",function(j){var i=$(this);var h=i.attr("tit");if(i.parent().hasClass("selected")){return}if(i.parent().find(".member-tip").length>0){if(!mindUI.member){$.showTip("当前主题风格只有会员才能使用，点击<a style='color:#fff;text-decoration:underline;' href='/upgrade?pos=5_3' target='_blank'>查看会员特权</a>",5500);mindUI.closeMenu();j.stopPropagation();return}}var f=e.model.topic;$("#mind-themes").find("li").removeClass("selected");e.style.setTheme.call(e,h,waterMark);var g=e.model.topic.theme;$("#mind-themes").find("div[tit="+g+"]").parent().addClass("selected");mindUI.closeMenu();poCollect("更改主题风格",{"页面名称":"思维导图编辑器","会员状态":mindUI.member?"会员":"非会员","页面来源":"官网项目"});j.stopPropagation()})},htmlEncode:function(b){var a="";if(b.length==0){return""}a=b.replace(/&/g,"&amp;");a=a.replace(/</g,"&lt;");a=a.replace(/>/g,"&gt;");a=a.replace(/ /g,"&nbsp;");a=a.replace(/\'/g,"&#39;");a=a.replace(/\"/g,"&quot;");return a},htmlDecode:function(b){var a="";if(b.length==0){return""}a=b.replace(/&amp;/g,"&");a=a.replace(/&lt;/g,"<");a=a.replace(/&gt;/g,">");a=a.replace(/&nbsp;/g," ");a=a.replace(/&#39;/g,"'");a=a.replace(/&quot;/g,'"');return a},showProcess:function(){var a=$("<div id='top-tip-uploading'></div>").appendTo("body")},initStyleEvent:function(){$(".pre-topic").off("click").on("click",function(){var h=$(this);var f=h.css("background-color");var b=h.css("color");var c=h.css("border-width");var a=h.css("border-color");var e=h.css("border-style");var g=h.css("border-radius");var d={"background-color":f,color:b,"border-radius":g};delete d.border;d["border-style"]=e;d["border-color"]=a;d["border-width"]=c;mind.operation.setStyle.call(mind,d)})},showUploading:function(){var a=$("<div class='mind-upload-tip'><span class='mind-icons rotate1'>&#xe65b;</span> <span>正在上传中......</span></div>");a.appendTo("body");a.css({top:60}).show()},hideUploading:function(){$(".mind-upload-tip").remove()},showWeixin:function(a){$.ajax({url:"/view/getlink",data:{chartId:chartId},success:function(e){if(e.viewLinkId!=""){var c="",b="";if($(".share-to-weixin").length<1){b=$("<div class='weixin-img-mask'><div class='share-to-weixin'></div></div>").appendTo("body");c=$(".share-to-weixin");$(".weixin-img-mask").css({position:"absolute",width:"100%",height:"100%",left:"0",top:"0",zIndex:99999});c.css({position:"absolute",width:200,height:216,left:"50%",top:"40%",marginLeft:-100,marginTop:-100,textAlign:"center",zIndex:9999999,border:"1px solid #ccc",background:"#fff",boxShadow:"1px 1px 12px #bbb"});var d=new QRCode(c[0],{width:180,height:180});c.find("img").css({width:"180px",height:"180px",marginTop:10,marginLeft:10}).after("<div>微信扫一扫 分享</div>");d.makeCode(e.viewLinkId)}b=$(".weixin-img-mask");b.off("mousedown.weixin").on("mousedown.weixin",function(f){f.stopPropagation();$("#mind_hover_tip").hide();b.remove()})}}})},insertUserImage:function(b){var a="";if(typeof b=="string"){a=b}else{a=b.userImage.fileId}var c=new Image();c.src=a;c.onload=function(){mind.operation.setTopicImage.call(mind,null,a,c);mindUI.hideUploading();$(".mind-image-dlg").dialog("close")}},uploadFile:function(e){if(!mindUI.member){return}$("#upload_form").remove();function d(j,k,i,l){var m=document.createElement(j);m.setAttribute("name",i);m.setAttribute("type",k);if(l!=null){m.setAttribute("value",l)}return m}var f=document.createElement("form");var c=d("input","file","upload_input_file");var b=d("input","hidden","upload_input_chartid",chartId);var a=d("input","hidden","upload_input_topic",e);var h=d("input","hidden","teamId",teamId||"");var g=d("input","hidden","orgId",orgId||"");f.setAttribute("id","upload_form");f.setAttribute("action","/mindmap/upload_atta");f.setAttribute("method","post");f.setAttribute("enctype","multipart/form-data");f.appendChild(c);f.appendChild(b);f.appendChild(a);f.appendChild(h);f.appendChild(g);document.body.appendChild(f);$("input[name=upload_input_file]").off("change").on("change",function(k){var j=this.files[0].type;if($.trim($(this).val())==""){return}try{var i=0;i=c.files[0].size;i=i/1024;i=i/1024}catch(k){i=100}if(i>5){$.showTip("上传图片大小不能超过5M",1500);return}mindUI.showUploading();$("#upload_form").submitForm({success:function(m){if(m.result=="size_wrong"){mindUI.hideUploading();$(c).val("");$.showTip("上传图片大小不能超过5M",1500);$(f).remove();return}if(m.file_url!=""){mindUI.hideUploading();var l={value:m.file_url,title:m.file_name,type:"file"};$.showTip("附件上传成功",1500);$(c).val("");mind.operation.setLink.call(mind,l,null,"file");$(f).remove();mind.util.selectById.call(mind,e)}},error:function(l){mindUI.hideUploading();$(f).remove()}})});$(c).trigger("click")},loadUserImages:function(a){var b=$(".upload-imgs");if(b.attr("loaded")&&a==null){return}$("#insertUserImage").hide();b.empty();$.ajax({url:"/user_image/list?type=mind",success:function(e){if(e.images&&e.images.length>0){for(var d=0;d<e.images.length;d++){var c=e.images[d];mindUI.appendUserImage(c)}b.append("<div style='clear: both'></div>");$("#insertUserImage").show()}else{b.append("<div style='text-align:center;width:100%;'><img style='display:inline-block;width:110px;' src='/assets/images/icon/empty_picture.svg'/><div>还没有使用过图片，可以点击上传</div><br></div>");$("#insertUserImage").hide()}}});b.attr("loaded","true");$("#insertUserImage").off().on("click",function(){var d=$(".upload-imgs").children(".image_item_selected");if(d.length>0){var c=d.attr("fileid");mindUI.insertUserImage(c)}})},appendUserImage:function(b){var c=$("<div class='upload-img' id='"+b.imageId+"' fileId='"+b.fileId+"'></div>").appendTo($(".upload-imgs"));var a="/file/id/"+b.fileId+"/diagram_user_image";if(b.fileId!=null&&b.fileId.indexOf("http")>=0){a=b.fileId;if(a.indexOf("orgu2a928.bkt.clouddn.com")>=0){a=a.replace("orgu2a928.bkt.clouddn.com","cdn2.processon.com")}else{if(a.indexOf("7xt9nt.com1.z0.glb.clouddn.com")>=0){a=a.replace("7xt9nt.com1.z0.glb.clouddn.com","cdn.processon.com")}else{if(a.indexOf("p7o7ul1nf.bkt.clouddn.com")>=0){a=a.replace("p7o7ul1nf.bkt.clouddn.com","cdn1.processon.com")}}}}var d=$("<div class='image_box'><img src='"+a+"'/></div>").appendTo(c);c.off().on("click",function(){$(".image_item_selected").removeClass("image_item_selected");$(this).addClass("image_item_selected");$(".mind-image-detail > [tit=history]").find(".mind-disable1").removeClass("mind-disable1")}).on("mouseenter",function(){var f=$(this);var e=$("<div title='删除图片' class='remove_icons'><span class='mind-icons'>&#xe630;</span></div>").appendTo(f);var g=f.attr("id");e.on("click",function(){f.fadeOut();$.ajax({url:"/user_image/remove",data:{imageId:g},success:function(){f.remove();if($("#history-list").find("img").length==0){$("#history-list").html("<div style='text-align:center;margin-top:65px;color:#a0a0a0;margin:0 auto;'><span style='font-size:80px;' class='mind-icons'>&#xe663;</span><br><br>还没有使用过图片，可以点击上传</div>");$("#insertUserImage").hide()}}})})}).on("mouseleave",function(){$(this).find(".remove_icons").remove()})},searchImages:function(a){var d=1;function c(f){b(f,function(g){if(g!=null){var h=g.pages;e(h)}})}function b(f,g){$.getJSON("https://iconsapi.com/api/search?appkey=5eed8a83e4b0b8982239fcab&page="+d+"&size=6&query="+f,function(h){if(g!=null){g(h)}})}function e(m){var g=$("#search-img-con");g.empty();m=m.elements;var h="";for(var l=0,f=m.length;l<f;l++){var j=m[l];if(j==null||j.url==null){continue}h+='<img msrc="'+(j.url)+'" alt="'+j.iconName+'" src="'+j.url+'" />'}g.html(h);if($("#image-search-btn").text()==""){var k="<div class='page-btn'><span class='text-tip'>点击图片，可直接插入</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class='mind-icons'>&#xe66a;</span><span class='mind-icons'>&#xe66b;</span></div>";$("#image-search-btn").html(k)}g.children("img").off().on("click",function(){var i=$(this).attr("msrc");mindUI.insertUserImage(i)});$(".page-btn").children(".mind-icons").off().on("click",function(n){var i=$(this);if(i.index()==2){d++}else{if(i.index()==1){d--;if(d<0){d=1}}}c(a)})}c(a)},exportFileFn:function(b){mindUI.exportFile.errorNum=0;mindUI.exportFile.errorUrls=[];mindUI.exportFile.proUrlObj={};mindUI.exportFile._errorUrls=[];$("#export_type").val(b);$("#export_title").val($(".header-item > .title:first").text());if(b=="svg"||b=="pnghd"||b=="pdfHD"||b=="image"||b=="jpg"){if(mind.operation.zoomVal!=100){mind.operation.zoomVal=100;$(".mind-zoomtxt").text(100);$(".mind-designer").css({transform:"scale(1)","-webkit-transform":"scale(1)","-moz-transform":"scale(1)"})}var m=navigator.userAgent,c=m.indexOf("MSIE ")>-1||m.indexOf("Trident/")>-1;var e=[];var j=$(".topic-box .topic .equation-text");if(j.length>9){Util.globalTopTip("当前公式过多，支持无力orz，请先截图使用，努力优化中～","top_error",5000,$(".mind-background-img-dlg"),true);return}j.each(function(o,r){$(r).css({transform:"scale(3)"}).addClass("eq-block");var q=$(r).find("svg"),p=r.getBoundingClientRect();q.attr("width",p.width);q.attr("height",p.height);var n=html2canvas(r,{useCORS:true,backgroundColor:"transparent",scale:1,scrollY:0,width:p.width,height:p.height+3}).then(function(s){var t=s.toDataURL("image/png");var u=t;if(u.indexOf("processon.com")>-1){u=u.replace("http://","https://")}$(r).attr("img-src",u)});$(r).removeAttr("style");e.push(n)});Promise.all(e).then(function(){if(c){h()}else{d()}});function h(){if(b=="pnghd"||b=="svg"||b=="pdfHD"){setTimeout(function(){MindToSvg.init(function(t,r){if(b=="pnghd"&&(t*r>81000000)){$.showTip("文件内容超出高清PNG下载限制",3000);return}var s=$("#svg-wrap"),u='<?xml version="1.0" standalone="no"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">'+s.html().replace(/&nbsp;/g,"\u00a0");$("#export_width").val(t);$("#export_height").val(r);$("#export_definition").val(u.replace(/&nbsp;/g,"\u00a0"));$("#export_form").submit();setTimeout(function(){MindToSvg.container.innerHTML=""},10000)},null,null,mindUI.exportFile.partId)},300)}else{var o=JSON.stringify(mind.model.topic);if(mind.currentRoot!=null){var q=mind.currentRoot.id;var p=mind.model.getTopicById(q);var n=p.structure;delete p.root;delete p.structure;o=JSON.stringify(mind.model.topic);p.root=true;p.structure=n}$("#export_definition").val(o);$("#export_form").submit()}}function d(){setTimeout(function(){var o=mind.style.getThemeStyle.call(mind,null);if(mind.opts.themeDef&&(mind.opts.themeDef!=undefined)&&(mind.opts.themeDef.background!=undefined)){var p=mind.opts.themeDef.background}else{var p=o.background}if(p.indexOf("url")>-1){var n=document.createElement("img");n.onload=function(){var q=this.width,r=this.height;n.remove();MindToSvg.init(function(u,s){if(b=="pnghd"&&(u*s>81000000)){$.showTip("文件内容超出高清PNG下载限制",3000);return}var t=$("#svg-wrap"),v='<?xml version="1.0" standalone="no"?><?xml-stylesheet type="text/css" href="https://www.processon.com/themes/default/mind/icons/icons.css" ?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">'+t.html().replace(/&nbsp;/g,"\u00a0");$("#export_width").val(u);$("#export_height").val(s);if(b=="svg"||b=="pdfHD"){$("#export_definition").val(v.replace(/&nbsp;/g,"\u00a0").replace(/NS[0-9]+:href/g,"xlink:href"));$("#export_form").submit()}else{l(v,u,s)}},q,r,mindUI.exportFile.partId)};n.src=p.replace("url(","").replace(")","")}else{MindToSvg.init(function(s,q){if(b=="pnghd"&&(s*q>81000000)){$.showTip("文件内容超出高清PNG下载限制",3000);return}var r=$("#svg-wrap"),t='<?xml version="1.0" standalone="no"?><?xml-stylesheet type="text/css" href="https://www.processon.com/themes/default/mind/icons/icons.css" ?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">'+r.html().replace(/&nbsp;/g,"\u00a0");$("#export_width").val(s);$("#export_height").val(q);if(b=="svg"||b=="pdfHD"){$("#export_definition").val(t.replace(/&nbsp;/g,"\u00a0").replace(/NS[0-9]+:href/g,"xlink:href"));$("#export_form").submit()}else{l(t,s,q)}},null,null,mindUI.exportFile.partId)}},300)}function l(r,p,n){r=r.replace(/&nbsp;/g,"\u00a0").replace(/NS[0-9]+:href/g,"xlink:href");var q=1;if(b=="pnghd"){q=2}else{q=1}$("#svg-wrap").html('<canvas id="canvas_exporter" width="'+p*q+'" height="'+n*q+'"></canvas>');canvg("canvas_exporter",r.replace(/\u00a0/g,"<tspan>\u00a0</tspan>"),{log:true,ignoreDimensions:true,enableRedraw:true,ignoreClear:true,forceRedraw:true,useCORS:true,forceRedraw:true,scaleWidth:p*q,scaleHeight:n*q,renderCallback:function(){if(mindUI.exportFile.errorNum>0){mindUI.exportFile.replaceErrorUrl();console.log("跨域图片处理");return}var t=document.getElementById("canvas_exporter");if(b=="jpg"){var u=t.toDataURL();var w=$(".header-item > .title:first").text()||"未命名文件";var v="jpg"}else{var u=t.toDataURL();var w=$(".header-item > .title:first").text()||"未命名文件";var v="png"}s(URL.createObjectURL(o(u)),w+"."+v);$("#svg-wrap").remove()}});function o(w){var v=atob(w.split(",")[1]),u=v.length,t=new Uint8Array(u);for(var x=0;x<u;x++){t[x]=v.charCodeAt(x)}return new Blob([t],{type:"image/png"})}function s(v,w){var u=new MouseEvent("click",{view:window,bubbles:false,cancelable:true});var t=document.createElement("a");t.setAttribute("download",w);t.setAttribute("href",v);t.setAttribute("target","_blank");t.dispatchEvent(u)}}}else{if(b=="ppt"){if(typeof outlineToPpt=="undefined"){var f={js:["/assets/js/mind.convert.ppt.js"],css:["/assets/css/mind.convert.ppt.css"]};bigPipe.render(f,function(){outlineToPpt.init()})}else{outlineToPpt.init()}}else{var a=JSON.stringify(mind.model.topic);if(mind.currentRoot!=null){var i=mind.currentRoot.id;var k=mind.model.getTopicById(i);var g=k.structure;delete k.root;delete k.structure;a=JSON.stringify(mind.model.topic);k.root=true;k.structure=g}$("#export_definition").val(a);$("#export_form").submit()}}$("#btn-download").addClass("mind-disable");setTimeout(function(){$("#export_definition").val("")},1000)},exportFile:{partId:null,errorNum:0,errorUrls:[],proUrlObj:{},_errorUrls:[],exportError:function(a){if(this.errorUrls.indexOf(a)<0){this.errorUrls.push(a);this.errorNum++}},replaceErrorUrl:function(){var b=this;var a=b.errorUrls.map(function(c){return encodeURIComponent(c)});$.ajax({url:"/chart_cors/process_cors_image",data:{urls:a.join(",")},type:"post",success:function(h){var j=h.proUrls,c=j.length;for(var g=0;g<c;g++){b.proUrlObj[b.errorUrls[g]]=j[g];if(!j[g]){b._errorUrls.push(b.errorUrls[g])}}for(key in mind.model.topicList.data){var e=mind.model.topicList.data[key].image;if(e&&e.url){for(proUrlsKey in b.proUrlObj){var f=e.url.replace(/^(http|https):\/\//,"");if(proUrlsKey.indexOf(f)!=-1){e.url=b.proUrlObj[proUrlsKey];var d="#topic_img_"+key;$(d).attr("src",b.proUrlObj[proUrlsKey])}}}}mindColla.doSync(chartId);$("#svg-wrap").remove();if(b._errorUrls.length){b.exportErrorTip(b._errorUrls[0])}else{$("#btn-download").trigger("click")}}})},exportErrorTip:function(b){var a=$("html");if($("#export_dialog").length>0){a=$("#export_dialog")}else{if($(".mind-download-dlg").length>0){a=$(".mind-download-dlg")}}Util.globalTopTip('下载失败，文件中存在不授信或者失效的图片,<br>请检查后重试，<a target="_blank" href="'+b+'">点击查看</a>',"top_error",8000,a,true);console.log(b)}},zhuge:function(a,b){try{if(!a||typeof b!="object"){return}else{zhuge.track(a,b)}}catch(c){}}};var backgroundImage={data:{img:{W:20,H:20,X:0,Y:0,opacity:100},content:{W:0,H:0,X:0,Y:0},repeat:"repeat",lock:0,url:"",imgBaes64:"",view:{scrollLeft:0,scrollTop:0,centerX:0,centerY:0,scale:1},iframeLoaded:false,drawImg:false,coverData:""},init:function(){var d=this,j=$("#background-set-iframe"),f=$("#background-img-center"),e=$(".mind-background-img-dlg .change-box"),h=e.find(".lock-box"),g=e.find("input[type=text]"),c=e.find(".number-group:not(.select-group) .mind-icons"),i=e.find(".select-group"),b=i.find("ul"),a=$(".mind-background-img-dlg .sub-group .submit");$(".mind-background-img-dlg").off("click").on("click",".mind-button.gray",function(){$(".mind-background-img-dlg").dialog("close")});$(".mind-background-img-dlg").off("mousedown").on("mousedown",function(k){k.stopPropagation()});this.cleanData();this.data.iframeLoaded=false;j.attr("src","/embed/"+chartId);j.get(0).onload=function(){backgroundImage.computeSize()};f.off("clikc").on("click",function(){d.centerView()});g.off("change").on("change",function(){d.setVal(this,$(this).val())});c.off("click").on("click",function(){var m=$(this).parents(".number-group").find("input[type=text]");var k=$(this).index();var l=parseInt(m.val());if(k){d.setVal(m,l-5)}else{d.setVal(m,l+5)}});i.off("click").on("click",function(){$(this).find("ul").slideToggle(200)});b.off("click").on("click","li",function(){if($(this).hasClass("checked")){return}if($(this).attr("data-val")=="cover"||d.data.repeat=="cover"){d.data.drawImg=true}d.data.repeat=$(this).attr("data-val");$(this).parent().siblings(".checked-title").text($(this).text());$(this).addClass("checked").siblings().removeClass("checked");switch(d.data.repeat){case"cover":var k={W:0,H:0,X:0,Y:0};if(d.data.content.W/d.data.content.H>d.data.lock){k.W=d.data.content.W;k.H=parseInt(d.data.content.W/d.data.lock);k.Y=parseInt((d.data.content.H-k.H)/2)}else{k.H=d.data.content.H;k.W=parseInt(d.data.content.H*d.data.lock);k.X=parseInt((d.data.content.W-k.W)/2)}d.data.coverData=k;d.disChange(["W","H","X","Y"],true);break;default:d.data.coverData="";d.disChange(["W","H","X","Y"],false)}d.backgroundImageShow()});$(".background-img-upload").off("change").on("change",function(){d.cleanData();var l=this.files[0];$(this).val("");if(!/image\/\w+/.test(l.type)){Util.globalTopTip("只能上传图片格式","top_error",2000,$(".mind-background-img-dlg"));return false}if(l.size>1024*1024*2){Util.globalTopTip("图片大小不能超过2M","top_error",2000,$(".mind-background-img-dlg"));return false}$(".mind-background-img-dlg .left .img-upload").hide();var k=new FileReader();k.readAsDataURL(l);k.onload=function(m){d.data.imgBaes64=this.result;d.data.url=this.result;d.imgData(this.result)}});a.off("click").on("click",function(){if($(this).hasClass("mind-disable1")){return}if(d.data.url&&d.data.iframeLoaded){$(this).addClass("mind-disable1");if(d.data.drawImg){d.drawToCanvas(true)}else{d.uploadImg()}}else{Util.globalTopTip("请上传图片","top_error",2000,$(".mind-background-img-dlg"))}})},cleanData:function(){var b=this;$(".mind-background-img-dlg .right").addClass("disabled");$(".mind-background-img-dlg .sub-group .submit").removeClass("mind-disable1");$(".mind-background-img-dlg .left .img-upload").css({display:"flex"});$(".mind-background-img-dlg .left .iframe-loading").css({display:"flex"});$(".mind-background-img-dlg .left .change").hide();$(".mind-background-img-dlg .number-group input").val("");$(".mind-background-img-dlg .number-group input[data-name=opacity]").val("100%");var a=$(".mind-background-img-dlg .select-group ul li[data-val=repeat]");a.parent().siblings(".checked-title").text(a.text());a.addClass("checked").siblings().removeClass("checked");b.disChange(["W","H","X","Y"],false);b.data.lock=0;b.data.url="";b.data.imgBaes64="";b.data.repeat=a.attr("data-val");b.data.img.opacity=100;b.data.drawImg=false;b.data.coverData=""},imgData:function(b){var c=this;if(!this.data.iframeLoaded){setTimeout(function(){c.imgData(b)},1000);return}var a=new Image;a.src=b;a.onload=function(){c.nameToSetVal("W",a.width);c.nameToSetVal("H",a.height);c.nameToSetVal("X",0);c.nameToSetVal("Y",0);c.data.lock=a.width/a.height;$(".mind-background-img-dlg .right").removeClass("disabled");c.backgroundImageShow();$(".mind-background-img-dlg .left .iframe-loading").hide();$(".mind-background-img-dlg .left .change").css({display:"block"})}},nameToSetVal:function(a,c){var b=".mind-background-img-dlg .number-group input[data-name="+a+"]";this.setVal(b,c,true)},setVal:function(e,c,a){var b=$(e).attr("data-name"),f=$(e).attr("min-number")||"",h=$(e).attr("max-number")||"",j=$(e).attr("unit")||"",k=this.data.lock;var i=parseInt(c);if(isNaN(i)){i=this.data.img[b]}else{if(f&&i<f){i=parseInt(f);Util.globalTopTip("最小值为"+f+""+j,"top_error",2000,$(".mind-background-img-dlg"))}if(h&&i>h){i=parseInt(h);Util.globalTopTip("最大值为"+h+""+j,"top_error",2000,$(".mind-background-img-dlg"))}}if(k){if(b=="W"){var d=Math.round(i/k);if(f&&d<f){d=f}if(h&&d>h){d=h}this.data.img.H=d;$(".mind-background-img-dlg .number-group input[data-name=H]").val(d+""+j)}else{if(b=="H"){var g=Math.round(i*k);if(f&&g<f){g=f}if(h&&g>h){g=h}this.data.img.W=g;$(".mind-background-img-dlg .number-group input[data-name=W]").val(g+""+j)}}}this.data.img[b]=i;$(e).val(i+""+j);if(b=="W"||b=="H"){this.data.drawImg=true}if(a){return}if(b=="opacity"){this.drawToCanvas();return}this.backgroundImageShow()},drawToCanvas:function(b){var d=this;var c=$("#canvas-opacity")[0];var a=new Image;a.src=d.data.imgBaes64;a.onload=function(){c.width=d.data.img.W;c.height=d.data.img.H;var e=c.getContext("2d");e.clearRect(0,0,c.width,c.height);e.globalAlpha=d.data.img.opacity/100;e.drawImage(a,0,0,d.data.img.W,d.data.img.H);d.data.url=c.toDataURL();d.data.drawImg=false;if(b){d.uploadImg()}else{d.backgroundImageShow()}}},base64ToBlob:function(c){var e;if(c.split(",")[0].indexOf("base64")>=0){e=atob(c.split(",")[1])}else{e=unescape(c.split(",")[1])}var a=c.split(",")[0].split(":")[1].split(";")[0];var b=new Uint8Array(e.length);for(var d=0;d<e.length;d++){b[d]=e.charCodeAt(d)}return new Blob([b],{type:a})},showSize:function(c){var g=c.replace("data:image/png;base64,","");var e=g.indexOf("=");if(g.indexOf("=")>0){g=g.substring(0,e)}var b=g.length;var h=parseInt(b-(b/8)*2);var i="";i=(h/1024).toFixed(2);var d=i+"";var f=d.indexOf(".");var a=d.substr(f+1,2);if(a=="00"){return d.substring(0,f)+d.substr(f+3,2)}return i},backgroundImageShow:function(d){var c=$("#background-set-iframe").contents().find(".mind-designer"),f=this.data,b=f.coverData?f.coverData:this.data.img,e=f.repeat=="cover"?"no-repeat":f.repeat;var a="url("+f.url+") "+(b.X+f.content.X)+"px "+(b.Y+f.content.Y)+"px / "+b.W+"px "+b.H+"px "+e;if(d){mind.operation.setBackground.call(mind,a,true);$(".mind-background-img-dlg").dialog("close");this.cleanData();$("#background-set-iframe").attr("src","")}else{c.css({background:a})}},uploadImg:function(){var d=this;var b=this.showSize(d.data.url);console.log("转化后的图片大小:",b);if(b/1024>10||b==0){Util.globalTopTip("图片大小不能超过2M","top_error",2000,$(".mind-background-img-dlg"));$(".mind-background-img-dlg .sub-group .submit").removeClass("mind-disable1");return}var c=new FormData();var a=d.base64ToBlob(d.data.url);c.append("mind_upload_bg_file",a);$.ajax({url:"/mindmap/upload_img_bg",type:"post",data:c,processData:false,contentType:false,success:function(e){$(".mind-background-img-dlg .sub-group .submit").removeClass("mind-disable1");if(e.result=="size_wrong"){Util.globalTopTip("图片大小不能超过2M","top_error",2000,$(".mind-background-img-dlg"));return}if(e.result=="type_wrong"){Util.globalTopTip("只能上传图片格式","top_error",2000,$(".mind-background-img-dlg"));return}if(e.img_url==null){Util.globalTopTip("上传失败","top_error",2000,$(".mind-background-img-dlg"));return}if(e.img_url!=""){d.data.url=e.img_url;d.backgroundImageShow(true)}},error:function(){$(".mind-background-img-dlg .sub-group .submit").removeClass("mind-disable1")}})},disChange:function(b,a){if(b&&b.length){b.map(function(c){var d=$(".mind-background-img-dlg .number-group input[data-name="+c+"]").parent();if(a){d.addClass("disabled")}else{d.removeClass("disabled")}})}},computeSize:function(){if($(".mind-background-img-dlg").is(":hidden")){return}$("#background-set-iframe").contents().find(".embed_title, .embed_resize, .mind-canvas-con").hide();var j=this;var i=null;var g=null;var b=null;var a=null;var h=0;var n=0;var e=0;var k=0;$("#background-set-iframe").contents().find(".topic-container, .connection-svg, .mind-connection-con").each(function(){var q=$(this),r=q.offset(),p=r.left+(q.outerWidth()==0?q[0].getBBox().width:q.outerWidth()),o=r.top+(q.outerHeight()==0?q[0].getBBox().height:q.outerHeight());if(i==null||r.left<i){i=r.left;h=q.position().left}if(g==null||r.top<g){g=r.top;n=q.position().top}if(b==null||p>b){b=p}if(a==null||o>a){a=o}});if(i==null){i=0;g=0;b=0;a=0}i=i-30;g=g-30;h=h-30;n=n-30;e=b+30-i;k=a+30-g;this.data.content.W=e;this.data.content.H=k;this.data.content.X=h;this.data.content.Y=n;var f=420,l=236;if(l/k>f/e){this.data.view.scale=f/e>1?1:f/e}else{this.data.view.scale=l/k>1?1:l/k}var d=Math.round((f-e)/2-i);var c=Math.round((l-k)/2-g);var m=$("#background-set-iframe").contents().find(".mind-container");this.data.view.scrollLeft=m.scrollLeft()-d;this.data.view.scrollTop=m.scrollTop()-c;this.data.view.centerX=Math.round(h+(e/2));this.data.view.centerY=Math.round(n+(k/2));if(this.data.view.scrollLeft<=0&&this.data.view.scrollTop<=0){setTimeout(function(){j.computeSize()},500);return}this.centerView();this.data.iframeLoaded=true},centerView:function(){var a=this.data.view,c=$("#background-set-iframe").contents().find(".mind-container"),b=$("#background-set-iframe").contents().find(".mind-designer");c.scrollLeft(a.scrollLeft);c.scrollTop(a.scrollTop);b.css({transformOrigin:a.centerX+"px "+a.centerY+"px",transform:"scale("+a.scale+")"})},};var smartAiHelpCon={params:{newclass:"",hotCon:"",subUnit:false,designerType:1,channel:1,tutorial:"45%",resultNum:5,extra:true,questions:5},init:function(p){var f=this,g=$("#right-help-con");var d=f.params=$.extend({},this.params,p);if(g.length<1){g=$("<div id='right-help-con' class='right-help-con "+(d.ai_class||"")+"'></div>").appendTo("body").hide();if(d.newclass){g.addClass(d.newclass)}var l=$("<div class='ai-search-input'><span class='ai-search-btn icons'>&#xe713;</span><input id='powerIpt' autocomplete='off' class='power-input' type='text' placeholder='搜索你想要的功能' /><div class='search-hot tag-box'><div class='hot-temp'></div></div><div class='power-search-del' style='display:none'><i class='icons'>&#xe714;</i></div></div>");g.append(l);var h=$("<div class='tag-box power-hot-tag colle-box' style='display:none'><h6>热搜</h6><div class='hot-temp'></div></div>");g.append(h);var o=$("<div class='power-search-result' style='display: none'></div>");g.append(o);if(d.subUnit){var b=d.subUnit,e="";if(typeof b=="string"){e=b}else{if(b instanceof Array){$.each(b,function(q,r){e+=r})}else{return}}g.append(e)}if(d.comm_question){f.renderQuestion(d)}var k=null;var a=null;if(d.bottom){a=d.bottom}if(d.top){k=d.top}g.css({bottom:a,top:k,left:d.left,right:d.right,width:d.width||g.outerWidth(),height:d.height||g.outerHeight()});f.spread()}var i=$(".ai-search-input"),n=i.find(".power-search-del");var m=0,j=null;var c=$("#powerIpt");c.off().on({keydown:function(q){q.stopPropagation()},keyup:function(q){q.stopPropagation()},input:function(q){j=null;m=q.timeStamp;j=setTimeout(function(){if(m==q.timeStamp){c.siblings(".ai-search-btn").trigger("click")}},400)},focus:function(q){q.preventDefault();var r=c.val();if(r==""){f.hotLabelHideorShow("hide","show")}else{f.hotLabelHideorShow("hide","hide");if($(".power-search-result").css("display")=="block"){return}f.powerSearch(r)}if(!d.extra){$("#extra-box").hide()}n.show()},blur:function(q){var r=c.val();if(r==""){setTimeout(function(){f.hotLabelHideorShow("show","hide")},10);if(!d.extra){$("#extra-box").show()}n.hide()}else{f.hotLabelHideorShow("hide","hide")}q.stopPropagation()}});i.off("click.search").on("click.search",".ai-search-btn",function(q){var r=c.val();if(r!=""){f.powerSearch(r);f.hotLabelHideorShow("hide","hide");n.show()}else{$(".power-search-result").hide();f.hotLabelHideorShow("hide","show");n.hide()}q.stopPropagation()});i.off("click.del").on("click.del",".power-search-del",function(){c.val("");$(".power-search-result").hide();f.hotLabelHideorShow("show","hide");$("#extra-box").css("display","block");n.hide()});$(".search-hot").off("click.hot").on("click.hot",".hot-item",function(r){r.stopPropagation();var s=$(this).text(),q=c.val();if(s==q){return}c.val(s);c.focus()});$(".power-hot-tag, .power-search-result").off("mousedown").on("mousedown",".hot-item",function(r){r.stopPropagation();var s=$(this).text(),q=c.val();c.focus();if(s==q){return}c.val(s);c.siblings(".ai-search-btn").trigger("click")});g.off("mousedown.power").on("mousedown.power",".comm-item, ",function(){var t=$(this),q=t.text(),s=t.attr("desc"),r=t.attr("url");if(q&&s&&r){smartAiHelpCon.tutorial(q,s,r)}smartAiHelpCon.close()});g.off("click.ai-pin").on("click.ai-pin",".res-temp",function(z){var x=$(this),A=x.attr("tit"),w=x.attr("desc")||"",q=x.attr("photoUrl")||"";var u=d.ai_tag_list;if(w||q){var v=x.text();f.tutorial(v,w,q);f.close();return}if(u[A]==undefined){return}var s="center";var r="";var t=u[A].trigger_btn,y=u[A].ponalign;if(t){$(t).trigger("click");r=$(u[A].tag)}else{r=$(u[A])}if(y){s=y}setTimeout(function(){f.drawingPin(r,s);f.close()},200);z.stopPropagation()});$("#right-help-con").off("mousedown.helpcon").on("mousedown.helpcon",function(q){q.stopPropagation()});f.getHotCon(d)},renderQuestion:function(b){var a="https://ai.processon.com/doc/random/"+b.channel+"/"+b.designerType+"/"+b.questions;$.ajax({url:a,type:"get",contentType:"application/json",success:function(f){if(f.result=="success"){var f=f.data;var d="<div class='comm-question'><div class='comm-question'><div class='comm-set'></div><div class='comm-tit'>常见问题</div>";for(var c=0;c<f.length;c++){var e=f[c];d+="<div class='comm-item' desc = '"+e.desc+"' url = '"+e.photoUrl+"'>"+e.title+"</div>"}d+="</div>";if($("#extra-box").length){$("#extra-box").append(d)}else{$("#right-help-con").append(d)}}else{console.log(error)}},error:function(){console.log("error")}})},receiveHot:false,getHotCon:function(b){var c=this;if(c.receiveHot){return}var a="https://ai.processon.com/searchTag/"+b.channel+"/"+b.designerType;$.ajax({url:a,type:"Post",success:function(f){if(f.result=="success"){if(f.result=="success"){if(f.data==null){return}b.hotCon=f.data.tag;var g=b.hotCon.split(",");var e="",d="";$.each(g,function(h,i){if(h>3){return false}if(h<2){e+="<span class='hot-item'>"+i+"</span>"}d+="<span class='hot-item'>"+i+"</span>"})}$(".ai-search-input").find(".hot-temp").html(e);$(".power-hot-tag").find(".hot-temp").html(d);c.receiveHot=true}else{}},error:function(){console.log("error")}})},resultLoading:false,powerSearch:function(e){var c=this;if(c.resultLoading){return}c.resultLoading=true;var a=$(".power-search-result");var b="https://ai.processon.com/search";var d=JSON.stringify({keyword:e,designerType:c.params.designerType,channel:c.params.channel});$.ajax({url:b,type:"POST",contentType:"application/json",data:d,success:function(n){if(n.result=="success"){var m=n.data,q=m.toolbarList,p=m.docList;var o=[];if(!m.elementsCount||m.elementsCount<1){if($(".tag-box.empty-rec").length>0){c.resultLoading=false;a.show();return}a.hide();o.push("<div class='tag-box empty-rec colle-box'><h6 style='margin-top:-3px'>找不到你想要的，试试这样搜</h6><div class='hot-temp'>");var g=c.params.hotCon.split(",");$.each(g,function(i,j){if(i<4){o.push("<span class='hot-item'>"+j+"</span>")}});o.push("</div></div>")}else{a.hide();if(q.length){for(var h=0;h<q.length;h++){var s=q[h],l=s.func.split(",")[0];var r=f(l,e);if(h<c.params.resultNum){o.push("<div id='"+s.id+"' class='res-temp' tit='"+s.tit+"'>"+r+"</div>")}}}if(p.length){for(var k=0;k<p.length;k++){var s=p[k],l=s.title.split(",")[0];var r=f(l,e);if(k<c.params.resultNum){o.push("<div desc='"+s.desc+"' photoUrl='"+s.photoUrl+"' id='"+s.id+"' class='res-temp'>"+r+"</div>")}}}}o=o.splice(0,c.params.resultNum).join("");a.html(o).show(100);c.resultLoading=false;function f(j,x){var i=x.length,v=j.indexOf(x);if(v>-1){var u=j.substring(0,v),t=j.substring(v+i);var w=u+'<span style="color:#DE0F18">'+x+"</span>"+t;return w}else{return j}}}else{if($(".tag-box.empty-rec").length>0){c.resultLoading=false;return}var o="<div class='tag-box empty-rec colle-box'><h6 style='margin-top:-3px'>找不到你想要的，试试这样搜</h6><div class='hot-temp'>";var g=c.params.hotCon.split(",");$.each(g,function(i,j){if(i<4){o+="<span class='hot-item'>"+j+"</span>"}});o+="</div></div>";$(".power-search-result").html(o);c.resultLoading=false}},error:function(f){c.resultLoading=false}})},drawingTime:null,drawingPin:function(c,e){if(!c.length){return}var j=$("#earch-drawing-pin");var h=this;if(j.length){clearTimeout(h.drawingTime)}else{var f=$("#right-help-con").find(".ai-search-btn").offset(),a=f.top,l=f.left;j=$("<div id='earch-drawing-pin' style='top:"+(a-2)+"px; left:"+l+"px' class='search-drawing-pin'><div class='pin'><span class='icons'>&#xe6c1c;</span></div><div class='pulse'></div></div>").appendTo($("body"))}var g=c.offset(),b=g.left,k=g.top,d=b,i=k-24;if(!isNaN(parseInt(e))){d+=parseInt(e)}else{if(e=="center"){d+=(c.outerWidth()/2-8)}}i=i>0?i:0;setTimeout(function(){j.css({top:i,left:d})});h.drawingTime=setTimeout(function(){j.remove()},5000);$(".power-search-result").hide()},tutorial:function(f,e,j,h){var c=$("#power-tutorial-con");if(c.length<1){c=$('<div id="power-tutorial-con" style="overflow:hidden" class="tutorial-detail dialog-box"><h3></h3><div class="tutorial-image"></div><div class="tutorial-text"><div class="textarea"></div></div></div>');c.appendTo("body")}var g=c.find("h3"),b=c.find(".tutorial-image"),i=c.find(".tutorial-text");g.text(f);i.find(".textarea").html(e);if(j!=null){b.css({border:"1px solid #e3e3e3",padding:"20px 0px 20px 0px"});c.css({"z-index":11,width:this.params.tutorial});var d='<img style="width:100%" src="'+j+'"/>';b.html(d);b.find("img").on("load",function(){a(c)})}else{b.empty();b.css({border:"none",padding:0});a(c)}function a(k){k.dialog()}$(".power-search-result").hide()},close:function(){var b=$("#right-help-con");b.addClass("remove");var a=$(".ai-search-input");a.find(".power-search-del").trigger("click");setTimeout(function(){b.css("display","none")},300)},spread:function(){var a=$("#right-help-con");a.removeClass("remove").css("display","block");$("#extra-box").css("display","block")},hotLabelHideorShow:function(a,d){var b=$(".tag-box.power-hot-tag"),c=$(".ai-search-input").find(".search-hot");a=="show"?c.css({display:"block"}):c.css({display:"none"});d=="show"?b.css({display:"block"}):b.css({display:"none"})}};var mindShare={publish:{source:'<div id="publish_toedit" class="pubpo-tab dialog-win-con"><div class="toedit-des">当前文件已发布（公开）到ProcessOn，您可以：</div><div class="publish-content"><div id="btn_submit_private"><span class="mind-icons">&#xe7bb;</span>取消发布</div><div class="item-seq">或者</div><div id="to_publish_edit"><span class="mind-icons">&#xe644;</span>修改发布信息</div></div><div style="margin-bottom:13px;" class="mind-dlg-buttons"><span class="mind-button pubdialog-close">关闭</span></div></div><div id="publish_verifying" class="pubpo-tab dialog-win-con"><div class="toedit-des">当前文件正在进行发布审核，请耐心等待</div><div class="publish-content"><div id="btn_verifying"><span class="mind-icons">&#xe61e;</span>审核中…</div><div class="item-seq">或者</div><div id="to_publish_edit"><span class="mind-icons">&#xe644;</span>修改发布信息</div></div><div class="mind-dlg-buttons"><span class="mind-button pubdialog-close">关闭</span></div></div><div id="publish_topublic" class="pubpo-tab dialog-win-con"> <h3>文件信息</h3><a href="/ac/210420?from=editor" target="_blank"><img src="/assets/images/new/streamer.png" class="streamer"/></a><ul class="form"><li class="form-row"><div class="text">标题</div><input type="text" class="txt" name="pub_title" id="pub_title" style="width:70%"></li><li class="form-row"><div class="text" style="vertical-align: top">文件描述</div><textarea id="publish_description" class="textarea txt" placeholder="详情描述限200字内"></textarea></li><li class="form-row"><div class="text">分类</div><div class="select-box" id="industry"><input type="text" class="select" placeholder="选择所属行业" disabled><ul></ul></div></li><li class="form-row"><div class="text">添加标签</div><div id="publish_addtags" class="feedTags txt"><div id="tag_items"></div><input id="tag_input" class="tag-txt" type="text" placeholder="回车键添加标签，最多可添加5个标签"></div><ul class="pro-tags"></ul><div class="change-tags">换一换</div></li><div style="height:1px;background:#F0F0F0;margin:23px 0"></div> <h3>设置文件克隆</h3><li class="form-row" style="padding-bottom:10px;"><div class="text">克隆类型</div><div class="content" style="width:auto!important"><div class="radio-btn-group"><input id="public_clone_free" type="radio" class="clone-radio" name="public_clone" checked><label for="public_clone_free">免费克隆</label></div><div class="radio-btn-group"><input id="public_clone_pay" type="radio" class="clone-radio " name="public_clone"><label for="public_clone_pay">付费克隆<span>（用户克隆后，您可以获取收益）</span></label></div><div class="radio-btn-group" title_pos="top" title="该设置模板将不被展示在模板首页，<br/>公开后请在推荐页查找此模板"><input type="radio" name="public_clone" id="no_clone" class="clone-radio"><label for="no_clone">不允许克隆<span>（仅可查看）</span></label></div></div></li><li class="form-row selece-price-box" style="padding-bottom:20px;"><div class="text">克隆价格</div><ul class="selece-price"><li class="select-price-item" style="width:154px;"><input id="setprice"  placeholder="请输入3元以上价格" type="text" value="" autocomplete="off"/><li class="select-price-item">3</li><li class="select-price-item">5</li><li class="select-price-item">10</li><li class="select-price-item">15</li><li class="select-price-item">20</li></li></ul></li></ul><div class="bot-line" style="padding:0;"><div class="agreement-group" style="display:block;margin:0; "><input id="agreement" type="checkbox" name="agreement" checked=""><label for="agreement">点击发布表示您同意我们的<a href="/tos" target="_blank" class="agreement-detail">《服务条款》</a></label></div><div class="dlg-buttons"><div class="btn" id="exposure">如何提升创作曝光<a href="https://www.processon.com/support#user-template" target="_blank"><img src="/assets/images/new/exposure.png"></a></div><span class="mind-button gray pubdialog-close">取消</span><span id="btn_submit_publish" class="mind-button  pub-btn">发布</span></div></div></div>',officialTags:[],getOfficialTags:function(){var a=$("#pub_title").val();$.ajax({url:"/templates/official_tags",data:{title:a=="未命名文件"?"":a},type:"post",success:function(c){mindShare.publish.officialTags=[];for(var b=0;b<c.tags.length;b++){mindShare.publish.officialTags.push(c.tags[b].tagName)}if(mindShare.publish.officialTags.indexOf("拆书稿征集")<-1){mindShare.publish.officialTags.push("拆书稿征集")}mindShare.publish.renderOfficialTags()}})},renderOfficialTags:function(){var a=$(".pro-tags");var e=a.find("li").length;var b=mindShare.publish.getRandomItem(mindShare.publish.officialTags,5);a.empty();if(e==0&&b.indexOf("拆书稿征集")<0){b[0]="拆书稿征集"}for(var c=0;c<b.length;c++){var d="";if(b[c]=="拆书稿征集"){d="hot"}a.append('<li class="'+d+'">'+b[c]+"</li>")}},getRandomItem:function(a,b){var d=[],e=$.extend(true,[],a);for(var c=0;c<b;c++){var f=Math.floor(Math.random()*e.length);if(d.indexOf(e[f])==-1){d.push(e[f]);e.splice(f,1)}}return d},execute:function(g){$("#btn_submit_publish").before($("#TencentCaptcha"));$("#TencentCaptcha").show();$("#btn_submit_publish").hide();$.ajax({url:"/view/chart/"+g,data:{},success:function(k){var j=k.chart;f(j.status);$("#tag_items").children("span").remove();$(".selece-price-box").hide();if(j.tags!=null&&j.tags.length>0){for(var h=0;h<j.tags.length;h++){c(j.tags[h])}}if(j.industry!=null){$("#industry .select").val(j.industry)}$("#publish_description").val(mindUI.restoreXss(j.description));$("#pub_title").val(mindUI.restoreXss(j.title)).off().on("blur",function(){if($("#pub_title").val()!=mindUI.restoreXss(j.title)){j.title=$("#pub_title").val();mindShare.publish.getOfficialTags()}});if(j.template==true){$("#public_clone_pay").attr("checked",true);$(".selece-price-box").show()}if(j.publicClone&&j.publicClonePrice>0){$("#public_clone_pay").attr("checked",true);$(".selece-price-box").show();$(".setprice-btn").val(j.publicClonePrice)}else{if(!j.publicClone&&j.status=="public"){$("#no_clone").attr("checked",true)}else{$("#public_clone_free").attr("checked",true)}}mindShare.publish.getOfficialTags()}});$("#mind-publish-dlg").on("click","#to_publish_edit",function(){a();$(".pubpo-tab").hide();$("#publish_topublic").show()});$("#publish_addtags").on("click",function(h){$("#tag_input").focus()});$(".select-box").click(function(h){h.stopPropagation();$(this).find("ul").toggle()});$("#file_type").on("click","li",function(){$("#file_type .select").val($(this).text())});$("body").click(function(){$(".select-box ul").hide()});$.ajax({url:"/templates/official_industries",data:{},success:function(j){for(var h in j.industries){$("#industry ul").append("<li>"+j.industries[h]+"</li>")}}});$("#industry").on("click","li",function(){$("#industry .select").val($(this).text())});var b=$(".pro-tags");$(".change-tags").off().on("click",function(){var h=mindShare.publish.getRandomItem(mindShare.publish.officialTags,5);b.empty();for(var j=0;j<h.length;j++){b.append("<li>"+h[j]+"</li>")}});b.off().on("click","li",function(k){k.stopPropagation();var j=$(this);if($("#tag_items").children("span").length<5){j.remove();b.append("<li>"+mindShare.publish.getRandomItem(mindShare.publish.officialTags,1)[0]+"</li>");for(var h=0;h<mindShare.publish.officialTags.length;h++){if(j.text()==mindShare.publish.officialTags[h]){mindShare.publish.officialTags.splice(h,1)}}}c(j.text())});$("#tag_items").find(".close-tag").die().live("click",function(){var h=$(this).parent().find("input").val();$(this).parent().remove();if($("#tag_items").children("span").length<5){$("#tag_input").val("").focus()}mindShare.publish.officialTags.push(h)});$("#tag_input").off("keyup.input").on("keyup.input",function(i){if($.trim($(this).val()).length>30){$(this).val($.trim($(this).val()).substring(0,30))}var h=i.which;if(h==188){c($("#tag_input").val().substr(0,$("#tag_input").val().length-1));$("#tag_input").val("")}$("#publish_addtags").scrollTop($(".input_item_box").height())}).off("keydown.delete").on("keydown.delete",function(h){if(h.which==8&&$("#tag_input").val()==""){$("#tag_items span:last-child").remove()}}).suggest({url:"/tags/suggest",valueField:"tagName",format:function(h){return h.tagName},onEnter:function(){c();$(".feedTags").scrollTop($(".input_item_box").height())}});$("#agreement").on("change",function(){var i=$(this).prop("checked"),h=$("#btn_submit_publish");if(!i){h.disable();return}h.enable()});$(".clone-radio").off().on("change",function(){var i=$("#public_clone_pay").prop("checked"),h=$("#btn_submit_publish");if(i){$(".selece-price-box").show();h.text("提交审核");return}$(".selece-price-box").hide();h.text("发布")});$(".selece-price").off().on("click",".select-price-item",function(i){var h=$(this);$(".select-price-item").removeClass("active");if(h.find("input").length>0){if($("#setprice").val()==0){$("#setprice").val("")}if($(this).val()===0){$(this).val(1)}$("#setprice").on("input",function(j){$(this).val($(this).val().replace(/^(\-)*(\d+)\.(\d).*$/,"$1$2.$3"));if($(this).val()===0){$(this).val(1)}}).on("blur",function(){if($(this).val()!=""){$(this).parent().addClass("active")}else{$(this).parent().removeClass("active")}$(this).parent().removeClass("ipterror")});return}else{$(".selece-price input").val("");$("#setprice").parent().removeClass("ipterror");h.addClass("active");return}});$("#btn_submit_publish").off().on("click",function(){var i="verifying";var h=$("#public_clone_free").prop("checked"),j=$("#no_clone").prop("checked");if(h||j){i="public"}d(i)});$("#btn_submit_private").off().on("click",function(){var h="private";d(h)});function d(n){var i=$("#publish_description"),h=$(".clone-radio:checked");var o={};o.id=g;o.description=i.val();o.title=$.trim($("#pub_title").val());o.industry=$("#industry .select").val();o.tags=e();o.signup_ticket=$("#signup_ticket").val();o.randstr=$("#randstr").val();o.status=n;o._public_clone=($("#no_clone")[0].checked==true)?"false":"true";o._public_clone_price=$("#setprice").val()?$("#setprice").val():$(".select-price-item.active").text();o.ignore="description";if(n!="private"){if(o.title==""||o.title=="未命名文件"){Util.globalTopTip("未命名文件不允许发布，请修改文件标题后再发布","top_error",3000,$("#mind-publish-dlg"),true);$("#pub_title").focus();return}if(o.description.length==0){Util.globalTopTip("请输入文件描述","top_error",3000,$("#mind-publish-dlg"),true);i.focus();return}if(!o.industry){Util.globalTopTip("请选择文件分类","top_error",3000,$("#mind-publish-dlg"),true);return}if(o.tags.length==0){Util.globalTopTip("请输入文件标签","top_error",3000,$("#mind-publish-dlg"),true);$("#publish_addtags").find("input").focus();return}if(h.length<1){Util.globalTopTip("您需要选择是否开放克隆","top_error",3000,$("#mind-publish-dlg"),true);return}var l=$("#public_clone_pay").prop("checked");if(l){var m=$("#setprice");var k=o._public_clone_price;if(k==0||k>99){Util.globalTopTip("请您输入价格(3 - 99)","top_error",3000,$("#mind-publish-dlg"),true);m.focus();return}else{if(!/^(\d+\.\d{1,1}|\d+)$/.test(k)){Util.globalTopTip("克隆价格需为数字，最多一位小数","top_error",3000,$("#mind-publish-dlg"),true);m.focus();return}else{if(k<3){Util.globalTopTip("克隆价格需大于3元","top_error",3000,$("#mind-publish-dlg"),true);m.focus();return}}}}}var j=n=="verifying"?"chart/verify":"publish";$.ajax({url:"/folder/"+j,data:o,traditional:true,type:"POST",success:function(q){if(q.result=="clone"||q.result=="error_clone"){Util.globalTopTip("克隆的文件暂不允许发布","top_error",3000,$("#mind-publish-dlg"),true);a();return}else{if(q.result=="error_owner"){Util.globalTopTip("非自己文件，不允许发布","top_error",3000,$("#mind-publish-dlg"),true);a();return}else{if(q.result=="error_status"){Util.globalTopTip("文件已在审核中，不允许发布","top_error",3000,$("#mind-publish-dlg"),true);a();return}else{if(q.result=="error_ticket"){Util.globalTopTip("发布操作频繁，请操作后重试","top_error",3000,$("#mind-publish-dlg"),true);a();return}else{if(q.result=="tag"){Util.globalTopTip("文件标签填写有误，请修改文件标签后再发布","top_error",3000,$("#mind-publish-dlg"),true);a();return}else{if(q.result=="rename"){Util.globalTopTip("未命名文件不允许发布，请修改文件标题后再发布","top_error",3000,$("#mind-publish-dlg"),true);a();return}else{if(q.result=="error"){Util.globalTopTip("当前模板内容较少，请丰富后再发布~","top_error",3000,$("#mind-publish-dlg"),true);a();return}else{if(q.result=="error_text"){var p=["正常","涉黄","广告","涉暴","涉政","辱骂","灌水"],r=q.msg;a();Util.globalTopTip("描述或标签中存在敏感词汇，请修改后再发布","top_error",3000,$("#mind-publish-dlg"),true);return}else{if(q.result=="error_safe_time"){Util.globalTopTip("新用户注册时间小于24小时禁止发布、请稍后再发布","top_error",3000,$("#mind-publish-dlg"),true);a();return}else{if(q.result=="error_safe_count"){Util.globalTopTip("已达到每天发布文件数量限制(默认24张)、请稍后再发布","top_error",3000,$("#mind-publish-dlg"),true);a();return}}}}}}}}}}if(n=="verifying"||n=="public"){poCollect("模版-发布成功",{"渠道记录":"编辑器内"});n="verifying";Util.globalTopTip("文件已经提交审核",null,3000,$("#mind-publish-dlg"),true);sessionStorage.setItem("published",true)}else{if(n=="public"){poCollect("模版-发布成功",{"渠道记录":"编辑器内"});Util.globalTopTip("文件已经发布成功",null,3000,$("#mind-publish-dlg"),true);sessionStorage.setItem("published",true)}else{if(n=="private"){Util.globalTopTip("文件已经取消发布，已处于私密状态",null,3000,$("#mind-publish-dlg"),true);a()}}}f(n)}})}function a(){$("#TencentCaptcha").show();$("#btn_submit_publish").hide()}$("#mind-publish-dlg").on("click",".pubdialog-close",function(){var h=$("#mind-publish-dlg");$.mask("close");h.hide();$("#TencentCaptcha").appendTo("body").hide();$(window).unbind("resize.dialog")});function f(h){var i=$(".pubpo-tab");if(h=="public"){i.hide();$("#publish_toedit").show()}else{if(h=="verifying"){i.hide();$("#publish_verifying").show()}else{i.hide();$("#publish_topublic").show();$("#publish_topublic").find("textarea").focus()}}}function c(i){if(typeof i=="undefined"){i=$("#tag_input").val();$("#tag_input").val("")}if($("#tag_items").children("span").length>=5){$("#tag_input").inputTip({text:"最多添加五个标签",pos:"rightout"});return}if(i!=""){i=mindUI.filterXss(i.trim());var h=$("#tag_items").find(".tagitem").map(function(){return $(this).find("input").val()}).get();if($.inArray(i,h)<0){$("#tag_items").append("<span class='tagitem'><span class='close-tag mind-icons'>&#xe622;</span><input type='hidden' name='tags' value='"+i+"'/>"+i+"</span>");$("#tag_items").show()}}}function e(){var h=$("#tag_items").find(".tagitem").map(function(){return $(this).find("input").val()}).get();return h}}},viewlink:{source:'<div class="dlg-content"><h3><span class="tip1">创建浏览链接，分享给别人后，可以通过此链接来安全地浏览您的文件</span></h3><div style="margin:15px 0;"><input type="text" id="view_link_input" class="txt-input share-link-input" style="width:90%;border-radius:0" readonly placeholder="您还没有给文件创建分享链接"><span original-title="复制链接" style="padding:8px 9px 7px 9px;" class="icons link-icon">&#xe6de;</span></div><div class="button-line"><div class="new-form-switch"><span class="switchbutton fl gray" val="false"><span class="switch left"><span class="mind-icons" style="color:#888;">&#xe6bc;</span></span><span class="switch-left">删除密码</span><span class="switch-right">添加密码</span></span></div><input type="text" class="txt-input input-pw" style="margin-left:10px;display:none;height:10px;" maxlength="8" placeholder="密码" /></div><div class="shareopt-group share-menu"><h3><span class="tip2">分享到社交网络</span></h3><a style="color:#3eb94e" onclick="mindUI.showWeixin(this)" class="mind-icons weixin">&#xe6e3;</a><a style="color:#ff0000" class="mind-icons weibo" target="_blank" rel="nofollow" href="http://service.weibo.com/share/share.php?appkey=4181333602&title='+chartTitle+"&url=https://www.processon.com/view/"+chartId+"&pic=https://www.processon.com/chart_image/id/"+chartId+'.png&ralateUid=2711044785">&#xe6e1;</a><a style="color:#2196f3;" class="mind-icons mingdao" target="_blank" rel="nofollow" href="http://www.mingdao.com/share?appkey=5967E9E0B4ADA1B9C23B1893ABAED0F&pic=https://www.processon.com/chart_image/id/'+chartId+".png&title="+chartTitle+"&url=https://www.processon.com/view/"+chartId+'">&#xe6e2;</a><a style="color:#228a31;" class="mind-icons douban" target="_blank" rel="nofollow" href="http://www.douban.com/share/service?name='+chartTitle+"&href=https://www.processon.com/view/"+chartId+'">&#xe6e0;</a></div><div class="share-del"><span class="pro-btn default create">创建链接</span><span class=""></span><span id="del-hint" style="margin-left:20px;">删除链接后别人无法浏览你的文件，你可以选择再次创建链接</span></div></div>',execute:function(k){var i=null;var f="";$.ajax({url:"/view/getlink",data:{chartId:k},success:function(n){var p=n.chart_pass;var o=n.chart_title;mindShare.chart=n.chart;f=n.viewLinkId;if(f==""||f==null){a()}else{var m="false";var l=null;if(p!=null&&p!=""){m="true";l=p}$(".switchbutton").attr("val",m);h(l);$("#view_link_input").val(f).select()}}});$(".sharedialog-close").off("click").on("click",function(l){l.stopPropagation();$(".mind-share-dlg").hide();$.mask("close")});$(".switchbutton").off().on("click",function(){var l=$(this).attr("val");if(l=="true"){$(this).attr("val",false)}else{$(this).attr("val",true)}c(this)});$(".link-icon").on("click",function(){if(!$("#view_link_input").val().trim()){return}$("#view_link_input").select();try{if(document.execCommand("copy",false,null)){Util.globalTopTip("链接已复制到剪切板","top_success",3000,$("#mind-share-dlg"),true);zhuge.track("点击复制链接",{"触发位置":"思维导图"})}else{}}catch(l){}});$(".input-pw").off().on("change",function(m){var l=$(this).val().trim();if(l==""){return}if(!/^[0-9a-zA-Z]+$/.test(l.trim())){Util.globalTopTip("只能为数字和字母的组合","top_error",3000,$("#mind-share-dlg"),true);return}j(l)});function a(){$(".dlg-content .create").text("创建链接").off().on("click",function(){e();$(".share-menu, .button-line").show();zhuge.track("点击创建分享链接",{"触发位置":"思维导图"})});$(".share-menu, .button-line").hide();$("#del-hint").hide();$("#view_link_input").val("").off()}function e(){$.ajax({url:"/view/addlink",data:{chartId:k},success:function(m){$(".switchbutton").attr("val","false");h();var l=m.viewLinkId;$("#view_link_input").val(l).select()}})}function h(l){$(".dlg-content .create").text("删除链接").off().on("click",function(){g();$(".share-menu, .button-line").hide()});$(".share-menu, .button-line").show();$("#del-hint").show();b(l)}function b(l){var n=$(".switchbutton");var m=n.attr("val");if(m=="false"){n.removeClass("green").addClass("gray");n.find(".switch").removeClass("right").addClass("left");n.find(".switch .icons").show();n.find(".switch-left").hide();n.find(".switch-right").show()}else{n.removeClass("gray").addClass("green");n.find(".switch").removeClass("left").addClass("right");n.find(".switch .icons").hide();n.find(".switch-left").show();n.find(".switch-right").hide();if(!!l){$(".input-pw").show().val(l)}}}function g(){$.ajax({url:"/view/dellink",data:{chartId:k},success:function(l){a()}})}function c(n){var m=$(n).attr("val");if(m=="true"){var l=d(4);$(".input-pw").show().val(l).select();j(l)}else{$.ajax({url:"/view/removepassword",data:{chartId:k},success:function(o){$(".input-pw").val("").hide();b($(".input-pw").val())}})}}function d(n){var o=["abcdefghijklmnopqrstuvwxyz","ABCDEFGHIJKLMNOPQRSTUVWXYZ","123456789"];var m,p;var l="";for(p=0;p<n;p++){m=Math.floor(Math.random()*3);l+=o[m].substr(Math.floor(Math.random()*(o[m].length)),1)}return l}function j(l){$.ajax({url:"/view/addpassword",data:{viewPassword:l,chartId:k},success:function(m){b($(".input-pw").val());Util.globalTopTip("密码设置成功","top_success",3000,$("#mind-share-dlg"),true)}})}}},emb:{source:'<div class="embed-left"><div class="embed-preview-wrap"><div class="embed-preview"></div></div></div><div class="embed_attributes form"><div id="embed_show_tip">您可以复制下面的代码，嵌入到第三方网站中，比如：<a href="https://www.yuque.com/?chInfo=ch_processon__chsub_embed" target="_blank"><svg style="width:50px;vertical-align:-5px;" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 81 28" id="logo"><g fill="none" fill-rule="evenodd"><path d="M48.96 6.168c-.282 0-.472-.049-.57-.146-.099-.097-.148-.267-.148-.51 0-.23.05-.4.148-.508.098-.11.288-.164.57-.164h9.77c.257 0 .438.054.542.164.105.109.157.279.157.509 0 .242-.052.412-.157.51-.104.096-.285.145-.542.145h-5.336l-.442 1.855h3.68c.417 0 .748.022.994.064.245.042.426.127.542.255.117.127.19.315.221.564.03.248.046.579.046.991v1.892h1.067c.258 0 .439.054.543.164.104.109.156.279.156.509 0 .218-.052.382-.156.491-.104.11-.285.164-.543.164H48.334c-.27 0-.453-.055-.552-.164-.098-.109-.147-.273-.147-.491 0-.23.05-.4.147-.51.099-.109.283-.163.552-.163h2.282l.607-2.474H49.29c-.208 0-.365-.046-.47-.137-.103-.09-.155-.263-.155-.518 0-.424.208-.637.625-.637h2.245l.441-1.855H48.96zm10.027 13.188c0 .558-.104.956-.313 1.192-.208.236-.582.355-1.122.355h-6.77c-.553 0-.93-.119-1.132-.355-.203-.236-.304-.634-.304-1.192v-3.201c0-.546.101-.934.304-1.164.202-.23.58-.346 1.131-.346h6.771c.54 0 .914.115 1.122.346.209.23.313.618.313 1.164v3.201zM57.662 16.3c0-.206-.08-.309-.239-.309H50.91c-.147 0-.22.103-.22.31v2.946c0 .207.073.31.22.31h6.513c.16 0 .24-.103.24-.31V16.3zm-8.978 1.074c.208.17.31.348.304.536-.007.188-.132.404-.378.646-.319.328-.613.6-.883.819-.27.218-.595.467-.975.746-.245.17-.478.27-.699.3a.848.848 0 01-.589-.119 1.032 1.032 0 01-.395-.509c-.092-.23-.126-.515-.102-.855l.479-7.586c.024-.242-.08-.345-.313-.309l-1.693.182c-.355.036-.595.006-.717-.091-.123-.097-.196-.279-.22-.546-.025-.23.02-.403.137-.518.117-.115.328-.185.635-.21l1.913-.181c.589-.06 1.021.033 1.297.282.276.248.396.7.36 1.355l-.442 7.095c-.013.194.049.23.184.109a13.208 13.208 0 001.03-.928c.38-.4.736-.473 1.067-.218zm3.956-8.06l-.608 2.475h5.023V9.733c0-.182-.018-.297-.055-.345-.037-.049-.141-.073-.313-.073H52.64zm-4.968-.927c-.319.291-.687.218-1.104-.218a84.667 84.667 0 00-1.076-1.119c-.374-.382-.794-.78-1.26-1.191-.405-.34-.43-.704-.074-1.092a.557.557 0 01.47-.182c.19.012.407.128.652.346.54.473.988.888 1.343 1.246.356.358.681.7.975 1.028.233.242.356.451.368.627.013.176-.085.361-.294.555zm28.636.2c-.368.23-.745.449-1.131.655-.386.206-.776.412-1.168.619.073.072.159.188.257.345.098.206.203.43.313.673l.331.728h5.133c.233 0 .405.052.515.155.11.103.166.276.166.518 0 .425-.227.637-.68.637h-5.465v1.273h4.912c.233 0 .405.052.515.155.11.103.166.276.166.518 0 .425-.227.637-.68.637h-4.913v1.219h4.784c.233 0 .404.051.515.154.11.103.165.276.165.519 0 .242-.055.41-.165.5-.11.091-.282.137-.515.137h-4.784v1.327h5.74c.454 0 .681.23.681.692 0 .242-.055.412-.166.51-.11.096-.282.145-.515.145H67.57v.09c0 .243-.058.416-.175.519-.116.103-.291.155-.524.155-.245 0-.42-.052-.524-.155-.105-.103-.157-.276-.157-.518v-8.096a154.592 154.592 0 01-1.582.364c-.38.085-.64.091-.782.018-.141-.072-.23-.248-.267-.527-.037-.23-.003-.403.101-.519.105-.115.298-.203.58-.263a39.981 39.981 0 004.26-1.146c1.355-.449 3.412-1.252 3.412-1.304V8.235v-3.54c0-.486.233-.728.7-.728.465 0 .698.242.698.727v3.984c1.076-.566 1.842-1.002 2.3-1.31.27-.17.49-.254.663-.254.171 0 .337.109.496.327.148.206.19.397.13.573-.062.176-.258.367-.59.573zm-6.44-3.802c.197.146.298.306.304.482.007.176-.095.41-.303.7a21.526 21.526 0 01-1.693 2.065 22.174 22.174 0 01-2.079 1.956c-.319.255-.57.391-.754.41-.184.017-.356-.077-.515-.283-.147-.194-.197-.373-.147-.536.049-.164.202-.361.46-.592a21.672 21.672 0 001.968-1.855 16.81 16.81 0 001.6-1.965c.21-.303.409-.479.599-.527.19-.049.377 0 .56.145zm5.888 1.165c-.233-.23-.364-.431-.395-.6-.03-.17.04-.34.211-.51.184-.17.362-.243.534-.218.172.024.38.145.626.363.552.51 1.143 1.125 1.775 1.847.632.721 1.26 1.5 1.886 2.337.208.28.325.51.35.692.024.182-.062.345-.258.49-.22.17-.42.228-.598.174-.178-.055-.39-.246-.635-.573a38.263 38.263 0 00-1.665-2.074 30.71 30.71 0 00-1.83-1.928zM67.57 19.356h5.648V18.03H67.57v1.327zm0-5.166h5.648v-1.273H67.57v1.273zm0 2.529h5.648v-1.22H67.57v1.22zm5.39-6.349a57.34 57.34 0 01-1.526.637c-.515.206-1.049.406-1.6.6h3.624a23.08 23.08 0 00-.405-.837c-.086-.157-.117-.29-.092-.4z" fill-opacity=".85" fill="#000"></path><g><g fill="#31CC79"><path d="M31.42 3.991l-2.564-.136s-.97-3.38-5.422-3.683c-4.452-.303-7.365-.113-7.365-.113s3.303 2.088 1.979 5.813c-.983 2.01-2.54 3.652-4.198 5.539L2.882 23.84c10.21-.148 16.23-.222 18.058-.222 5.13 0 9.464-4.417 9.287-9.332-.122-3.378-1.205-4.141-1.577-5.62-.373-1.48.373-3.84 2.77-4.676z" id="logo_a"></path></g><g fill-opacity=".6" fill="url(#logo_b)"><path d="M31.42 3.991l-2.564-.136s-.97-3.38-5.422-3.683c-4.452-.303-7.365-.113-7.365-.113s3.303 2.088 1.979 5.813c-.983 2.01-2.54 3.652-4.198 5.539L2.882 23.84c10.21-.148 16.23-.222 18.058-.222 5.13 0 9.464-4.417 9.287-9.332-.122-3.378-1.205-4.141-1.577-5.62-.373-1.48.373-3.84 2.77-4.676z" id="logo_a"></path></g></g><g><g fill="#93E65C"><path d="M13.805 11.45C8.437 17.473 0 27.053 0 27.053c15.178 3.956 22.171-5.646 23.266-8.97 1.468-4.457-.606-6.631-1.78-7.34-3.98-2.405-6.934-.129-7.68.709z" id="logo_c"></path></g><g fill-opacity=".75" fill="url(#logo_d)" style="mix-blend-mode:overlay"><path d="M13.805 11.45C8.437 17.473 0 27.053 0 27.053c15.178 3.956 22.171-5.646 23.266-8.97 1.468-4.457-.606-6.631-1.78-7.34-3.98-2.405-6.934-.129-7.68.709z" id="logo_c"></path></g></g><g opacity=".448"><g fill="#60DB69"><path d="M19.203 23.678c-2.435.016-7.89.086-16.363.209l10.485-11.884.68-.768c.986-.944 3.806-2.75 7.515-.51 1.178.712 3.26 2.896 1.787 7.37-.428 1.298-1.75 3.55-4.104 5.583z" id="logo_e"></path></g><g fill-opacity=".65" fill="url(#logo_f)"><path d="M19.203 23.678c-2.435.016-7.89.086-16.363.209l10.485-11.884.68-.768c.986-.944 3.806-2.75 7.515-.51 1.178.712 3.26 2.896 1.787 7.37-.428 1.298-1.75 3.55-4.104 5.583z" id="logo_e"></path></g></g></g></svg></a> &nbsp;等</div><textarea id="iframe_html" class="textarea txt-input" readonly="readonly" style="line-height: 16px;margin-top:10px;height:50px;width:97%;"></textarea><div class="embed-size"><label class="title" for="embed_width">宽度:</label><input type="text" id="embed_width" name="embed_width" class="txt-input" value="525"><label for="embed_width">px</label>,<label class="title" for="embed_height">高度:</label><input type="text" id="embed_height" name="embed_height" class="txt-input" value="245"><label for="embed_height">px</label></div><div style="margin-top:10px;">或者直接引用以下地址：</div><textarea id="iframe_html1" class="textarea txt" readonly="readonly" style="margin-top:5px;height:16px;width:98%;"></textarea></div>',execute:function(f){var d=location.host;if(d.indexOf("http")<0&&d.indexOf("processon.com")<0){d="http://"+d}else{if(d.indexOf("wxmp.processon.com")>=0){d="https://wxmp.processon.com"}else{if(d.indexOf("processon.com")>=0){d="https://www.processon.com"}}}$("#iframe_html").val("");$(".embed-preview").html("");var c="/embed/";var a,b;a=$("#embed_width").val();b=$("#embed_height").val();e(a,b);$("#iframe_html").select();function e(g,k){var i='<iframe id="embed_dom" name="embed_dom" frameborder="0" style="display:block;width:'+g+"px; height:"+k+'px;" src="'+(d+c+f)+'"></iframe>';$("#iframe_html").val(i);$("#iframe_html1").val(d+c+f);$(".embed-preview-wrap").css({"margin-top":(-k/2)+"px","margin-left":(-g/2)+"px"});$(".embed-preview").html(i);var j=document.getElementById("embed_dom");j.onload=j.onreadystatechange=function(){if(!j.readyState||j.readyState=="complete"){setTimeout(function(){$(".embed-preview .preview_dis").remove();setTimeout(function(){$(".embed_obj").fadeIn()},100)},400)}}}$(".embed-size").find("input").keyup(function(){var g=$.trim($("#embed_width").val())==""?340:$.trim($("#embed_width").val());var i=$.trim($("#embed_height").val())==""?160:$.trim($("#embed_height").val());g=parseInt(g);i=parseInt(i);$(".embed-preview").find("div:first").css({width:g+"px",height:i+"px"});$(".embed-preview").find("iframe").css({width:g+"px",height:i+"px"});e(g,i)});$("#iframe_html,#iframe_html1").off().on("click",function(){$(this).select();try{if(document.execCommand("copy",false,null)){Util.globalTopTip("链接已复制到剪切板","top_success",3000,$("#mind-share-dlg"),true)}else{}}catch(g){}});$(".embed-preview").keydown(function(){$(".embed-size").find("input").blur()})}},image:{source:'<div class="dlg-content"><h3><span class="tip1">分享图片链接</span></h3><div><input type="text" id="img_link_input" class="txt-input" readonly style="width:95%;margin-top:10px;"><div style="clear:both;"></div></div></div>',execute:function(a){$.ajax({url:"/folder/on_line_pic/"+a,success:function(c){$("#img_link_input").show().prev().hide();var b=c.url.replace("www.processon.com","assets.processon.com");$("#img_link_input").val(b).off().on("click",function(){$(this).select();try{if(document.execCommand("copy",false,null)){Util.globalTopTip("链接已复制到剪切板","top_success",3000,$("#mind-share-dlg"),true)}else{}}catch(d){}}).select()}})}}};var Outline={dataList:[],nodeList:{},data:{},init:function(b,d,a){var c={listType:"dot",indent:"default",target:"outline-con",line:{show:false}};$(".outline-search .search-input").focus().val("");this.data=d;this.opts=$.extend(c,b);this.designer=document.getElementById(b.target);this.searchDesigner=document.getElementById(b.searchTarget);this.searchDesigner.innerHTML="";this.designer.style.display="block";this.searchDesigner.style.display="none";this.dataList=this.util.resetDataList();if(d!=null){this.controller.renderAll()}else{this.controller.add()}this.controller.initEvent()},initNodeEvent:function(b){var a=this,c=document;var d=b.querySelector(".node-self");d.addEventListener("mouseenter",function(f){Outline.controller.posNodeBg(d,"hover");f.stopPropagation()});d.addEventListener("mouseleave",function(g){var f=c.querySelector(".outline-hover-bg");f.style.display="none";g.stopPropagation()});d.addEventListener("click",function(g){if(g.target.className=="node-title"||$(g.target).parents(".node-title").length>0){var h=b.getAttribute("id").replace("ol_","").replace("search_","");var f=Outline.util.getParentId(h);mind.model.showTopics.call(mind,f,true);mind.util.selectById.call(mind,h)}});$("#ol_root").off().on("click",function(){mind.util.selectById.call(mind,"root")});if(this.opts.readOnly){return}},controller:{setTitle:function(b){var a=$(Outline.designer).prev();a.html(b).attr("id","ol_root")},renderAll:function(e){var f=Outline.data,c=Outline.designer;if(e&&Object.keys(e).length>0){document.querySelector("#ol_"+e.id).innerHTML="";this.add(null,e);if(e.summaries&&e.summaries.length>0){for(var b=0;b<e.children.length;b++){if(e.children[b].summary===true){delete e.children[b]}}e.children=e.children.concat(e.summaries)}var a=e.children;if(a&&!e.collapsed){this.renderChild(a)}return}var a=f.children||[],g=f.leftChildren||[];this.setTitle(f.title);c.innerHTML="";var d=a.concat(g);if(d.length==0){return}this.renderChild(d,c)},renderChild:function(e,d){for(var c=0,a=e.length;c<a;c++){var f=e[c];if(f.summaries&&f.summaries.length>0){f.children=f.children.concat(f.summaries);delete f.summaries}this.add(null,f,d);if(f.children.length>0){var b=f.children;this.renderChild(b)}}},add:function(o,p,b){var n=document,a=Outline.opts,i=Outline.model;var c=p?p.id:util.newId(),o=o||0;var g=null;var l=n.querySelector("#ol_"+c);if(l){g=l}else{g=n.createElement("div");if(a.indent=="wider"){g.setAttribute("class","node-element wider")}else{g.setAttribute("class","node-element")}g.setAttribute("id","ol_"+c);if(p!=null){if(b==null){b=n.getElementById("ol_"+p.parent).querySelector(".node-children")}b.appendChild(g)}}var f=n.createElement("div");f.setAttribute("class","node-self");g.appendChild(f);var e=n.createElement("span");f.appendChild(e);var h=n.createElement("span");e.appendChild(h);var m=n.createElement("div");m.setAttribute("class","node-title");if(!a.readOnly){m.setAttribute("contenteditable",true)}m.setAttribute("spellcheck","false");m.setAttribute("autocapitalize","off");var j=p?p.title:"";m.innerHTML=j.replace(/<br>/g,"&nbsp;&nbsp;");f.appendChild(m);var d=n.createElement("div");var k="node-children";if(a.line.show){k+=" line"}if(a.line.dashed){k+=" dashed"}d.setAttribute("class",k);g.appendChild(d);if(a.listType=="num"){e.setAttribute("class","node-type num")}else{e.setAttribute("class","node-type dot")}if(p!=null){this.addStateIcon(p,g)}else{m.focus()}Outline.initNodeEvent(g);mind.operation.renderEquation($(g))},addStateIcon:function(f,c){var b=document;var e=c.querySelector(".node-state"),d=c.querySelector(".node-self");f.summaries=f.summaries?f.summaries:[];if(f.children.length>0||f.summaries.length>0&&e==null){e=b.createElement("div");e.setAttribute("class","node-state");var a=b.createElement("span");a.setAttribute("class","collapse-icon openIcon");e.appendChild(a);d.appendChild(e)}},selectNodeById:function(d){var c=this;var b=document.querySelector("#ol_"+d),a=null;if($("#outline-container-search").is(":visible")){var b=document.querySelector("#search_ol_"+d)}if(!b){return}if(d=="root"){a=b}else{a=b.querySelector(".node-self")}c.selectNode(a)},updateNodeById:function(f){var a=f.topics,k=f.insertChild,l=$("#outline-search-ipt").val(),n=[];for(var d=0;d<a.length;d++){var g=a[d],c=g.id;if(l.length>0){Outline.dataList=Outline.util.resetDataList();for(var e=0;e<Outline.dataList.length;e++){if(Outline.dataList[e].title.indexOf(l)>-1&&Outline.dataList[e].id!="root"){n.push(Outline.dataList[e])}}this.searchNode(n)}if(c=="root"){Outline.data=mind.util.copy(mind.model.topic);this.renderAll();return}if(k||f.rebuild=="current"){var b=document.querySelector("#ol_"+c),o=mind.util.copy(this.getNodeById(c));if(b==null){return}var m=b.querySelector(".node-children");if(m){m.innerHTML=""}this.renderAll(o);return}var h=this.getParentNodeById(c);if(h.id=="root"){this.renderAll();return}var b=document.querySelector("#ol_"+h.id),m=b.querySelector(".node-children");if(m){m.innerHTML=""}this.renderAll(h)}},foldNodeById:function(b){var a=b.type,c=b.id;if(a=="show"){this.openChildren("ol_"+c);return}this.closeChildren("ol_"+c)},nodePosUpdate:function(e){var a=e.id,h=e.target;if(h=="root"){this.renderAll()}else{var d=document.querySelector("#ol_"+h),f=this.getNodeById(h),i=d.querySelector(".node-children");if(i){i.innerHTML=""}this.renderChild(f.children)}if(a==h){return}if(a=="root"){this.renderAll()}else{var c=this.getNodeById(a),b=document.querySelector("#ol_"+a),g=b.querySelector(".node-children");if(g){g.innerHTML=""}this.renderChild(c.children)}},openChildren:function(e){var c=this.getNodeById(e.replace("ol_","")),b=document.querySelector("#"+e);var a=b.querySelector(".node-children");if(a){a.innerHTML=""}if(c.children.length>0){this.renderChild(c.children)}if(c.summaries&&c.summaries.length>0){this.renderChild(c.summaries)}$(a).show();var d=b.querySelector(".collapse-icon");if(d){d.classList.remove("closeIcon");d.classList.remove("openIcon");d.classList.add("openIcon")}},closeChildren:function(d){var a=document.getElementById(d),b=a.querySelector(".node-children");$(b).hide();var c=a.querySelector(".collapse-icon");if(c){c.classList.remove("openIcon");c.classList.remove("closeIcon");c.classList.add("closeIcon")}},selectNode:function(a){this.posNodeBg(a,"current");var b=$(a).parent().attr("id");if(b&&b.indexOf("search")>-1){publicSearchEvent.selectId=b.split("search_ol_")[1];$(".outline-search .dis-current").removeClass("mind-disable")}else{$(".outline-search .dis-current").addClass("mind-disable")}},posNodeBg:function(d,b){var a=null;if(b=="hover"){a=document.querySelector(".outline-hover-bg")}if(b=="current"){a=document.querySelector(".outline-curt-bg")}var c=d.getBoundingClientRect();var e=$("#outline-dlg").parent().scrollTop();a.style.top=c.top-45+e+"px";a.style.display="block";a.style.height=d.offsetHeight+"px";c=null},getNodeById:function(a){return mind.model.getTopicById(a)},getParentNodeById:function(b){if(b==null){return mind.model.topic}b=b.replace("ol_","");var a=mind.model.getTopicById(b);return mind.model.getTopicById(a.parent)},initEvent:function(){var a=this;$(document).on("click",".node-state",function(f){var d=$(this),c=d.parent().parent(),g=c.attr("id");var b=$(d.children()[0]);if(b.hasClass("openIcon")){a.closeChildren(g);b.removeClass("openIcon").addClass("closeIcon")}else{a.openChildren(g);b.removeClass("closeIcon").addClass("openIcon")}f.stopPropagation()});publicSearchEvent.init(function(d){var b=[];Outline.dataList=Outline.util.resetDataList();if(d!=""&&d.length>0){Outline.designer.style.display="none";Outline.searchDesigner.style.display="block";Outline.searchDesigner.innerHTML="";for(var c=0;c<Outline.dataList.length;c++){if(Outline.dataList[c].title.indexOf(d)>-1&&Outline.dataList[c].id!="root"){b.push(Outline.dataList[c])}}a.searchNode(b,d)}else{Outline.designer.style.display="block";Outline.searchDesigner.style.display="none";$(".outline-search .dis-total").addClass("mind-disable");$(".outline-search .dis-current").addClass("mind-disable")}})},searchNode:function(e,k){var m=document,a=Outline.opts,h=Outline.model;Outline.searchDesigner.innerHTML="";if(e.length>0){for(var f=0;f<e.length;f++){var d=null;d=m.createElement("div");d.setAttribute("class","node-element wider");d.setAttribute("id","search_ol_"+e[f].id);Outline.searchDesigner.appendChild(d);var c=m.createElement("div");c.setAttribute("class","node-self");d.appendChild(c);var b=m.createElement("span");c.appendChild(b);var g=m.createElement("span");b.appendChild(g);var l=m.createElement("div");l.setAttribute("class","node-title");if(!a.readOnly){l.setAttribute("contenteditable",true)}l.setAttribute("spellcheck","false");l.setAttribute("autocapitalize","off");var j=e[f]?e[f].title:"";j=j.replace(k,"<font color='#2C78FF'>"+k+"</font>");l.innerHTML=j.replace(/<br>/g,"&nbsp;&nbsp;");c.appendChild(l);if(a.listType=="num"){b.setAttribute("class","node-type num")}else{b.setAttribute("class","node-type dot")}mind.operation.renderEquation($(d));Outline.initNodeEvent(d)}$(".outline-search .dis-total").removeClass("mind-disable")}else{var n=m.createElement("p");n.innerHTML="暂无结果";n.style.color="#666666";n.style.paddingLeft="20px";Outline.searchDesigner.appendChild(n);$(".outline-search .dis-total").addClass("mind-disable");$(".outline-search .dis-current").addClass("mind-disable")}}},util:{newId:function(){function a(){return(((1+Math.random())*65536)|0).toString(16).substring(1)}return(a()+""+a()+""+a()+""+a())},copy:function(a){return $.extend({},a)},resetDataList:function(){var a=[];for(item in mind.model.topicList.data){a.push(mind.model.topicList.data[item])}return a},getParentId:function(d){var c=[],b=mind.model.topicList.data;function a(f){var e=b[f].parent;if(e!="root"){if(b[e].collapsed==true){c.push(e)}a(e)}}a(d);return c.reverse()},getElementIndex:function(a){var b=$(a);return b.index()},getCurrentDate:function(){var b=new Date();var a=[],c=[];a.push(b.getFullYear());a.push((b.getMonth()+1));a.push(b.getDate());c.push(b.getHours());c.push(b.getMinutes());c.push(b.getSeconds());return a.join("-")+" "+c.join(":")},moveToEnd:function(b){var a=document.getElementById(b);a.setSelectionRange(1,1)},removeAttribute:function(d,b){if(!d||!b){return}for(var c=0,a=d.length;c<a;c++){var e=d[c];e.removeAttribute(b)}},setCursorPosition:function(g,f){var d=document.getElementById("ol_"+g);if(d==null){return}var c=d.querySelector(".node-title");if(f==null){f=c.innerText.length}var a=c.childNodes[0];if(a==null){c.focus();return}var b=document.createRange();var e=window.getSelection();b.setStart(a,f);b.setEnd(a,f);b.collapse(true);e.removeAllRanges();e.addRange(b);c.focus()}}};var publicSearchEvent={searchDataList:[],currentPage:0,totalPage:0,selectId:"",searchVal:"",replaceVal:"",init:function(i){var e=this;var d=$(".po-search-con"),h=$("#outline-search-ipt"),c=$("#outline-replace-ipt"),g=d.find(".dis-current"),f=d.find(".search-del"),b=d.find(".dis-total");var a=null;h.focus().val("");c.val("");g.addClass("mind-disable");b.addClass("mind-disable");f.hide();h.off().on("input",function(j){e.searchVal=mindUI.filterXss($(this).val().trim());if(a){clearTimeout(a)}a=setTimeout(function(){if(i){poCollect("查找结果",{"来源":"思维导图","用户属性":mindUI.member?"会员用户":"普通用户"});i(e.searchVal)}e.searchNode()},500);if(e.searchVal!=""){$(this).next(".search-del").show()}else{$(this).next(".search-del").hide()}});c.off().on("input",function(j){e.replaceVal=mindUI.filterXss($(this).val().trim());if(e.replaceVal!=""){$(this).next(".search-del").show()}else{$(this).next(".search-del").hide()}});f.off().on("click",function(j){j.stopPropagation();$(this).prev("input").val("").trigger("input");$(this).hide()});$(".top-op-btn .change-btn").off("click").on("click",function(){var k=$(this);if(k.hasClass("on")){return}k.addClass("on").siblings().removeClass("on");if(k.index()==1){k.parent().addClass("on");$(".outline-retrieval").children("div").show()}else{k.parent().removeClass("on");$(".outline-retrieval").children("div").not(":first").hide()}var j=mind.util.getSelectedId();Outline.controller.selectNodeById(j)});g.off("click").on("click",function(){if(e.replaceVal==e.searchVal||$(this).hasClass("mind-disable")){return}poCollect("点击-替换",{"来源":"思维导图","用户属性":mindUI.member?"会员用户":"普通用户"});e.replacePage()});b.off("click").on("click",function(){if(e.replaceVal==e.searchVal||$(this).hasClass("mind-disable")){return}poCollect("点击-全部替换",{"来源":"思维导图","用户属性":mindUI.member?"会员用户":"普通用户"});e.replacePage("all")})},searchNode:function(){var d=this;d.searchDataList=[];var c=d.getTopicList();if(this.searchVal!=""&&this.searchVal.length>0){for(var b=0;b<c.length;b++){var a=d.getTopicById(c[b]);if(a.title.indexOf(d.searchVal)>-1){d.searchDataList.push(c[b])}}}},replacePage:function(d){var b=this;if(d=="all"){this.updateTopicNodes();return}var c=this.selectId;var a=this.getTopicById(c);this.updateTopicNode(a)},updateTopicNodes:function(){var b=this;var c=[],a=[];this.searchDataList.map(function(e,d){var f=b.getTopicById(e);oldTp=mind.util.copy(f);a.push(oldTp);f.title=f.title.replace(new RegExp(b.searchVal,"g"),b.replaceVal);c.push(f)});mind.model.updateTopicNode.call(mind,c,a,"node");b.searchNode()},updateTopicNode:function(a){if(!a){return}var c=this.searchDataList.indexOf(a.id);this.searchDataList.splice(a.id,1);var d=a.title.replace(new RegExp(this.searchVal,"g"),this.replaceVal);mind.model.updateTopicText.call(mind,a,d);if(c>this.searchDataList.length){c=1}var b=this.searchDataList[c-1];if(!b){b=this.searchDataList[c]}this.selectDom(b)},getTopicList:function(){return Object.keys(mind.model.topicList.data)},getTopicById:function(a){return mind.model.getTopicById(a)},selectDom:function(a){if(!a){return}$("#search_ol_"+a).find(".node-title").trigger("click")},};window.callback_public=function(b){poCollect("验证发布",{"名称":"发布模板-验证发布"});if(b.ret===0){var a=b.ticket;$("#signup_ticket").val(a);$("#randstr").val(b.randstr);$("#TencentCaptcha").hide();$("#btn_submit_publish").show()}};$(function(){getDef(function(a){if(a!=null&&a.theme&&a.theme.indexOf("customise_")>=0){getThemeById(a.theme,function(b){mind=new mindDesigner("#mind_con",{chartId:chartId},JSON.stringify(a),b)})}else{mind=new mindDesigner("#mind_con",{chartId:chartId},JSON.stringify(a))}})});function getDef(a){$.get("/diagraming/getdef",{id:chartId},function(c){if(c.error=="reptile"){var b=new TencentCaptcha("2046103261",function(d){if(d.ret===0){setTimeout(function(){getDef(a)},1000)}});b.show();return}else{if($.isEmptyObject(c)){location.reload()}else{a(JSON.parse(c.def))}}})};