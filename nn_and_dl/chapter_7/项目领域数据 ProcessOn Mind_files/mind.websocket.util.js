(function(){if(!("WebSocket" in window)){return}function a(){}function b(){var e=Math.random(),d=(e+new Date().getTime());return d.toString(16).replace(".","")}function c(e,p,t){var t=t||{},d=t.clientId,r=t.heartMsg||JSON.stringify({type:"PING"}),h=t.onOpen||a,s=t.onMessage||a,n=t.onClose||a,j=t.onError||a,g=t.onCatchError||a,m=t.timeoutInterval||60000,i=t.reconnectInterval||30000;this.url=e+"&clientId="+(d||b());this.maxReconnectAttempts=t.maxReconnectAttempts||5;this.reconnectAttempts=0;this.protocols=p;this.readyState=WebSocket.CONNECTING;var q=this,k=false,o=new Date().getTime(),f=false,l;this.open=function(w){try{if(f){return}l=new WebSocket(q.url,p||[]);if(w){if(this.maxReconnectAttempts&&this.reconnectAttempts>this.maxReconnectAttempts){this.close();return}}else{this.reconnectAttempts=0}var u=setTimeout(function(){l&&l.close()},m);l.onopen=function(x){clearTimeout(u);q.readyState=WebSocket.OPEN;q.reconnectAttempts=0;w=false;o=new Date().getTime();h(x);q.heartCheck.reset().start()};l.onclose=function(x){l=null;q.heartCheck.reset();if(k){q.readyState=WebSocket.CLOSED;if(f){n(x,"timeout")}else{n(x,"force")}}else{q.readyState=WebSocket.CONNECTING;setTimeout(function(){q.reconnectAttempts++;q.open(true)},i)}};l.onmessage=function(x){q.heartCheck.reset().start();if(new Date().getTime()-o>3600000){f=true;q.close()}s(x)};l.onerror=function(x){j(x)}}catch(v){g(v)}};this.send=function(u){if(l){if(JSON.parse(u).type!="PING"){o=new Date().getTime()}return l.send(u)}else{}};this.close=function(){k=true;if(l){l.close()}};this.heartCheck={timeout:15000,resetCount:0,timeoutObj:null,reset:function(){clearTimeout(this.timeoutObj);return this},start:function(){var u=this;u.timeoutObj=setTimeout(function(){q.send(r)},u.timeout)}}}window.WebSocketPo=c})();var MindWebsocketUtil={MESSAGE_TYPE:{PING:"PING",PONG:"pong",JOIN_IN:"JOIN_IN",LEAVE_OUT:"LEAVE_OUT",ONLINE_USER:"ONLINE_USER",DELIVER_MESSAGE:"_s@deliver"},doDomList:[],doListMax:1,isListDo:false,ws:null,websocketUrl:"wss://wpscb.processon.com/websocket",clientId:null,chartId:chartId,userId:userId,userName:userName||"访客",usersMap:{},collaUserList:[],init:function(){var a=this;a.clientId=a.newClientId();this.websocketInit()},makeList:function(){var b=this;if(!this.isListDo){return}var a=this.doDomList.shift();if(!a){return}console.log("get---------",a.data.msg,this.doDomList);a.fn.call(mind,a.data,function(c){mindColla.showUserOp(c,a.data.client);if(b.doDomList.length<=0){b.isListDo=false}b.makeList()})},newClientId:function(){var b=Math.random(),a=(b+new Date().getTime());return a.toString(16).replace(".","")},websocketInit:function(){var h=this,f=h.websocketUrl,e=h.usersMap,g=h.chartId,c=h.userId,d=h.userName,a=h.clientId,b;if("WebSocketPo" in window){if(location.href.indexOf("iframe")>-1){return}b=h.ws=new WebSocketPo(f+"?chartId="+g+"&userId="+c+"&userName="+encodeURIComponent(d),null,{clientId:a,reconnectInterval:1,heartMsg:JSON.stringify({type:h.MESSAGE_TYPE.PING}),onOpen:function(){h.deliverMsg({type:h.MESSAGE_TYPE.ONLINE_USER})},onMessage:function(s){var m=JSON.parse(s.data);if(m.type==h.MESSAGE_TYPE.PONG){}else{if(m.type===h.MESSAGE_TYPE.ONLINE_USER){e={};m.clients.forEach(function(i){i.online=true;if(e[i.userId]){$.extend(e[i.userId],i)}else{e[i.userId]=e}mindColla.collaUserClient[i.clientId]=i});mindColla.renderUsers(m.clients,m.type)}else{if(m.type===h.MESSAGE_TYPE.JOIN_IN){var l=m.content,p=l.userId;if(!e[p]){l.online=true;e[p]=l}mindColla.collaUserClient[l.clientId]=l;mindColla.renderUsers(l,m.type)}else{if(m.type===h.MESSAGE_TYPE.LEAVE_OUT){h.deliverMsg({type:h.MESSAGE_TYPE.ONLINE_USER});var l=m.content,p=l.userId;if(e[p]){l.online=false}$.extend(mindColla.collaUserClient[l.clientId],l);mindColla.renderUsers(l,m.type)}else{if(m.type==="forceRefresh"){mind.messageSource.excuteMsgDirect.call(mind,m,function(){})}else{if(m.type===h.MESSAGE_TYPE.DELIVER_MESSAGE){var j=m.content,r=j.msg;var o=[];for(var n=0;n<r.length;n++){var q=r[n];if(q!=null&&q.length>0){var k=q[0];if(k!=null&&"disable"==k.action){mindColla.renderOff("focus");mind.operation.setDisable.call(mind);break}else{if(k!=null&&"focus"==k.action){}}}if(j.source=="outline"){directMatch.outline.init(j);return}o.push(q)}j.msg=o;mind.messageSource.excuteMsgDirect.call(mind,j,function(i){mindColla.showUserOp(i,j.client)})}}}}}}},onClose:function(i,j){h.ws=null;if(j!=="timeout"){}},onError:function(i){h.ws=null},onCatchError:function(i){h.ws=null;$.showTip("当前浏览器不支持WebSocket，请选择其他浏览器(Chrome, FireFox, Safari)")}});b.open()}else{$.showTip("当前浏览器不支持WebSocket，请选择其他浏览器(Chrome, FireFox, Safari)")}},deliverMsg:function(b){var a=this;if(a.ws&&a.ws.readyState===WebSocket.OPEN){a.ws.send(JSON.stringify(b))}else{a.getCollaUserNum(function(c){if(c.length>0){mindColla.renderOff("colla")}})}},getCollaUserNum:function(a){$.get("https://wpscb.processon.com/online_user",{chartId:chartId},function(b){a(b)})}};MindWebsocketUtil.init();var directMatch={outline:{executing:false,mess:[],init:function(D){var J=D.msg,y=this,g=mind.model,q=g.topic;if(this.executing){this.mess.concat(J);return}this.executing=true;var u=mind.util.copyArray(this.mess.concat(J));try{for(var M=0;M<u.length;M++){var B=u[M],d=B.action;switch(d){case"add":var C=B.content,v=B.indexs,I=B.parts;if(C&&C.length>0){for(var G=0,n=C.length;G<n;G++){var t=C[G];if(t.parent=="root"){if(!I[t.id]){I[t.id]="right"}}else{var h=g.getSubTopic(t);var l=mind.util.getSelectedPart(h.id,q.structure);I[t.id]=l}}}var r={msg:[{action:"create",content:{content:C,index:v,parts:I}}],client:D.client};mind.messageSource.excuteMsgDirect.call(mind,r);break;case"update":var k=B.content,C=k.nodes,f=k.oldNodes,m=k.key;if(m=="title"){for(var G=0,n=C.length;G<n;G++){var t=C[G];var r={msg:[{action:"updateTitle",content:{content:t.id,update:t.title}}],client:D.client};mind.messageSource.excuteMsgDirect.call(mind,r)}}else{if(m=="note"||m=="tag"||m=="link"||m=="icon"||m=="style"||m=="task"){var k=B.content,z=k.nodes,f=k.oldNodes,m=k.key;var r={msg:[{action:"update",content:{content:z,original:f,type:m}}],client:D.client};mind.messageSource.excuteMsgDirect.call(mind,r)}else{if(m=="collapsed"){var r={msg:[{action:"changetopicexpand",content:{content:C[0].id,type:null}}],client:D.client};mind.messageSource.excuteMsgDirect.call(mind,r)}else{if(m=="image"){}}}}break;case"moveNode":var k=B.content,s=k.sourceId,b=k.target,p=k.source;var C=[];for(var G=0,n=s.length;G<n;G++){var c=s[G];if(!b.id&&!b[c]){continue}C.push(mind.model.getTopicById(c))}if(b.id){E(C,b)}else{for(var F=0,A=C.length;F<A;F++){var L=C[F],H=b[L.id];E([L],H)}}function E(i,e){if(e.pos){if(e.pos=="up"){e.pos="before"}if(e.pos=="down"){e.pos="after"}if(e.pos=="in"){}}var a={msg:[{action:"updatePos",content:{content:mind.util.copyArray(i),target:e,moveFromOutline:true}}],client:D.client};mind.messageSource.excuteMsgDirect.call(mind,a)}break;case"delete":var C=B.content;var r={msg:[{action:"delete",content:{content:mind.util.copyArray(C),updates:null}}],client:D.client};mind.messageSource.excuteMsgDirect.call(mind,r);break;case"open":break;case"close":break;case"indent":var k=B.content;var O=k.ids,x=k.targets,o=k.origins,P=k.type;if(O.length==0){return}var N=mind.util.copyArray(O),C=[];for(var n=N.length,G=0;G<n;G++){var w=N[G],b=x[w],t=mind.util.copy(mind.model.getTopicById(w)),H=b;if(b){if(P!="undo"){H={id:b.id,pos:"in"}}var r={msg:[{action:"updatePos",content:{content:[t],target:H,moveFromOutline:true}}],client:D.client};mind.messageSource.excuteMsgDirect.call(mind,r)}}break;case"unIndent":var k=B.content;var N=k.ids,x=k.targets,o=k.origins;if(N.length>0){N.reverse()}var O=mind.util.copyArray(N),o={};for(var G=0;G<N.length;G++){var w=N[G];var t=mind.model.getTopicById(w);if(t.parent=="root"){continue}var b={id:t.parent,pos:"after"};var r={msg:[{action:"updatePos",content:{content:[t],target:b,moveFromOutline:true}}],client:D.client};mind.messageSource.excuteMsgDirect.call(mind,r)}break}}}catch(K){}this.executing=false;this.mess=[]}}};