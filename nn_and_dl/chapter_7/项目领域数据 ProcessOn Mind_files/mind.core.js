var mindDesigner=function(g,e,f,h){this.container=$(g);this.containerId=g;this.opts=$.extend({canvasW:20000,canvasH:20000,readonly:false},e);if(h!=null){this.opts.themeDef=h}if(this.opts.chartId==null){this.opts.chartId=this.model.newId()}this.model.groupList.clearData();if(f!=null){var c=typeof(f)=="object"?f:JSON.parse(f);var b=this.util.getNewDef(c,this);this.model.topic=b}else{f=this.messageSource.checkLocalValue(this.opts.chartId);if(f!=null){var c=typeof(f)=="object"?f:JSON.parse(f);var b=this.util.getNewDef(c,this);this.model.topic=b}else{var d=this.model;d.topic=this.util.copy(d.topicDef);var a=d.topic;d.groupList.doGroup(a,d.topic.structure)}}this.styles=this.style.getThemeStyle.call(this,h);this.operation.getInvariantLineColor.call(this);this.initCanvas();this.line.renderLineCon.call(this);this.render();this.events.push("loadsuccess",this)};mindDesigner.prototype={currentRoot:null,render:function(){var b=this.model.topic;this.model.topicList.resetTopicList.call(this);this.operation.getStDef.call(this,this.model.topic.structure);this.renderTopic(b);if(typeof isView!="undefined"){this.operation.setMapSize.call(this)}var a=this;if(!a.operation.resetFlag){setTimeout(function(){a.operation.resetFlag=true;a.operation.resetEqNodePos.call(a)},500)}},renderTopic:function(a){var b=this;b.renderCenterTopic(a);b.range.rangeTopics.call(b,a);b.renderFreeTopics();b.renderFreeSummaries();b.renderFreeBoundaries();b.connection.loadConnections.call(b)},renderSubTopic:function(e,h,d,c){var g=this,b=g.summary,a=g.model;f(e,h,d,c);function f(s,v,n,t){if(!s){return}if(s.summary){if(g.model.topic.structure=="mind_tree"){return}b.renderSummaryDom(g,s,n)}else{if(s.boundary){if(g.model.topic.structure=="mind_tree"||g.model.topic.structure=="mind_org"){return}g.boundary.renderBoundaryDom(g,s,n)}else{g.renderTopicDom(s,n,v,t)}}if(s.collapsed){return}var m=s.children;var u=m.length;if(u>0){for(var r=0;r<u;r++){var l=m[r];f(l,null,n)}}if(s.summaries!=null&&s.summaries.length>0){var q=s.summaries.length;for(var p=0;p<q;p++){var o=s.summaries[p];f(o,null,n)}}if(s.boundaries!=null&&s.boundaries.length>0){var q=s.boundaries.length;for(var p=0;p<q;p++){var k=s.boundaries[p];f(k,null,n)}}}},renderFreeSummaries:function(Q,q){var H=this,c=H.model,A=c.topic,E=H.currentRoot||A,a=(A.structure=="mind_org"),R=(A.structure=="mind_tree"),m=H.util,O=H.operation.zoomVal/100;var C=E.summaries;var z=[];if(R){return}var k=H.currentRoot==null?false:true;var B=[];if(C!=null&&C.length>0){var u=E.children,J=E.leftChildren||[];var v=C.length;var a=(A.structure=="mind_org");for(var P=0;P<v;P++){var e=C[P];var t=m.copy(e);if(q!=null&&q.indexOf(t.id)>=0){continue}var o=t.range+"";var s=Number(o.indexOf(",")>0?o.split(",")[0]:o);var r=Number(o.indexOf(",")>0?o.split(",")[1]:o);var D={},L=null,d=null;if(t.part=="right"||k){L=u[s];d=u[r]}else{L=J[s];d=J[r]}if(L==null&&J[s]!=null){L=J[s];t.part="left"}if(d==null&&J[r]!=null){d=J[r];t.part="left"}if(d==null){d=u[u.length-1]}if(L==null){continue}var p=m.getTopicContainer(L.id);var M=m.getTopicContainer(d.id);var y=Math.max(p.width(),M.width());var K=Math.min(p.position().left,M.position().left);var w=-1;if(a){w=Math.max(p.position().top/O+p.height(),M.position().top/O+M.height())}for(var I=s+1;I<r;I++){var g=t.part=="left"?J[I]:u[I];if(g!=null){var l=m.getTopicContainer(g.id);y=Math.max(y,l.width());K=Math.min(K,l.position().left);if(a){w=Math.max(w,l.position().top/O+l.height())}}}var f=p.position().left/O+y+38;if(t.part=="left"){f=K/O-38}var G=p.position().top/O;var F=M.position().top/O+M.outerHeight();var b=(G+F)/2;if(a){y=(M.position().left+M.width())-p.position().left;b=w+38;f=p.position().left/O+y/2;D.x1=M.position().left/O+M.width();D.x2=p.position().left/O}D.x=f;D.y=b;D.minY=G;D.maxY=F;if(a){D.maxY=w}t.pos=m.copy(D);H.renderSubTopic(t,null,t.part||"right");var h=m.getTopicContainer(t.id);if(a){h.css("left","-="+h.width()/2+"px")}else{h.css("top","-="+h.height()/2+"px");if(t.part=="left"){h.css("left","-="+h.width()+"px")}}var N=h.children(".topic-box");var n;if(a){n={x:h.outerWidth()/2,y:N.outerHeight(),h:N.outerHeight()}}else{if(R){n={x:9,y:N.outerHeight(),h:N.outerHeight()}}else{if(t.part=="left"){n={x:h.outerWidth()-N.outerWidth(),y:h.outerHeight()/2-0.5,h:N.outerHeight()}}else{n={x:N.outerWidth(),y:h.outerHeight()/2-0.5,h:N.outerHeight()}}}}H.line.renderLines.call(H,t,n,t.part);B.push(t)}H.summary.renderFreeSummariesShape.call(H,B,a,E)}},renderFreeBoundaries:function(M,l){var D=this,b=D.model,v=b.topic,z=D.currentRoot||v,a=(v.structure=="mind_org"),N=(v.structure=="mind_tree"),g=D.util,K=D.operation.zoomVal/100;var y=z.boundaries;var u=[];if(N||a){return}var e=D.currentRoot==null?false:true;var C=[];if(y!=null&&y.length>0){var o=z.children,F=z.leftChildren||[];var p=y.length;for(var L=0;L<p;L++){var s=y[L];var J=g.copy(s);if(l!=null&&l.indexOf(J.id)>=0){continue}var h=J.range+"";var n=Number(h.indexOf(",")>0?h.split(",")[0]:h);var m=Number(h.indexOf(",")>0?h.split(",")[1]:h);var w={},H=null,c=null;if(J.part=="right"||e){H=o[n];c=o[m]}else{H=F[n];c=F[m]}if(H==null&&F[n]!=null){H=F[n];J.part="left"}if(c==null&&F[m]!=null){c=F[m];J.part="left"}if(c==null){c=o[o.length-1]}if(H==null){continue}var k=g.getTopicContainer(H.id);var I=g.getTopicContainer(c.id);var t=Math.max(k.width(),I.width());var G=Math.min(k.position().left,I.position().left);var r=-1;for(var E=n+1;E<m;E++){var d=J.part=="left"?F[E]:o[E];if(d!=null){var f=g.getTopicContainer(d.id);t=Math.max(t,f.width());G=Math.min(G,f.position().left)/K}}var B=k.position().top/K;var A=I.position().top/K+I.outerHeight();var q=Number(D.boundary.boundsSpace)+Number(J.style&&J.style.lineWidth||D.boundary.model.styles.lineWidth)/2;w.minx=G-q;w.miny=B-q;w.maxX=G+t+q;w.maxY=A+q;J.pos=g.copy(w);D.renderSubTopic(J,null,J.part||"right");D.line.renderLines.call(D,J,null,J.part);C.push(J)}D.boundary.renderFreeBoundariesShape.call(D,C,a,z)}},renderFreeTopics:function(){var g=this,c=g.model,f=g.summary,t=g.boundary,q=c.groupList,o=c.topic,e=(o.structure=="mind_org"),l=(o.structure=="mind_tree"),a=g.util,h=g.line;if(q.freeList.length){for(var r=0,s=q.freeList.length;r<s;r++){var p=q.freeList[r];b(p);var m=a.getSelectedPart(p.id,o.structure);var d=a.getTopicContainer(p.id);var k=d.children(".topic-box");var n;if(e){n={x:d.outerWidth()/2,y:k.outerHeight(),h:k.outerHeight()}}else{if(l){n={x:9,y:k.outerHeight(),h:k.outerHeight()}}else{if(m=="left"){n={x:d.outerWidth()-k.outerWidth(),y:d.outerHeight()/2-0.5,h:k.outerHeight()}}else{n={x:k.outerWidth(),y:d.outerHeight()/2-0.5,h:k.outerHeight()}}}}h.renderLines.call(g,p,n,m)}}function b(C,x,D){if(C.summary){if(!l){f.renderSummaryDom(g,C,x)}}else{if(C.boundary){t.renderBoundaryDom(g,C,x)}else{g.renderTopicDom(C,x,null,D)}}if(C.collapsed){return}var w=C.children,E=w.length;if(E>0){for(var B=0;B<E;B++){var v=w[B];b(v,x)}}if(C.summaries!=null&&C.summaries.length>0){var A=C.summaries.length;for(var z=0;z<A;z++){var y=C.summaries[z];b(y,x)}}if(C.boundaries!=null&&C.boundaries.length>0){var A=C.boundaries.length;for(var z=0;z<A;z++){var u=C.boundaries[z];b(u,x)}}}},renderTopics:function(c,b){var e=this,a=e.summary;d(c,b);function d(o,h){if(o.collapsed){return}var g=o.children,p=g.length;if(p>0){for(var n=0;n<p;n++){var f=g[n];e.renderTopicDom(f,h);d(f,h)}}if(o.summaries!=null&&o.summaries.length>0){var m=o.summaries.length;for(var l=0;l<m;l++){var k=o.summaries[l];d(k,h)}}}},renderTopicDom:function(B,A,o,g){var i=this,b=i.util,d=i.designer,c=this.model,D=i.operation,C=i.currentRoot||c.topic,y=C.structure||c.topic.structure,l=this.styles;var v=b.getMargin.call(i);var h=v.childMarginW,z=v.childMarginH;var t=$("#"+B.id);if(t.length>0){t.parent().remove()}var e=y=="mind_org",x=y=="mind_tree";var E=B.title.replace(/\n/g,"<br>").replace(/\&lt;br\&gt;/g,"<br>"),r="";if(e){r="org";z=40}else{if(x){r="tree";z=26}}t=$("<div class='topic-container "+r+"'><div id='"+B.id+"' class='topic-box'><div class='topic'>"+E+"</div></div></div>");var p=t.children(".topic-box");if(!B.root&&B.parent!=C.id){var k="topic-children";var u=$("#"+B.parent).parent(),n=u.children("."+k);if(n.length==0){n=$("<div class='"+k+"'></div>");if(A=="left"){n.prependTo(u);if(!e&&!x){n.css("margin-right",h+16)}else{if(x){n.css("margin-right",20)}}}else{n.appendTo(u);if(!e&&!x){n.css("margin-left",h+16)}else{if(x){n.css("margin-left",20)}}}}t.css("margin-top",z);if(g!=null){var s=g-1;if(s>=0){if(o!=null&&o.summaries!=null&&o.summaries.length>0){var a=o.children[s];var w=b.getTopicContainer(a.id);if(w.parent().parent().hasClass("summary-con")){var f=w.parent().parent().index();var m=w.parent().children().length-1;if(g>=(f+m)){w.parent().parent().after(t)}else{n.append(t)}}else{w.after(t)}}else{var w=n.children().eq(g-1);w.after(t)}}else{if(s<0){if(o!=null&&o.summaries!=null&&o.summaries.length>0){var w=n.children().eq(0);if(w.length>0&&w.parent().parent().hasClass("summary-con")){n.append(t)}else{n.prepend(t)}}else{n.prepend(t)}if(t.next().css("margin-top")=="0px"){t.next().css("margin-top",z)}}}}else{t.appendTo(n)}if(A=="left"){t.addClass("part_left")}}else{p.attr("sub",true);if(B.pos){t.css("position","absolute").appendTo(d);t.css({left:B.pos.x,top:B.pos.y});p.addClass("free")}else{t.css("position","absolute").prependTo(d)}i.line.renderSubLineCon(t,B.id)}D.renderTopicImage(B);var q=i.style.getStyle.call(i,B);this.renderTopicStyle(p,B,q,l);i.icons.renderTopicIcons(b,B,A);i.remark.renderTopicNote(b,B,A);D.renderTopicLink(b,B,A);i.tags.renderTopicTag(b,B,A);i.task.renderTopicTask(b,B,A);i.operation.updateNumber.call(i,B);if(o!=null){this.renderTopicExpand(o,$("#"+o.id),A,q);if(B.children.length>0){this.renderTopicExpand(B,p,A,q)}}else{this.renderTopicExpand(B,p,A,q)}i.operation.renderEquation(t);return t},renderCenterTopic:function(c){var b=this.model;this.renderTopicDom(c);var d=this.opts,a=b.getTopicDomById(c.id);a.css({left:(d.canvasW-a.width())/2,top:d.canvasH/2-a.height()-30})},renderTopicStyle:function(b,g,i,n){i["font-family"]=i["font-family"]||i.family;i["font-style"]=i["font-style"]!=null?i["font-style"]:i.italic?"italic":"normal";i["font-weight"]=i["font-weight"]!=null?i["font-weight"]:i.bold?"bold":"normal";if(i["border-style"]!=null&&i["border-width"]==null){i["border-width"]="0px"}b.removeAttr("style");b.css(i);if(i["text-decoration"]!=null&&i["text-decoration"]!="none"){b.children(".topic").css("text-decoration",i["text-decoration"])}else{b.children(".topic").removeAttr("style")}if(n&&n.thinner&&i.lineStyle!=null&&i.lineStyle.underLine){var d=i.lineStyle.randomLineColor;var c=d||this.style.getLineColor();b.css("border-bottom-color",c)}if(n&&n.autoColor&&n.unilateral&&g.parent=="root"&&i.lineStyle!=null){var h=this.model,m=this.currentRoot||h.topic;var d=i.lineStyle.randomLineColor;var c=d||this.style.getLineColor(m);if(g.summary){var l=i.lineStyle.lineColor||c;var p=i.lineStyle&&i.lineStyle.lineWidth+"px",a=p+" solid "+l;if(!i["border-style"]&&!i["border-width"]&&!i["border-color"]){b.css({"border-bottom":a})}}if(g.free){var f=i.lineStyle.lineColor||c;var p=i.lineStyle&&i.lineStyle.lineWidth+"px",a=p+" solid "+f;if(!i["border-style"]&&!i["border-width"]&&!i["border-color"]){b.css({"border-bottom":a,"box-sizing":"border-box"})}}}if(n&&n.autoColor&&n.unilateral&&g.summary&&g.parent!="root"&&i.lineStyle!=null){var k=this,e=k.util;var o=k.model.getTopicById(g.parent);var c=i.lineStyle.lineColor||e.getPtLineColor.call(k,o);if(c&&!i["border-width"]){var p=i.lineStyle&&i.lineStyle.lineWidth+"px",a=p+" solid "+c;b.css({"border-bottom":a})}}},renderTopicExpand:function(e,d,a,g){var h=e.children.length;if(h<1||e.root){return}var i=d.find("span.expand_box");if(i.length>0){return}i=$("<span class='expand_box mind-icons'>&#xe7bb;</span>").appendTo(d);if(e.collapsed){i.html("&#xe647;").addClass("hide")}var f=this.model,k=this.currentRoot||f.topic,c=f.topic.background||this.styles.background;if(a=="left"){i.addClass("left")}var l={};if(k.structure=="mind_org"||k.structure=="mind_tree"){l={backgroundColor:c,top:d.outerHeight()+2}}else{l={top:(d.outerHeight()-i.outerHeight()*0.9)/2-1,backgroundColor:c}}if(g!=null){var b=g.lineStyle;if(b&&b.lineColor){l.color=b.lineColor}}i.css(l)},resetTopicExpandPos:function(b,a){var c=b.find(".expand_box");if(a=="mind_org"){c.css({top:b.outerHeight()+2})}else{if(a=="mind_tree"){}else{c.css({top:(b.outerHeight()-c.outerHeight())/2-0.5})}}},range:{rangeTopics:function(F){var O=this,E=O.opts,H=O.operation,b=O.model,f=O.util,l=O.line,B=F.structure||b.topic.structure,m=b.groupList,I=O.styles,T=H.zoomVal/100;var N=f.getTopicDomProp(F.id,T);m.doGroup(F,B);if(B=="mind"||B=="mind_right"||B=="mind_free"){var V=F.leftChildren||[],q=m.rightList;var d=f.getMargin.call(O);var J=V.length,L=q.length,w=0,z=0,e=d.marginW,u=d.marginH;var A=O.boundary.boundsSpace,a={start:[],end:[]},S=F.boundaries||[],D=S.length;if(D>0){for(var X=0;X<D;X++){var n=S[X],t=n.part,h=n.range,r=h.indexOf(",")==-1?h:h.split(",")[0],p=h.indexOf(",")==-1?h:h.split(",")[1];var G=t=="left"?V[r]:q[r],K=t=="left"?V[p]:q[p];if(!G||!K||G<0||K<0){continue}a.start.push(G.id);a.end.push(K.id);if(t=="left"){w+=A*2}else{z+=A*2}}}var U={};if(J>0){for(var X=0;X<J;X++){var Y=V[X];O.renderSubTopic(Y,null,"left");var c=f.getTopicContainer(Y.id);w+=I.underLine?Math.floor(c[0].getBoundingClientRect().height/T):c.outerHeight();if(X<J-1){w+=u}U[Y.id]=c}}var o={};for(var X=0;X<L;X++){var Y=q[X];O.renderSubTopic(Y,null,"right");var c=f.getTopicContainer(Y.id);z+=I.underLine?Math.floor(c[0].getBoundingClientRect().height/T):c.outerHeight();if(X<L-1){z+=u}o[Y.id]=c}var Q=N.x+N.w+e,P=Math.round(N.y+(N.h-z)/2);var C={x:N.x+N.w/2,y:N.y+N.h/2};for(var X=0;X<L;X++){var Y=q[X],M=Y.id;var aa=Y.margin,R=aa&&aa.marginW?aa.marginW:0,Z=aa&&aa.marginH?aa.marginH:0;var s=P;if(a.start.indexOf(M)>-1){s+=A}if(I.underLine){s-=14}var c=o[Y.id];c.css({top:s,left:Q+R});var v={x:Q+R,y:Math.round(s+c.outerHeight()/2)};l.renderSubLine.call(O,Y,F,C,v,"right");if(Y.children.length>0||(Y.summaries!=null&&Y.summaries.length>0)){var W=c.children(".topic-box");var g={x:W.outerWidth(),y:Math.round(c.outerHeight()/2),h:W.outerHeight()};l.renderLines.call(O,Y,g,"right")}P+=u+Z+c.outerHeight();if(a.end.indexOf(M)>-1&&X<L-1){P+=A}}if(J>0){Q=N.x-e,P=Math.round(N.y+(N.h-w)/2);for(var X=0;X<J;X++){var Y=V[X],M=Y.id;var aa=Y.margin,R=aa&&aa.marginW?aa.marginW:0,Z=aa&&aa.marginH?aa.marginH:0;var s=P;if(a.start.indexOf(M)>-1){s+=A}if(I.underLine){s-=14}var c=U[Y.id];c.css({top:s,right:E.canvasW-Q+R});var v={x:Q-R,y:s+c.outerHeight()/2};l.renderSubLine.call(O,Y,F,C,v,"left");if(Y.children.length>0||(Y.summaries!=null&&Y.summaries.length>0)){var W=c.children(".topic-box");var g={x:W.position().left,y:Math.floor(c.outerHeight()/2),h:W.outerHeight()};l.renderLines.call(O,Y,g,"left")}P+=u+Z+c.outerHeight();if(a.end.indexOf(M)>-1&&X<J-1){P+=A}}}}else{if(B=="mind_org"){var q=m.rightList;var L=q.length,k=0,e=I.marginW,u=I.marginH;var o={};for(var X=0;X<L;X++){var Y=q[X];O.renderSubTopic(Y,null,"right");var c=f.getTopicContainer(Y.id);o[Y.id]=c}var C={x:N.x+N.w/2,y:N.y+N.h};var Q=C.x,P=N.y+N.h+u*2;for(var X=0;X<L;X++){var Y=q[X];var c=o[Y.id];c.css({top:P,left:Q});k+=c.outerWidth();if(X!=L-1){k+=e/2}}Q-=k/2;for(var X=0;X<L;X++){var Y=q[X];var c=o[Y.id];c.css({left:Q});var v={x:Q+c.outerWidth()/2,y:P};l.renderSubLine.call(O,Y,F,C,v,"right");if(Y.children.length>0||(Y.summaries!=null&&Y.summaries.length>0)){var W=c.children(".topic-box");var g={x:c.outerWidth()/2,y:W.outerHeight(),h:W.outerHeight()};l.renderLines.call(O,Y,g,"right")}Q+=c.outerWidth()+e/2}}else{if(B=="mind_tree"){var q=m.rightList;var L=q.length,k=0,e=I.marginW,u=I.marginH;var o={};for(var X=0;X<L;X++){var Y=q[X];O.renderSubTopic(Y,null,"right");var c=f.getTopicContainer(Y.id);o[Y.id]=c}var C={x:N.x+N.w/2,y:N.y+N.h};var Q=C.x,P=N.y+N.h+u*2;for(var X=0;X<L;X++){var Y=q[X];var c=o[Y.id];c.css({top:P,left:Q});k+=c.outerWidth();if(X!=L-1){k+=e/2}}Q-=k/2;for(var X=0;X<L;X++){var Y=q[X];var c=o[Y.id];c.css({left:Q});var v={x:Q+c.children(".topic-box").outerWidth()/2,y:P};l.renderSubLine.call(O,Y,F,C,v,"right");if(Y.children.length>0){var W=c.children(".topic-box");var g={x:10,y:W.outerHeight(),h:W.outerHeight()};l.renderLines.call(O,Y,g,"right")}Q+=c.outerWidth()+e/2}}}}},changeOrgTopicPos:function(k,r,p,s,h,o,w){var e=k.model,q=k.currentRoot||e.topic,u=e.groupList,v=u.rightList.length,b=k.util,a=k.operation.zoomVal/100;var d=b.getTopicDomProp(q.id,a);var n=u.rightList,z=0,A={};var g={x:d.x+d.w/2,y:d.y+d.h};var m=g.x,l=d.y+d.h+w*2;for(var t=0;t<v;t++){var c=n[t];var f=b.getTopicContainer(c.id);A[c.id]=f;f.css({top:l,left:m});z+=f.outerWidth();if(t!=v-1){z+=o/2}}m-=z/2;for(var t=0;t<v;t++){var c=n[t];var f=A[c.id];f.css({left:m});m+=f.outerWidth()+o/2}},changeTopicPos:function(i,w,t,u,x){var d=i.model,n=i.opts,v=i.currentRoot||d.topic,g=(v.structure=="mind_org"),r=(v.structure=="mind_tree"),b=i.util,e,B=0,k=i.styles,l=i.operation,a=l.zoomVal/100;var p=i.util.getMargin.call(i);var o=p.marginW,C=p.marginH;if(g||r){this.changeOrgTopicPos(i,w,t,x,g,o,C);return}if(w.id!=t.id){e=b.getTopicContainer(t.id);B=(e.outerHeight()-x.h)/2;if(B<=0){return}}else{e=b.getTopicContainer(w.id);B=(e.outerHeight()+C)/2}if(t.free){e.css({top:"-="+B});return}if(u=="right"){var z=d.groupList,A=z.rightList.length;var c;if(A==1){c=b.getTopicDomProp(v.id,a);e.css({left:c.x+c.w+o,top:Math.round(c.y+(c.h-e.outerHeight())/2)});return}else{var q=d.getPrevTopicWithoutFree(t);var m;if(q==null){if(t.id==w.id){var s=d.getNextTopic(t);c=b.getTopicDomProp(s.id,a);if(c==null){c=b.getTopicDomProp(v.id,a);c.x=c.x+c.w+o;m=c.y+(c.h-e.outerHeight())/2}else{m=c.y-B}}else{c=b.getTopicDomProp(t.id,a);m=c.y-B}}else{c=b.getTopicDomProp(q.id,a);m=c.y+c.h+C-B}e.css({left:c.x,top:Math.round(m)})}i.range.doChangeSubTopicPos(i,t,B,0,u)}else{if(u=="left"){var f=v.leftChildren,A=f.length;var c;if(A==1){c=b.getTopicDomProp(v.id,a);e.css({right:n.canvasW-c.x+o,top:Math.round(c.y+(c.h-e.outerHeight())/2)});return}else{var q=d.getPrevTopicWithoutFree(t,u);var m;if(q==null){if(t.id==w.id){var s=d.getNextTopic(t,u);c=b.getTopicDomProp(s.id,a);m=c.y-B}else{c=b.getTopicDomProp(t.id,a);m=c.y-B}}else{c=b.getTopicDomProp(q.id,a);m=c.y+c.h+C-B}e.css({right:n.canvasW-c.x-c.w,top:Math.round(m)})}i.range.doChangeSubTopicPos(i,t,B,0,u)}}return B},doChangeOrgSubTopicPos:function(n,a,k,r,d,b){var l=n.util,t=Math.abs;if(a.root){var c=l.getTopicContainer(a.id);if(k>0){c.css("top","-="+t(k)*2)}else{if(k<0){c.css("top","+="+t(k)*2)}}if(r>0){c.css("left","-="+t(r)/2)}else{if(r<0){c.css("left","+="+t(r)/2)}}return}if(a.free){return}if(r==0){return}var g=n.model,p=n.currentRoot||g.topic,l=n.util,o=g.groupList.rightList;var e=true;var m=o.length;for(var f=0;f<m;f++){var q=o[f];if(q.id==a.id){e=false;var s=l.getTopicContainer(q.id);if(r<0){s.css("left","-="+r/2)}else{s.css("left","-="+r/2)}continue}var s=l.getTopicContainer(q.id);if(e){s.css("left","-="+r/2)}else{if(!e){s.css("left","+="+r/2)}}}},doChangeSubTopicPos:function(e,f,r,g,n,k){var a=e.util,c=e.model,o=e.currentRoot||c.topic;if(o.structure=="mind_org"||o.structure=="mind_tree"){this.doChangeOrgSubTopicPos(e,f,r,g,n,k);return}if(f.root){var d=a.getTopicContainer(f.id),m=f.leftChildren||[];if(r>0){d.css("top","-="+Math.abs(r))}else{if(r<0){d.css("top","+="+Math.abs(r))}}if(g>0){d.css("left","-="+Math.abs(g));if(m.length>0){for(var p=0,q=m.length;p<q;p++){var l=m[p];var s=a.getTopicContainer(l.id);s.css("right","+="+Math.abs(g))}}}else{if(g<0){d.css("left","+="+Math.abs(g));if(m.length>0){for(var p=0,q=m.length;p<q;p++){var l=m[p];var s=a.getTopicContainer(l.id);s.css("right","-="+Math.abs(g))}}}}return}if(r==0){return}if(f.free){var d=e.util.getTopicContainer(f.id);d.css("top","-="+r);return}var c=e.model,o=e.currentRoot||c.topic,a=e.util,t=c.groupList.rightList;var v=true;if(n=="left"){t=o.leftChildren}var q=t.length;for(var p=0;p<q;p++){var b=t[p];if(b.id==f.id){v=false;if(r<0||k){var u=a.getTopicContainer(b.id);u.css("top","-="+r)}continue}var u=a.getTopicContainer(b.id);if(v){u.css("top","-="+r)}else{if(!v){u.css("top","+="+r)}}}},resetSubTopics:function(s){var M=this,b=M.model,F=this.currentRoot||b.topic,H=M.operation,Q=H.zoomVal/100,E=M.opts,h=M.util,m=M.line,B=F.structure,n=b.groupList,I=M.styles;var L=h.getTopicDomProp(F.id,Q);if(F.children.length==0&&F.leftChildren==null){return}var e=M.util.getMargin.call(M);var A=n.rightList;if(s=="left"){A=F.leftChildren||[]}var v=A.length,R=0,t=e.marginH,g=e.marginW;var w=M.boundary.boundsSpace,a={start:[],end:[]},P=F.boundaries||[],C=P.length;if(C>0){for(var S=0;S<C;S++){var o=P[S],k=o.range,d=o.part,q=k.indexOf(",")==-1?k:k.split(",")[0],p=k.indexOf(",")==-1?k:k.split(",")[1];var G=A[q],J=A[p];if(!G||!J||G<0||J<0||d!=s){continue}a.start.push(G.id);a.end.push(J.id);R+=w*2}}var z={};if(v>0){for(var S=0;S<v;S++){var T=A[S];if(T.pos!=null||T.summary){continue}var f=h.getTopicContainer(T.id);R+=I.underLine?Math.floor(f[0].getBoundingClientRect().height/Q):f.outerHeight();if(S<v-1){R+=t}z[T.id]=f}}var D={x:L.x+L.w/2,y:L.y+L.h/2},N=Math.round(L.y+(L.h-R)/2);if(s=="left"){var O=L.x-g;for(var S=0;S<v;S++){var T=A[S],K=T.id;var r=N;if(T.pos!=null||(F.id==T.parent&&T.summary)){continue}if(a.start.indexOf(K)>-1){r+=w}if(I.underLine){r-=14}var f=z[T.id];f.css({top:r,right:E.canvasW-O});var u={x:O,y:r+f.outerHeight()/2};m.renderSubLine.call(M,T,F,D,u,"left");N+=t+f.outerHeight();if(a.end.indexOf(K)>-1&&S<v-1){N+=w}}M.renderFreeBoundaries(s)}else{if(B=="mind_tree"||B=="mind_org"){var D={x:L.x+L.w/2,y:L.y+L.h};var O=D.x,N=L.y+L.h+t*2,l=0;for(var S=0;S<v;S++){var T=A[S];if(T.pos!=null||(F.id==T.parent&&T.summary)){continue}var f=z[T.id];l+=f.outerWidth();if(S!=v-1){l+=g/2}}O-=l/2;for(var S=0;S<v;S++){var T=A[S];if(T.pos!=null){continue}var f=z[T.id];f.css({left:O,top:N});var c=f.children(".topic-box");var u={x:O+c.position().left+c.outerWidth()/2,y:N};m.renderSubLine.call(M,T,F,D,u,"right");O+=f.outerWidth()+g/2}}else{var O=L.x+L.w+g;for(var S=0;S<v;S++){var T=A[S],K=T.id;if(T.pos!=null||(F.id==T.parent&&T.summary)){continue}var r=N;if(a.start.indexOf(K)>-1){r+=w}if(I.underLine){r-=14}var f=z[T.id];f.css({top:r,left:O});var u={x:O,y:r+f.outerHeight()/2};m.renderSubLine.call(M,T,F,D,u,s);N+=t+f.outerHeight();if(a.end.indexOf(K)>-1&&S<v-1){N+=w}}M.renderFreeBoundaries(s)}}}},initCanvas:function(){var b=this.container,c=this.model.topic,f=this.opts,e=this.styles,a=$(window).height();b.css({height:f.height?f.height:a-b.siblings("div:visible:not(.embeditem)").height()});var d=$("<div class='mind-designer'></div>").appendTo(b);d.css({width:f.canvasW,height:f.canvasH});this.designer=d;this.operation.moveToCenter.call(this);this.operation.setBackground.call(this);this.initEvent();this.boundary.init.call(this)},initEvent:function(){var g=this,n=g.opts,l=g.operation,a=g.util,d=g.model,q=d.topic,f=g.connection,t=0;$(document).off("mousedown.dragmove").on("mousedown.dragmove",function(z){var w=z.pageX,A=z.pageY;t=0;if((z.ctrlKey||z.metaKey)&&g.plugins.presenter.beforeSelecting){if(g.plugins.presenter.selecting==false){g.plugins.presenter.selecting=true;g.plugins.presenter.initEvent(g,w,A,z)}return}if(z.button==2){return}g.events.push("hideMenu");if(z.ctrlKey||z.metaKey){l.selectingBox.call(g,z);return}var v=g.container.scrollTop();var u=g.container.scrollLeft();$(document).on("mousemove.dragmove",function(y){var x=y.pageX-w,B=y.pageY-A;if(Math.abs(x)>6||Math.abs(B)>6){g.container.scrollLeft(u-x);g.container.scrollTop(v-B)}});$(document).on("mouseup.dragmove",function(x){$(document).off("mousemove.dragmove");$(document).off("mouseup.dragmove");g.plugins.navigator.renderViewport()})});$(document).off("click.expand").on("click.expand",".expand_box",function(w){$(document).off("mousemove.dragmove");$(document).off("mouseup.dragmove");var v=$(this);var u=v.parent(),x=u.attr("id");g.operation.showOrHideChildren.call(g,x);$(".resize-boundary").remove();$(".boundary-dot").remove();w.stopPropagation()});$(document).off("dblclick.expand").on("dblclick.expand",".expand_box",function(u){u.stopPropagation()});var i=0,h=0,o=false,r=null;$(document).off("mousemove.mouse").on("mousemove.mouse",function(u){if(!o){i=u.pageX,h=u.pageY}});g.designer.on("mousewheel DOMMouseScroll",function(z){var w=z.originalEvent.wheelDelta||-z.originalEvent.detail;var C=Math.max(-1,Math.min(1,w));if(z.ctrlKey||z.metaKey){o=true;z.preventDefault();var u=g.container.scrollLeft()+i;var B=g.container.scrollTop()+h;var v=u/g.opts.canvasW*100+"% "+B/g.opts.canvasH*100+"%";if(C<0){var A=g.operation.zoomVal-=5;g.operation.tochZoom.call(g,g.designer,A,v);$(".mind-zoomtxt").text(A+"%")}else{var A=g.operation.zoomVal+=5;g.operation.tochZoom.call(g,g.designer,A,v);$(".mind-zoomtxt").text(A+"%")}if(r==null){r=setTimeout(function(){o=false;r=null},200)}}else{g.plugins.navigator.renderViewport()}});document.addEventListener("gesturestart",function(u){u.preventDefault()});if(navigator.userAgent.indexOf("Mac OS")>0){g.designer[0].removeEventListener("gesturestart",c);g.designer[0].removeEventListener("gesturechange",b);g.designer[0].removeEventListener("gestureend",k);var e=0;function c(u){e=Math.round(u.scale*100);u.preventDefault()}function b(x){var u=Math.round(x.scale*100),v=0;v=u-e;if(Math.abs(v)>=5){if(v<0){var w=g.operation.zoomVal-=5;if(w<40){w=40}g.operation.tochZoom.call(g,g.designer,w);$(".mind-zoomtxt").text(w+"%")}else{if(v>0){var w=g.operation.zoomVal+=5;if(w>200){w=200}g.operation.tochZoom.call(g,g.designer,w);$(".mind-zoomtxt").text(w+"%")}}e=u}x.preventDefault()}function k(u){u.preventDefault()}g.designer[0].addEventListener("gesturestart",c,false);g.designer[0].addEventListener("gesturechange",b,false);g.designer[0].addEventListener("gestureend",k,false)}if(g.opts.readonly){return}$(window).on("resize.canvas",function(x){var u=$(window).height(),w=$(window).width();var v=g.container;v.css({height:g.opts.height?g.opts.height:u-v.siblings("div:visible").height()})});var s="",t=0;$(document).off("keydown.hotkey").on("keydown.hotkey",function(D){if(g.opts.readonly||t>3){g.plugins.presenter.keyEvent(D,g);if(t>3){D.preventDefault()}return}if(l.draging){return}t++;var v=D.keyCode;if(v==13){l.appendTopic.call(g,false);var A=g.util.getSelectedId();if(A.length==0){return}l.editTopicDom.call(g,A);g.model.poPasteType="editpaste";D.preventDefault()}else{if(v==45||v==9){D.preventDefault();var B=g.util.getSelectedId();if(B.length==0){return}l.appendTopic.call(g,true);var A=g.util.getSelectedId();l.editTopicDom.call(g,A);g.model.poPasteType="editpaste"}else{if(v==27){l.closeTip();$(".topic-box.cut_related").removeClass("cut_related");D.preventDefault()}else{if(v==46||v==8){if(s!=""){l.removeTopicImage.call(g,s);s=""}else{if(f.currentLine){f.deleteConnection(g,f.currentLine)}if($("#resize-boundary-box").length>0){var x=$("#resize-boundary-box").attr("for");var u=d.getTopicById(x);g.boundary.model.removeBoundary.call(g,[u]);return}var B=g.util.getSelectedId();if(B.length==0||B==""){return}if(D.ctrlKey||D.metaKey){l.removeTopicSelf.call(g)}else{l.removeTopic.call(g)}}D.preventDefault()}else{if(v==37){if(D.ctrlKey||D.metaKey){t--;var y=g.container.scrollLeft();g.container.scrollLeft(y-10);D.preventDefault();return}if(g.plugins.presenter.presenting){g.plugins.presenter.prevSlide(g);return}var C=d.getNearTopic.call(g,"left");if(C!=null){a.selectOne.call(g,C);D.preventDefault()}}else{if(v==38||v==36){if(D.ctrlKey||D.metaKey){t--;var y=g.container.scrollTop();g.container.scrollTop(y-10);D.preventDefault();return}var C=d.getNearTopic.call(g,"up");if(C!=null){a.selectOne.call(g,C);D.preventDefault()}if(v==36){D.preventDefault()}}else{if(v==39){if(D.ctrlKey||D.metaKey){t--;var y=g.container.scrollLeft();g.container.scrollLeft(y+10);D.preventDefault();return}if(g.plugins.presenter.presenting){g.plugins.presenter.nextSlide(g);return}var A=g.util.getSelectedId();var C=d.getNearTopic.call(g,"right");if(C!=null){a.selectOne.call(g,C);D.preventDefault()}}else{if(v==40||v==35){if(D.ctrlKey||D.metaKey){t--;var y=g.container.scrollTop();g.container.scrollTop(y+10);D.preventDefault();return}var C=d.getNearTopic.call(g,"down");if(C!=null){a.selectOne.call(g,C);D.preventDefault()}if(v==35){D.preventDefault()}}else{if(v==32){var A=a.getSelectedId();D.preventDefault();if(A!=""){l.editTopicDom.call(g,A);g.model.poPasteType="editpaste"}}else{if(v==67&&(D.ctrlKey||D.metaKey)){var A=a.selectedIds;if(A.length>0){d.doCopy.call(g,A)}D.preventDefault()}else{if(v==65&&(D.ctrlKey||D.metaKey)){g.util.selectById.call(g,"root");D.preventDefault()}else{if(v==88&&(D.ctrlKey||D.metaKey)){var A=a.selectedIds;if(A.length>0){var F=$(".topic-box.selected").map(function(){return $(this).attr("id")}).get();d.doCut.call(g,F)}D.preventDefault()}else{if(v==86&&(D.ctrlKey||D.metaKey)){t=0;var A=a.getSelectedId();d.poPasteType="node";if(A!=""){if(document.activeElement.getAttribute("id")==null){g.operation.editTopicDomInit.call(g,A)}}else{D.preventDefault();$.showTip("请选择主题后，再进行粘贴",1200)}}else{if(v==83&&(D.ctrlKey||D.metaKey)){if(D.ctrlKey||D.metaKey){g.events.push("saveOnline");D.preventDefault()}}else{if(v==90&&(D.ctrlKey||D.metaKey)){D.preventDefault();t=0;if(D.shiftKey){g.messageSource.redo(g);return}g.messageSource.undo(g)}else{if(v==89&&(D.ctrlKey||D.metaKey)){D.preventDefault();t=0;g.messageSource.redo(g)}else{if((v==221||v==219)&&(D.ctrlKey||D.metaKey)){D.preventDefault();if(g.opts.readonly){return}var A=a.selectedIds;if(A.length>0){g.summary.addSummary.call(g,A)}}else{if(v==17||v==91){D.preventDefault()}else{if(v==66&&(D.ctrlKey||D.metaKey)){var A=a.getSelectedId();if(A!=""){var E=d.getTopicById(A);if(E.style==null){mind.operation.setStyle.call(mind,{"font-weight":"bold"})}else{if(E.style.bold!=null&&E.style.bold==false){mind.operation.setStyle.call(mind,{"font-weight":"bold"})}else{if(E.style["font-weight"]=="normal"||E.style["font-weight"]==null){mind.operation.setStyle.call(mind,{"font-weight":"bold"})}else{mind.operation.setStyle.call(mind,{"font-weight":"normal"})}}}}D.preventDefault()}else{if(v==70&&D.altKey){return;var A=g.util.getSelectedId();if(A!=""){if(A!=g.model.topic.id){g.operation.focusTopic.call(g,A)}}D.preventDefault()}else{if(v==71&&(D.ctrlKey||D.metaKey)){g.events.push("initBrash");D.preventDefault()}else{if(v==82&&(D.ctrlKey||D.metaKey)){D.preventDefault();g.events.push("showRightMenu","remark")}else{if(v==84&&(D.ctrlKey||D.metaKey)){D.preventDefault()}else{if(v==75&&(D.ctrlKey||D.metaKey)){D.preventDefault();g.events.push("showRightMenu","link")}else{if(v==73&&(D.ctrlKey||D.metaKey||D.shiftKey)){if(D.ctrlKey&&D.metaKey||D.shiftKey){g.events.push("showRightMenu","style");return}var A=a.getSelectedId();if(A!=""){var E=d.getTopicById(A);if(E.style==null){mind.operation.setStyle.call(mind,{"font-style":"italic"})}else{if(E.style.bold!=null&&E.style.bold==false){mind.operation.setStyle.call(mind,{"font-style":"italic"})}else{if(E.style["font-style"]=="normal"||E.style["font-style"]==null){mind.operation.setStyle.call(mind,{"font-style":"italic"})}else{mind.operation.setStyle.call(mind,{"font-style":"normal"})}}}}D.preventDefault()}else{if((D.ctrlKey||D.metaKey)&&D.keyCode==83){t=0;D.preventDefault()}else{if((D.ctrlKey||D.metaKey)&&(D.keyCode==187||D.keyCode==107)){D.preventDefault();t=0;g.operation.zoomIn.call(g,g.designer);var z=g.operation.zoomVal;g.events.push("zoom",z)}else{if((D.ctrlKey||D.metaKey)&&(D.keyCode==189||D.keyCode==109)){D.preventDefault();t=0;g.operation.zoomOut.call(g,g.designer);var z=g.operation.zoomVal;g.events.push("zoom",z)}else{if((D.ctrlKey||D.metaKey)&&D.keyCode==48){D.preventDefault();t=0;g.operation.zoomVal=85;g.operation.zoomIn.call(g,g.designer);g.events.push("zoom",100)}else{if((D.ctrlKey||D.metaKey)&&D.keyCode>=49&&D.keyCode<=57){D.preventDefault();t=0;var v=D.keyCode-49;$(".mind-right-detail-icons").find("[n=priority][ico="+v+"]").trigger("click")}else{if((D.ctrlKey||D.metaKey)&&D.keyCode==191){D.preventDefault();t=0;var A=g.util.getSelectedId();if(A!=""){var w=a.getTopicDom(A);if(w.children(".expand_box").length>0){w.children(".expand_box").trigger("mouseup")}}}else{if((D.ctrlKey||D.metaKey)&&D.keyCode==76){D.preventDefault();t=0;var A=g.util.getSelectedId();if(A!=""){$(".header-item.icon_conn").trigger("click")}}else{if(D.keyCode==16){$(".topic-box.free").parent().addClass("noevent")}else{if((D.ctrlKey||D.metaKey)&&D.keyCode==70){D.preventDefault();g.events.push("load-outline")}else{var A=g.util.getSelectedId();if(A!=""){if(D.metaKey){return}l.editTopicDom.call(g,A);g.model.poPasteType="editpaste"}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}});$(document).off("keyup.hotkey").on("keyup.hotkey",function(u){t=0;if(u.keyCode==16){$(".topic-box.free").parent().removeClass("noevent")}});g.events.push("documentkeydown");$(document).off("dblclick.edit").on("dblclick.edit",".topic-box",function(w){if(n.readonly){return}var v=$(this);var u=a.getSelectedId();if(u!=""){l.editTopicDom.call(g,u);g.model.poPasteType="editpaste"}});$(document).off("click.selected").on("click.selected",".topic-box",function(v){var u=$(this);var w=d.getTopicById(u.attr("id"));if(v.ctrlKey||v.metaKey){g.util.select([w],g)}else{g.util.selectOne.call(g,w);g.events.push("setDock",w)}f.currentLine=null;g.operation.brash.call(g,w.id);g.operation.hideLink();g.plugins.hideSummaryTip();g.plugins.hideBoundaryTip();v.stopPropagation();g.events.push("hideMenu")});$(document).off("mouseup.topicnote").on("mouseup.topicnote",".topic-note",function(v){var u=$(this);var w=d.getTopicById(u.parent().attr("id"));g.util.selectOne.call(g,w);g.events.push("setDock",w);g.events.push("openNote",w);v.stopPropagation()});var p=false;g.designer.off("mousedown.dragmovefree").on("mousedown.dragmovefree",".topic-box.free",function(U){if(n.readonly||U.button==2){return}var L=$(this),O=L.attr("id");var Q=g.model.getTopicById(O);if(Q.summary&&(Q.pos!=null||Q.part!=null)){return}var N=Math.abs,v=g.operation.zoomVal/100;$(document).on("selectstart",function(){return false});U.stopPropagation();$(".mind-util-container").addClass("noevent");$("header").addClass("noevent");$(".mind-canvas-con").addClass("noevent");$(".mind-right-con").addClass("noevent");$(".mind-right-menu").addClass("noevent");g.plugins.closeGlobalMenu();f.clearControls();var E=[],T=[],P={},D=[];var M=a.getTopicContainer(O);var G=M.position().left,F=M.position().top;var w=[];if(g.util.selectedIds.length>1){for(var S=0;S<g.util.selectedIds.length;S++){var z=g.util.selectedIds[S];var R=a.getTopicContainer(z);var C=g.model.getTopicById(z);if(C.root||C.summary){continue}E.push({dom:R,id:z,free:C.free,left:R.position().left,top:R.position().top});T.push(C);var H=f.getConnectionsByTopic.call(g,z);w=w.concat(H);D.push(z)}}else{E.push({dom:M,id:O,free:Q.free,left:G,top:F});T.push(Q);w=f.getConnectionsByTopic.call(g,Q.id)||[];D.push(O)}T=a.getAvailableSelected(g,q,T);var K=U.pageX,I=U.pageY;var J=false,X={};var W=a.copyArray(w);var u=g.container.scrollTop();var V=g.container.scrollLeft();g.operation.initScrollPos();var B=U.offsetX,A=U.offsetY;g.designer.off("mousemove.dragmovefree").on("mousemove.dragmovefree",function(af){var Y=af.pageX,y=af.pageY;var ac=Y-K,aa=y-I;if(N(ac)>1||N(aa)>1){g.operation.draging=true;g.operation.isScroll(af.pageX,af.pageY);var ag=g.container.scrollTop();var x=g.container.scrollLeft();var ab=(x-V)/v;var Z=(ag-u)/v;if(E.length>0){M.css({left:G/v+ac/v+ab,top:F/v+aa/v+Z});for(var ad=0;ad<E.length;ad++){var ae=E[ad];if(ae.free==true){ae.dom.css({left:ae.left/v+ac/v+ab,top:ae.top/v+aa/v+Z})}if(!ae.dom.hasClass("mind-disable1")){ae.dom.addClass("topic-moving-related").addClass("mind-disable1")}}}if($(".topic-insert").length==0){g.virtualTopic.setMovingRelated(Q,null);g.virtualTopic.initEvent.call(g,Q,X)}if(w!=null&&w.length>0){f.resetConnectionsOnMoving.call(g,w)}J=true}g.designer.addClass("noselect");p=true;af.stopPropagation();af.preventDefault()});g.designer.off("mouseup.dragmovefree").on("mouseup.dragmovefree",function(ab){$(document).off("selectstart");g.designer.off("mousemove.dragmovefree");g.designer.off("mouseup.dragmovefree");g.designer.removeClass("noselect");M.removeClass("topic-moving-related").css("z-index",2).removeClass("mind-disable1");if(E.length>0){for(var aa=0;aa<E.length;aa++){var ag=E[aa];ag.dom.removeClass("topic-moving-related").css("z-index",2).removeClass("mind-disable1")}}$(".mind-util-container").removeClass("noevent");$("header").removeClass("noevent");$(".mind-canvas-con").removeClass("noevent");$(".mind-right-con").removeClass("noevent");$(".mind-right-menu").removeClass("noevent");g.operation.stopScroll();g.operation.draging=false;p=false;if(J){if(ab.target.tagName=="svg"){X={}}if(X.id!=null){var Z=a.copyArray(T);var Y=false;for(var aa=0;aa<Z.length;aa++){var ae=Z[aa];if(ae.id==Q.id){Y=true;break}}if(!Y){Z.push(a.copy(Q));a.selectedIds.push(Q.id);D.push(Q.id);Z=a.getAvailableSelected(g,q,Z)}d.updateTopicPos.call(g,Z,null,X,true,null,D)}else{if(J){if(E.length>0){for(var aa=0;aa<E.length;aa++){var ag=E[aa];var af=ag.dom.position().left/v,ad=ag.dom.position().top/v;var ac={x:af,y:ad};P[ag.id]=ac}g.model.updateFreeTopicPos.call(g,T,P,w,W)}}}}f.hideOrShowConnectionText(null,"show");$(".topic-insert").remove();$(".topic-moving-target").removeClass("topic-moving-target");$(this).css({cursor:"default"});g.virtualTopic.removeShape();g.virtualTopic.offEvent.call(g)})});g.designer.off("dblclick.freetopic").on("dblclick.freetopic",".mind-line-svg",function(x){if(g.opts.readonly){return}if(g.currentRoot!=null){$.showTip("聚焦模式下无法新建自由主题",1400);return}var u={parent:q.id,title:"自由主题",children:[],id:d.newId()};if(g.styles.autoColor){var w=g.style.getLineColor(q);u.lineStyle={randomLineColor:w}}var v=a.getRealPos.call(g,x.pageX,x.pageY);d.addFreeTopic(u,v,g);x.stopPropagation()});g.designer.off("mousedown.dragmovetp").on("mousedown.dragmovetp",".topic-box:not(.free)",function(B){if(n.readonly||B.button==2){return}g.events.push("hidepopeditor");g.plugins.closeGlobalMenu();g.plugins.hideContextMenu();var z=$(this),u=z.attr("id");var G=z.hasClass("summary");if(G){B.stopPropagation();return}p=false;var A=g.model.getTopicById(u);var F=B.pageX,E=B.pageY,C=false;if(A.root){var D=g.container.scrollTop();var w=g.container.scrollLeft();g.designer.off("mousemove.dragmovetp").on("mousemove.dragmovetp",function(y){var x=y.pageX-F,H=y.pageY-E;if(Math.abs(x)>6||Math.abs(H)>6){if(!C){z.addClass("noevent")}C=true;g.container.scrollLeft(w-x);g.container.scrollTop(D-H);p=true}});g.designer.off("mouseup.dragmovetp").on("mouseup.dragmovetp",function(x){g.designer.off("mousemove.dragmovetp");g.designer.off("mouseup.dragmovetp");C=false;p=false;z.removeClass("noevent");x.stopPropagation()});B.stopPropagation();B.preventDefault();return}else{l.topicDrag.call(g,{x:F,y:E},A,B)}if($(".connection_point").length>0){var v=document.getElementsByClassName("mind-connection-label");a.unSelectText(v);f.blurConnection(g);f.currentLine=null}B.stopPropagation()});$(document).off("click.menuPanel").on("click.menuPanel",".topic-menu",function(){var u=$(this).parent(),v=u.attr("id");g.plugins.hideContextMenu();g.plugins.showContextMenu.call(g,u,v);$(document).off("mousedown.contextmenu").on("mousedown.contextmenu",function(w){g.plugins.hideContextMenu();w.stopPropagation()});$(".mind-context-menu").off("mousedown.contextmenu").on("mousedown.contextmenu",function(w){w.stopPropagation()})});$(document).off("mouseenter.menuPanel").on("mouseenter.menuPanel",".topic-menu",function(){return;var u=$(this).parent(),v=u.attr("id");g.plugins.showContextMenu.call(g,u,v);$(document).off("mousedown.contextmenu").on("mousedown.contextmenu",function(){g.plugins.hideContextMenu()});$(".mind-context-menu").off("mousedown.contextmenu").on("mousedown.contextmenu",function(w){w.stopPropagation()})});$(document).on("click",".connection-line",function(y){var v=q.lines;var x=$(this),u=x.attr("id").substring(5);var w=v[u];f.isFocus=false;f.focusConnection(g,w)});g.designer.off("keyup.conn-label").on("keyup.conn-label",".mind-connection-label",function(x){var w=$(this);if(x.keyCode==13){var y=w.html();var v=f.currentLine;if(!x.altKey&&!x.shiftKey&&v.label!=null&&y!=v.label){if(y!=""&&y!="label"){var u=a.copy(v);v.label=y;f.saveConnectionText(g,v,u);f.clearControls()}}}x.stopPropagation()});$(document).on("keydown.conn-label",".mind-connection-label",function(u){u.stopPropagation();if(u.keyCode==13&&!u.shiftKey){u.preventDefault()}if(u.keyCode==13&&!u.altKey){u.preventDefault()}});g.designer.off("mousedown.conn-label").on("mousedown.conn-label",".mind-connection-label",function(x){var u=$(this).parent().attr("conn");var v=q.lines;var w=v[u];f.focusConnection(g,w);x.stopPropagation()});g.designer.off("mousedown.conn-label").on("mousedown.conn-label",".mind-connection-label",function(u){a.selectText(this);u.stopPropagation()});g.designer.on("mouseenter",".summary-dot",function(v){var u=$(this),w=u.parent().attr("id");g.plugins.showSummaryTip(g,w);v.stopPropagation()});g.designer.on("mouseenter",".boundary-dot",function(v){var u=$(this),w=u.attr("bound-id");g.plugins.showBoundaryTip(g,w);v.stopPropagation()});g.designer.on("mouseenter",".mind-connection-label-icons",function(w){var v=$(this),x=v.parent().attr("conn");var u=q.lines[x];f.currentLine=u;g.plugins.showConnectionTip(u,g);w.stopPropagation()});g.designer.off("blur.conn-label").on("blur.conn-label",".mind-connection-label",function(x){var w=$(this),y=$.trim(w.html()),v=f.tempLine||f.currentLine;if(v==null){return}if(v.label!=y){var u=a.copy(v);v.label=y;f.saveConnectionText(g,v,u)}if(y==""||y=="label"){w.parent().remove();f.currentLine=null}});g.designer.off("focus.conn-label").on("focus.conn-label",".mind-connection-label",function(w){var v=$(this),y=v.parent().attr("conn");if(y!=null){var u=q.lines[y];f.currentLine=u;f.tempLine=u}var x=$.trim(v.html())});g.designer.on("mousedown.conn-label",function(A){var E=g.operation.zoomVal/100;if($(".connection_point").length>0){var z=document.getElementsByClassName("mind-connection-label");a.unSelectText(z);f.blurConnection(g)}g.plugins.closeGlobalMenu();var w=A.target.classList+"";if(g.operation.brashData.style!=null&&w.indexOf("topic")<0){g.operation.closeTip()}g.operation.hideLink();g.util.clearSelect();g.plugins.hideConnectionTip();g.events.push("changeOpStatus",g);if($(A.target).hasClass("resize-boundary")){return}var F=a.getRealPos.call(g,A.pageX,A.pageY);var D=F.x,C=F.y;var B=$("#root"),v="right";if(B.length>0){var u=B.offset().left/E+B.outerWidth()/2;v=u>A.pageX/E?"left":"right"}g.boundary.getBoundariesPos.call(g,D,C,v)});g.designer.on("mousedown.conn-label",".connection_point",function(u){u.stopPropagation()});g.designer.on("mousemove.move",function(A){var z=$(A.target);if(!z.hasClass("topic")&&!z.hasClass("expand_box")&&!z.hasClass("topic-menu")&&!z.hasClass("topic-box")&&!z.hasClass("connection_point")){var w=q.lines;if(w==null||$.isEmptyObject(w)){return}var y=a.getRealPos.call(g,A.pageX,A.pageY);var u=f.getConnectionByPoint.call(g,y.x,y.y);if(u.inline>0&&u.inline!=20){var v=u.lines[0];var x=document.getElementById("line_"+v.id);if(x==null){return}g.designer.css("cursor","pointer");m(v)}else{g.designer.css("cursor","default");g.designer.off("mousedown.connection")}}else{g.designer.off("mousedown.connection");g.designer.css("cursor","default")}});function m(u){g.designer.off("mousedown.connection").on("mousedown.connection",function(v){var w=q.lines[u.id];f.focusConnection(g,u);g.designer.css("cursor","default");g.designer.off("mousedown.connection");v.stopPropagation()})}g.designer.off("mousedown.conn-menu").on("mousedown.conn-menu",".mind-connection-menu",function(u){u.stopPropagation()});g.designer.on("mousedown.conn-menu",function(){$(".mind-connection-menu").hide();g.designer.find(".img-dot").remove();g.designer.find(".topic-image .img-btn").remove();g.designer.find(".topic-image img.active").removeClass("active");s=""});g.designer.on("click.image",function(u){s="";g.designer.find(".img-dot").remove();g.designer.find(".topic-image img.active").removeClass("active");g.designer.find(".topic-image .img-btn").remove()});g.designer.on("click.imagedel",".topic-image > .img-btn",function(u){if(s!=""){l.removeTopicImage.call(g,s);s="";$("#mind_hover_tip").remove()}u.stopPropagation()});g.designer.on("mousedown.imagedel",".topic-image > .img-btn",function(u){u.stopPropagation()});g.designer.on("contextmenu.image",".topic-image > img",function(u){$(this).trigger("click.image");u.preventDefault()});g.designer.on("mousedown.imagemove",".topic-image > img",function(B){var z=$(this),v=B.pageX,C=B.pageY,u=Math.abs,A=false,w=z.parent().parent().attr("id");$.showTip("拖动到其他主题上，可以快速复制图片",null);g.designer.off("mousemove.imagemove").on("mousemove.imagemove",function(y){var x=y.pageX,D=y.pageY;if(u(v-x)>5){if(!A){A=true}}});g.designer.off("mouseup.imagemove").on("mouseup.imagemove",function(E){g.designer.off("mousemove.imagemove");g.designer.off("mouseup.imagemove");A=false;$.showTip("close");var I=$(E.target).parents(),F=false,x=null;for(var D=0;D<I.length;D++){var H=$(I[D]);if(H.hasClass("topic-box")){F=true;x=H;break}}if(F){if(x.attr("id")!=w){var y=z.attr("src");var G=new Image();G.src=y;G.onload=function(){l.setTopicImage.call(g,x.attr("id"),y,G)}}}});B.stopPropagation();B.preventDefault()});g.designer.on("click.image",".topic-image > img",function(D){var B=$(this),A=B.width(),G=B.height(),F,C;var v=B.attr("id");var x=v.substring(10);s=x;var E=d.getTopicById(x);if(D.ctrlKey||D.metaKey){g.util.select([E],g)}else{g.events.push("setDock",E);g.util.selectById.call(g,x)}var y=a.copy(d.getTopicById(x));g.designer.find(".img-dot").remove();g.designer.find(".topic-image .img-btn").remove();g.designer.find(".topic-image img.active").removeClass("active");var u=$("<span title='调整图片大小' class='img-dot'></span>");B.parent().append(u);var z=$("<span title='删除图片' class='img-btn del'><span class='mind-icons'>&#xe618;</span></span>");B.parent().append(z);B.addClass("active");u.css({top:G-u.height()+2,left:A-u.width()}).show();$(".topic-image .img-dot").off("mousedown").on("mousedown",function(I){I.stopPropagation();var w=I.pageX,K=I.pageY,H=B.width(),J=B.height();z.hide();g.designer.off("mousemove.img-dot").on("mousemove.img-dot",function(N){N.preventDefault();N.stopPropagation();var L=N.pageX,P=N.pageY,O=L-w,M=P-K;if(Math.abs(O)>5||Math.abs(M)>5){F=H+O;C=F*J/H;if(F>20){B.width(F);B.height(C);u.css({left:F-u.width(),top:C-u.height()})}}});g.designer.off("mouseup.img-dot").on("mouseup.img-dot",function(L){H=B.width();J=B.height();var M=a.copy(y);z.show();M.image=$.extend(true,M.image,{w:H,h:J});d.updateTopicImage.call(g,M,y,true);g.designer.off("mouseup.img-dot");g.designer.off("mousemove.img-dot");$("#mind_hover_tip").remove()})});D.stopPropagation()});g.designer.on("dblclick.imagePreview",".topic-image > img",function(v){v.stopPropagation();var u=$(this).attr("src");g.operation.previewTopicImage.init(u)});g.designer.off("contextmenu.rightclick").on("contextmenu.rightclick",function(A){if(n.readonly){A.preventDefault();return}if($(".topic-moving").length>0||A.button==0){A.preventDefault();return}var E=A.pageX;var C=A.pageY;var B=A.target;var z=["topic","topic-box","topic-task","topic-tag"];var v=B.getAttribute("class")+"";if(v.indexOf("topic-container")>=0){g.plugins.showGlobalMenu(g,E,C);A.preventDefault()}else{if(v.indexOf("topic")>=0||v.indexOf("textarea_topic")>=0||v.indexOf("topic-box")>=0||v.indexOf("topic-tag")>=0||v.indexOf("topic-task")>=0||v.indexOf("topic-icons")>=0){var w=null;if(v.indexOf("textarea_topic")>=0){w=$(B).parent()}else{w=$(B).attr("id")?$(B):$(B).parent()}if(w.hasClass("cut_related")){A.preventDefault();return}var u=w.attr("id");if(u!=null){var D=d.getTopicById(u);a.selectOne.call(g,D);w.children(".topic-menu").trigger("click")}A.preventDefault()}else{if(B.tagName=="svg"&&B.className.baseVal.indexOf("mind-line-svg")>=0){g.plugins.showGlobalMenu(g,E,C);A.preventDefault()}}}});g.designer.off("click.clickicon").on("click.clickicon",".topic-icons > span",function(w){var v=$(this),y=v.attr("n"),u=v.attr("ico");var x=v.parent().parent().attr("id");g.util.selectById.call(g,x);g.icons.showIcons.call(g,v,x,y,u);w.stopPropagation()});g.designer.off("mousedown.clickicon").on("mousedown.clickicon",".topic-icons > span",function(u){u.stopPropagation()});g.designer.off("click.clicktag").on("click.clicktag",".topic-tag",function(v){g.events.push("showRightMenu","tag");var u=$(this);var w=u.parent().parent().attr("id");g.util.selectById.call(g,w);v.stopPropagation()});g.designer.off("click.clicktask").on("click.clicktask",".topic-task",function(v){var u=$(this);var w=u.parent().attr("id");g.events.push("showRightMenu","task");g.util.selectById.call(g,w);v.stopPropagation()})},operation:{moveToCenter:function(){var b=this.container,l=$(".mind-designer:first"),g=this,f=g.model,i=g.currentRoot||f.topic,a=b.width(),k=b.height();var c=0,h=0;var e=i.image?i.image.h:0;if(i.structure=="mind_tree"||i.structure=="mind_org"){var m=$(window).height()/2;c=(l.width()-a)/2;h=(l.height()-k+m-100-e)/2}else{if((i.leftChildren==null)||(i.leftChildren.length==0&&i.children.length>0)){var d=$(window).width()/2;c=(l.width()-a+d)/2;h=(l.height()-k-100-e)/2}else{if(i.leftChildren.length>0&&i.children.length==0){var d=$(window).width()/2;c=(l.width()-a-d)/2;h=(l.height()-k-100-e)/2}else{c=(l.width()-a)/2;h=(l.height()-k-100-e)/2}}}b.scrollLeft(c);b.scrollTop(h)},setMapSize:function(){var w=$(".mind-designer:first"),h=this,c=h.model,r=h.currentRoot||c.topic,k=h.operation;var d=0,t=0,p=0,n=0,g=0,l=[],e=[];var m=$(".mind-container");if((r.children.length>0||r.leftChildren.length>0)){if(r.structure=="mind_tree"||r.structure=="mind_org"){var a=$("#root").height();p=m.width(),n=m.height();for(var s=0;s<r.children.length;s++){var f=$("#"+r.children[s].id).parent();d+=f.width();l.push(f.height())}}else{var a=$("#root").width();p=m.height(),n=m.width();if(r.children){for(var s=0;s<r.children.length;s++){var f=$("#"+r.children[s].id).parent();d+=f.height();l.push(f.width())}}if(r.leftChildren){for(var s=0;s<r.leftChildren.length;s++){var q=$("#"+r.leftChildren[s].id).parent();g+=q.height();e.push(q.width())}}d=d>g?d:g}l.sort(function(x,i){return x-i});e.sort(function(x,i){return x-i});t=(l.length>0?l[l.length-1]:0)+(e.length>0?e[e.length-1]:0)+a+100;if(d<p&&t<n){return}var u=p/d,o=n/t;var v=Math.ceil((o>u?u:o)*100);if(v<70){v=70}k.zoomVal=v;var b=v/100;w.css({transform:"scale("+b+")","-webkit-transform":"scale("+b+")","-moz-transform":"scale("+b+")"})}},draging:false,topicDrag:function(g,v,B){if($(".topic-moving").length>0){$(".topic-moving").remove();return}var k=this,f=k.model,a=k.util,p=k.line,u=k.currentRoot||f.topic,x=f.groupList;var s=k.util.getMargin.call(k);var C=s.marginH;var A=$("#"+v.id);var b=A.clone(false).appendTo("body").attr("id","move_"+v.id).addClass("topic-moving");b.children(".topic").siblings().remove();b.removeClass("selected");b.css({background:"#fff","box-shadow":"1px 1px 0px #ccc"});var l=a.selectedIds.length,z=[],y=[],h=[];if(l>1){b.children(".topic").text(l+"个节点");var d=$(".topic-box.selected[sub=true]").get().reverse();var q=$(".topic-box.selected");for(var w=0;w<q.length;w++){var m=q[w];if($(m).attr("sub")!=null){continue}d=d.concat(m)}for(var w=0;w<d.length;w++){var m=$(d[w]);var t=m.attr("id");var c=f.getTopicById(t);if(c.root||c.summary){continue}z.push(c);h.push(c.id)}}else{z.push(v)}y=a.getAvailableSelected(k,u,z);if(y.length==0&&z.length==1){y=z}var D={};var n=f.getParentTopic(v.parent),r=A.parent();var o=false;$(".mind-util-container").addClass("noevent");$("header").addClass("noevent");$(".mind-canvas-con").addClass("noevent");$(".mind-right-con").addClass("noevent");$(".mind-right-menu").addClass("noevent");k.operation.initScrollPos();k.designer.off("mousemove.dragmove").on("mousemove.dragmove",function(E){var i=E.pageX-g.x,G=E.pageY-g.y;var e=Math.abs(i),F=Math.abs(G);if(e>8||F>8){k.operation.isScroll(E.pageX,E.pageY);o=true;k.operation.draging=true;$(this).css({cursor:"move"});if($(".topic-insert").length==0){k.virtualTopic.setMovingRelated(v,n,y);b.find(".topic-insert").remove()}if($(".mind-tip").length==0){$.showTip("拖动到其他主题上，进行排序或移动",null)}if(F>200||e>200){if(E.target.tagName=="svg"){$.showTip("松开鼠标，即可添加为自由主题",null)}else{$.showTip("close")}}b.css({left:E.pageX-b.width()/2,top:E.pageY-b.height()/2})}});k.designer.off("mouseup.dragmove").on("mouseup.dragmove",function(J){k.model.copying=false;var G=J.pageX-g.x,E=J.pageY-g.y;if(J.target.tagName=="svg"){D.id=null}k.operation.draging=false;$(".mind-util-container").removeClass("noevent");$("header").removeClass("noevent");$(".mind-canvas-con").removeClass("noevent");$(".mind-right-con").removeClass("noevent");$(".mind-right-menu").removeClass("noevent");k.operation.stopScroll();var i=b.offset().left,e=b.offset().top;b.remove();$(".topic-insert").remove();$(".topic-moving-target").removeClass("topic-moving-target");$(this).css({cursor:"default"});k.virtualTopic.removeShape();k.designer.off("mouseup.dragmove");k.designer.off("mousemove.dragmove");k.designer.off("mouseenter.dragmove");$(".topic-moving-related").removeClass("topic-moving-related");if(Math.abs(G)>8||Math.abs(E)>8){if(D.id!=null){f.updateTopicPos.call(k,a.copyArray(y),null,D,null,null,h)}else{if(o){if(mind.currentRoot!=null){$.showTip("聚焦模式下无法新建自由主题",1400);return}if(Math.abs(G)>200||Math.abs(E)>200){var F=f.topic.margin,I=null;if(F){I=F.marginH}var H=I==null?k.styles.marginH:I;var K=a.getRealPos.call(k,i,e);K.y-=$("#"+v.id).parent().outerHeight()/2-H;f.changeToFreeTopic.call(k,v,null,K)}}}}$.showTip("close")});k.virtualTopic.initEvent.call(k,v,D)},selectingBox:function(p){var k=this,h=k.model,i=k.util;k.util.clearSelect();var f=null;var m=p.pageX,l=p.pageY,g=p.offsetX,d=p.offsetY;var o=k.designer,a=k.container,n=k.operation.zoomVal/100;var c=a.scrollLeft(),b=a.scrollTop();if(n!=1){c=Math.abs(o.offset().left)/n;b=Math.abs(o.offset().top)/n}var e={};$(document).on("selectstart",function(){return false});$(document).off("mousemove.multiselect").on("mousemove.multiselect",function(q){if(Math.abs(q.pageX-p.pageX)>2){if(f==null){f=$("<div id='selecting_box'></div>").appendTo(k.designer)}if(q.pageX<m){g=q.pageX}else{g=m}if(q.pageY<l){d=q.pageY}else{d=l}e.x=c+g/n;e.y=b+d/n;e.w=Math.abs(p.pageX-q.pageX);e.h=Math.abs(p.pageY-q.pageY);f.css({left:e.x,top:e.y,width:e.w/n,height:e.h/n})}});$(document).off("mouseup.multiselect").on("mouseup.multiselect",function(s){if(f!=null){var t=k.operation.zoomVal/100;var q={x:f.offset().left/t,y:f.offset().top/t,w:f.width(),h:f.height()};var x=k.util.getTopicsByRange(q,t);var w=[];for(var r=0;r<x.length;r++){var v=x[r];var u=k.model.getTopicById(v);w.push(u)}k.util.clearSelect();k.util.select(w,k);f.remove()}e={};$(document).off("mouseup.multiselect");$(document).off("mousemove.multiselect");$(document).off("selectstart")})},setConfig:function(b,a,c){$.ajax({url:"/mindmap/config",data:{field:b,value:a},cache:false,type:"post",success:function(d){if(c!=null){c(d)}}})},removeTopicSelf:function(){var o=this,k=o.model,s=o.line,q=o.currentRoot||k.topic,m=o.operation,l=o.util;var a=o.util.selectedIds;if(a.length==1&&a[0]==q.id){return}if(a.length==0){return}var n=[],r={},p={},c={};for(var g=0;g<a.length;g++){var b=a[g];var h=k.getTopicById(b);if(h.summary||h.root||h.free||h.children.length==0){continue}var e=l.getSelectedPart(b,q.structure);p[b]=e;n.push(h);r[h.id]=[];for(var f=0;f<h.children.length;f++){var d=h.children[f];r[h.id].push(d);c[d.id]=e}o.operation.updateNumber.call(o,h)}if(n.length>0){k.removeAndAdd.call(o,l.copyArray(n),l.copy(r),p,c)}o.events.push("poCollect",{name:"点击-右键菜单-删除当前主题",paramObj:{"来源":"思维导图","用户属性":typeof mindUI!="undefined"?mindUI.member?"会员用户":"普通用户":""}})},removeTopic:function(){var h=this,f=h.model,m=h.line,k=h.currentRoot||f.topic;var a=h.util.selectedIds;if(a.length==1&&a[0]==k.id){return}if(a.length==0){return}var g=[],b=[],l=[];for(var d=0;d<a.length;d++){var c=a[d];var e=f.getTopicById(c);g.push(e)}if(g.length>0){f.removeTopic.call(h,g,null)}},focusTopic:function(e,b,t){var h=this,f=h.model,a=h.util,m="",p=f.topic;h.operation.zoomVal=100;h.events.push("zoom",100);var l=null;if(e!=null){m=e}else{var o=a.selectedIds;if(o.length==0){return}m=o[0]}if(b==null){var r=h.events.push("focusable");if(!r){return}}var q=f.getTopicById(m);if(q!=null){if(h.currentRoot!=null){var c=f.getTopicById(h.currentRoot.id);var k=c.summaries;var g=c.boundaries;if(k!=null&&k.length>0){for(var s=0;s<k.length;s++){var d=k[s];delete d.pos}}if(g!=null&&g.length>0){for(var s=0;s<g.length;s++){var u=g[s];delete u.pos}}l=c.id;delete c.root;delete c.structure;h.currentRoot=null}if(q.root==null){h.currentRoot=q;h.currentRoot.root=true;h.currentRoot.structure=p.structure}h.operation.clearCanvas.call(h);h.initCanvas();h.line.renderLineCon.call(this);h.renderTopic(q);h.plugins.navigator.init.call(h);var n=true;if(b){h.operation.renderFocusBar(h,true);n=null}else{h.operation.renderFocusBar(h)}if(t==null){h.messageSource.send.call(h,"focus",{targetId:m,sourceId:l,local:n},n)}}if(h.currentRoot==null){h.events.push("focus",null)}else{h.events.push("focus",true)}},renderFocusBar:function(f,a){var b=f.currentRoot;if(b!=null){var k=f.model.getParentTopics(b.id);$(".mind-util-container").find(".mind-topic-focus").remove();var e=['<div class="mind-topic-focus">'];for(var d=k.length-1;d>=0;d--){var g=k[d],h=g.title;e.push('<div topicid="'+g.id+'">'+h+'</div><i class="mind-icons">&#xe736;</i>')}e.push('<div class="active" topicid="'+b.id+'">'+b.title+'</div><i title="退出聚焦模式" class="mind-icons close">&#xe622;</i>');e.push("</div>");$(".mind-util-container").append(e.join(""));this.initFocusEvent(f,a)}else{$(".mind-topic-focus").remove()}var c=$(".mind-util-container").find(".equation-text");c.html(c.data("equation"))},initFocusEvent:function(b,c){var a=$(".mind-topic-focus");a.children().off("click").on("click",function(g){var f=$(this);if(f.hasClass("active")){return}if(this.tagName.toLowerCase()=="div"){var d=f.attr("topicid");if(d!=null&&c==null){b.operation.focusTopic.call(b,d)}else{if(c){b.operation.focusTopic.call(b,d,true,false)}}if(d==b.model.topic.id){b.operation.exitFocus.call(b)}}else{if(f.hasClass("close")){if(c){b.operation.focusTopic.call(b,b.model.topic.id,true,false)}else{b.operation.focusTopic.call(b,b.model.topic.id)}b.operation.exitFocus.call(b);$("#mind_hover_tip").remove()}}g.stopPropagation()})},insertParent:function(b){var c=this,a=c.model;if(b&&(b.root||b.summary||b.free)){return}a.insertParentTopic.call(this,b)},exitFocus:function(){this.currentRoot=null;$(".mind-topic-focus").remove()},appendTopic:function(w){var h=this,d=h.model,u=d.topic,e=(u.structure=="mind_org"),o=(u.structure=="mind_tree"),b=h.util,i=h.styles,k=h.line;if(this.util.selectedIds.length==0){return}var p=b.getSelectedId(),n=null,a=d.getTopicById(p),l=d.newId(),x="子主题",s="right";if(w&&a.collapsed){return}if((a.summary||a.free)&&a.collapsed){return}if(a.root||a.free||a.summary||w){n=a}else{n=d.getTopicById(a.parent)}s=b.getSelectedPart(p,u.structure);var v=n.id;if((w&&a.root)||(!w&&n.root)){x="分支主题"}if(a.root&&!e&&!o){var r=b.getChildrenCount(u,"left");var g=b.getChildrenCount(u,"right");if(r<g){s="left"}}if(h.currentRoot!=null){s="right"}var f=d.getNewTopicIndex(a,n,w,s);var m={},q={};q[l]=s;m[l]=f;var t={id:l,parent:v,children:[],title:x};if(i.autoColor&&v=="root"){var c=h.style.getLineColor(u);t.lineStyle={randomLineColor:c}}d.addTopicMulti.call(h,[t],null,m,q);b.selectOne.call(h,t);return t},hideTopics:function(h){var f=this,b=f.model,a=f.currentRoot||b.topic;var d=a.children,g=a.leftChildren||[];var e=[];for(var c=0;c<d.length;c++){e.push(d[c].id)}for(var c=0;c<g.length;c++){e.push(g[c].id)}b.hideTopics.call(f,e,h)},showTopics:function(h){var f=this,b=f.model,a=f.currentRoot||b.topic;var d=a.children,g=a.leftChildren||[];var e=[];for(var c=0;c<d.length;c++){e.push(d[c].id)}for(var c=0;c<g.length;c++){e.push(g[c].id)}b.showTopics.call(f,e,h)},hideChildren:function(i,b){var m=this,k=m.model,g=k.groupList,n=m.currentRoot||k.topic,d=k.getSubTopic(i),l=m.util,q=m.line;var e=l.getTopicContainerProp(d.id),c=l.getSelectedPart(i.id,n.structure);var a=l.getTopicContainer(i.id);a.children(".topic-children").remove();q.deleteChildrenLines(i);if(d.summary!=true){var p=l.getTopicContainerProp(d.id);var f=(p.h-e.h)/2;var o=0;if(n.structure=="mind_org"||n.structure=="mind_tree"){o=(p.w-e.w)}m.range.doChangeSubTopicPos(m,d,f,o,c)}m.renderFreeSummaries(c);m.renderFreeBoundaries(c);q.resetLines.call(m,[d.id],f,c);m.events.push("outline-prebuild",{topics:[i],rebuild:"current"})},showChildren:function(s){var m=this,d=m.model,b=m.util,r=m.currentRoot||d.topic,o=m.line,t=d.groupList;var g=d.getSubTopic(s),q=b.getSelectedPart(s.id,r.structure);var f=s.children,x=f.length;var e=b.getTopicContainerProp(g.id);var p=b.getTopicContainer(s.id);var y=f;if(s.summary&&s.part!=null){q=s.part}for(var u=0;u<x;u++){var k=y[u];m.renderSubTopic(k,null,q)}if(s.summaries&&s.summaries.length>0){for(var u=0;u<s.summaries.length;u++){var c=s.summaries[u];m.summary.renderSummaryDoms(m,c,q)}}if(s.boundaries&&s.boundaries.length>0){for(var u=0;u<s.boundaries.length;u++){var a=s.boundaries[u];m.boundary.renderBoundaryDom(m,a,q)}}if(g.summary!=true){var l=b.getTopicContainerProp(g.id);var v=(l.h-e.h)/2;var n=0;if(r.structure=="mind_org"||r.structure=="mind_tree"){n=(l.w-e.w)}m.range.doChangeSubTopicPos(m,g,v,n,q,true)}m.renderFreeSummaries(q);m.renderFreeBoundaries(q);o.resetLines.call(m,[g.id],v,q);m.events.push("outline-prebuild",{topics:[s],rebuild:"current"})},showOrHideChildren:function(a,m,d){var k=this,g=k.util,f=k.model,n=k.currentRoot||f.topic;var b=g.getTopicDom(a),l=b.children(".expand_box");var e=f.getTopicById(a),i="&#xe7bb;",h="&#xe647;";var c=g.getSelectedPart(e.id,n.structure);if(m==null){if(e.collapsed){m="show"}else{m="hide"}}if(m=="show"){l.html(i).removeClass("hide");delete e.collapsed;k.operation.showChildren.call(k,e);k.connection.showConnectionMulti(k,[e])}else{if(m=="hide"){l.html(h).addClass("hide");e.collapsed=true;k.operation.hideChildren.call(k,e,b);k.connection.deleteConnectionByTopics.call(k,[e],false);poCollect("点击-右键菜单-收起主题",{"来源":"思维导图","用户属性":typeof mindUI!="undefined"?mindUI.member?"会员用户":"普通用户":""})}}k.connection.resetAllConnectionPos.call(k,n);if(k.opts.readonly){return}f.changeTopicExpand.call(k,e,m,c,d)},showOrHideLevelChildren:function(f,h,g,b){var e=this,d=e.model,i=g||e.currentRoot||d.topic;var a=[];c(i);function c(r){var l=r.leftChildren||[],q=r.children;var m=q.concat(l);if(m==0){return}for(var p=0,n=m.length;p<n;p++){var v=m[p],k=v.id,t=v.collapsed?"show":"hide",u=d.getParentTopics(k),s=0;if(v.children.length==0){continue}for(var o=0;o<u.length;o++){s++;if(u[o].summary){break}}if(t==h&&s==f&&a.indexOf(k)==-1){a.push(k);continue}if(s<f){c(v)}}}if(h=="show"){e.model.showTopics.call(e,a,b)}else{poCollect("点击-右键菜单-收起全部同级主题",{"来源":"思维导图","用户属性":typeof mindUI!="undefined"?mindUI.member?"会员用户":"普通用户":""});e.model.hideTopics.call(e,a,b)}},isPaste:false,editTopicDomInit:function(c){var i=this,h=i.operation,g=i.util;var f=i.model.getTopicById(c),e=i.util.getTopicDom(c);var o=f.title,k=e.find(".topic");e.find(".textarea_topic").remove();var b=$("<div contenteditable='true' spellcheck=false id='area_"+c+"' class='textarea_topic'></div>").prependTo(e);if(new Date().valueOf()%2==0&&g.tipCount()){b.addClass("tip1")}else{if(g.tipCount()){b.addClass("tip2")}}var a=i.style.getStyle.call(i,f);var q={"font-family":a.family,"font-size":a["font-size"],"font-weight":a.bold?"bold":"normal","font-style":a.italic?"italic":"normal","text-align":a.textAlign};b.css(q);var m=o.replace(/\n/g,"<br>");b.html(m);if($(":focus").parents("#color_picker").length==0){b.focus()}b.css({left:0,width:k.outerWidth(),height:k.outerHeight()});if(f.image!=null){b.css({bottom:0-b.height()/2,top:"auto"})}if(f.tags!=null){b.css({top:b.height()/2+2})}$("#textarea_topic_temp").remove();var p=$("<div id='textarea_topic_temp'></div>").appendTo(e);p.css(q);$(".topic-menu").remove();var d=$("<span class='icons topic-menu'>&#xe65a</span>");d.appendTo(e).hide();var l=document.getElementById("area_"+c);if(l!=null){return;l.addEventListener("paste",function(y){if(g.isChrome()){var s=y.clipboardData,t,w,z;if(s){t=s.items;z=s.types||[];for(var v=0;v<z.length;v++){if(z[v]==="Files"){w=t[v];break}}if(w&&w.kind==="file"&&w.type.match(/^image\//i)&&t.length!=4){y.preventDefault();var r=w.getAsFile(),x=new FileReader();x.readAsDataURL(r);x.onload=function(B){var A=x.result;h.uploadImage(A,c,function(D){if(D.result){$.showTip("close");if(D.result=="type_error"){$.showTip("文件类型错误，只允许图片文件。",3000);return}$.showTip("升级到个人版或者团队版后，才可以直接粘贴截图，  <a style='color:#fff;letter-spacing:1px;' href='/upgrade?pos=5_6' target='_blank'>升级</a>",7000)}else{var C=new Image();C.src=D.img_url;i.events.push("showuploading");$(l).trigger("blur");C.onload=function(){h.setTopicImage.call(i,null,D.img_url,C);C.remove()}}})};y.stopPropagation();return false}else{i.util.isPaste=true;for(var v=0;v<z.length;v++){if(z[v]=="text/plain"){w=t[v];break}}w.getAsString(function(A){n(A)});y.preventDefault();return false}}i.util.isPaste=true}else{if(g.isFirefox()){var s=y.clipboardData,t,w,z;if(s){t=s.items;z=s.types||[];if(t!=null){for(var v=0;v<z.length;v++){if(z[v]=="text/plain"){w=t[v];break}}if(w!=null){w.getAsString(function(A){n(A)});i.util.isPaste=true;y.preventDefault();return false}}}i.util.isPaste="safari"}else{if(g.isSafari()){var s=y.clipboardData,t,w,z;if(s){var u=s.getData("text/plain");if(u!=null&&u!=""){n(u);i.util.isPaste=true;y.preventDefault();return false}}i.util.isPaste="safari"}else{i.util.isPaste=true}}}y.stopPropagation()})}function n(t){t=t.replace(/</g,"&lt;");t=t.replace(/>/g,"&gt;");t=t.replace(/\n/g,"<br>");var s=window.getSelection();var r=s.getRangeAt(0);if(document.queryCommandSupported("insertHTML")){document.execCommand("insertHTML",false,t)}else{if(r.pasteHTML){r.pasteHTML(t)}}}},uploading:false,uploadImage:function(b,d,c){var a=this;if(a.uploading){return}a.uploading=true;$.ajax({url:"/mindmap/uploadimage",type:"post",data:{id:chartId,img:b},success:function(e){a.uploading=false;if(c!=null){c(e)}},error:function(){a.uploading=false}})},editTopicDom:function(b){var i=this,f=i.model,g=i.util,n=false,d=false,h=i.operation,l=false;var a=$("#area_"+b);if(a.length==0){this.operation.editTopicDomInit.call(i,b);a=$("#area_"+b)}var e=f.getTopicById(b),c=g.getTopicDom(b);var p=e.title,k=c.find(".topic"),q=$("#textarea_topic_temp");a.css({"z-index":9,width:k.parent().outerWidth(),opacity:1});if(e.image!=null){a.css({bottom:0-a.height()/2,top:"auto"})}var m=p.replace(/\n/g,"<br>");a.html(m).focus();i.operation.renderEquation(a);document.execCommand("selectAll",false,null);$(".topic-box.free").parent().removeClass("noevent");a.off().on({keydown:function(z){z.stopPropagation();var B=$(this),u=B.html();if(z.altKey&&u.substring(u.length-4,u.length)!=="<br>"){B.append("<br>")}if(z.altKey&&z.keyCode==13){z.preventDefault();g.setBrNode(B[0])}else{if(!z.shiftKey&&z.keyCode==13){o(u,B)}else{if(z.keyCode==27){$("#textarea_topic_temp").remove();a.remove()}else{if(z.keyCode==9){a.trigger("blur");z.preventDefault()}else{if((z.ctrlKey||z.metaKey)&&(z.keyCode==187||z.keyCode==107)){z.preventDefault()}else{if((z.ctrlKey||z.metaKey)&&(z.keyCode==189||z.keyCode==109)){z.preventDefault()}else{if((z.ctrlKey||z.metaKey)&&z.keyCode==83){z.preventDefault()}else{if((z.keyCode==67||z.keyCode==88)&&(z.ctrlKey||z.metaKey)){var y=window.getSelection().getRangeAt(0),s=y.cloneContents().childNodes;if(s.length>1||(s.length==1&&s[0].nodeType==1)){if(z.keyCode==88){document.addEventListener("cut",C,true)}else{document.addEventListener("copy",C,true)}}function C(G){var E=document.createElement("div");E.innerHTML='<div class="mind-clipboard"></div>';E.querySelector(".mind-clipboard").appendChild(y.cloneContents());$(E).find(".equation-text>span:eq(0)").html("");var I=E.innerHTML;var H=E.cloneNode(true);var F=$(H).find(".equation-text");if(F.length>0){F.html(F.data("equation"))}G.clipboardData.setData("Text",$(H).text());G.clipboardData.setData("text/html",I);if(z.keyCode==88){window.getSelection().deleteFromDocument();document.removeEventListener("cut",C,true);if($(I).find(".equation-text").length>0){a.find(".equation-text").each(function(J,K){$(K).attr("data-index",J)})}}else{document.removeEventListener("copy",C,true)}G.preventDefault()}}else{if(z.keyCode==37||z.keyCode==39){if(a.find(".equation-text").length>0){var t=window.getSelection();var y=t.getRangeAt(0);var r=document.createElement("span");r.className="equation-temp";y.insertNode(r);y.collapse(false);var D=y.startContainer;var v=D.nodeType==1?D:D.parentNode;w(v)}function w(G){var F=G.childNodes;for(var E=0;E<F.length;E++){if(F[E].nodeType==3&&F[E].nodeValue==""){G.removeChild(F[E])}}for(var E=0;E<F.length;E++){if(F[E].className=="equation-temp"){if(z.keyCode==39){if(E==F.length-1){x(G)}else{if(F[E+1].className=="equation-text"){i.operation.equationInit(a,$(F[E+1]))}else{if(F[E+1].nodeType==1){A(F[E+1])}}}}else{if(E==0){x(G)}else{if(F[E-1].className=="equation-text"){i.operation.equationInit(a,$(F[E-1]))}else{if(F[E-1].nodeType==1){A(F[E-1])}}}}a.find(".equation-temp").remove();break}}}function x(F){var E=F.parentNode;if(E.childNodes.length==1){x(E)}else{if(E.className!="topic-box selected"){if(z.keyCode==39){F.after(r)}else{F.before(r)}w(E)}}}function A(E){if(E.childNodes.length==1&&E.childNodes[0].className!="equation-text"){A(E.childNodes[0])}else{if(E.nodeType==1){if(z.keyCode==39){E.insertBefore(r,E.childNodes[0])}else{E.appendChild(r)}w(E)}}}}}}}}}}}}},blur:function(){if($(".eq-editor").is(":visible")||l){return}var s=$(this);var r=s.html();o(r,s);i.model.poPasteType="node"},keyup:function(u){var s=$(this).html();q.html(s);var t=q.outerHeight();var r=q.outerWidth()+19;if(r<c.outerWidth()){r=c.outerWidth()+10}if($(".eq-editor").is(":hidden")){popEditor.renderMenuPos($(this))}a.css({width:r,height:t,left:(c.outerWidth()-(r))/2-3});if(e.image!=null){a.css({bottom:0-a.height()/2,top:"auto"})}u.stopPropagation()},mousemove:function(r){d=true;if($(".eq-editor").is(":visible")){return false}r.stopPropagation()},mousedown:function(r){n=true;if($(r.target).parents(".equation-text").length>0){l=true}r.stopPropagation()},mouseup:function(u){if(d&&n){popEditor.init(this);d=false;n=false}l=false;var v=$(".eq-editor");var s=$(u.target).parents(".equation-text");if(v.is(":visible")){if(s.length>0){var t,r;if(window.getSelection){t=window.getSelection();r=t.getRangeAt(0)}else{t=document.selection;r=t.createRange()}r.setStartAfter(s.get(0));r.collapse(false);t.removeAllRanges();t.addRange(r);$(".pop-editor").hide()}var s=a.find(".equation-text.cur");v.hide();$(".eq-shade").remove();if($(".notranslate").html()==""){s.remove()}s.removeClass("cur")}else{if(s.length>0){i.operation.equationInit(a,s)}}},click:function(r){r.stopPropagation()},dblclick:function(r){r.stopPropagation()},dragstart:function(){return false}});var o=function(v,u){if(u.find(".equation-text").length>0){$("body").append('<div id="html_temp" style="display:none"></div>');var t=$("#html_temp");t.html(v);u.find(".equation-text").each(function(w){t.find(".equation-text:eq("+w+")").children(":first").html("")});v=t.html();t.remove()}v=v.replace(/\n/g,"<br>");if(i.util.isPaste=="safari"){var s=u.find("img:first");if(s.length>0){$.showTip("close");$.showTip("Firfox和Safari浏览器暂时还不支持粘贴截图",4000);s.remove();v=e.title}else{var r=document.createElement("div");r.innerHTML=v;v=r.innerText}}$("#textarea_topic_temp").remove();a.remove();i.events.push("hidepopeditor");i.util.isPaste=false;if(v==e.title||a.hasClass("invalid")){return}i.model.updateTopicText.call(i,e,v);i.events.push("outline-prebuild",{topics:[e],rebuild:"current"})}},equationInit:function(k,t){var v;$(".pop-editor").hide();var s=$(".eq-editor");if(s.length==0){s=$('<div class="eq-editor"><div><div class="notranslate" contenteditable="true"></div><div class="done">完成</div></div><div class="eg-title"><span>上/下标</span><span>根号/分号</span><span>积分/极限/求和/乘积</span><div class="icons">&#xe796;</div></div><div class="eg-con"></div></div>').appendTo("body");s=$(".eq-editor")}$(".eg-con").html("");$(".eg-title span").removeClass("on");var o,m,f;if(document.selection){o=document.selection.createRange();m=document.getSelection().toString().replace(/\n/g,"");f=o.htmlText}else{var r=window.getSelection();o=r.getRangeAt(0);m=r.toString().replace(/\n/g,"");var l=document.createElement("div");l.appendChild(o.cloneContents());f=l.innerHTML}var b=document.createElement("div");b.innerHTML=f;var d=$(b).find(".equation-text");if(d.length>0&&!t){t=k.find(".equation-text[data-index="+d.eq(0).data("index")+"]")}var w=$(".notranslate");if(!t){var p=document.createElement("span");p.className="eq-l";var n=document.createElement("span");n.className="eq-r";o.insertNode(p);o.collapse(false);o.insertNode(n);v=k.clone(true);v.find(".equation-temp").remove();o.setStart(p,0);o.setEnd(n,0);k.find(".eq-l,.eq-r").remove();w.text(m);var i='<span class="equation-text" contenteditable="false"><span></span><span>&#65279;</span></span>';var u=$(i)[0];u.childNodes[0].appendChild(o.cloneContents());var g=$(o.startContainer).parents(".equation-text");if(g.length>0){o.setStartAfter(g.get(0))}var e=o.startContainer,c=o.endContainer;o.deleteContents();o.insertNode(u);r.removeAllRanges();h(c);q(c);function h(x){if(e!=x){if(x.className=="textarea_topic"){var y=o.extractContents();e.append(y);return}h(x.parentNode)}}function q(x){if(!x.innerHTML){var y=x.parentNode;x.remove();q(y)}}t=$(u)}else{v=k.clone(true);w.text($(t[0].outerHTML).data("equation"))}k.find(".equation-text").each(function(x,y){$(y).attr("data-index",x)});t.addClass("cur");var a=mind.operation.zoomVal/100;s.css({left:k.offset().left+k.outerWidth()*a/2-s.outerWidth()/2,top:k.offset().top+k.outerHeight()*a}).show();$("body").append("<div class='eq-shade' style='position:fixed;top:0;left:0;width:100%;height:100%;z-index:2'></div>");w.focus();setTimeout(function(){w.selectText()});this.equationInitEvent(k,v,t)},equationInitEvent:function(e,b,f){var l=false,i=false,c=false;var h=$(".eq-editor"),d=$(".notranslate"),k=h.find(".done");h.off().on("keydown",function(m){m.stopPropagation()}).on("click",".eg-title span, .eg-title .icons, .eg-con",function(s){var o=["x^{y^z_w}=(1+{\\rm e}^x)^{-2xy^w}","x=\\frac{-b\\pm\\sqrt{b^2-4ac}}{2a}","x = (-b +- sqrt(b^2-4ac))/(2a)"];var r=s.target;var t=r.className?r.className:r.parentNode.className;if(t=="icons"){var n=$(".mind-corner.left");if(n.hasClass("active")&&n.children("[tit=equation]").is(":visible")){$(".mind-corner.active .close").trigger("click")}else{$(".corner-item[tp=equation]").trigger("click")}}else{if(t=="eg-con"){d.html(o[$(".eg-title .on").index()]).trigger("keydown").trigger("keyup");d.textMoveToEnd()}else{var q=$(this);poCollect("点击-方程式编辑器-"+q.text()+"（例）",{"来源":"思维导图","用户属性":typeof mindUI!="undefined"?mindUI.member?"会员用户":"普通用户":""});q.addClass("on").siblings().removeClass("on");var p=o[q.index()];var m=katex.renderToString(p);$(".eg-con").html('<span style="align-self: flex-start;color:#999">例：</span><div style="margin:0 auto 10px;pointer-events:none">'+m+"</div>")}}s.stopPropagation()});k.off().on("mousedown",function(m){m.stopPropagation()}).on("mouseup",function(m){m.stopPropagation();l=true;a()});d.off().on("mousedown",function(m){m.stopPropagation()}).on("keydown",function(p){i=true;if(p.keyCode==13){if(e.hasClass("invalid")){p.preventDefault();return}l=true;a();return}if(p.keyCode==39||p.keyCode==37){var o,m;if(window.getSelection){o=window.getSelection();m=o.getRangeAt(0)}else{o=document.selection;m=o.createRange()}if((o.anchorOffset==d.text().length&&p.keyCode==39)||(o.anchorOffset==0&&p.keyCode==37)){if(c){setTimeout(function(){n(p);c=true},10)}else{setTimeout(function(){if(!c){n(p);c=true}},300)}}}function n(){m.deleteContents();m=m.cloneRange();var q=$(f[0].outerHTML).data("index"),r;if(e.hasClass("invalid")){b.find(".equation-temp").remove();e.html(b.html());if(p.keyCode==37){r=e.find(".eq-l").get(0)}else{r=e.find(".eq-r").get(0)}}if(!r){r=e.find(".equation-text[data-index="+q+"]").get(0)}e.focus();if(p.keyCode==37){m.setEndBefore(r)}else{m.setStartAfter(r)}m.collapse(true);o.removeAllRanges();o.addRange(m);a(p)}c=false}).on("keyup",function(m){c=true;if(i){g()}else{document.execCommand("selectAll",false,null)}});$(".eq-shade").off().on("click",function(){a()}).on("mousedown",function(){return false});g();function g(){try{var o=d.text();var m=katex.renderToString(o);k.removeClass("disable");f.attr("data-equation",o);e.removeClass("invalid")}catch(n){var m="无效方程式";k.addClass("disable");e.addClass("invalid")}f.children(":first").html(m);e.trigger("keyup")}function a(m){if($(f[0].outerHTML).data("equation")==""){f.remove();e.find(".equation-text").each(function(n,o){$(o).attr("data-index",n)})}h.hide();$(".eq-shade").remove();f.removeClass("cur");e.find(".eq-l,.eq-r").remove();if(!m){if(!l){e.addClass("invalid")}e.trigger("blur")}}},renderEquation:function(b){var a=b.find(".equation-text");a.each(function(){var d=$(this);var e=d.data("equation")?d.data("equation").toString():"";var c=katex.renderToString(e);d.children(":first").html(c)})},resetFlag:false,resetEqNodePos:function(){var k=this,f=k.model,g=k.util,m=k.line,l=k.currentRoot||f.topic;var e=k.model.getTopicById("root");var b=e.children.concat(e.leftChildren||[]);for(var d=0;d<b.length;d++){var a=b[d];var c=g.getTopicDom(a.id);if(c.parent().find(".equation-text").length>0){h(a)}}function h(p){var o=f.getSubTopic(p);var n=g.getSelectedPart(o.id,l.structure);var t=g.getTopicContainerProp(o.id);var s=g.getTopicDom(p.id);var r=g.getTopicContainerProp(o.id);var q=(r.h-t.h)/2;var i=r.w-t.w;k.range.doChangeSubTopicPos(k,o,q,i,n,true);k.resetTopicExpandPos(s,l.structure);if(p.root){n="left,right,";k.line.resetSubLines.call(k,n)}else{if(o.summary&&o.part=="left"){n="left"}k.line.resetLines.call(k,[o.id],null,n)}}},setDisable:function(){this.opts.readonly=true},setEnable:function(){this.opts.readonly=false},clearWatermark:function(){var a=$(".mind-line-svg");var b=a.find("defs")[0];if($(b).find("#pattern_mark").length>0){$(b).find("#pattern_mark").remove();a.find("#rect_mark").remove()}},setWatermark:function(v){if(v==""||v==null){return}var i=this,c=i.util;var k=this.styles,q=this.model.topic,h=q.background||k.background;if(h!=null&&h.indexOf("null")>0){h="rgb(244,244,244)"}if(h.indexOf("rgb")>=0){h=c.getHexColor(h).hex}var a=c.getRgbFromHex(h);if(a==null){a={r:190,g:190,b:190}}var e=20;var o=a.r-e;var s=a.g-e;var t=a.b-e;if(o<0&&a.r!=0){o=0}else{if(a.r<10){o=a.r+e*2}}if(s<0&&a.g!=0){s=0}else{if(a.g<10){s=a.g+e*2}}if(t<0&&a.b!=0){t=0}else{if(a.b<10){t=a.b+e*2}}var m="rgb("+o+","+s+","+t+")";var p=$(".mind-line-svg");var n=p.find("defs")[0];if($(n).find("#pattern_mark").length>0){$(n).find("#pattern_mark").remove();p.find("#rect_mark").remove()}var u="http://www.w3.org/2000/svg";var f=document.createElementNS(u,"pattern");f.setAttributeNS(null,"patternUnits","userSpaceOnUse");f.setAttributeNS(null,"id","pattern_mark");f.setAttributeNS(null,"width","300");f.setAttributeNS(null,"height","200");n.appendChild(f);var l=document.createElementNS(u,"text");l.setAttributeNS(null,"x","0");l.setAttributeNS(null,"y","96");l.setAttributeNS(null,"fill",m);l.setAttributeNS(null,"font-size","18");l.textContent=v;f.appendChild(l);var d=document.createElementNS(u,"rect");d.setAttributeNS(null,"fill","url(#pattern_mark)");d.setAttributeNS(null,"x","4000");d.setAttributeNS(null,"y","4000");d.setAttributeNS(null,"width",12000);d.setAttributeNS(null,"height",12000);d.setAttributeNS(null,"id","rect_mark");d.setAttributeNS(null,"pointer-events","none");d.setAttributeNS(null,"transform","rotate(320, 10000, 10000)");p.prepend(d);q.watermark=v},setMargin:function(b,a){var h=this,f=h.util,l=h.line,e=h.model,i=h.currentRoot||e.topic;if(i.structure=="mind_org"||i.structure=="mind_tree"){return}var c=f.copy(e.topic.margin);e.topic.margin=$.extend(e.topic.margin,b);if($.isEmptyObject(b)&&$.isEmptyObject(c)){return}var g=c.marginH==h.styles.marginH&&c.marginW==h.styles.marginW&&c.childMarginH==h.styles.childMarginH&&c.childMarginW==h.styles.childMarginW;if($.isEmptyObject(b)&&!g){e.topic.margin={};k()}else{if($.isEmptyObject(b)&&g){return}}if(b.marginH>=0&&b.marginH!=c.marginH){h.range.resetSubTopics.call(h,"left");h.range.resetSubTopics.call(h,"right")}else{if(b.childMarginH>=0){k()}}if(b.marginW>=0&&b.marginW!=c.marginW){h.range.resetSubTopics.call(h,"left");h.range.resetSubTopics.call(h,"right")}else{if(b.childMarginW>=0){k()}}function k(){var t=[],p=i.children||[],m=p.length,s=i.leftChildren||[],q=s.length;for(var o=0;o<m;o++){var r=p[o];t.push(r.id);h.renderSubTopic(r,null,"right")}for(var o=0;o<q;o++){var n=s[o];t.push(n.id);h.renderSubTopic(n,null,"left")}h.range.resetSubTopics.call(h,"left");h.range.resetSubTopics.call(h,"right");l.resetLines.call(h,t,null,"left,right")}h.renderFreeSummaries("left,right");h.renderFreeBoundaries("left,right");h.connection.resetAllConnectionPos.call(h,e.topic);if(a==null){var d=f.copy(e.topic.margin);h.messageSource.send.call(h,"updatePage",{content:d,original:c,type:"margin"})}h.events.push("updateMargin")},setBackground:function(e,g,a){var d=$(this.designer),f=this.styles,b=this.model.topic,h=b.background||f.background;var c=e||f.background;if(e==null){if(h){c=h}}if(c.indexOf("obqv3yxb1.bkt.clouddn.com")>=0){c=c.replace("obqv3yxb1.bkt.clouddn.com","cdn3.processon.com")}d.css({background:c});if(g){b.background=c;if(a==null){this.messageSource.send.call(this,"updateBg",{content:c,original:h})}}this.designer.find(".expand_box").css("background-color",c)},showLink:function(){var g=this,e=g.util,c=g.model,a=e.getSelectedId(),f=g.operation;if(a==null||$.trim(a)==""){return}if(g.opts.readonly){return}var b=e.getTopicDom(a);var l=$(".mind-link-box");if(l.length==0){l=$("<div class='mind-topic-box mind-link-box'><h3>超链接<span id='remove_link' style='cursor:pointer;font-size:13px;font-size: 13px;font-weight: normal;float: right;text-decoration: underline;'>删除</span></h3><div><span>链接地址</span><input id='mind-topic-link' autofocus type='text'/></div><div><span>显示标题</span><input  id='mind-topic-linktitle' type='text'/></div><div class='mind-topic-box-btn'><span class='mind-button green'>添加</span></div></div>").appendTo(g.designer)}var d=c.getTopicById(a);var i=l.find("input:first");if(d.link!=null){i.val(d.link.value||"");l.find("input:last").val(d.link.title||"")}$.fn.showPanel({target:b,panel:l});i.focus();var h=l.find(".mind-button.green");var k=l.find("#remove_link");i.on("blur",function(){var m=$.trim($(this).val());if(typeof mindUI!="undefined"&&mindUI.filterXss){m=mindUI.filterXss(m)}if(m!=""&&!e.isUrl(m)&&m.length<200){$(this).val("http://"+m)}});i.on("keyup",function(m){if(m.keyCode==13){i.trigger("blur");setTimeout(function(){h.trigger("click")},100)}});h.off().on("click",function(){var o=$("#mind-topic-link");var p=$.trim(o.val());if(p!=""&&e.isUrl(p)&&p.length<200){var m=$.trim($("#mind-topic-linktitle").val().substring(0,30));var n={value:p,title:m,type:"url"};f.setLink.call(g,n);f.hideLink()}else{o.val("").focus();o.attr("placeholder","请输入合法的URL地址")}});k.off().on("click",function(){f.removeLink.call(g);f.hideLink()})},hideLink:function(){setTimeout(function(){$(".mind-topic-box").find("input[type=text]").val("")},500)},setLink:function(k,i,h){var f=this,e=f.util,d=f.model,a=i||e.getSelectedId();if(a==null||$.trim(a)==""||$.trim(k.value)==""){return}if(f.opts.readonly){return}var l=$.trim(k.value),c=d.getTopicById(a),g=c.link;if(g==null){c.link={}}var b=e.copy(c);if((b.link!=null&&b.link.value==k.value)&&(b.link!=null&&b.link.title==k.title)){return}c.link={value:k.value,type:h||"url",title:k.title};d.updateTopicNode.call(f,c,b,"link")},removeLink:function(){var e=this,b=e.util,d=e.model,f=b.getSelectedId();if(f==null||$.trim(f)==""){return}if(e.opts.readonly){return}var c=d.getTopicById(f);if(c.link==null){return}var a=b.copy(c);delete c.link;d.updateTopicNode.call(e,c,a,"link")},setStyle:function(d,e){var p=this,n=p.util,m=p.model,a=e||n.selectedIds;if(a.length==0){return}if(p.opts.readonly){return}var b=[],c=[];for(var k=0,o=a.length;k<o;k++){var f=a[k];var l=m.getTopicById(f);var g=n.copy(l);c.push(g);var h="line";if(d["line-width"]!=null){l.lineStyle=l.lineStyle||{};l.lineStyle.lineWidth=d["line-width"]}else{if(d["line-color"]!=null){l.lineStyle=l.lineStyle||{};l.lineStyle.lineColor=d["line-color"]}else{if(d["line-type"]!=null){l.lineStyle=l.lineStyle||{};l.lineStyle.lineType=d["line-type"]}else{l.style=$.extend(l.style,d);h="style";if(l.style["border-width"]&&l.style.border){delete l.style.border}}}}b.push(l)}m.updateTopicNode.call(p,b,c,h)},getInvariantLineColor:function(){var l=this,h=l.model,p=h.topic,k=l.operation,s=l.styles;var m=p.children,o=p.leftChildren||{};var a=m.concat(o);var c=[];if(s.autoColor){for(var g=0;g<a.length;g++){var q=a[g],e=q.id,b=q.lineStyle||{},f={};if(!b||!b.randomLineColor){var d=l.style.getLineColor(p);var n=$.extend({},b,{randomLineColor:d});q.lineStyle=n;f[e]={randomLineColor:d};c.push(f)}}if(c.length>0){r(c)}}function r(t){var i=encodeURIComponent(JSON.stringify(t));$.ajax({url:"/mindmap/autoLineColor",data:{chartId:chartId,msgStr:i},type:"post",success:function(u){},error:function(u){}})}},clearStyle:function(){var d=this,a=d.util,c=d.model,n=this.currentRoot||c.topic,m=a.selectedIds,e=d.styles;if(m.length==0){return}if(d.opts.readonly){return}var s=[],h=[];for(var q=0,u=m.length;q<u;q++){var k=m[q];var o=c.getTopicById(k);var b=a.copy(o);h.push(b);delete o.style;delete o.lineStyle;var v=o.title,w=v.split("<br>");var f=$("<div id='temp_input' style='display:none;' contenteditable='true'></div>").appendTo("body");var l=[];for(var r=0;r<w.length;r++){var g=w[r];f.html(g);l.push(f.text())}$("#temp_input").remove();o.title=l.join("<br>");if(e.autoColor&&o.parent=="root"){var p=d.style.getLineColor(n);o.lineStyle={randomLineColor:p}}s.push(o)}c.updateTopicNode.call(d,s,h,"clearStyle")},setTopicImage:function(b,a,d){var h=this,e=h.model,g=h.util;if(h.opts.readonly){return}if(b==null){b=g.getSelectedId()}if(b==null){return}var f=e.getTopicById(b);var c=g.copy(f);var i=g.copy(f);i.image=$.extend(true,{w:d.width,h:d.height},{url:a});e.updateTopicImage.call(h,i,c)},removeTopicImage:function(f){var e=this,d=e.model,b=e.util;if(e.opts.readonly){return}var c=d.getTopicById(f);var a=b.copy(c);if(c!=null){delete c.image;d.updateTopicImage.call(e,c,a)}},renderTopicImage:function(b){if(b.image&&b.image.url){var g=$(".topic-box[id="+b.id+"]");if(b.image.w>900){var d=b.image.h*900/b.image.w;b.image.w=900;b.image.h=d}if(b.image.h==null){b.image.w=460;b.image.h=300}var a=b.image.url;if(a.indexOf("orgu2a928.bkt.clouddn.com")>=0){a=a.replace("orgu2a928.bkt.clouddn.com","cdn2.processon.com")}else{if(a.indexOf("7xt9nt.com1.z0.glb.clouddn.com")>=0){a=a.replace("7xt9nt.com1.z0.glb.clouddn.com","cdn.processon.com")}else{if(a.indexOf("p7o7ul1nf.bkt.clouddn.com")>=0){a=a.replace("p7o7ul1nf.bkt.clouddn.com","cdn1.processon.com")}}}var i=navigator.userAgent.toLowerCase().indexOf("firefox")>=0;var c=b.image.w;var f=b.image.h;if(i){a+="?s=100_100"}c=c==0?100:c;f=f==0?100:f;var e=$("<div style='height:"+f+"px;width:"+c+"px;' class='topic-image'><img style='height:"+f+"px;width:"+c+"px;' id='topic_img_"+b.id+"' src='"+a+"'/></div>");g.prepend(e);return e}},previewTopicImage:{data:{imgUrl:"",imgW:0,imgH:0,scale:100,scaleMin:10,scaleMax:500,scaleInt:15,translateX:0,translateY:0,clientWidth:0,clientHeight:0,zoomNoticeTimeIdx:0,imageShow:false},init:function(b){if(!b){$.showTip("图片打开失败",2500);return}var e=this,c=this.data,d=$("#img-preview"),a=$("#img-preview .current-image")[0];c.imageShow=true;c.scale=100;c.translateX=0;c.translateY=0;c.imgUrl=b;a.src=b;a.onload=function(){if(c.imageShow){c.imgW=a.width;c.imgH=a.height;e.imgInit();d.show()}};a.onerror=function(){if(c.imageShow){$.showTip("图片打开失败",2500)}};d.off("mousedown").on("mousedown",function(f){f.stopPropagation()});$("#img-preview .current-image").off("mousedown").on("mousedown",function(i){i.stopPropagation();var g=e.data,k=g.translateX,h=g.translateY,f=i.pageX,l=i.pageY;$(document).off("mousemove.imgPreview").on("mousemove.imgPreview",function(o){o.stopPropagation();var m=o.pageX,n=o.pageY;g.translateX=Math.round(k+(m-f));g.translateY=Math.round(h+(n-l));e.setChange()});$(document).off("mouseup.imgPreview").on("mouseup.imgPreview",function(m){$(document).off("mousemove.imgPreview");$(document).off("mouseup.imgPreview")})});d.off("mousewheel DOMMouseScroll").on("mousewheel DOMMouseScroll",function(g){var f=g.originalEvent.wheelDelta||-g.originalEvent.detail;var h=Math.max(-1,Math.min(1,f));g.preventDefault();if(h<0){e.zoomFn(-1)}else{e.zoomFn(1)}return false});$("#img-preview .bottom-tool").off("click").on("click",".tool-item",function(){if($(this).hasClass("zoom-in")){e.zoomFn(1);return}if($(this).hasClass("zoom-out")){e.zoomFn(-1);return}if($(this).hasClass("zoom-size-adapt")){e.zoomFn(0)}});$("#img-preview .close-btn").off("click").on("click",function(){c.imageShow=false;d.hide();a.src=""})},zoomFn:function(d){var e=this.data,g=e.scale,f=Math.floor((e.scale-100)/e.scaleInt)+d,b=e.scaleInt*f+100;if(d===0){e.scale=100;e.translateX=0;e.translateY=0}else{e.scale=b<e.scaleMin?e.scaleMin:b>e.scaleMax?e.scaleMax:b;var a=Math.round(e.imgW*e.scale/100),c=Math.round(e.imgH*e.scale/100);e.clientWidth=$(document).width();e.clientHeight=$(document).height();if(a>e.clientWidth){e.translateX=e.translateX-Math.round(e.imgW*(e.scale-g)/200)}if(c>e.clientHeight){e.translateY=e.translateY-Math.round(e.imgH*(e.scale-g)/200)}}this.zoomNotice();this.setChange()},setChange:function(){var e=this.data,a=Math.round(e.imgW*e.scale/100),c=Math.round(e.imgH*e.scale/100);e.clientWidth=$(document).width();e.clientHeight=$(document).height();var d=a>e.clientWidth?(a-e.clientWidth):0,b=c>e.clientHeight?(c-e.clientHeight):0;if(d||b){$("#img-preview .current-image").addClass("move")}else{$("#img-preview .current-image").removeClass("move")}e.translateX=e.translateX>0?0:e.translateX<-d?-d:e.translateX;e.translateY=e.translateY>0?0:e.translateY<-b?-b:e.translateY;$("#img-preview .current-image").css({width:a,height:c,});$("#img-preview .image-container").css({width:a,height:c,left:e.translateX,top:e.translateY})},imgInit:function(){var a=this.data;a.clientWidth=$(document).width();a.clientHeight=$(document).height();if(a.imgW>a.clientWidth||a.imgH>a.clientHeight){a.scale=Math.round(100*Math.min(a.clientWidth/a.imgW,a.clientHeight/a.imgH))}this.setChange()},zoomNotice:function(){var b=$("#img-preview .zoom-ratio-notice"),a=this.data.scale+"%";if(b.is(":visible")){clearTimeout(this.data.zoomNoticeTimeIdx)}b.html(a).show();this.data.zoomNoticeTimeIdx=setTimeout(function(){b.hide()},1000)}},clearCanvas:function(){var a=$(".mind-context-menu");a.hide();a.appendTo($(".mind-util-container"));this.container.html("")},getStDef:function(n){var g=this,c=g.model,o=c.topic,h=g.operation,a=g.util;if(n!="mind_free"||!o.boundaries||o.boundaries.length==0){return}var t={};for(var r=0;r<o.boundaries.length;r++){var b=o.boundaries[r];var l=b.range+"";var s=Number(l.split(",")[0]);var q=Number(l.split(",")[1]);var e=o.children.concat(o.leftChildren||[]);var k=e[s].id;var p=e[q].id;if(b.part=="right"){t[b.id]=[k,p]}}var e=$.extend([],o.children);var f=$.extend([],o.leftChildren);for(var v in t){var k=t[v][0],p=t[v][1];for(var r=0;r<f.length;r++){var d=c.getTopicById(p);var m=f.indexOf(d);if(m>-1){var u=f.splice(0,m+1)||[];e=e.concat(u)}}}o.children=e;o.leftChildren=f},changeStructure:function(w,O,ac,ah,av){var af=this,f=af.model,S=f.topic,W=af.operation,C=af.messageSource,g=S.structure,t=af.util;W.zoomVal=100;S.structure=w;var e="&#xe6fe;";var H=S.children,P=t.copyArray(H),N=[],h=0;for(var ar=0;ar<P.length;ar++){var p=P[ar];if(p.free){var o=t.copy(p);N.push(o);H.splice(ar-h,1);h++;continue}}switch(w){case"mind_right":var aj=t.copyArray(S.leftChildren||[]);var q=S.children.length;var L=at(q,"right","left");S.leftChildren=[];S.children=S.children.concat(aj);e="&#xe6fb;";c(w,O||L.newSums,L.oldSums,ac||L.newBounds,L.oldBounds);break;case"mind_free":var M=[],T=[],m=[],s=[],G={},ae={};if(S.summaries&&S.summaries.length>0){var E={};for(var ar=0;ar<S.summaries.length;ar++){var F=S.summaries[ar];var u=F.range+"";var z=Number(u.split(",")[0]);var y=Number(u.split(",")[1]);var H=F.part=="left"?S.leftChildren:S.children;var l=H[z].id;var d=H[y].id;E[F.id]=[l,d]}}if(S.boundaries&&S.boundaries.length>0){var ab={};for(var ar=0;ar<S.boundaries.length;ar++){var v=S.boundaries[ar],aa=t.copy(v);m.push(aa);var u=v.range+"";var z=Number(u.split(",")[0]);var y=Number(u.split(",")[1]);var H=v.part=="left"?S.leftChildren:S.children;var l=H[z].id;var d=H[y].id;ab[v.id]=[l,d]}}var H=$.extend([],S.children);var aj=$.extend([],S.leftChildren);S.children=[];S.leftChildren=[];var ao=H.concat(aj);var K=ao.length;var r=K/2;if(K%2==1){r=(K+1)/2}var aq={};for(var ar=0;ar<K;ar++){var au=ao[ar],ad=au.id,B=0,D="",Q=true;if(Object.keys(aq).length>0){for(var an in aq){var a=aq[an];if(a.endId&&a.part){Q=false;if(a.part=="right"){B=S.children.length;S.children.push(au)}else{B=S.leftChildren.length;S.leftChildren.push(au)}D=a.part;break}}}if(Q){if(ar<r){B=S.children.length;S.children.push(au);D="right"}else{B=S.leftChildren.length;S.leftChildren.push(au);D="left"}}if(typeof ab!="undefined"&&Object.keys(ab).length>0){for(var J in ab){var b=ab[J];if(b[0]==ad&&b[1]!=ad){var am=f.getTopicById(J);am.part=D;am.range=B+",";s.push(am);aq[am.id]={part:D,endId:b[1]}}}}if(Object.keys(aq).length>0){for(j in aq){var d=aq[j].endId;if(d==ad){var am=f.getTopicById(j);if(typeof am!="undefined"){am.range+=B;delete aq[j]}}}}G[au.id]=D;ae[au.id]=B}var Y=S.children.concat(S.leftChildren),A=Y.length;var aj=S.leftChildren,H=S.children;var ap=S.summaries;if(ap!=null&&ap.length>0){for(var ai=0;ai<ap.length;ai++){var F=ap[ai];var al=t.copy(F);delete al.children;var aw=E[F.id];var Z=aw[0],d=aw[1];var X=G[Z];var I=G[d];var n=ae[Z];var ag=ae[d];var V=false;if(X==I){F.part=X;F.range=n+","+ag;V=true}else{if(X=="left"&&I=="right"){F.part="left";F.range=n+","+n;V=true}else{if(X=="right"&&I=="left"){F.part="right";F.range=n+","+n;V=true}}}if(V){var ak=t.copy(F);delete ak.children;M.push(al);T.push(ak)}}}c(w,O||T,M,ac||s,m);break;case"mind_left":var U=(S.leftChildren||[]).length;var L=at(U,"left","right");S.structure="mind_right";var H=$.extend([],S.children);S.leftChildren=S.leftChildren||[];S.children=[];for(var ar=0;ar<H.length;ar++){var R=H[ar];if(R.free){S.children.push(R)}else{S.leftChildren.push(R)}}e="&#xe6fc;";c(w,O||L.newSums,L.oldSums,ac||L.newBounds,L.oldBounds);break;case"mind_org":var q=S.children.length;var L=at(q,"right","left");var H=$.extend([],S.leftChildren);S.leftChildren=[];S.children=S.children.concat(H);e="&#xe6fd;";c(w,O||L.newSums,L.oldSums,ac||L.newBounds,L.oldBounds);break;case"mind_tree":var q=S.children.length;var L=at(q,"right","left");var H=$.extend([],S.leftChildren);delete S.leftChildren;S.children=S.children.concat(H);e="&#xe6fd;";c(w,O||L.newSums,L.oldSums,ac||L.newBounds,L.oldBounds);break}function at(aA,aF,aC){var aH=[],ax=[],k=[],az=[];if(S.summaries&&S.summaries.length>0){for(var aD=0;aD<S.summaries.length;aD++){var aG=t.copy(S.summaries[aD]);aG.children=[];if(aG.part&&aG.part==aC){aH.push(t.copy(aG));var aE=aG.range+"";var aB=Number(aE.split(",")[0]);var ay=Number(aE.split(",")[1]);var aJ=(aB+aA)+","+(ay+aA);var aI=aF;aG.part=aI;aG.range=aJ;ax.push(aG);S.summaries[aD].part=aI;S.summaries[aD].range=aJ}}}if(S.boundaries&&S.boundaries.length>0){for(var aD=0;aD<S.boundaries.length;aD++){var x=t.copy(S.boundaries[aD]);x.children=[];if(x.part&&x.part==aC){k.push(t.copy(x));var aE=x.range+"";var aB=Number(aE.split(",")[0]);var ay=Number(aE.split(",")[1]);var aJ=(aB+aA)+","+(ay+aA);var aI=aF;x.part=aI;x.range=aJ;az.push(x);S.boundaries[aD].part=aI;S.boundaries[aD].range=aJ}}}return{oldSums:aH,newSums:ax,oldBounds:k,newBounds:az}}function c(k,i,ax,ay,x){if(N.length>0){S.children=S.children.concat(N)}if(ah!=null){ah(e)}f.groupList.doGroup(S,S.structure);f.topicList.resetTopicList.call(af);W.clearCanvas.call(af);var az=af.opts.themeDef;mind=new mindDesigner("#mind_con",{chartId:chartId},S,az);if(av==null){C.send.call(af,"updateStructure",{content:k,original:g,newSums:i,oldSums:ax,newBounds:ay,oldBounds:x})}}},changeSumsorBoundsDom:function(k,u){var e=k.model,a=k.util,v=k.currentRoot||e.topic;if(!u||u==v.id){return}var t=e.getTopicById(u),l=a.getTopicDom(u),g=t.children,f=g[0].id,n=t.summaries,h=t.boundaries;if(!h||h.length==0){return true}l.find(".topic-children-boundary").removeClass("topic-children-boundary");for(var w=0,c=h.length;w<c;w++){var b=h[w],q=b.range,y=Number(q.indexOf(",")>0?q.split(",")[0]:q),r=g[y].id;if(n&&n.length>0){for(var x=0,s=n.length;x<s;x++){var d=n[x],o=d.range,p=Number(o.indexOf(",")>0?o.split(",")[0]:o);if(y==p){m(r)}}}if(f==r){m(r)}}function m(z){var i=a.getTopicContainer(z);i.addClass("topic-children-boundary")}},renderTopicLink:function(b,d,c){if(d.link&&d.link.value!=null){var g=d.link;var f=b.getTopicDom(d.id);var e=f.children(".topic-link");if(e.length){e.attr("href",g.value);e.attr("title",g.title);if(d.link.type=="file"){e.html("&#xe760;")}}else{var a="&#xe6aa;";if(d.link.type=="file"){a="&#xe760;"}e=$("<a href='"+g.value+"' target='_blank' title='"+g.title+"' class='topic-link mind-icons'>"+a+"</a>");if(d.note){f.find(".topic-note").after(e)}else{f.find(".topic").after(e)}}if(c=="right"||c==null){e.addClass("right")}else{if(c=="left"){e.addClass("left")}}}else{var f=b.getTopicDom(d.id);f.children(".topic-link").remove()}},zoomVal:100,zoomIn:function(a){var b=this,e=b.operation;e.zoomVal=Number(e.zoomVal)+15;var d=e.zoomVal;if(d>190){e.zoomVal=190;return}var c=d/100;a.css({transform:"scale("+c+")","-webkit-transform":"scale("+c+")","-moz-transform":"scale("+c+")"});mind.plugins.navigator.init.call(mind)},zoomOut:function(a){var b=this,e=b.operation;e.zoomVal=Number(e.zoomVal)-15;var d=e.zoomVal;if(d<40){e.zoomVal=40;return}var c=d/100;a.css({transform:"scale("+c+")","-webkit-transform":"scale("+c+")","-moz-transform":"scale("+c+")"});mind.plugins.navigator.init.call(mind)},tochZoom:function(b,e,a){var c=this,f=c.operation;if(e<40){f.zoomVal=40;return}if(e>190){f.zoomVal=190;return}f.zoomVal=e;var d=e/100;b.css({transform:"scale("+d+")","-webkit-transform":"scale("+d+")","-moz-transform":"scale("+d+")"});if(a!=null){b.css({"transform-origin":a,"-webkit-transform-origin":a})}mind.plugins.navigator.init.call(mind)},initBrash:function(h){var f=h.util,b=f.getSelectedId(),e=h.model,g=h.operation;if(b==""){return}var i=e.getTopicById(b);var a=h.style.getStyle.call(h,i);var d=f.copy(a);if(h.styles.autoColor&&d.lineStyle&&!d.lineStyle.lineColor&&!d.lineStyle.randomLineColor){var k=e.getTopicById(i.parent);var c=f.getPtLineColor.call(h,k);if(c){d.lineStyle=$.extend({},d.lineStyle,{lineColor:c});d.lineStype=d.lineStyle}}g.brashData.style=d;g.brashData.id=b;g.showTip()},brash:function(i){var f=this,d=f.util,c=f.model,e=f.operation,g=f.currentRoot||c.topic;if(e.brashData==null||e.brashData.style==null||e.brashData.id==i){return}var h=c.getTopicById(i);var a=e.brashData.style;var b=d.getSelectedPart(h.id,g.structure);f.style.setTopicStyles(f,h,a,b)},brashData:{id:null,style:null},showTip:function(){$("#mind-brash-tip").show().css({left:25,top:70})},closeTip:function(){$("#mind-brash-tip").hide();this.brashData.style=null;this.brashData.id=null;$(".brash").addClass("mind-disable")},scrollStv:null,scrollIsOver:false,scrollLayout:null,scrollPos:{},initScrollPos:function(){var a=$(window);this.scrollLayout=$("#mind_con");this.scrollPos.b=a.height()-80;this.scrollPos.t=105;this.scrollPos.l=80;this.scrollPos.r=a.width()-80},isScroll:function(a,c){var b=this;if(a<b.scrollPos.l){b.startScroll("l")}else{if(a>b.scrollPos.r){b.startScroll("r")}else{if(c<b.scrollPos.t){b.startScroll("t")}else{if(c>b.scrollPos.b){b.startScroll("b")}else{if(b.scrollIsOver){b.stopScroll()}}}}}},stopScroll:function(){var a=this;window.clearInterval(a.scrollStv);a.scrollStv=null;a.scrollIsOver=false},startScroll:function(b){var a=this;if(a.scrollIsOver){return}a.scrollIsOver=true;a.scrollStv=setInterval(function(){a.scrolling(b)},20)},scrolling:function(c){var b=this,a=b.scrollLayout;switch(c){case"t":a.scrollTop(a.scrollTop()-5);break;case"b":a.scrollTop(a.scrollTop()+5);break;case"l":a.scrollLeft(a.scrollLeft()-5);break;case"r":a.scrollLeft(a.scrollLeft()+5);break}},setNumber:function(n,m,a){var k=this,h=k.util,g=k.model;var e=[],c=[];for(var d=0;d<n.length;d++){var b=n[d];var f=g.getTopicById(b);var l=h.copy(f);if(m=="none"){delete f.number}else{f.number={type:m,level:a}}e.push(f);c.push(l)}g.updateTopicNode.call(k,e,c,"number",true)},renderNumber:function(b,d){var c=b.copyArray(d.children);if(d.leftChildren&&d.leftChildren.length>0){c=c.concat(d.leftChildren||[])}var f=0+"";if(!d.number){e(c,null,true,0);return}var a=d.number.level;e(c,null,null,0);function e(h,s,o,g){if(h.length>0){var n=0;g++;for(var m=0,p=h.length;m<p;m++){var k=h[m];if(k.free){continue}var l=b.getTopicDom(k.id);var q=l.children(".topic-number");if(q.length>0){q.remove()}if(!o&&d.number){n++;var r=b.convert(n,d.number.type);f=s==null?(r+"."):(s+r+".");q=$('<div class="topic-number">'+f+"</div>");l.prepend(q)}if(k.number){continue}var t=k.children;if(g<a&&k.children.length>0){e(t,f,o,g)}else{if(g<3){e(t,null,true,g)}}}}}},updateNumber:function(d,f){if(f){if(f>2){return}else{f++}}else{f=1}var e=this,c=e.model,a=e.util;if(d.parent){var b=c.getTopicById(d.parent);if(b.number){e.operation.renderNumber.call(e,a,b);return}e.operation.updateNumber.call(e,b,f)}},insertTemp:function(d,h,c,f){var e=this,b=e.model,a=b.topic,g=e.util.copy(a);if(!h){e.operation.clearCanvas.call(e);if(d!=null&&d.theme&&d.theme.indexOf("customise_")>=0){getThemeById(d.theme,function(i){mind=new mindDesigner("#mind_con",{chartId:chartId},d,i)})}else{mind=new mindDesigner("#mind_con",{chartId:chartId},d)}if(f==null){e.messageSource.send.call(e,"insertTemp",{content:d,original:a,tempId:c})}}}}};mindDesigner.prototype.line={renderLineCon:function(){var a='<svg xmlns="http://www.w3.org/2000/svg" version="1.1" width="100%" height="100%" xlink="http://www.w3.org/1999/xlink" class="mind-line-svg"><defs></defs><g  class="svg-topic-con" transform="translate(0.5,0.5)"></g><g class="svg-connection-con" transform="translate(0.5,0.5)"></g><g class="svg-freesums-con" transform="translate(0.5,0.5)"></g><g  class="svg-freebos-con" transform="translate(0.5,0.5)"></g></svg>';$(this.designer).append(a)},renderSubLineCon:function(b,c){var a='<svg xmlns="http://www.w3.org/2000/svg" version="1.1" width="100%" height="100%"  xlink="http://www.w3.org/1999/xlink"><g id="subline_'+c+'" transform="translate(0.5,-0.5)"></g><g transform="translate(0.5,0)"></g><g  class="svg-summary-con" transform="translate(0.5,0.5)"></g><g  class="svg-boundary-con" transform="translate(0.5,0.5)"></g></svg>';b.append(a)},getLineDom:function(a){return $("#line_"+a)},renderSubLine:function(r,k,g,e,o){var h=this,v=document,d=h.model,q=h.currentRoot||d.topic,b=h.line,i=h.styles;var f=v.getElementsByClassName("svg-topic-con")[0],s=h.style,a=h.util;var l=$("#line_"+r.id);if(l.length){l.remove()}var n;var c=s.getLineStyle.call(h,r);if(q.structure=="mind_org"||q.structure=="mind_tree"){n=a.copy(b.getOrgSubLinePath(c,g,e))}else{n=a.copy(b.getSubLinePath(c,r,k,i.thinner,i.unilateral,g,e,o,null,q.id))}var u="http://www.w3.org/2000/svg";var m=v.createElementNS(u,"path");m.setAttributeNS(null,"part",o);m.setAttributeNS(null,"sub","true");m.setAttributeNS(null,"id","line_"+r.id);for(var t in n){m.setAttributeNS(null,t,n[t])}f.appendChild(m)},getOrgSubLinePath:function(b,h,c,g){var a=Math.floor(h.x),f=Math.floor(c.y);c.x=Math.floor(c.x);h.y=Math.floor(h.y);if(Math.abs(a-c.x)<3&&a!=c.x){c.x=a}var e="M"+a+" "+h.y+" L"+a+" "+(f-23)+" L"+c.x+" "+(f-23)+" L"+c.x+" "+(f);if(g){return e}return{d:e,stroke:b.lineColor,fill:"none","stroke-width":b.lineWidth}},getSubLinePath:function(f,e,k,l,m,a,c,b,h,i){var d=f.lineType,g="sub"+d+"UnderLine";if(f.underLine&&this.linePaths[g]!=null){return this.linePaths[g](e,k,f,a,c,l,m,b,h,i)}return this.linePaths["sub"+d](e,k,f,a,c,l,m,b,h,i)},getLinePath:function(d,f,e,h,a,c,b,g){if(e.underLine&&this.linePaths[e.lineType+"UnderLine"]!=null){return this.linePaths[e.lineType+"UnderLine"](d,f,e,h,a,c,b,null,g)}var i=this.linePaths[e.lineType](d,f,e,h,a,c,b,null,g);return i},getTreeLinePath:function(e,k,f,l,a,c,b,h){var i=a.y+2,m=a.x+c.w+10;var g="M"+a.x+" "+i+" L"+a.x+" "+c.y+"L"+m+" "+c.y;if(h){return g}return{d:g,p:k.id,stroke:f.lineColor,fill:"none","stroke-linecap":"round","stroke-width":1}},getOrgLinePath:function(e,l,f,m,a,c,b,h){var i=Math.floor(a.y)+2;a.x=Math.floor(a.x);c.x=Math.floor(c.x);c.y=Math.floor(c.y);if(Math.abs(a.x-c.x)<3&&a.x!=c.x){c.x=a.x}var g="M"+a.x+" "+i+" L"+a.x+" "+(i+24)+" L"+c.x+" "+(i+24)+"L"+c.x+" "+(c.y-2);if(l.summary){var k=a.x;if(Math.abs(c.x-k)<6){c.x=k}g="M"+k+" "+i+" L"+k+" "+(i+24)+" L"+c.x+" "+(i+24)+"L"+c.x+" "+(c.y-2)}if(h){return g}return{d:g,p:l.id,stroke:f.lineColor,fill:"none","stroke-linecap":"round","stroke-width":f.lineWidth}},renderLines:function(d,a,b){var k=this,h=k.util,i=k.operation,o=i.zoomVal/100,q=k.line,g=k.model,m=k.currentRoot||g.topic,f=m.structure;if(b=="left"){n(d,a)}else{e(d,a)}function c(s,t){if(s.summaries!=null&&s.summaries.length>0){var u=s.summaries;for(var r=0;r<u.length;r++){var v=u[r];p(v,t)}}}function p(t,s){if(t.summary&&f=="mind_tree"){return}k.summary.renderSummarieShape.call(k,t,b,s);if(t.collapsed){return}var r=h.getChildTopicRelativePos.call(k,t.id,o);if(b=="left"){n(t,r)}else{if(t.summary&&f=="mind_org"){r.x+=r.w/2}else{r.x+=r.w}e(t,r)}}function l(s,r){k.boundary.renderBoundariesShape(k,d,b)}function e(w,r){if(w.summary&&f=="mind_tree"){return}if(w.collapsed){return}var s=w.children,x=s.length;var A=w.summaries,y=s;if(A!=null&&A.length>0){y=s.concat(A);x=y.length}var t=w.boundaries;if(t!=null&&t.length>0){y=y.concat(t);x=y.length}if(x==0){return}if(x>0){for(var v=0;v<x;v++){var z=y[v];if(!z){continue}if(f=="mind_org"){if(z.boundary){l(z,w);continue}var u=h.getOrgChildTopicRelativePos.call(k,z.id,o);if(z.summary){p(z,w)}else{q.renderLine.call(k,z,w,r,u,d.id)}u.y+=u.h}else{if(f=="mind_tree"){if(z.summary){continue}if(z.boundary){l(z,w);continue}var u=h.getTreeChildTopicRelativePos.call(k,z.id,o);if(!z.summary){q.renderLine.call(k,z,w,r,u,d.id)}else{continue}u.x+=9}else{if(z.boundary){l(z,w);continue}var u=h.getChildTopicRelativePos.call(k,z.id,o);if(z.summary){p(z,w)}else{q.renderLine.call(k,z,w,r,u,d.id)}u.x+=u.w}}if(!z.summary&&!z.boundary){e(z,u)}}}}function n(w,r){if(w.collapsed||w.boundary){return}var s=w.children,x=s.length;var A=w.summaries,y=s;if(A!=null&&A.length>0){y=s.concat(A);x=y.length}var t=w.boundaries;if(t!=null&&t.length>0){y=y.concat(t);x=y.length}if(x>0){for(var v=0;v<x;v++){var z=y[v];if(z.boundary){l(z,w);continue}if(z.summary){p(z,w)}else{var u=h.getChildTopicRelativePos.call(k,z.id,o);q.renderLine.call(k,z,w,r,u,d.id,"left");n(z,u)}}}}},renderLine:function(r,h,d,c,e,o){if(d.w==0){return}var f=this,b=f.model,q=f.currentRoot||b.topic,g=f.styles,s=f.style,m=q.structure||b.topic.structure;var i=$("#line_"+r.id);var k=document.getElementById("subline_"+e);if(i.length){i.remove()}var a=s.getLineStyle.call(f,r);var n;if(m=="mind_org"){n=f.line.getOrgLinePath(r,h,a,false,d,c,o)}else{if(m!="mind_tree"){n=f.line.getLinePath(r,h,a,g,d,c,o,q.id)}else{n=f.line.getTreeLinePath(r,h,a,false,d,c,o)}}var u="http://www.w3.org/2000/svg";var l=document.createElementNS(u,"path");l.setAttributeNS(null,"id","line_"+r.id);if(typeof n=="object"){for(var t in n){l.setAttributeNS(null,t,n[t])}}k.appendChild(l)},renderNewLine:function(g,e,f,d,c){var b=g.line;if(f.root){b.renderSubLine.call(g,e,f,{x:0,y:0,h:0},{x:0,y:0,h:0},c)}else{var a=document.getElementById("subline_"+d);b.renderLine.call(g,e,f,{x:0,y:0,h:0,w:0},{x:0,y:0,h:0,w:0},d,c)}},renderNewLines:function(g,d,c){var b=g.line,f=d.children,a=f.length;if(a>0){for(var e=0;e<a;e++){var h=f[e];b.renderNewLine(g,h,d,c);if(h.collapsed){continue}b.renderNewLines(g,h,c)}}},resetSubLines:function(s){var k=this,b=k.util,e=k.model,m=k.operation,a=m.zoomVal/100,t=k.currentRoot||e.topic,l=k.styles,o=k.line,x=$(".svg-topic-con");var r=null;if(s!=null&&s.indexOf("left")>=0&&s.indexOf("right")<0){r=x.children("path[part=left]")}else{if(s!=null&&s.indexOf("left")>=0&&s.indexOf("right")>=0){r=x.children("path")}else{r=x.children("path[part=right]")}}var c=b.getTopicContainerProp(t.id,a);var g={x:c.x+c.w/2,y:c.y+c.h/2};var v=r.length;for(var u=0;u<v;u++){var w=r[u],f;var p=w.getAttribute("id").substr(5);if(t.structure=="mind_org"){f=b.getSubTopicDomProp(p,"mind_org",a)}else{if(t.structure=="mind_tree"){f=b.getSubTopicDomProp(p,"mind_tree",a)}else{f=b.getSubTopicDomProp(p,null,a)}}var q=w.getAttribute("part");if(q=="left"){f.x+=f.w}var d=e.getTopicById(p);var y=k.style.getLineStyle.call(k,d);var h;if(t.structure=="mind_org"||t.structure=="mind_tree"){h=o.getOrgSubLinePath(y,g,f,true)}else{var n=e.getParentTopic(d.parent);h=o.getSubLinePath(y,d,n,l.thinner,l.unilateral,g,f,q,true,t.id)}w.setAttribute("d",h)}},resetLines:function(m,J,n){var B=new Date().valueOf();var F=this,e=F.util,w=F.opts,z=F.operation,H=z.zoomVal/100,c=F.model,v=F.currentRoot||c.topic,o=v.structure||c.topic.structure,A=F.styles,f=F.line,E=$(".svg-topic-con"),x;if(n!=null&&n.indexOf("left")>=0&&n.indexOf("right")<0){x=E.children("path[part=left]")}else{if(n!=null&&n.indexOf("left")>=0&&n.indexOf("right")>=0){x=E.children("path")}else{x=E.children("path[part=right]")}}var a=(o=="mind_org");var M=(o=="mind_tree");var r=x.length;if(J!=null&&J==0&&!a&&!M){r=0}var G={};var D=e.getTopicDomProp(v.id,H);var u={x:D.x+D.w/2,y:D.y+D.h/2};for(var I=0;I<r;I++){var b=x[I];var C=b.getAttribute("id").substr(5);var g=b.getAttribute("part");var q;if(a){q=e.getSubTopicDomProp(C,"mind_org",H)}else{if(M){q=e.getSubTopicDomProp(C,"mind_tree",H)}else{q=e.getSubTopicDomProp(C,null,H)}}if(g=="left"){q.x+=q.w}G[C]=g;var L=c.getTopicById(C);if(L.free){continue}var t=F.style.getLineStyle.call(F,L);var K="";if(a||M){K=f.getOrgSubLinePath(t,u,q,true)}else{var l=c.getParentTopic(L.parent);K=f.getSubLinePath(t,L,l,A.thinner,A.unilateral,u,q,g,true,v.id)}b.setAttribute("d",K)}if(m.length>0){for(var I=0;I<m.length;I++){var C=m[I],p=c.getTopicById(C);if(p==null){continue}var d=$("#subline_"+C),k=d.children("path"),y=k.length,g=G[C];if((p.children.length==0&&p.summaries==null)||d.length==0){continue}if(g==null){g=n;if(p.part!=null){g=p.part}}var u;if(a){u=e.getSubTopicRelativePos(C,"mind_org")}else{if(M){u=e.getSubTopicRelativePos(C,"mind_tree");u.x+=9}else{u=e.getSubTopicRelativePos(C);if(g=="left"){var s=e.getTopicDomProp(C);u.x=s.w-u.w-2}else{u.x=u.w}}}f.renderLines.call(F,p,u,g)}}},deleteLine:function(b){var e=this,d=b.children,a=d.length;$("path[id=line_"+b.id+"]").remove();if(b.summary){$("path[id=sum_"+b.id+"]").remove()}if(b.boundary){$("path[id=bo_"+b.id+"]").remove()}if(a>0){for(var c=0;c<a;c++){var f=d[c];e.deleteLine(f)}}if(b.summaries!=null&&b.summaries.length>0){for(var c=0;c<b.summaries.length;c++){var f=b.summaries[c];e.deleteLine(f)}}if(b.boundaries!=null&&b.boundaries.length>0){for(var c=0;c<b.boundaries.length;c++){var f=b.boundaries[c];e.deleteLine(f)}}},deleteChildrenLines:function(b){var e=this,d=b.children,a=d.length;if(a>0){for(var c=0;c<a;c++){var f=d[c];$("path[id=line_"+f.id+"]").remove();e.deleteChildrenLines(f)}}if(b.summaries!=null&&b.summaries.length>0){for(var c=0;c<b.summaries.length;c++){var f=b.summaries[c];if(f.summary){$("path[id=sum_"+f.id+"]").remove()}e.deleteChildrenLines(f)}}if(b.boundaries!=null&&b.boundaries.length>0){for(var c=0;c<b.boundaries.length;c++){var f=b.boundaries[c];if(f.boundary){$("path[id=bo_"+f.id+"]").remove()}e.deleteChildrenLines(f)}}},linePaths:{subcurve:function(o,m,c,i,e,g,t,n,b){if(g){var p=["M"];var a=i.y-6;var s=i.y+6;var l=i.x+10;var k=-120,r=-100;if(n=="left"){k=120,r=100;l=i.x-10}if(e.y<a){p.push(i.x);p.push(a);p.push("C");p.push(i.x);p.push(a);p.push(e.x+k);p.push(e.y);p.push(e.x);p.push(e.y);p.push("C");p.push(e.x+r);p.push(e.y);p.push(l);p.push(i.y);p.push(l);p.push(i.y);p.push("L");p.push(i.x);p.push(a);p.push("Z")}else{if(e.y>=a&&e.y<=s){p.push(i.x);p.push(a);p.push("L");p.push(i.x);p.push(s);p.push("L");p.push(e.x);p.push(e.y);p.push("L");p.push(i.x);p.push(a)}else{p.push(i.x);p.push(s);p.push("C");p.push(i.x);p.push(s);p.push(e.x+k);p.push(e.y);p.push(e.x);p.push(e.y);p.push("C");p.push(e.x+r);p.push(e.y);p.push(l);p.push(i.y);p.push(l);p.push(i.y);p.push("L");p.push(i.x);p.push(s);p.push("Z")}}var q=p.join(" ");if(b){return q}return{d:q,stroke:c.lineColor,fill:c.lineColor,"stroke-width":2}}else{if(t){var p=["M"];p.push(i.x);p.push(i.y);p.push("L");var h=$("#root").outerWidth()/2;var f=0;if(n=="left"){f=i.x-h+12}else{f=i.x+h-12}p.push(f);p.push(i.y);p.push("C");if(n=="left"){p.push(f-40)}else{p.push(f+40)}p.push(i.y);if(n=="left"){p.push(f-40)}else{p.push(f+40)}p.push(e.y);p.push(e.x);p.push(e.y);var q=p.join(" ");if(b){return q}return{d:q,stroke:c.lineColor,fill:"none","stroke-width":c.lineWidth}}else{var p=["M"];p.push(i.x);p.push(i.y);p.push("C");p.push(i.x);p.push(i.y);if(n=="left"){p.push(i.x-10)}else{p.push(i.x+10)}p.push(e.y);p.push(e.x);p.push(e.y);var q=p.join(" ");if(b){return q}return{d:q,stroke:c.lineColor,fill:"none","stroke-width":c.lineWidth}}}},substraight:function(f,m,g,a,e,n,p,b,l){if(n){var k=["M"];var i=a.y-6;var o=a.y+6;var c=a.x+6;if(b=="left"){c=a.x-6}if(e.y<i){k.push(a.x);k.push(i);k.push("L");k.push(c);k.push(a.y);k.push("L");k.push(e.x);k.push(e.y);k.push("L");k.push(a.x);k.push(i)}else{if(e.y>=i&&e.y<=o){k.push(a.x);k.push(i);k.push("L");k.push(a.x);k.push(o);k.push("L");k.push(e.x);k.push(e.y);k.push("L");k.push(a.x);k.push(i)}else{k.push(a.x);k.push(o);k.push("L");k.push(c);k.push(a.y);k.push("L");k.push(e.x);k.push(e.y);k.push("L");k.push(a.x);k.push(o)}}k.push("Z");var h=k.join(" ");if(l){return h}return{d:h,stroke:g.lineColor,fill:g.lineColor,"stroke-width":2}}else{var k="M"+a.x+" "+a.y+" L"+e.x+" "+e.y;if(l){return k}return{d:k,stroke:g.lineColor,fill:"none","stroke-width":g.lineWidth}}return path},subbroken:function(e,l,f,a,c,m,n,b,h){if(m){}else{var k=Math.ceil(a.x),i=Math.ceil(c.y);var g="M"+k+" "+a.y+" L"+k+" "+i+" L"+c.x+" "+i;if(h){return g}return{d:g,stroke:f.lineColor,fill:"none","stroke-width":f.lineWidth}}return path},subroundBroken:function(g,n,h,c,f,o,p,e,m){var k=["M"];if(o){}else{if(p){var l=$("#root").outerWidth()/2;var a=0;if(e=="left"){a=c.x-l-30}else{a=c.x+l+30}var b=(c.y<f.y);k.push(c.x);k.push(c.y);k.push("L");k.push(a);k.push(c.y);k.push("L");k.push(a);if(Math.abs(f.y-c.y)>8){k.push(b?f.y-8:f.y+8);k.push("A");k.push(8);k.push(8);k.push(0);k.push(0);if(e=="left"){k.push(b?1:0);k.push(a-8)}else{k.push(b?0:1);k.push(a+8)}k.push(f.y)}else{k.push(f.y)}k.push("L");k.push(f.x);k.push(f.y);var i=k.join(" ");if(m){return i}return{d:i,stroke:h.lineColor,fill:"none","stroke-width":h.lineWidth}}else{var b=(c.y<f.y);k.push(c.x);k.push(c.y);k.push("L");k.push(c.x);if(Math.abs(f.y-c.y)>8){k.push(b?f.y-8:f.y+8);k.push("A");k.push(8);k.push(8);k.push(0);k.push(0);if(e=="left"){k.push(b?1:0);k.push(c.x-8)}else{k.push(b?0:1);k.push(c.x+8)}k.push(f.y)}else{k.push(f.y)}k.push("L");k.push(f.x);k.push(f.y);var i=k.join(" ");if(m){return i}return{d:i,stroke:h.lineColor,fill:"none","stroke-width":h.lineWidth}}}return path},subslant:function(g,n,h,c,f,o,p,e,m){var k=["M"];if(o){}else{if(p){var l=$("#root").outerWidth()/2;var a=0;if(e=="left"){a=c.x-l-10}else{a=c.x+l+10}var b=(c.y<f.y);k.push(c.x);k.push(c.y);k.push("L");k.push(a);k.push(c.y);k.push("L");if(e=="left"){k.push(f.x+20)}else{k.push(f.x-20)}k.push(f.y);k.push("L");k.push(f.x);k.push(f.y);var i=k.join(" ");if(m){return i}return{d:i,stroke:h.lineColor,fill:"none","stroke-width":h.lineWidth}}else{var b=(c.y<f.y);k.push(c.x);k.push(c.y);k.push("L");k.push(c.x);if(Math.abs(f.y-c.y)>8){k.push(b?f.y-8:f.y+8);k.push("A");k.push(8);k.push(8);k.push(0);k.push(0);if(e=="left"){k.push(b?1:0);k.push(c.x-8)}else{k.push(b?0:1);k.push(c.x+8)}k.push(f.y)}else{k.push(f.y)}k.push("L");k.push(f.x);k.push(f.y);var i=k.join(" ");if(m){return i}return{d:i,stroke:h.lineColor,fill:"none","stroke-width":h.lineWidth}}}return path},subcurveUnderLine:function(q,o,c,i,e,g,w,p,b){var s=["M"],m=$("#"+q.id),l=m.outerHeight(),v=m.outerWidth();e.y=e.y+l/2-1.5;if(p=="left"){e.x=e.x-1}else{e.x=e.x}if(g){var s=["M"];var a=i.y-6;var u=i.y+6;var n=i.x+10;var k=-120,t=-100;if(p=="left"){k=120,t=100;n=i.x-10}if(e.y<a){s.push(i.x);s.push(a);s.push("C");s.push(i.x);s.push(a);s.push(e.x+k);s.push(e.y);s.push(e.x);s.push(e.y);s.push("C");s.push(e.x+t);s.push(e.y);s.push(n);s.push(i.y);s.push(n);s.push(i.y);s.push("L");s.push(i.x);s.push(a);s.push("Z")}else{if(e.y>=a&&e.y<=u){s.push(i.x);s.push(a);s.push("L");s.push(i.x);s.push(u);s.push("L");s.push(e.x);s.push(e.y);s.push("L");s.push(i.x);s.push(a)}else{s.push(i.x);s.push(u);s.push("C");s.push(i.x);s.push(u);s.push(e.x+k);s.push(e.y);s.push(e.x);s.push(e.y);s.push("C");s.push(e.x+t);s.push(e.y);s.push(n);s.push(i.y);s.push(n);s.push(i.y);s.push("L");s.push(i.x);s.push(u);s.push("Z")}}var r=s.join(" ");if(b){return r}return{d:r,stroke:c.lineColor,fill:c.lineColor,"stroke-width":2}}else{if(w){var s=["M"];s.push(i.x);s.push(i.y);s.push("L");var h=$("#root").outerWidth()/2-5;var f=0;if(p=="left"){f=i.x-h}else{f=i.x+h}s.push(f);s.push(i.y);s.push("C");if(p=="left"){s.push(f-40)}else{s.push(f+40)}s.push(i.y);if(p=="left"){s.push(f-40)}else{s.push(f+40)}s.push(e.y);s.push(e.x);s.push(e.y);s.push("L");if(p=="left"){var v=$("#"+q.id).outerWidth();s.push(e.x-v)}else{var v=$("#"+q.id).outerWidth();s.push(e.x+v)}s.push(e.y);var r=s.join(" ");if(b){return r}return{d:r,stroke:c.lineColor,fill:"none","stroke-linecap":"round","stroke-width":c.lineWidth}}else{var s=["M"];s.push(i.x);s.push(i.y);s.push("C");if(p=="left"){s.push(i.x-30);s.push(i.y);s.push(i.x-10)}else{s.push(i.x+30);s.push(i.y);s.push(i.x+10)}s.push(e.y);s.push(e.x);s.push(e.y);var r=s.join(" ");if(b){return r}return{d:r,stroke:c.lineColor,fill:"none","stroke-width":c.lineWidth}}}},curve:function(h,o,i,q,a,e,b,m){var r="",l=["M"],p=e.x;if(Math.abs(e.y-a.y)<=3){e.y=a.y}var f=e.x-20,g=a.x+24,c=16;if(b=="left"){f=e.x+18+e.w,g=a.x-20;c=-16;p+=e.w}var n=(a.y+e.y)/2;if(q.unilateral){l.push(a.x);l.push(a.y);l.push("L");l.push(a.x);l.push(a.y);l.push("C");if(b=="left"){l.push(a.x-25)}else{l.push(a.x+25)}l.push(a.y);if(b=="left"){l.push(a.x-25)}else{l.push(a.x+25)}l.push(e.y);l.push(p);l.push(e.y);var k=l.join(" ");if(m){return k}return{d:k,p:o.id,stroke:i.lineColor,"stroke-linecap":"round",fill:"none","stroke-width":i.lineWidth}}else{l.push(a.x);l.push(a.y);l.push("L");l.push(a.x+c);l.push(a.y);l.push("C");l.push(g);l.push(a.y);l.push(f);l.push(e.y);l.push(p);l.push(e.y);var k=l.join(" ");if(m){return k}return{d:k,p:o.id,stroke:i.lineColor,"stroke-linecap":"round",fill:"none","stroke-width":i.lineWidth}}},straight:function(e,i,f,m,a,c,b,h){if(Math.abs(c.y-a.y)<=3){c.y=a.y}var n="",l=c.x,k=c.y;var g="";if(b=="left"){l+=c.w;g="M"+(a.x-4)+" "+a.y+" L"+(a.x-17)+" "+a.y+" L"+l+" "+c.y}else{g="M"+(a.x+4)+" "+a.y+" L"+(a.x+17)+" "+a.y+" L"+l+" "+c.y}if(h){return g}return{d:g,p:i.id,stroke:f.lineColor,fill:"none","stroke-linecap":"round","stroke-width":f.lineWidth}},broken:function(h,o,i,q,a,e,b,l,n){if(Math.abs(e.y-a.y)<=3){e.y=a.y}var k="",g=a.x;var f=i.underLine?(a.y+a.h/2):a.y;var p=i.underLine?(e.y+e.h/2):e.y;var c=o.summary?true:false;var m=o.parent==n;if(!m&&!c&&b=="left"){g-=a.w}if(b=="left"){e.x+=e.w;k="M"+g+" "+f+"L"+Math.ceil(g-15)+" "+f+" L"+Math.ceil(g-15)+" "+p+" L"+e.x+" "+p}else{k="M"+g+" "+f+"L"+Math.ceil(g+15)+" "+f+" L"+Math.ceil(g+15)+" "+p+" L"+e.x+" "+p}if(l){return k}return{d:k,p:o.id,stroke:i.lineColor,fill:"none","stroke-linecap":"square","stroke-width":i.lineWidth}},roundBroken:function(o,k,c,h,g,f,n,b,s){if(Math.abs(f.y-g.y)<=3){f.y=g.y}var m="",r=["M"],l=g.x;var p=c.underLine?(g.y+g.h/2):g.y;var a=c.underLine?(f.y+f.h/2):f.y;var t=a>g.y;var i=k.parent==s;var e=k.summary?true:false;if(!i&&!e&&n=="left"){l-=g.w}r.push(l);r.push(i?g.y:p);r.push("L");if(n=="left"){l=l-18;f.x+=f.w}else{l=g.x+18}r.push(l);r.push(i?g.y:p);r.push("L");r.push(l);if(Math.abs(a-p)>5){r.push(t?a-4:a+4);r.push("A");r.push(4);r.push(4);r.push(0);r.push(0);if(n=="left"){r.push(t?1:0);r.push(l-4)}else{r.push(t?0:1);r.push(l+4)}r.push(a)}else{r.push(a)}r.push("L");r.push(f.x);r.push(a);var q=r.join(" ");if(b){return q}return{d:q,p:k.id,stroke:c.lineColor,fill:"none","stroke-linecap":"square","stroke-width":c.lineWidth}},slant:function(o,k,c,h,g,f,n,b,s){if(Math.abs(f.y-g.y)<=3){f.y=g.y}var m="",r=["M"],l=g.x;var p=c.underLine?(g.y+g.h/2):g.y;var a=c.underLine?(f.y+f.h/2):f.y;var t=a>g.y;var i=k.parent==s;var e=k.summary?true:false;if(!i&&!e&&n=="left"){l-=g.w}if(h.unilateral){r.push(l);r.push(i?g.y:p);r.push("L");if(n=="left"){l=Math.ceil(l-18);f.x+=f.w}else{l=Math.ceil(g.x+18)}r.push(l);r.push(i?g.y:p);r.push("L");if(n=="left"){r.push(f.x+15)}else{r.push(f.x-15)}r.push(a);r.push("L");r.push(f.x);r.push(a);var q=r.join(" ");if(b){return q}return{d:q,p:k.id,stroke:c.lineColor,fill:"none","stroke-width":c.lineWidth}}else{r.push(l);r.push(i?g.y:p);r.push("L");if(n=="left"){l=Math.ceil(l-18);f.x+=f.w}else{l=Math.ceil(g.x+18)}r.push(l);r.push(i?g.y:p);r.push("L");r.push(l);if(Math.abs(a-p)>5){r.push(t?a-4:a+4);r.push("A");r.push(4);r.push(4);r.push(0);r.push(0);if(n=="left"){r.push(t?1:0);r.push(l-4)}else{r.push(t?0:1);r.push(l+4)}r.push(a)}else{r.push(a)}r.push("L");r.push(f.x);r.push(a)}var q=r.join(" ");if(b){return q}return{d:q,p:k.id,stroke:c.lineColor,fill:"none","stroke-linecap":"square","stroke-width":c.lineWidth}},roundBrokenUnderLine:function(n,i,c,g,f,e,m,b,r){var l="",q=["M"],k;if(f.x==0){return""}if(Math.abs(e.y-f.y)<=3){e.y=f.y}var o=Math.floor(f.y+f.h/2);if(i.summary){o-=Math.floor(f.h/2)}var a=Math.floor(e.y+e.h/2);var t=a>f.y;var h=i.parent==r;q.push(f.x);q.push(h?f.y:o);q.push("L");if(m=="left"){k=Math.ceil(f.x-18)}else{k=Math.ceil(f.x+18)}q.push(k);q.push(h?f.y:o);q.push("L");q.push(k);if(Math.abs(a-o)>20){q.push(t?a-4:a+4);q.push("A");q.push(4);q.push(4);q.push(0);q.push(0);if(m=="left"){q.push(t?1:0);q.push(k-4)}else{q.push(t?0:1);q.push(k+4)}q.push(a)}else{q.push(a)}q.push("L");if(m=="left"){q.push(e.x)}else{var s=$("#"+n.id).outerWidth();q.push(e.x+s)}q.push(a);var p=q.join(" ");if(b){return p}return{d:p,p:i.id,stroke:c.lineColor,fill:"none","stroke-linecap":"square","stroke-width":c.lineWidth}},curveUnderLine:function(o,k,e,h,g,f,n,c,s){var m="",r=["M"],l;if(g.x==0){return""}if(Math.abs(f.y-g.y)<=3){f.y=g.y}var p=Math.floor(g.y+g.h/2);var a=Math.floor(f.y+f.h/2);var u=a>g.y;var i=k.parent==s;if(h.unilateral){r.push(g.x);r.push(p);r.push("L");r.push(g.x);r.push(p);r.push("M");r.push(g.x);r.push(p);r.push("C");var b=f.x;if(n=="left"){b+=$("#"+o.id).outerWidth()}if(n=="left"){r.push(b+30);r.push(p);r.push((g.x+b)/2);r.push(a);r.push(b)}else{r.push(f.x-30);r.push(p);r.push((g.x+f.x)/2);r.push(a);r.push(b)}r.push(a);r.push("L");if(n=="left"){r.push(f.x)}else{var t=$("#"+o.id).outerWidth();r.push(f.x+t)}r.push(a);var q=r.join(" ");if(c){return q}return{d:q,p:k.id,stroke:e.lineColor,fill:"none","stroke-linecap":"round","stroke-width":e.lineWidth}}else{r.push(g.x);r.push(p);r.push("L");if(n=="left"){l=Math.ceil(g.x-18)}else{l=Math.ceil(g.x+18)}r.push(l);r.push(p);r.push("M");r.push(l);r.push(p);r.push("C");var b=f.x;if(n=="left"){b+=$("#"+o.id).outerWidth()}if(n=="left"){r.push(b+20);r.push(p);r.push((g.x+b)/2);r.push(a);r.push(b)}else{r.push(f.x-20);r.push(p);r.push((g.x+f.x)/2);r.push(a);r.push(b)}r.push(a);r.push("L");if(n=="left"){r.push(f.x)}else{var t=$("#"+o.id).outerWidth();r.push(f.x+t)}r.push(a);var q=r.join(" ");if(c){return q}return{d:q,p:k.id,stroke:e.lineColor,fill:"none","stroke-linecap":"square","stroke-width":e.lineWidth}}},brokenUnderLine:function(o,k,c,i,g,f,n,b,s){if(Math.abs(f.y-g.y)<=3){f.y=g.y}var m="",r=["M"],l,t=$("#"+o.id).outerWidth();var e=k.summary?true:false;var p=g.y;if(!e){p+=g.h/2}var a=f.y+f.h/2;var u=a>g.y;var h=k.parent==s;r.push(g.x);r.push(h?g.y:p);r.push("L");if(n=="left"){l=Math.ceil(g.x-18)}else{l=Math.ceil(g.x+18)}r.push(l);r.push(h?g.y:p);r.push("L");r.push(l);r.push(a);r.push("L");if(n=="left"){r.push(l-t-18)}else{r.push(l+t+18)}r.push(a);var q=r.join(" ");if(b){return q}return{d:q,p:k.id,stroke:c.lineColor,fill:"none","stroke-linecap":"square","stroke-width":c.lineWidth}}}};mindDesigner.prototype.summary={model:{styles:{lineColor:"#bf1e1b",lineWidth:"1",lineType:"curve_complex"},currentStyle:null,addSummary:function(f,s){var e=this,a=e.util,b=e.model,n=e.currentRoot||b.topic,g=e.line,p=b.groupList;var r=f.length,l={},t=[];for(var q=0;q<r;q++){var d=a.copy(f[q]);var m=d.part;var k=b.getTopicById(d.parent);var h=b.getSubTopic(d);if(m==null){m=a.getSelectedPart(h.id,n.structure)}if(k){t.push(k)}if(k.id==n.id){d.pos={}}var c=k.summaries;if(c==null){k.summaries=[]}k.summaries.push(d);b.addTopicToList(d,k);if(d.part==null){var o=null;if(!k.root){o=a.getTopicContainerProp(h.id)}e.renderSubTopic(d,null,m);e.range.changeTopicPos(e,d,h,m,o);g.resetLines.call(e,[h.id],null,m)}else{e.renderSubTopic(d,null,m)}l[d.id]=m}p.doGroup(n,n.structure);b.topicList.resetTopicList.call(e);e.renderFreeSummaries(m);if(t){e.events.push("outline-prebuild",{topics:t,insertChild:true})}if(s==null){e.messageSource.send.call(e,"addSummary",{content:f,parts:l});a.selectOne.call(e,f[0])}},removeSummary:function(F,x,I){var k=this,d=k.model,B=k.currentRoot||d.topic,E=d.groupList,a=k.util,q=k.line,m=k.styles;var v=k.util.getMargin.call(k);var u=v.marginW,L=v.marginH;var K=[],A={},x=x||{},l="",J=[];k.connection.deleteConnectionByTopics.call(k,F);for(var D=F.length-1;D>=0;D--){var z=F[D];var n=d.getParentTopic(z.parent);if(n==null){continue}J.push(n);var f=d.getSubTopic(z);var y=a.getSelectedPart(z.id,B.structure);var H=0;var c=a.getTopicContainerProp(f.id);var o=$(".topic-box[id="+z.id+"]").parent().parent().prev();if(o.length){if(o.children().length>0){var r=z.range+"";var t=0;var M=0;if(r.indexOf(",")<0){t=r;M=r}else{t=r.split(",")[0];M=r.split(",")[1]}var b=o.parent();o.children().each(function(){var h=$(this);b.before(h)});b.remove()}}q.deleteLine(z);if(!z.free&&c!=null){if(f.id==z.id){H=c.h+L;var p=0;if(B.structure=="mind_org"||B.structure=="mind_tree"){p=-(c.w)-u/2}k.range.doChangeSubTopicPos(k,f,-H/2,p,y)}else{var s=a.getTopicContainerProp(f.id);H=s.h-c.h;var p=0;if(B.structure=="mind_org"||B.structure=="mind_tree"){p=(s.w-c.w)}k.range.doChangeSubTopicPos(k,f,H/2,p,y)}if(K.indexOf(f.id)<0){K.push(f.id)}}if(I==null){a.selectOne.call(k,n)}var e=n.summaries;var G=e.length;for(var C=0;C<G;C++){var g=e[C];if(g.id==z.id){A[z.id]=C;e.splice(C,1);break}}x[z.id]=y;l+=y+","}k.model.topicList.resetTopicList.call(k);d.groupList.doGroup(B,B.structure);q.resetLines.call(k,K,null,l);if(I==null){k.messageSource.send.call(k,"deleteSummary",{content:F,index:A,parts:x})}k.connection.resetAllConnectionPos.call(k,B);if(J.length>0){k.events.push("outline-prebuild",{topics:J,insertChild:true})}}},renderSummaryDoms:function(a,c,b){var e=this;if(a.model.topic.structure=="mind_tree"){return}d(c,b);function d(o,h){e.renderSummaryDom(a,o,h);if(o.collapsed){return}var g=o.children;var p=g.length;if(p>0){for(var n=0;n<p;n++){var f=g[n];a.renderSubTopic(f,null,h)}}if(o.summaries!=null&&o.summaries.length>0){var m=o.summaries.length;for(var l=0;l<m;l++){var k=o.summaries[l];d(k,h)}}}},renderSummaryDom:function(E,x,s){var o=E.util,m=E.designer,c=E.model,g=E.operation,D=c.topic,A=E.styles;var b=$("#"+x.id);if(b.length>0){b.parent().remove()}var v=$(".summary-con[for="+x.id+"]");if(v.length>0){v.remove()}var a=D.structure=="mind_org",Q=D.structure=="mind_tree";var l=E.util.getMargin.call(E);var F=l.childMarginW,J=l.childMarginH;var B=x.title.replace(/\n/g,"<br>").replace(/\&lt;br\&gt;/g,"<br>"),N="";if(a){N="org";J=20}else{if(Q){N="tree";J=26}}b=$("<div class='topic-container "+N+"'><div id='"+x.id+"' class='topic-box summary'><div class='topic'>"+B+"</div></div></div>");var n=b.children(".topic-box");if(!x.root&&x.parent!=D.id&&x.pos==null){var w="topic-children",q=x.range+"";var R=$("#"+x.parent).parent(),u=R.children("."+w);var k=0,G=0;var r=c.getTopicById(x.parent);if(q.indexOf(",")<0){k=Number(q+"");G=Number(q+"")}else{k=Number(q.split(",")[0]);G=Number(q.split(",")[1])}var H=r.children[k];var e=r.children[G];var C=u.children(".topic-container").eq(k);if(C.length>0&&C.hasClass("summary-con")){var t=c.getTopicById(C.attr("for"));var y=t.range+"";var L=y.indexOf(",")>=0?y.split(",")[1]:y;if(Number(G)>Number(L)){}else{u=u.children("[for="+t.id+"]").children("div").eq(0)}}if(u.length==0){u=$("<div class='"+w+"'></div>");var S=0;if(!a&&!Q){S=F+24}else{if(Q){S=A.childMarginW+8}}if(s=="left"){u.prependTo(R);u.css("margin-right",S)}else{u.appendTo(R);u.css("margin-left",S)}}var z=30,P="";if(H.collapsed&&e.collapsed){z=46;P='style="margin-left:'+z+'px;"';if(s=="left"){P='style="margin-right:'+z+'px;"'}}var M=$("<div for='"+x.id+"' class='topic-container summary-con'><div></div><div "+P+"></div></div>");if(s=="left"){M.addClass("part_left")}var f=M.children("div:first");var O=M.children("div:last");b.appendTo(O);if(k-1<0){u.prepend(M)}else{var d=r.children[k];var p=o.getTopicDom(d.id).parent();p.before(M)}if(q.indexOf(",")<0){var h=r.children[q];var C=o.getTopicDom(h.id).parent();C.appendTo(f)}else{var G=q.split(",")[1];for(var K=k;K<=G;K++){var h=r.children[K];if(h==null){continue}var C=o.getTopicDom(h.id).parent();C.appendTo(f)}}if(M.index()>0){M.css("margin-top",J)}if(s=="left"){b.addClass("part_left")}}else{n.attr("sub",true);if(x.pos){b.css("position","absolute").appendTo(m);b.css({left:x.pos.x,top:x.pos.y});n.addClass("free")}else{b.css("position","absolute").prependTo(m)}E.line.renderSubLineCon(b,x.id)}g.changeSumsorBoundsDom(E,x.parent);g.renderTopicImage(x);var I=E.style.getStyle.call(E,x);E.renderTopicStyle(n,x,I,A);E.icons.renderTopicIcons(o,x,s);E.remark.renderTopicNote(o,x,s);g.renderTopicLink(o,x,s);E.tags.renderTopicTag(o,x,s);E.task.renderTopicTask(o,x,s);E.renderTopicExpand(x,n,s,I);E.operation.renderEquation(b);return b},getSummaryPos:function(f){var g=this,b=g.util,e=g.model;if(f.length==1){var a=b.getTopicContainer(f[0]);var h=a.offset();var d=b.getRealPos.call(g,h.left,h.top);d.w=a.outerWidth();d.h=a.outerHeight();var c=b.getSelectedPart(f[0],e.topic.structure);return{part:c,startY:d.y,endY:d.y+d.h,startX:d.x+d.w}}},getFreeSummarySize:function(p,q,d,r){var n=this,m=n.util;var l=p.range+"";var e=Number(l.split(",")[0]);var c=Number(l.split(",")[1]);var k=null,i=null;if(d=="left"||p.part=="left"){k=q.leftChildren[e];i=q.leftChildren[c]}else{k=q.children[e];i=q.children[c]}var h=m.getTopicContainer(k.id);var o=m.getTopicContainer(i.id);var a=o.position().top/r+o.height();var f=h.position().top/r;var g=h.position().left/r;var b=o.position().left/r+o.width();return{maxY:a,minY:f,minX:g,maxX:b}},getChunkPos:function(l,k,r){var f=this,c=f.model,b=f.util,s=f.currentRoot||c.topic,g=f.operation,a=g.zoomVal/100;var t=b.getTopicDom(l.id).parent(),o=l.range+"";var w=0,u=0;if(k.root){var p=f.summary.getFreeSummarySize.call(f,l,k,r,a);u=p.maxY;w=p.minY}else{var q=t.parent().prev();if(q.length==0||q.height()==0){var m=$(".topic-box[id="+l.parent+"]");w=m.position().top/a+4;u=w+m.outerHeight()-4}else{w=q.position().top/a+4;u=q.position().top/a+q.height()-4}}var d={x:r=="left"?Math.floor(t.position().left/a)+t.width():Math.floor(t.position().left/a),minY:Math.floor(w),maxY:Math.floor(u)};if(s.structure=="mind_org"){if(k.root){var p=f.summary.getFreeSummarySize.call(f,l,k,r,a);d.x=p.minX;d.x1=p.maxX}else{var n=b.getTopicDom(l.id).parent(),i=n.parent().prev();if(i.length>0){var e=i.children().eq(0);var h=i.children().eq(i.children().length-1);var x=e.position().left/a+4;var v=h.position().left/a+h.outerWidth()+8;d.x=x;d.x1=v}}d.minY+=10;d.maxY+=10}return d},getSummaryChunk:function(H,y){if(y.length==0){return}var b=H.model,e=H.util,u=H.currentRoot||b.topic,K=[],I=y.length;var A={},J={},o=true;for(var O=0;O<y.length;O++){var G=y[O];var x=b.getTopicById(G);if(x.root||x.free||x.summary){o=false;continue}var m=e.getSelectedPart(G,u.structure);var h=b.getTopicById(x.parent);var r=h.id;if(h.root){r+="_"+m}var D=b.getTopicIndex(x,h,m);if(A[r]==null){A[r]=[]}A[r].push(D);A[r].sort(function(Q,i){return Q>i?1:-1})}if(!o){return[]}var v=[];for(var s in A){var f=A[s],r=s,n=null;if(s.indexOf("_")>0){r=s.split("_")[0];n=s.split("_")[1]}var c=[];for(var O=0;O<f.length;O++){var P=f[O];if(O==f.length-1){if(P-1==f[O-1]){c.push(P);var p={parent:r,range:c};if(n!=null){p.part=n}v.push(p)}else{var p={parent:r,range:[P]};if(n!=null){p.part=n}v.push(p)}break}if(P+1==f[O+1]){c.push(P)}else{c.push(P);v.push({parent:r,range:c});c=[]}}}var B=[];var d={};for(var O=0;O<v.length;O++){var a=v[O];var h=b.getTopicById(a.parent);var N=h.summaries||[];for(var M=0;M<N.length;M++){var q=N[M];var m="";if(q.part){m=q.part}else{m=e.getSelectedPart(q.id,u.structure)}d[q.id]=m}}for(var O=0;O<v.length;O++){var C=v[O],g=C.range,m=C.part||m;var z="";var l=g[0],k=g[g.length-1];z=l+","+k;var t=true;var h=b.getTopicById(C.parent);var N=h.summaries||[];for(var M=0;M<N.length;M++){var q=N[M],w=q.range+"";if(w.indexOf(",")>0){var F=Number(w.split(",")[0]);var E=Number(w.split(",")[1]);var n=d[q.id];if(l<F&&k>=F||k>E&&l<=E){if(n==m){t=false;break}}else{if(l>=F&&k<=E&&n==m){t=false;break}}if(w==z&&n==m){t=false;break}}}if(!t){continue}var L=b.getTopicById(C.parent);if(L!=null&&L.root&&C.part==null){var m=e.getSelectedPart(G,u.structure);C.part=m}C.range=z;B.push(e.copy(C))}if(B.length==0){return[]}return B},addSummary:function(e){var n=this,h=n.util,g=n.model,q=n.currentRoot||g.topic,p=n.summary;if(e.join(",").indexOf(q.id)>=0){return}var l=p.getSummaryChunk(n,e),o=l.length;if(o==0){$.showTip("当前位置无法添加概要",2000);return}var b=[];var d={};for(var f=0;f<o;f++){var r=l[f];var s=g.getTopicById(r.parent);var k=s.summaries||[];var a=false;for(var c=0;c<k.length;c++){var m=k[c];if(m.range==r.range&&m.part==r.part){a=true;break}}if(a){continue}r=$.extend(r,{title:"概要",children:[],summary:true,id:g.newId()});if(p.model.currentStyle!=null){r.style=h.copy(p.model.currentStyle)}else{r.style=h.copy(p.model.styles)}if(r.part!=null){d[r.id]=r.part}b.push(r)}if(b.length==0){$.showTip("当前位置已存在相同的概要",2000);return}p.model.addSummary.call(n,b)},updateSummary:function(C,R,Y){var M=this,e=M.model,A=M.currentRoot||e.topic,k=M.util;var a=(A.structure=="mind_org");C=k.copy(C);R=k.copy(R);var p=k.getSelectedPartByPos(C.id);var P=$(".svg-summary-con").children("#sum_"+C.id);if(C.part!=null&&C.summary){P=$(".svg-freesums-con").children("#sum_"+C.id)}var m=false,E=false;if(C.style!=null){if(C.style.lineType!=null){var n=e.getTopicById(C.parent);var h=e.getSubTopic(n);var f=p;if(h.free&&f=="left"){f="right"}var V=M.summary.getSummaryD.call(M,C,f,a,n);P.attr("d",V.join(""))}if(C.style.lineColor!=null){P.attr("stroke",C.style.lineColor)}if(C.style.lineWidth!=null){P.attr("stroke-width",C.style.lineWidth)}var X=e.getTopicById(C.id);X.style=$.extend(X.style,C.style);m=true}if(C.range!=R.range){E=true;var G=M.operation,S=G.zoomVal/100;var n=e.getTopicById(C.parent);var l=C.range+"";var y=R.range+"";e.topicList.resetTopicList.call(M);var q=e.getTopicById(C.id);q.range=l;var u=Number(y.indexOf(",")>0?y.split(",")[0]:y);var t=Number(y.indexOf(",")>0?y.split(",")[1]:y);var D=Number(l.indexOf(",")>0?l.split(",")[0]:l);var B=Number(l.indexOf(",")>0?l.split(",")[1]:l);if(C.parent!=A.id){var Q=$(".summary-con[for="+C.id+"]");if(D<u){for(var U=u;U>=D;U--){var g=n.children[U];var w=k.getTopicContainer(g.id);Q.children().eq(0).prepend(w)}}else{if(D>u){for(var U=u;U<D;U++){var g=n.children[U],N=n.children.length;var w=k.getTopicContainer(g.id);Q.before(w);var K=Q.css("margin-top");if(K=="0px"||K==null){var I=n.children[N-1];var w=k.getTopicContainer(I.id);Q.css("margin-top",w.css("margin-top"))}}}else{if(B>t){for(var U=Number(t)+1;U<=B;U++){var g=n.children[U];var w=k.getTopicContainer(g.id);Q.children().eq(0).append(w)}}else{if(B<t){for(var U=t;U>Number(B);U--){var g=n.children[U];var w=k.getTopicContainer(g.id);Q.after(w)}}else{return}}}}var h=e.getSubTopic(n);var J=A.id==C.parent?true:false;var v=0;var O=$(".topic-summary-resize");if(!J){var F=k.getTopicContainer(h.id);var H=F.offset();var f=p;if(h.free&&f=="left"){f="right"}if(n.boundaries&&n.boundaries.length>0){M.operation.changeSumsorBoundsDom(M,C.parent)}M.line.resetLines.call(M,[h.id],null,f);v=O.parent().width()}var r=n.children,s=r.length,o={};for(var U=0;U<s;U++){var g=r[U];var c=k.getTopicContainer(g.id);var T=c.height()+1;if(J){var W=c.position().top/S;o[U]=[W,T+W];v=Math.max(v,c.width())}else{var L=c.offset().top-3;var z=(L-H.top)/S;var x=z+T;o[U]=[z,x]}}var z=o[D][0];var x=o[B][1];O.css({top:z,height:x-z});M.range.resetSubTopics.call(M,p)}else{var b=k.getTopicDom(C.id);M.summary.renderSummaryOp.call(M,C,b)}M.renderFreeSummaries(p)}if(Y==null&&(E||m)){C.children=[];R.children=[];var f=p;if(h.free&&f=="left"){f="right"}M.messageSource.send.call(M,"updateSummary",{content:C,original:R,part:f});M.util.selectOne.call(M,C)}if(E||m){M.connection.resetAllConnectionPos.call(M,A)}},getRemovedSums:function(A,q,v,H,d,f,G){if(!$.isEmptyObject(q)){var g=A.util,b=A.model;var N=q==null?v.updates:q.updates;for(var p in N){var L=N[p];for(var M=0;M<L.length;M++){var o=L[M];if(!o.summary){continue}if(q==null){var s=b.getTopicById(o.parent);if(s.summaries==null){s.summaries=[]}var F=g.copy(o);delete F.removed;s.summaries.push(F);var N=v.updates;if(N[s.id]==null){N[s.id]=[]}N[s.id].push(o);continue}if(o.removed){var I=b.getTopicById(o.parent);var F=g.copy(o);var z=g.copy(o);var l=F.range+"";var e=0,C=0;if(l.indexOf(",")<0){e=C=l}else{e=l.split(",")[0];C=l.split(",")[1]}var y=null;if(G==null){F.parent=d;y=H[o.id]}else{y=I.children[e].id;d=o.parent}if(y==null){continue}var a=f||g.getSelectedPart(y,b.topic.structure);var J=b.getTopicById(F.parent);if(!J.root){delete F.pos;delete F.part}else{F.part=a}var t=b.getTopicById(y);var s=b.getTopicById(d);var m=f||g.getSelectedPart(s.id,b.topic.structure);if(F.part!=null){m=a}var B=b.getTopicIndex(t,s,m);var w=Number(C)-Number(e);var k=Number(B)+w;if(w==0){F.range=B+","+B}else{F.range=B+","+k}if(!s.root&&F.part){delete F.part;delete F.pos}if(s.summaries==null){s.summaries=[]}var K=g.copy(F);delete K.removed;s.summaries.push(K);b.addTopicToList(K,s);A.summary.renderSummaryDoms(A,K,m);if(G==null){var N=v.updates;var u=v.original;if(N[s.id]==null){N[s.id]=[]}if(u[s.id]==null){u[s.id]=[]}N[s.id].push(F);u[s.id].push(g.copy(F))}}else{var s=b.getTopicById(o.parent);var n=b.getTopicById(o.id);var h=false;if(v){for(var E in v.updates){var r=v.updates[E];for(var D=0;D<r.length;D++){var c=r[D];if(c.id==o.id){n.range=c.range;h=true;break}}}}if(!h){n.range=o.range}b.addTopicToList(n,s)}}}}},getUpdatedSummaries:function(P,d,T,W,h,z){var U={},H={},E={};var M=this,n=M.util,c=M.model,G=M.model.topic,p=M.line;if(z!=null){for(var A in z){var q=c.getTopicById(A);var v=T[A];var K=z[A];if(K!=null&&K.length>0){for(var Q=0;Q<K.length;Q++){var m=K[Q],b=n.copy(m);if(!m.summary){continue}if(m.removed){if(W=="delete"){for(var N=0;N<q.summaries.length;N++){var y=q.summaries[N];if(y.id==m.id){b.removed=true;E[b.id]=true;q.summaries.splice(N,1);V(b,b,q.id);p.deleteLine(b);break}}c.removeTopicFromList(b.id)}else{if(q.summaries==null){q.summaries=[]}var C=n.copy(m);if(v==null){v=n.getSelectedPart(q.id,c.topic.structure)}delete C.removed;q.summaries.push(C);c.addTopicToList(C,q);M.summary.renderSummaryDoms(M,m,v);E[m.id]=true;V(b,b,q.id)}}else{for(var N=0;N<q.summaries.length;N++){var f=q.summaries[N];var O=n.copy(f);if(f.id==m.id){f.range=m.range;c.addTopicToList(f,q);E[f.id]=true;V(b,O,q.id)}}}}}}F(E,true);return{updates:U,original:H}}var L=[];for(var S=0,B=P.length;S<B;S++){var I=P[S];if(I.summary){L.push(I.id)}}for(var S=0,B=P.length;S<B;S++){var I=P[S],J=d[I.id],v=T[I.id],q=c.getTopicById(I.parent);if(I.summary){continue}if(q!=null&&q.summaries&&q.summaries.length>0){var R=q.summaries;for(var Q=0,l=R.length;Q<l;Q++){var y=R[Q];if(L.indexOf(y.id)>=0){continue}if(y.part!=null&&y.part!=v){continue}var D=g(y,J,W);if(D!=null){if(E[y.id]==null){E[y.id]=D}else{var t=E[y.id]["r1"];var s=E[y.id]["r2"];E[y.id]["r1"]=t+D.r1;E[y.id]["r2"]=s+D.r2}}}}}if(!$.isEmptyObject(E)){var v="right";for(var A in E){var D=E[A];var y=c.getTopicById(A);if(y==null){continue}var r=c.getTopicById(y.parent);var O=n.copy(y);if(W=="delete"){var o=y.range+"";var w=a(o);var t=Number(w.r1)+D.r1;var s=Number(w.r2)+D.r2;if(t>s||t<0||s<0){O.removed=true;var R=r.summaries,k=R.length;for(var S=0;S<k;S++){var u=R[S];if(u.id==y.id){r.summaries.splice(S,1);V(O,O,r.id);p.deleteLine(O);break}}c.removeTopicFromList(O.id)}else{e(y,D);V(y,O,r.id)}}else{e(y,D);V(y,O,r.id)}}F(E)}return{updates:U,original:H};function V(x,X,i){if(U[i]==null){U[i]=[]}U[i].push(n.copy(x));if(H[i]==null){H[i]=[]}H[i].push(n.copy(X))}function F(aj,aq){var aa=[];for(var ap in aj){var x=c.getTopicById(ap);if(x==null){var ah=$(".summary-con[for="+ap+"]");ah.remove();$("path[id=sum_"+ap+"]").remove();var ao=n.getTopicContainer(ap);if(ao.length>0){ao.remove()}continue}var ad=c.getTopicById(x.parent);var ah=$(".summary-con[for="+x.id+"]");if(ah.length==0){var ak=n.getSelectedPart(x.parent,G.structure);M.summary.renderSummaryDoms(M,x,ak);continue}var ac=ah.children().eq(0);var ag=ah.index();var X=a(x.range+"");for(var am=0,an=P.length;am<an;am++){var al=P[am],ab=d[al.id];if(al.parent==ad.id){var Z=n.getTopicContainer(al.id);if(ab<X.r1){if(aa.indexOf(al.id)>=0){continue}var ai=ad.children[ab-1];if(ai!=null){var af=n.getTopicContainer(ai.id);af.after(Z)}else{if(ab+1==X.r1){ah.before(Z)}else{ai=ad.children[ab+1];var Y=n.getTopicContainer(ai.id);Y.before(Z)}}continue}else{if(ab==X.r1){Z.prependTo(ac);aa.push(al.id);continue}else{if(ab>X.r2){continue}}}var ae=ab-ag;if(ae>=1){var af=ac.children().eq(ae-1);af.after(Z)}else{Z.prependTo(ac)}}}}}function g(Y,Z,aa){var X=Y.range+"";var i=a(X);var ab=i.r1,x=i.r2;var ad=0,ac=0;if(aa=="delete"){if(Z<ab){ad=-1;ac=-1}else{if(Z>=ab&&Z<=x){ac=-1}else{return null}}}else{if(Z<=ab){ad=1;ac=1}else{if(Z>ab&&Z<=x){ac=1}else{return null}}}return{r1:ad,r2:ac}}function e(Y,i){var X=Y.range+"";if(X.indexOf(",")<0){Y.range=parseInt(X)+i.r1}else{var x=a(X);Y.range=(parseInt(x.r1)+i.r1)+","+(parseInt(x.r2)+i.r2)}c.addTopicToList(Y,r)}function a(i){var x=0,X=0;if(i.indexOf(",")<0){x=X=i}else{x=Number(i.split(",")[0]);X=Number(i.split(",")[1])}return{r1:x,r2:X}}},addSummaries:function(h,k,s){if(k!=null&&!$.isEmptyObject(k)){var e=h.model,a=h.util;var r=k.update,o=r.length;if(o>0){for(var n=0;n<o;n++){var u=r[n];if(u.removed){var p=s[u.id];if(p!=null){var b=e.getTopicById(p);var q=e.getTopicById(u.parent);var f=a.getSelectedPart(q.id,e.topic.structure);var t=e.getTopicIndex(b,q,f);if(t==-1){t=newIndexs[b.id]}var c=u.range+"";var l=0,v=0;if(c.indexOf(",")<0){l=v=c}else{l=c.split(",")[0];v=c.split(",")[1]}var m=Number(v)-Number(l);var d=Number(t)+m;if(m==0){u.range=t}else{u.range=t+","+d}if(q.summaries==null){q.summaries=[]}var g=a.copy(u);delete g.removed;q.summaries.push(g);e.addTopicToList(g,q);h.summary.renderSummaryDoms(h,g,f)}}}}}},renderSummaryOp:function(C,J,z){var n=this;if(C.summary){var m=n.summary,e=n.model,b=n.util;var B=n.model.topic,g=(B.structure=="mind_org");if(g){return}var o=n.operation,a=o.zoomVal/100;$(".summary-dot").hide();if(J.find(".summary-dot").length==0){var A='<div class="summary-dot"><span class="mind-icons">&#xe663;</span></div>';J.append(A)}J.find(".summary-dot").show();var t=$("#"+C.id).parent().parent().prev();var r=0,q,s=0,I=0;if(t.length==0){var v=C.range+"";var G=Number(v.indexOf(",")>0?v.split(",")[0]:v);var E=Number(v.indexOf(",")>0?v.split(",")[1]:v);var p=e.getTopicById(C.parent);var f=C.part=="left"?(p.leftChildren||[]):p.children,H=f.length;var k=f[G];var u=f[E];for(var F=G;F<=E;F++){var l=f[F];if(l!=null){var d=b.getTopicContainer(l.id);if(F==G){q=d.position().top/a}if(F==E){I=d.position().top/a+d.height();I=I-q-3}if(C.part=="left"){if(r==0){r=d.position().left}else{r=Math.min(d.position().left,r)}}else{r=d.position().left}s=Math.max(s,d.outerWidth())}}r=r/a-1;s=s-3;t=n.designer}else{r=t.position().left/a-3;q=t.position().top/a-3;s=t.outerWidth()+6;I=t.outerHeight()}var c={};var D=n.summary.model.styles.lineColor;if(C.style&&C.style.lineColor){D=C.style.lineColor}c={x:r,y:q,w:s,h:I};$(".topic-summary-resize").remove();var o=$('<div class="topic-summary-resize"><span><i class="mind-icons">&#xe76e;</i></span><span><i class="mind-icons">&#xe76e;</i></span></div>').appendTo(t);o.css({left:c.x,top:c.y,width:c.w,height:c.h,"border-color":D});o.find("span").css("background",D);m.resizeEvent(n,C)}else{$(".topic-summary-resize").remove()}},getSummaryD:function(z,w,k,r){var o=this,n=o.summary;var m=(z.pos&&z.pos.x!=null)?z.pos:n.getChunkPos.call(o,z,r,w);var F=[];var h=z.style==null?null:z.style.lineType;if(h==null){h="curve_complex"}var H=Math.floor((m.minY+m.maxY)/2),l=Math.floor(m.x-22),v=Math.floor(m.x-12),i=Math.floor(m.x-2);if(k){switch(h){default:var t=Math.floor(m.x),B=Math.floor(m.x1);var s=Math.floor(m.maxY+10),f=s+20;var q=Math.floor((m.x+m.x1)/2);var u=z.range+"";if(u!=""){var A=u.split(",")[1];if(A==r.children.length-1&&!r.root){B=B-10;q=Math.floor((m.x+B)/2)}}if(r.root){t=Math.floor(m.x2);q=Math.floor((m.x2+m.x1)/2)}F.push(" M "+t+" "+s);F.push(" L "+t+" "+(s+10));F.push(" L "+B+" "+(s+10));F.push(" L "+B+" "+s);F.push(" M "+q+" "+(s+10));F.push(" L "+q+" "+f);break}}else{switch(h){case"straight":var b=Math.floor(m.x);var G=b-18,E=b,D=Math.floor(m.minY),C=Math.floor(m.maxY),e=Math.floor((D+C)/2),g=b-9;if(w=="left"){G=b+18;g=b+9;E=b-9}F.push(" M "+G+" "+D);F.push(" L "+g+" "+e);F.push(" L "+G+" "+C);break;case"curve":var G=Math.floor(m.x)-22,E=G-2,D=Math.floor(m.minY),C=Math.floor(m.maxY),e=Math.floor((D+C)/2),g=G+15;if(w=="left"){var b=Math.floor(m.x);E=b+22,G=b+2,g=b+6;F.push(" M "+E+" "+D);F.push(" Q "+(g-10)+" "+e+" "+E+" "+C);F.push(" M "+(g+3)+" "+e);F.push(" L "+(g-6)+" "+e)}else{F.push(" M "+G+" "+D);F.push(" Q "+(g+10)+" "+e+" "+G+" "+C);F.push(" M "+(g-3)+" "+e);F.push(" L "+(g+10)+" "+e)}break;case"broken":if(w=="left"){l=Math.floor(m.x+22);v=Math.floor(m.x+12);i=Math.floor(m.x+2)}F.push(" M "+l+" "+Math.floor(m.minY));F.push(" L "+v+" "+Math.floor(m.minY));F.push(" L "+v+" "+Math.floor(m.maxY));F.push(" L "+l+" "+Math.floor(m.maxY));F.push(" M "+v+" "+H);F.push(" L "+i+" "+H);break;case"curve_complex":var b=Math.floor(m.x);var G=b-18,E=b,D=Math.floor(m.minY),C=Math.floor(m.maxY),e=Math.floor((D+C)/2),g=b-9;var c=17,p=5,a=4;if(Math.abs(C-D)<50){c=12;p=2;a=1}if(w=="left"){G=b,E=b+18,g=b+9;F.push(" M "+E+" "+D);F.push(" C "+(E-c)+" "+(D+a)+" "+(g+c)+" "+(e-p)+" "+(g-p)+" "+e);F.push(" M "+E+" "+C);F.push(" C "+(E-c)+" "+(C-a)+" "+(g+c)+" "+(e+p)+" "+(g-p)+" "+e)}else{F.push(" M "+G+" "+D);F.push(" C "+(G+c)+" "+(D+a)+" "+(g-c)+" "+(e-p)+" "+(g+p)+" "+e);F.push(" M "+G+" "+C);F.push(" C "+(G+c)+" "+(C-a)+" "+(g-c)+" "+(e+p)+" "+(g+p)+" "+e)}break}}return F},renderFreeSummariesShape:function(b,p,o){var g=this;var l=this.summary;var a=$(".svg-freesums-con");var q=g.util.copy(l.model.styles);for(var f=0;f<b.length;f++){var h=b[f],n=h.pos;var e=document.getElementById("sum_"+h.id);if(e==null){var m="http://www.w3.org/2000/svg";var e=document.createElementNS(m,"path");e.setAttribute("id","sum_"+h.id);a[0].appendChild(e);e=document.getElementById("sum_"+h.id)}var c=h.part;if(h.style!=null){e.setAttributeNS(null,"fill","none");e.setAttributeNS(null,"stroke",h.style.lineColor||q.lineColor);e.setAttributeNS(null,"stroke-width",h.style.lineWidth||q.lineWidth);var k=g.summary.getSummaryD.call(g,h,c,p,o);e.setAttributeNS(null,"d",k.join(""))}else{var k=g.summary.getSummaryD.call(g,h,c,p,o);e.setAttributeNS(null,"stroke",q.lineColor);e.setAttributeNS(null,"fill","none");e.setAttributeNS(null,"stroke-width",q.lineWidth);e.setAttributeNS(null,"d",k.join(""))}e.setAttributeNS(null,"stroke-linecap","round")}},renderSummarieShape:function(m,n,k){var i=this,c=i.model,b=i.util;var o=c.topic.margin,l=null;if(o){l=o.childMarginH}var q=l===null?i.styles.childMarginH:l;var s=i.model.topic,f=(s.structure=="mind_org"),g=i.summary;if(k==null){k=c.getTopicById(m.parent)}var p=c.getSubTopic(m);var t=b.getTopicDom(p.id).parent();var e=t.find(".svg-summary-con")[0];var v="http://www.w3.org/2000/svg";if(document.getElementById("sum_"+m.id)!=null){var a=document.getElementById("sum_"+m.id);a.parentNode.removeChild(a)}var h=document.createElementNS(v,"path");h.setAttribute("id","sum_"+m.id);e.appendChild(h);var h=document.getElementById("sum_"+m.id);var r="right";if(n){r=n}if(m.style!=null){h.setAttributeNS(null,"fill","none");h.setAttributeNS(null,"stroke",m.style.lineColor||g.model.styles.lineColor);h.setAttributeNS(null,"stroke-width",m.style.lineWidth||g.model.styles.lineWidth);var u=i.summary.getSummaryD.call(i,m,r,f,k);h.setAttributeNS(null,"d",u.join(""))}else{var u=i.summary.getSummaryD.call(i,m,r,f,k);h.setAttributeNS(null,"stroke",g.model.styles.lineColor);h.setAttributeNS(null,"fill","none");h.setAttributeNS(null,"stroke-width",g.model.styles.lineWidth);h.setAttributeNS(null,"d",u.join(""))}h.setAttributeNS(null,"stroke-linecap","round")},resizeEvent:function(e,h){var c=e.model,b=e.util,g=h.parent;var a=e.currentRoot||c.topic;var f=e.operation,d=f.zoomVal/100;$(".topic-summary-resize").children("span").off().on("mousedown.summary",function(I){var s=$(this),w=s.index(),k=s.parent();var p=c.getParentTopic(g);var n=h.part=="left"?(p.leftChildren||[]):p.children,F=n.length;var x={},t={},L=-1,G=-1;var q=c.getSubTopic(p);var v=a.id==h.parent?true:false;var l=b.getTopicContainer(q.id);var y=l.offset(),E=y.top;var K=-1,H=-1;for(var C=0;C<F;C++){var r=n[C];if(r.free){continue}var D=b.getTopicContainer(r.id),J=D.height()+1;var B=D.offset().top;var A=D.offset().top+J;x[C]=[B,A];if(v){var z=D.position().top/d;t[C]=[z,(z+J)]}else{var o=(B-E)/d;var m=o+J;t[C]=[o,m]}}var u=h.range+"";if(u.indexOf(",")<0){K=u;H=u}else{K=u.split(",")[0];H=u.split(",")[1]}K=Number(K);H=Number(H);L=K;G=H;if(w==0){e.designer.addClass("nresize")}else{e.designer.addClass("sresize")}$(document).on("mousemove.summary",function(Q){if(F>1){var O=Q.pageY,R=-1;for(var T in x){var S=x[T];var P=S[0],U=S[1];var N=(P+U)/2;if(O<=U&&O>=P){R=T;break}}if(R>=0){if(w==0&&L!=R){L=R}else{if(w==1&&G!=R){G=R}}if(L>H){L=H}if(G<K){G=K}var M=t[L][0];var i=t[G][1];k.css({top:M,height:i-M-4})}}});$(document).on("mouseup.summary",function(){$(document).off("mousemove.summary");$(document).off("mouseup.summary");if(w==0){e.designer.removeClass("nresize")}else{e.designer.removeClass("sresize")}var Q=c.getParentTopic(g);var R=Q.summaries||[];var P=true;if(R.length>1){for(var O=0;O<R.length;O++){var S=R[O];if(S.id!=h.id){if(S.part&&h.part&&S.part!=h.part){continue}var U=S.range+"";var T=Number(U.indexOf(",")>0?U.split(",")[0]:U);var N=Number(U.indexOf(",")>0?U.split(",")[1]:U);if(T>G||N<L){}else{if((L>=T&&G<N)||(L>T&&G<=N)){}else{P=false;break}}}}}if(!P){$.showTip("当前位置无法修改概要",2000);$(".topic-summary-resize").remove();return}var M=b.copy(h);h.range=L+","+G;e.summary.updateSummary.call(e,h,M)});I.stopPropagation()})},initEvent:function(c){var i=this,g=i.model,h=i.util,d=i.summary;var k=g.getTopicById(c),a=k.style;var e=$(".mind-summary-menu");e.find(".active").removeClass("active");var f=d.model.styles.lineColor,b=d.model.styles.lineWidth,l=d.model.styles.lineType;if(a!=null){if(a.lineColor!=null){f=a.lineColor}if(a.lineWidth!=null){b=a.lineWidth}if(a.lineType!=null){l=a.lineType}}if(f.indexOf("rgb")>=0){f="#"+h.getHexColor(f).hex}e.find("[alt=color] > [ac="+f+"]").addClass("active");e.find("[alt=width] > [ac="+b+"]").addClass("active");e.find("[alt=type] > [ac="+l+"]").addClass("active");e.find("div[alt]").children().off("click").on("click",function(r){var p=$(this),t=p.parent(),v=p.attr("ac");var q=t.attr("alt");var s=g.getTopicById(c);var o=h.copy(s);var m=s.style||{},n;if(q=="width"){if(m.lineWidth==v){return}s.style=$.extend(m,{lineWidth:v})}else{if(q=="color"){if(m.lineColor==v){return}s.style=$.extend(m,{lineColor:v})}else{if(q=="type"){if(m.lineType==v){return}s.style=$.extend(m,{lineType:v})}}}p.addClass("active").siblings().removeClass("active");i.summary.updateSummary.call(i,s,o);var u=h.copy(d.model.styles);d.model.currentStyle=$.extend(u,s.style)})},getSummaryByTopic:function(c,b){var e=this;var a=null;d(c);function d(n){if(n.root){return}var p=e.model.getTopicById(n.parent),o=e.util.copyArray(p.summaries)||[],l=o.length;if(o&&l>0){var k=e.model.getTopicIndex(n,p,b);for(var g=0;g<l;g++){var m=o[g];var h=m.range.split(",")[0],f=m.range.split(",")[1];if(m.part){if(m.part==b){if(k>=h&&k<=f){a=m;break}}}else{if(k>=h&&k<=f){a=m;break}}}}if(!a){d(p)}}return a}};mindDesigner.prototype.boundary={boundsSpace:8,model:{styles:{lineColor:"#bf1e1b",lineWidth:"2",lineType:"1",dasharray:"6,3",fill:"#ff9f1a",opacity:"0.1"},currentStyle:null,addBoundary:function(t,s){var d=this,a=d.util,b=d.model,m=d.currentRoot||b.topic,f=d.line,o=b.groupList;var q=t.length,k={},e="";for(var p=0;p<q;p++){var r=a.copy(t[p]);var l=r.part;var h=b.getTopicById(r.parent);var g=b.getSubTopic(r);if(l==null){l=a.getSelectedPart(g.id,m.structure)}if(h.summary){l=a.getSelectedPartByPos(h.id)}if(h.id==m.id){r.pos={}}var c=h.boundaries;if(c==null){h.boundaries=[]}h.boundaries.push(r);b.addTopicToList(r,h);if(r.part==null){var n=null;if(!h.root){n=a.getTopicContainerProp(g.id)}d.renderSubTopic(r,null,l);d.range.changeTopicPos(d,r,g,l,n);f.resetLines.call(d,[g.id],null,l)}else{d.renderSubTopic(r,null,l)}k[r.id]=l;e+=l+","}o.doGroup(m,m.structure);b.topicList.resetTopicList.call(d);if(e.indexOf("right")>=0){d.range.resetSubTopics.call(d,"right")}if(e.indexOf("left")>=0){d.range.resetSubTopics.call(d,"left")}d.renderFreeBoundaries(l);d.renderFreeSummaries(l);if(s==null){d.messageSource.send.call(d,"addBoundary",{content:t,parts:k})}},removeBoundary:function(g,p,x){var h=this,d=h.model,s=h.currentRoot||d.topic,a=h.util,m=h.line;var y=[],r={},p=p||{},k="";for(var v=g.length-1;v>=0;v--){var t=g[v],o=t.id;var l=d.getParentTopic(t.parent);if(l==null){continue}var e=d.getSubTopic(t);var q=t.part||a.getSelectedPart(e.id,s.structure);if(l.summary){q=a.getSelectedPartByPos(t.parent)}var c=a.getTopicContainerProp(e.id);if(c!=null){if(y.indexOf(e.id)<0){y.push(e.id)}}var n=l.boundaries;var w=n.length;for(var u=0;u<w;u++){var f=n[u];if(f.id==t.id){r[t.id]=u;n.splice(u,1);break}}d.removeTopicFromList(o);var b=$("#bo_"+o);if(b.length>0){b.remove();$(".resize-boundary").remove();$(".boundary-dot").remove()}h.boundary.renderBoundaryDom(h,t,q);p[o]=q;k+=q+","}if(k.indexOf("right")>=0){h.range.resetSubTopics.call(h,"right")}if(k.indexOf("left")>=0){h.range.resetSubTopics.call(h,"left")}h.plugins.hideBoundaryTip();h.model.topicList.resetTopicList.call(h);d.groupList.doGroup(s,s.structure);m.resetLines.call(h,y,null,k);if(x==null){h.messageSource.send.call(h,"deleteBoundary",{content:g,index:r,parts:p})}h.connection.resetAllConnectionPos.call(h,s)}},init:function(){var e=this,d=e.styles,c=e.boundary.model.styles,f=e.model.topic.theme;var b=d.centerTopic.border,a=d.centerTopic["border-color"]||(b?b.split(" ")[2]:d.centerTopic.backgroundColor);var g=d.boundaryStyle&&d.boundaryStyle.lineColor||a;if(f=="jianbihua_1"||f=="jianbihua"){g="#333333"}c.opacity="0.1";if(f=="delicate_dark"||f=="jianbihua_1"||f=="jianbihua"||f=="paper"||f=="paper_1"){c.opacity="0.05"}c.lineColor=c.fill=g},renderBoundaryDoms:function(a,c,b){var e=this;d(c,b);function d(h,g){e.renderBoundaryDom(a,h,g);if(h.collapsed){return}var l=h.children;var f=l.length;if(f>0){for(var k=0;k<f;k++){var m=l[k];a.renderSubTopic(m,null,g)}}}},renderBoundaryDom:function(l,w,v){var b=l.util,e=l.model,D=l.operation,C=l.currentRoot||e.topic,p=l.line,A=l.boundary,m=l.styles,a=D.zoomVal/100;var z=w.parent,n=e.getTopicById(z),h=e.getSubTopic(w);var g=C.structure=="mind_org",t=C.structure=="mind_tree";var d=b.getTopicContainer(h.id);if(d.length==0||n.children.length==0){return}var c=d.find(".svg-boundary-con");if(!w.root&&w.parent!=C.id){var s=l.util.getMargin.call(l);var i=s.childMarginW,u=s.childMarginH;var F=w.title.replace(/\n/g,"<br>").replace(/\&lt;br\&gt;/g,"<br>"),o="";if(!v){v=b.getSelectedPart(h.id,C.structure)}if(g||t){return}A.boundsSpace=8;if(w.style&&w.style.lineType==3){A.boundsSpace=13}var r=w.range+"",y=Number(r.indexOf(",")>0?r.split(",")[0]:r),x=Number(r.indexOf(",")>0?r.split(",")[1]:r);var f=n.children.slice(y,x+1);var q=b.getTopicContainer(n.children[0].id);A.setChunkMargin.call(l,n,v);l.operation.changeSumsorBoundsDom(l,z);if(f.length<0){return}var B=l.util.copy(A.model.styles);var k=document.getElementById("bo_"+w.id);if(k==null){var E="http://www.w3.org/2000/svg";var k=document.createElementNS(E,"path");k.setAttribute("id","bo_"+w.id);c[0].appendChild(k);k=document.getElementById("bo_"+w.id)}k.setAttributeNS(null,"stroke-linejoin","round");if(w.style!=null){k.setAttributeNS(null,"fill",w.style.fill||B.fill);k.setAttributeNS(null,"fill-opacity",w.style.opacity||B.opacity);k.setAttributeNS(null,"stroke",w.style.lineColor||B.lineColor);k.setAttributeNS(null,"stroke-width",w.style.lineWidth||B.lineWidth);k.setAttributeNS(null,"stroke-dasharray",w.style.dasharray||B.dasharray)}else{k.setAttributeNS(null,"stroke",B.lineColor);k.setAttributeNS(null,"fill-opacity",B.opacity);k.setAttributeNS(null,"fill",B.fill);k.setAttributeNS(null,"stroke-width",B.lineWidth);k.setAttributeNS(null,"stroke-dasharray",B.dasharray)}}D.renderTopicImage(w);l.boundary.renderBoundariesShape(l,h,v)},getFreeBoundarySize:function(h,g,l,a){var f=this,b=f.util;var k=h.range+"";var o=Number(k.split(",")[0]);var m=Number(k.split(",")[1]);var e=l=="left"?(g.leftChildren||[]):g.children;var v=-1,t=-1,u=-1,s=-1;for(var n=0;n<e.length;n++){if(e[n].free||(n<o||n>m)){continue}var q=b.getTopicContainer(e[n].id);var r=q.position().left/a,d=q.position().top/a,p=q.position().left/a+q.outerWidth(),c=q.position().top/a+q.outerHeight();if(v==-1||t==-1){v=r;t=d;u=p;s=c;continue}v=Math.min(v,r);t=Math.min(t,d);u=Math.max(u,p);s=Math.max(s,c)}return{maxY:s,minY:t,minX:v,maxX:u}},setChunkMargin:function(E,v){var N=this,d=N.model,o=N.util,J=N.styles,H=N.boundary,C=N.currentRoot||d.topic,I=N.operation,S=I.zoomVal/100,b=d.topic.structure=="mind_org";var m=o.getMargin.call(N),O=m.childMarginW,T=m.childMarginH;if(E.root){return}if(b){T=40;O=15}var z=Number(H.boundsSpace),w=E.children,u=d.getTopicChildrenIds(E),K=E.boundaries,W=E.summaries,y=K.length;if(w.length==0){return}if(!K||y==0){for(var X=0;X<w.length;X++){var h=w[X],e=h.id,n=o.getTopicContainer(e);n.css({margin:T+"px 0px 0px"});if(b){n.css({"margin-left":O+"px"})}}return}var l=false,L={},f=[];var aa=o.getTopicContainer(w[0].id);for(var X=0;X<y;X++){var r=K[X],q=r.id,p=r.range;var t=Number(p.indexOf(",")>0?p.split(",")[0]:p),s=Number(p.indexOf(",")>0?p.split(",")[1]:p)+1,k=s-t;if(f.indexOf(k)==-1){f.push(k)}}f.sort(function(ad,i){return ad-i});for(var X=0;X<f.length;X++){var Z=f[X];if(!L[Z]){L[Z]=[]}for(var V=0;V<y;V++){var r=K[V],q=r.id,p=r.range;var t=Number(p.indexOf(",")>0?p.split(",")[0]:p),s=Number(p.indexOf(",")>0?p.split(",")[1]:p)+1,k=s-t;if(Z==k&&L[Z].indexOf(q)==-1){L[Z].push(q)}}}var P=[],G={},A={startArr:[],endArr:[],nextArr:[]};for(var x in L){var ac=L[x];for(var X=0;X<ac.length;X++){var r=d.getTopicById(ac[X]),p=r.range;var t=Number(p.indexOf(",")>0?p.split(",")[0]:p),s=Number(p.indexOf(",")>0?p.split(",")[1]:p),M=0,a=[],Y=Number(r.style&&r.style.lineWidth||H.model.styles.lineWidth);for(var V=0;V<y;V++){var R=K[V],F=R.range;var Q=Number(F.indexOf(",")>0?F.split(",")[0]:F),B=Number(F.indexOf(",")>0?F.split(",")[1]:F);var g=u[Q],ab=u[B];if(Q<=t&&B>=s&&(t!=Q||s!=B)){a.push(R)}if(s==Q-1||s==B){M++}}var D=H.includeChunks(a);r.boundRank=D;U(Y,r,M,D)}}function U(av,ae,aj,az){var ap=ae.range,ao=Number(ap.indexOf(",")>0?ap.split(",")[0]:ap),an=Number(ap.indexOf(",")>0?ap.split(",")[1]:ap);var al=w.slice(ao,an+1);for(var ax=0;ax<al.length;ax++){var ak=al[ax],at=ak.id;if(!G[at]){var ar=w[0].id==at?0:Number(T);G[at]=[ar,0,0,0]}var aC=G[at];var au=aC[0],aw=aC[1],ad=aC[2],aA=aC[3];var af=w[ao],am=af.id,ay=w[an],ag=ay.id,aq=w[an+1]&&w[an+1].id||null,aB=z+av;var ai=w[0].id,aD=al.length-1,ah=al[aD].id;if(am==at||b){au+=aB}if(b){aw=Math.max(aw,az*aB);aA=Math.max(aA,az*aB+15)}else{aw=Math.max(aw,az*aB);aA=Math.max(aA,az*aB)}if(aj&&aj>0&&ag==at&&!b){ad=aj*(aB)}if(b){ad+=az*(aB)}else{if(at==ag&&at!=u[u.length-1]){ad+=T}}G[at][0]=au;G[at][1]=aw;G[at][2]=ad;G[at][3]=aA}}for(var X=0;X<w.length;X++){var h=w[X],e=h.id,n=o.getTopicContainer(e);var c=G[e];if(c){n.css({margin:c[0]+"px "+c[1]+"px "+c[2]+"px "+c[3]+"px"})}else{n.css({margin:T+"px 0px 0px"});if(b){n.css({"margin-left":O+"px"})}}}},isNextChunk:function(h,m,c){var a=m.boundaries,k=a.length;var d=0;var i=h.range;var e=Number(i.indexOf(",")>0?i.split(",")[0]:i),b=Number(i.indexOf(",")>0?i.split(",")[1]:i);for(var g=0;g<k;g++){var n=a[g],o=n.range;var l=Number(o.indexOf(",")>0?o.split(",")[0]:o),f=Number(o.indexOf(",")>0?o.split(",")[1]:o);if(b==l-1){d++}}return d},includeChunks:function(e){var q=e.length,g={},t=1;for(var o=0;o<q;o++){var a=e[o],f=a.range,h=a.id;var p=Number(f.indexOf(",")>0?f.split(",")[0]:f),n=Number(f.indexOf(",")>0?f.split(",")[1]:f);if(g[h]){break}g[h]=1;for(var m=0;m<q;m++){var l=e[m],s=l.range,c=a.id;var k=Number(s.indexOf(",")>0?s.split(",")[0]:s),b=Number(s.indexOf(",")>0?s.split(",")[1]:s);if(k>=p&&b<=n){g[h]+=1}}}var d=[];for(var u in g){d.push(u)}for(var o=0,q=d.length;o<q;o++){t=Math.max(t,d[o])}return t},identicalStartLen:function(o,f,m){if(!f.boundaries){return 0}var e=f.boundaries,v=e.length,i=o.range,u=Number(i.indexOf(",")>0?i.split(",")[0]:i),t=Number(i.indexOf(",")>0?i.split(",")[1]:i);var d=f.children,c=d[u],l=c.id;var g=1,q=true;for(var s=0;s<v;s++){var r=e[s],k=r.range;var p=Number(k.indexOf(",")>0?k.split(",")[0]:k),a=Number(k.indexOf(",")>0?k.split(",")[1]:k);var h=f.children,n=h[p],b=n.id;if(p==u&&a==t){continue}if(p<=u&&a>=t){q=false;if(l==b){g++}}}if(q){g=1}return g},identicalEndLen:function(o,g,n){if(!g.boundaries){return 0}var e=g.boundaries,v=e.length,i=o.range,u=Number(i.indexOf(",")>0?i.split(",")[0]:i),t=Number(i.indexOf(",")>0?i.split(",")[1]:i);var d=g.children,c=d[t],l=c.id;var f=1,q=true;for(var s=0;s<v;s++){var r=e[s],k=r.range;var p=Number(k.indexOf(",")>0?k.split(",")[0]:k),a=Number(k.indexOf(",")>0?k.split(",")[1]:k);var h=g.children,m=h[a],b=m.id;if(p==u&&a==t){continue}if(p<=u&&a>=t){q=false;if(l==b){f+=1}}}if(q){f=1}return f},chunkLineW:1,getChunkPos:function(a,p,s,h){var O=this,e=O.model,n=O.util,G=O.boundary,L=O.styles,C=O.currentRoot||e.topic,K=O.operation,U=K.zoomVal/100;var d=n.getTopicDom(p.id),o=a.range+"";var i=n.getMargin.call(O),P=i.childMarginW,V=i.childMarginH,c=C.structure=="mind_org";if(c){P=15;V=40}var z=0,x=0,w=0,y=0;var E=a.boundRank||1,u=Number(G.boundsSpace),Y=a.style&&a.style.lineType;G.chunkLineW=Number(a.style&&a.style.lineWidth||G.model.styles.lineWidth);if(Y==3){G.chunkLineW+=u}var X=G.chunkLineW;if(p.root){var k=G.getFreeBoundarySize.call(O,a,p,s,U);w=k.maxY+u+X/2;x=k.minY-u-X/2;z=k.minX-u-X/2;y=k.maxX+u+X/2}else{var J=p.children;var r=Number(o.indexOf(",")>0?o.split(",")[0]:o),q=Number(o.indexOf(",")>0?o.split(",")[1]:o);if(J.length<1){return}if(!J[r]){r=0}if(!J[q]){q=[J.length-1]}var D=n.getTopicDom(J[r].id).parent(),S=n.getTopicDom(J[q].id).parent();var F=d.parent().children(".topic-children"),N=parseInt(F.css("margin-left")),M=c?(D.position().left)/U+P:(F.position().left+N)/U,b=parseInt(S.css("margin-right")),g=parseInt(D.css("margin-left")),A=0,B=G.getMaxWidth.call(O,D,s);var Q=J.slice(r,q+1);Q.map(function(aa,Z){var ad=n.getTopicDom(aa.id).parent(),t=parseInt(ad.css("margin-right")),ac=parseInt(ad.css("margin-left")),ab=parseInt(ad.outerWidth());if(c){A+=(t+ac+ab)}else{var l=G.getMaxWidth.call(O,ad,s);b=Math.max(b,t);if(t+l>B){B=t+l;g=ac}}});var W=u+X,v=(E-1)*W;z=M+E*W-u-X/2;y=M+g+B-v-X/2-1;x=G.getTopicMiny(O,a,J[r]);w=G.getTopicMaxy(O,a,J[q],s);if(s=="left"){var f=F.outerWidth();z=M+(f-B-g)+E*W-u-X/2;y=M+f-v-X/2}if(c){y=M-P+A-v-X/2}if(h){var m=e.getSubTopic(p),I=n.getTopicContainer(m.id),T=I.position().left/U,R=I.position().top/U;z+=T;x+=R;y+=T;w+=R}}var H={minx:Math.floor(z),maxX:Math.floor(y),miny:Math.floor(x),maxY:Math.floor(w)};return H},getTopicMiny:function(l,n,x){var b=l.util,f=l.model,z=l.boundary,a=l.operation.zoomVal/100,c=Number(z.boundsSpace),A=f.topic,y=n.boundRank||1,v=z.chunkLineW;var t=b.getMargin.call(l),i=t.childMarginW,w=t.childMarginH,g=A.structure=="mind_org";if(g){i=15;w=40}var m=f.getTopicById(x.parent),o=b.getTopicDom(x.id).parent(),d=parseInt(o.css("margin-top")),r=(o.position().top+d)/a-d;var h=f.getTopicChildrenIds(m),p=m.summaries,q=h[0],B=c+v;var s=z.identicalStartLen(n,m);var u=(y-1)*B;var k=s>1?w+(s-1)*B:w;if(q==x.id){k=u}var e=r+k+v/2;if(g){e=r+w+v/2}return e},getTopicMaxy:function(D,b,v,p){var h=D.util,e=D.model,x=D.boundary,H=D.operation.zoomVal/100,r=Number(x.boundsSpace),C=e.topic,u=b.boundRank||1,M=x.chunkLineW;var f=h.getMargin.call(D),E=f.childMarginW,I=f.childMarginH,c=C.structure=="mind_org";if(c){E=15;I=40}var i=b.range+"",n=Number(i.indexOf(",")>0?i.split(",")[0]:i),m=Number(i.indexOf(",")>0?i.split(",")[1]:i);var l=e.getTopicById(v.parent),K=l.summaries,y=l.children,G=h.getTopicDom(v.id).parent(),a=parseInt(G.css("margin-top")),w=parseInt(G.css("margin-top")),J=(G.position().top+w)/H-w,q=G.outerHeight(),k=parseInt(G.css("margin-bottom")),z=0;var o=e.getTopicChildrenIds(l),d=o[o.length-1],L=r+M,B=x.isNextChunk(b,l,p),t=(u-1)*L,g=x.identicalEndLen(b,l);var F=y.slice(n,m+1);F.map(function(P,O){var R=h.getTopicDom(P.id).parent(),N=parseInt(R.css("margin-top"));if(c){var Q=R.outerHeight()+N;z=Math.max(z,Q)}});var A=g>1?I+(B>0?g:g-1)*L:I+(B*L);if(d==v.id){A=t}var s=J+(k+w+q)-A-M/2;if(c){s=J+a/H+z-u*L-M/2}return s},getMaxWidth:function(b,c){var i=this,f=i.model,g=i.util,h=i.operation,m=h.zoomVal/100;if(b.length<1){return 0}var a=0;var d=b.children(".topic-box"),n=b.children(".topic-children");var e=0,l=0,k=0;if(d.length>0){e=d.outerWidth()}if(n.length>0){l=n.outerWidth();k=parseInt(n.css("margin-left"));if(c=="left"){k=parseInt(n.css("margin-right"))}}var a=e+l+k;return a},getBoundaryChunk:function(J,A){if(A.length==0){return}var b=J.model,h=J.util,x=J.currentRoot||b.topic,N=[],K=A.length;var C={},M={},t=true;for(var R=0;R<A.length;R++){var I=A[R];var z=b.getTopicById(I);var S=b.getParentTopics(I);var f=false;for(var P=0;P<S.length;P++){var L=S[P].id;var m=b.getTopicById(L);if(A.indexOf(L)>-1&&L!="root"){f=true}}if(f){continue}if(z.root||z.free||z.summary){t=false;continue}var r=h.getSelectedPart(I,x.structure);var n=b.getTopicById(z.parent);var u=n.id;if(n.root){u+="_"+r}var F=b.getTopicIndex(z,n,r);if(C[u]==null){C[u]=[]}if(!C[u]){continue}C[u].push(F);C[u].sort(function(V,i){return V>i?1:-1})}if(!t){return[]}var y=[];for(var v in C){var l=C[v],u=v,s=null;if(v.indexOf("_")>0){u=v.split("_")[0];s=v.split("_")[1]}var e=[];for(var R=0;R<l.length;R++){var U=l[R];if(R==l.length-1){if(U-1==l[R-1]){e.push(U);var Q={parent:u,range:e};if(s!=null){Q.part=s}y.push(Q)}else{var Q={parent:u,range:[U]};if(s!=null){Q.part=s}y.push(Q)}break}if(U+1==l[R+1]){e.push(U)}else{e.push(U);y.push({parent:u,range:e});e=[]}}}var D=[];var g={};for(var R=0;R<y.length;R++){var a=y[R];var n=b.getTopicById(a.parent);var H=n.boundaries||[];for(var P=0;P<H.length;P++){var o=H[P];var r="";if(o.part){r=o.part}else{var T=b.getSubTopic(a);r=a.part||h.getSelectedPart(T.id,x.structure)}g[o.id]=r}}for(var R=0;R<y.length;R++){var E=y[R],k=E.range,T=b.getSubTopic(E),r=E.part||h.getSelectedPart(T.id,x.structure);var B="";var q=k[0],p=k[k.length-1];B=q+","+p;var w=true;var n=b.getTopicById(E.parent);var H=n.boundaries||[];for(var P=0;P<H.length;P++){var o=H[P],G=o.range+"";if(G.indexOf(",")>0){var d=Number(G.split(",")[0]);var c=Number(G.split(",")[1]);var s=g[o.id];if(G==B&&s==r){w=false;break}}}if(!w){continue}var O=b.getTopicById(E.parent);if(O!=null&&O.root&&E.part==null){var T=b.getSubTopic(a),r=h.getSelectedPart(T.id,x.structure);E.part=r}E.range=B;D.push(h.copy(E))}if(D.length==0){return[]}return D},addBoundary:function(s){var e=this,a=e.util,c=e.model,m=e.currentRoot||c.topic,r=e.boundary;if(s.join(",").indexOf(m.id)>=0){return}var k=r.getBoundaryChunk(e,s),p=k.length;if(p==0){$.showTip("当前位置已有外框",2000);return}var t=[];var l={};for(var o=0;o<p;o++){var h=k[o];var g=c.getTopicById(h.parent);var d=g.boundaries||[];var q=false;for(var n=0;n<d.length;n++){var b=d[n];if(b.range==h.range&&b.part==h.part){q=true;break}}if(q){continue}h=$.extend(h,{title:"外框",boundary:true,children:[],id:c.newId()});if(r.model.currentStyle!=null){h.style=a.copy(r.model.currentStyle)}else{var f=a.copy(r.model.styles);delete f.lineColor;delete f.fill;h.style=f}if(h.part!=null){l[h.id]=h.part}t.push(h)}if(t.length==0){$.showTip("当前位置已有外框",2000);return}r.model.addBoundary.call(e,t)},updateBoundary:function(y,K,R){var E=this,c=E.model,w=E.currentRoot||c.topic,g=E.util;var a=(w.structure=="mind_org");y=g.copy(y);K=g.copy(K);var m=c.getTopicById(y.parent);var f=c.getSubTopic(m);var p=y.part||g.getSelectedPart(f.id,w.structure);var e=g.getMargin.call(E),H=e.childMarginW,N=e.childMarginH;var J=$(".svg-boundary-con").children("#bo_"+y.id);if(y.part!=null&&y.boundary){J=$(".svg-freebos-con").children("#bo_"+y.id)}var k=false,A=false;if(y.style!=null){var C=document.getElementById("bo_"+y.id);if(y.style.lineType!=null){C.setAttributeNS(null,"lineType",y.style.lineType)}if(y.style.lineColor!=null){C.setAttributeNS(null,"stroke",y.style.lineColor)}if(y.style.lineWidth!=null){C.setAttributeNS(null,"stroke-width",y.style.lineWidth)}if(y.style.fill!=null){C.setAttributeNS(null,"fill",y.style.fill)}if(y.style.dasharray!=null){C.setAttributeNS(null,"stroke-dasharray",y.style.dasharray)}var Q=c.getTopicById(y.id);Q.style=$.extend(Q.style,y.style);k=true}var M=c.getTopicById(y.id);if(y.range!=K.range){A=true;var D=E.operation,L=D.zoomVal/100;var h=y.range+"";var v=K.range+"";c.topicList.resetTopicList.call(E);M.range=h;var u=Number(v.indexOf(",")>0?v.split(",")[0]:v);var t=Number(v.indexOf(",")>0?v.split(",")[1]:v);var z=Number(h.indexOf(",")>0?h.split(",")[0]:h);var x=Number(h.indexOf(",")>0?h.split(",")[1]:h);if(y.parent!=w.id){E.boundary.boundsSpace=10;if(y.style&&y.style.lineType==3){E.boundary.boundsSpace=13}var q=m.children.slice(u,t+1),B=m.children.slice(z,x+1),r=E.boundary.boundsSpace,P=Number(y.style&&y.style.lineWidth||E.boundary.model.styles.lineWidth),G=r+P;for(var O=0;O<q.length;O++){var F=q[O].id,b=g.getTopicContainer(F),o=b.css("margin-left"),n=b.css("margin-right"),l=b.css("margin-top"),s=b.css("margin-bottom");b.css({"margin-left":I(parseInt(o)-G),"margin-right":I(parseInt(n)-G),"margin-top":parseInt(l)>N?parseInt(l)-G:parseInt(l),"margin-bottom":I(parseInt(s)-G-N)})}function I(i){i-=r;if(i<0){i=0}return i}}}E.boundary.setChunkMargin.call(E,m,p);E.operation.changeSumsorBoundsDom(E,y.parent);if(f.id!=w.id){E.line.resetLines.call(E,[f.id],null,p)}E.boundary.resizeEventBoundary(E,M,p);E.renderFreeBoundaries(p);if(R==null&&(A||k)){y.children=[];K.children=[];var d=p;if(f.free&&d=="left"){d="right"}E.messageSource.send.call(E,"updateBoundary",{content:y,original:K,part:d})}},getRemovedBounds:function(z,d,h,G,c,f,F){if(!$.isEmptyObject(d)){var k=z.util,b=z.model;var N=d==null?h.updates:d.updates;for(var q in N){var l=N[q];for(var M=0;M<l.length;M++){var J=l[M];if(!J.boundary){continue}if(d==null){var s=b.getTopicById(J.parent);if(s.boundaries==null){s.boundaries=[]}var D=k.copy(J);delete D.removed;s.boundaries.push(D);var N=h.updates;if(N[s.id]==null){N[s.id]=[]}N[s.id].push(J);continue}if(J.removed){var H=b.getTopicById(J.parent);var D=k.copy(J);var o=D.range+"";var e=0,B=0;if(o.indexOf(",")<0){e=B=o}else{e=o.split(",")[0];B=o.split(",")[1]}var y=null;if(F==null){D.parent=c;y=G[J.id]}else{y=H.children[e].id;c=J.parent}if(y==null){continue}var g=b.getSubTopic(J);var a=f||k.getSelectedPart(g.id,b.topic.structure);var I=b.getTopicById(D.parent);if(!I.root){delete D.pos;delete D.part}else{D.part=a}var t=b.getTopicById(y);var s=b.getTopicById(c);var p=f||k.getSelectedPart(g.id,b.topic.structure);if(D.part!=null){p=a}var A=b.getTopicIndex(t,s,p);var w=Number(B)-Number(e);var n=Number(A)+w;if(w==0){D.range=A+","+A}else{D.range=A+","+n}if(!s.root&&D.part){delete D.part;delete D.pos}if(s.boundaries==null){s.boundaries=[]}var u=k.copy(D);delete u.removed;s.boundaries.push(u);b.addTopicToList(u,s);z.boundary.renderBoundaryDom(z,u,p);if(F==null){var N=h.updates;var v=h.original;if(N[s.id]==null){N[s.id]=[]}if(v[s.id]==null){v[s.id]=[]}N[s.id].push(D);v[s.id].push(k.copy(D))}}else{var s=b.getTopicById(J.parent);var K=b.getTopicById(J.id);var m=false;if(h){for(var E in h.updates){var L=h.updates[E];for(var C=0;C<L.length;C++){var r=L[C];if(r.id==J.id){K.range=r.range;m=true;break}}}}if(!m){K.range=J.range}b.addTopicToList(K,s)}}}}},getUpdatedBoundries:function(R,d,X,ab,g,w){var Y={},I={},C={};var N=this,l=N.util,c=N.model,H=N.model.topic,n=N.line;if(w!=null){for(var z in w){var o=c.getTopicById(z);var u=X[z];var M=w[z];if(M!=null&&M.length>0){for(var V=0;V<M.length;V++){var h=M[V],b=l.copy(h);if(!h.boundary){continue}if(h.removed){if(ab=="delete"){for(var P=0;P<o.boundaries.length;P++){var T=o.boundaries[P];if(T.id==h.id){b.removed=true;C[b.id]=true;o.boundaries.splice(P,1);aa(b,b,o.id);n.deleteLine(b);break}}c.removeTopicFromList(b.id)}else{if(o.boundaries==null){o.boundaries=[]}var y=l.copy(h),Z=c.getSubTopic(h);if(u==null){u=h.part||l.getSelectedPart(Z.id,c.topic.structure)}delete y.removed;o.boundaries.push(y);c.addTopicToList(y,o);N.boundary.renderBoundaryDom(N,h,u);C[h.id]=true;aa(b,b,o.id)}}else{for(var P=0;P<o.boundaries.length;P++){var E=o.boundaries[P];var O=l.copy(E);if(E.id==h.id){E.range=h.range;c.addTopicToList(E,o);C[E.id]=true;aa(b,O,o.id)}}}}}}D(C,true);return{updates:Y,original:I}}var Q=[],F=[];for(var W=0,A=R.length;W<A;W++){var J=R[W];if(J.boundary){Q.push(J.id)}}for(var W=0,S=R.length;W<S;W++){var J=R[W],K=d[J.id],u=X[J.id],o=c.getTopicById(J.parent);if(J.boundary||J.summary){continue}if(o!=null&&o.boundaries&&o.boundaries.length>0){var L=o.boundaries;for(var V=0,A=L.length;V<A;V++){var q=L[V];if(!q.boundary){continue}if(F.indexOf(q.id)<0){F.push(q.id)}if(Q.indexOf(q.id)>=0){continue}if(q.part!=null&&q.part!=u){continue}var B=f(q,K,ab);if(B!=null){if(C[q.id]==null){C[q.id]=B}else{var s=C[q.id]["r1"];var r=C[q.id]["r2"];C[q.id]["r1"]=s+B.r1;C[q.id]["r2"]=r+B.r2}}}}}if(!$.isEmptyObject(C)){var u="right";for(var z in C){var B=C[z];var q=c.getTopicById(z);if(q==null){continue}var p=c.getTopicById(q.parent);var O=l.copy(q);if(ab=="delete"){var m=q.range+"";var v=a(m);var s=Number(v.r1)+B.r1;var r=Number(v.r2)+B.r2;if(s>r||s<0||r<0){O.removed=true;var L=p.boundaries,G=L.length;for(var W=0;W<G;W++){var T=L[W];if(T.id==q.id){L.splice(W,1);aa(O,O,p.id);n.deleteLine(O);break}}c.removeTopicFromList(O.id)}else{e(q,B);aa(q,O,p.id)}}else{e(q,B);aa(q,O,p.id)}}D(C)}else{for(var U=0,A=F.length;U<A;U++){var q=c.getTopicById(F[U]);t(N,q,u)}}return{updates:Y,original:I};function aa(k,x,i){if(Y[i]==null){Y[i]=[]}Y[i].push(l.copy(k));if(I[i]==null){I[i]=[]}I[i].push(l.copy(x))}function D(x,i){for(var k in x){var ac=c.getTopicById(k);if(ac==null){$("path[id=bo_"+k+"]").remove();continue}t(N,ac,u)}}function t(x,k,i){x.boundary.renderBoundaryDom(x,k,i)}function f(i,ad,ae){var ac=i.range+"";var k=a(ac);var af=k.r1,x=k.r2;var ah=0,ag=0;if(ae=="delete"){if(ad<af){ah=-1;ag=-1}else{if(ad>=af&&ad<=x){ag=-1}else{return null}}}else{if(ad<=af){ah=1;ag=1}else{if(ad>af&&ad<=x){ag=1}else{return null}}}return{r1:ah,r2:ag}}function e(ac,i){var x=ac.range+"";if(x.indexOf(",")<0){ac.range=parseInt(x)+i.r1}else{var k=a(x);ac.range=(parseInt(k.r1)+i.r1)+","+(parseInt(k.r2)+i.r2)}c.addTopicToList(ac,p)}function a(i){var k=0,x=0;if(i.indexOf(",")<0){k=x=i}else{k=Number(i.split(",")[0]);x=Number(i.split(",")[1])}return{r1:k,r2:x}}},getBoundaryD:function(t,s,m,q){var o=this,b=o.util,i=o.model,v=o.boundary;var a=o.operation.zoomVal/100;var n=v.getChunkPos.call(o,t,q,s);var y=[];var h=t.style==null?null:t.style.lineType;if(h==null){h="1"}var l=n.minx,g=n.miny,z=n.maxX,x=n.maxY;switch(h){case"1":y.push(" M "+l+" "+g);y.push(" L "+z+" "+g);y.push(" L "+z+" "+x);y.push(" L "+l+" "+x);y.push(" L "+l+" "+g);break;case"2":var r=(l+10),k=(z-10);y.push(" M "+l+" "+(g+10));y.push(" C "+l+" "+(g+10)+" "+l+" "+g+" "+r+" "+g);y.push(" L "+k+" "+g);y.push(" C "+k+" "+g+" "+z+" "+g+" "+z+" "+(g+10));y.push(" L "+z+" "+(x-10));y.push(" C "+z+" "+(x-10)+" "+z+" "+x+" "+k+" "+x);y.push(" L "+r+" "+x);y.push(" C "+r+" "+x+" "+l+" "+x+" "+l+" "+(x-10));y.push(" L "+l+" "+(g+10));break;case"3":y.push(" M "+l+" "+g);y.push(p(l,z,g,"hori"));y.push(p(g,x,z,"vert"));y.push(p(l,z,x,"hori_back"));y.push(p(g,x,l,"vert_back"));y.push(" L "+l+" "+g);break;case"4":var A=s=="right"?z:l;u(t,q,y,h,"min",{x:A,y:g});y.push(" L "+A+" "+g);y.push(" L "+A+" "+x);u(t,q,y,h,"max",{x:A,y:x});var f=y[0].replace(" M "," L ");y.push(f);break;case"5":y.push(" M "+l+" "+g);y.push(p(l,z,g,"hori"));y.push(p(g,x,z,"vert"));y.push(p(l,z,x,"hori_back"));y.push(p(g,x,l,"vert_back"));y.push(" L "+l+" "+g);break;default:y.push(" M "+l+" "+g);y.push(" L "+z+" "+g);y.push(" L "+z+" "+x);y.push(" L "+l+" "+x);y.push(" L "+l+" "+g)}return y;function p(H,P,K,N){var M=[],D=15,I=Math.abs(Math.floor((P-H)/D)),E=(P-H)-I*D;D+=(E/I);for(var J=0;J<I;J++){var B=6;var L=J*D;if(N.indexOf("vert")>-1){var R=K,C=N.indexOf("back")>-1?K-B:K+B,O=N.indexOf("back")>-1?P-L:H+L,Q=N.indexOf("back")>-1?P-(J+1)*D:H+(J+1)*D,F=N.indexOf("back")>-1?(O-D/2):(O+D/2);Q=Q>P?P:Q<H?H:Q;M.push(" C "+R+" "+O+" "+C+" "+F+" "+R+" "+Q)}else{if(N.indexOf("hori")>-1){var R=N.indexOf("back")>-1?P-L:H+L,C=N.indexOf("back")>-1?P-(J+1)*D:H+(J+1)*D,G=N.indexOf("back")>-1?(R-D/2):(R+D/2),O=K,Q=N.indexOf("back")>-1?K+B:K-B;C=C>P?P:C<H?H:C;M.push(" C "+R+" "+O+" "+G+" "+Q+" "+C+" "+O)}}}return M.join("")}function u(L,P,X,D,Y,R){var W=b.copy(v.model.styles),K=L.style&&L.style.lineWidth||W.lineWidth,O=P.root;var G=P.root?(s=="left"?P.leftChildren||[]:P.children):P.children,M=L.range,U=Number(M.indexOf(",")<0?M:M.split(",")[0]),S=Number(M.indexOf(",")<0?M:M.split(",")[1]);var C=G[U],V=G[S];var ac=[],Q=[];Y=="min"?aa(C):F(V);function aa(ad){var af=w(ad,K,Y,O);if(Q.indexOf(af.y)==-1){ac.push(af);Q.push(af.y)}var d=ad.children;if(!d||d.length<1||ad.collapsed){return}var ae=d[0];aa(ae)}function F(ad){var af=w(ad,K,Y,O);if(Q.indexOf(af.y)==-1){ac.push(af);Q.push(af.y)}var d=ad.children;if(!d||d.length<1||ad.collapsed){return}var ae=d[d.length-1];F(ae)}var E=[];Z(0);function Z(ad){var d=ac.length,ah=[ac[ad],R],ag=true;for(var af=ad;af<d;af++){var ai=ac[af];if(!e(ai,ah,Y)){var ae=ac.indexOf(ai);if(ae!=-1){if(E.indexOf(ai)==-1){E.push(ai)}ag=false;continue}}}if(ad<d-1){ad++;Z(ad)}}var H=ac.concat([]);for(var T=0;T<E.length;T++){var I=E[T],N=H.indexOf(I);if(N>-1){H.splice(N,1)}}var B=H.concat([]);for(var T=1,J=H.length;T<J;T++){if(T==J-1){break}var ab=[H[T-1],H[T+1]],I=H[T];if(!e(I,ab,Y)){var N=B.indexOf(I);if(N!=-1){B.splice(N,1)}}}if(Y=="max"){B.reverse()}for(var T=0;T<B.length;T++){var I=B[T];if(T==0&&Y=="min"){c(I,X,D,0);continue}c(I,X,D)}}function w(d,E,Q,J){var N=b.getTopicDom(d.id),H=N.position().top/a,K=N.position().left/a,M=N.outerHeight(),F=N.outerWidth(),P=v.boundsSpace,I=E/2,D=K-P+I,B=H-P-I;if(Q=="max"){B=H+M+P+I}if(s=="left"){D=K+F+P-I}var G={x:D,y:B};if(J){var C=i.getSubTopic(d);var R=C.id=="root"?N.parent():b.getTopicDom(C.id).parent(),O=R.position().left/a,L=R.position().top/a;G.x+=O;G.y+=L}return G}function c(E,C,B,D){if(D==0){C.push(" M "+E.x+" "+E.y);return C}if(B==4){C.push(" L "+E.x+" "+E.y)}else{if(B==5){C.push(" L "+(E.x-10)+" "+E.y);C.push(" C "+E.x+" "+E.y)}else{if(B==6){}}}return C}function e(D,F,C){F=F.slice();F.push(F[0]);var H=F[0];var E=F[1];var B=E.x-H.x;var d=E.y-H.y;var G=d/B*(D.x-H.x)+H.y;if((D.x==H.x&&D.y==H.y)||(D.x==E.x&&D.y==E.y)){return true}if(s=="left"){if(C=="max"){if(B<0&&D.y<G){return false}}else{if(B<0&&D.y>G){return false}}return true}if(C=="max"){if(B>0&&D.y<G){return false}}else{if(B>0&&D.y>G){return false}}return true}},renderFreeBoundariesShape:function(a,q,p){var g=this,s=g.styles,o=g.currentRoot||g.model.topic;var c=this.boundary;var k=$(".svg-freebos-con");var r=g.util.copy(c.model.styles);for(var f=0;f<a.length;f++){var h=a[f],n=h.pos;var e=document.getElementById("bo_"+h.id);if(e==null){var m="http://www.w3.org/2000/svg";var e=document.createElementNS(m,"path");e.setAttribute("id","bo_"+h.id);k[0].appendChild(e);e=document.getElementById("bo_"+h.id)}var b=h.part;if(o.id!="root"){b="right"}e.setAttributeNS(null,"stroke-linejoin","round");if(h.style!=null){e.setAttributeNS(null,"fill",h.style.fill||r.fill);e.setAttributeNS(null,"fill-opacity",h.style.opacity||r.opacity);e.setAttributeNS(null,"stroke",h.style.lineColor||r.lineColor);e.setAttributeNS(null,"stroke-width",h.style.lineWidth||r.lineWidth);e.setAttributeNS(null,"stroke-dasharray",h.style.dasharray||r.dasharray);var l=g.boundary.getBoundaryD.call(g,h,b,q,p);e.setAttributeNS(null,"d",l.join(""))}else{var l=g.boundary.getBoundaryD.call(g,h,b,q,p);e.setAttributeNS(null,"stroke",r.lineColor);e.setAttributeNS(null,"fill-opacity",r.opacity);e.setAttributeNS(null,"fill",r.fill);e.setAttributeNS(null,"stroke-width",r.lineWidth);e.setAttributeNS(null,"stroke-dasharray",r.dasharray);e.setAttributeNS(null,"d",l.join(""))}}},renderBoundariesShape:function(f,i,b){var e=f.util,d=f.model,c=d.topic;var k=c.structure=="mind_org",g=c.structure=="mind_tree";var h=[];a(i);function a(n){var q=n.children,r=n.boundaries,p=n.summaries;if(r&&r.length>0){r.map(function(x,u){if(!x.id||!x.parent){return}var t=x.parent,v=d.getTopicById(t),s=document.getElementById("bo_"+x.id);if(s){var w=f.boundary.getBoundaryD.call(f,x,b,k,v);s.setAttributeNS(null,"d",w.join(""))}})}if(!q||q.length==0){return}if(p&&p.length>0){for(var m=0,l=p.length;m<l;m++){a(p[m])}}if(q&&q.length>0){for(var o=0;o<q.length;o++){a(q[o])}}}},resizeEventBoundary:function(k,z,s){if(!z){return}var f=k.model,c=k.util,t=k.currentRoot||f.topic,l=k.operation,b=l.zoomVal/100,g=(t.structure=="mind_org");var u=z.parent,n=f.getTopicById(u);var i=this.getChunkPos.call(k,z,n,s);if($(".resize-boundary").length>0){$(".resize-boundary").remove()}if($(".boundary-dot").length>0){$(".boundary-dot").remove()}var x='<div class="resize-boundary resize-boundary-bar" idx = "1"><span class="mind-icons">&#xe76e;</span></div><div class="resize-boundary resize-boundary-bar" idx = "2"><span class="mind-icons">&#xe76e;</span></div>';if(g){x=""}var p='<div id="resize-boundary-box" for="'+z.id+'" class="resize-boundary resize-boundary-box"></div>'+x;var r='<div class="boundary-dot" bound-id = "'+z.id+'"><span class="mind-icons">&#xe663;</span></div>';if(u==t.id){k.designer.append(p);k.designer.append(r)}else{var q=c.getTopicDom(u).parent(),m=q.children(".topic-children");m.append(p);m.append(r)}var e=$("#resize-boundary-box");var y=$("#bo_"+z.id),a=y.attr("stroke");var o=i.maxX-i.minx,v=i.maxY-i.miny;e.css({height:v,width:o,borderColor:a,top:i.miny,left:i.minx});var d=$(".resize-boundary-bar");d.css({left:i.minx+(o-d.outerWidth())/2,top:i.miny-9,background:a});d.eq(1).css({top:i.maxY});$(".boundary-dot").css({left:i.minx+o,top:i.miny-18}).show();k.boundary.resizeEvent(k,z,u,s)},resizeEvent:function(g,a,c,b){var d=g.model,e=g.util,h=g.currentRoot||d.topic,f=g.operation,k=f.zoomVal/100,i=(h.structure=="mind_org");$(document).off("mousedown.boundary").on("mousedown.boundary",".resize-boundary-bar",function(J){var s=$(this),w=s.attr("idx"),l=$("#resize-boundary-box");k=f.zoomVal/100;var y=d.getParentTopic(c);var o=(y.root&&b=="left")?(y.leftChildren||[]):y.children,G=o.length;var x={},t={},M=-1,H=-1;var q=d.getSubTopic(y);var v=h.id==c?true:false;var m=e.getTopicContainer(q.id);var z=m.offset(),F=z.top/k;var L=-1,I=-1;for(var D=0;D<G;D++){var r=o[D];if(r.free){continue}var E=e.getTopicContainer(r.id),K=E.height();var C=E.offset().top/k;var B=E.offset().top/k+K;x[D]=[C,B];if(v){var A=E.position().top/k;t[D]=[A,(A+K)]}else{var p=(C-F);var n=p+K;t[D]=[p,n]}}var u=a.range+"";L=Number(u.indexOf(",")<0?u:u.split(",")[0]);I=Number(u.indexOf(",")<0?u:u.split(",")[1]);M=L;H=I;if(w==1){g.designer.addClass("nresize")}else{if(w==2){g.designer.addClass("sresize")}}$(document).on("mousemove.boundary",function(R){if(G>1){var P=R.pageY/k,S=-1;for(var U in x){var T=x[U];var Q=T[0],V=T[1];if(P<=V&&P>=Q){S=U;break}}if(S>=0){if(w==1&&M!=S){M=S}else{if(w==2&&H!=S){H=S}}if(M>I){M=I}if(H<L){H=L}var O=t[M][0];var N=t[H][1];l.css({top:O-8,height:N-O+8})}}});$(document).on("mouseup.boundary",function(V){V.stopPropagation();$(document).off("mousemove.boundary");$(document).off("mouseup.boundary");if(w==1){g.designer.removeClass("nresize")}else{g.designer.removeClass("sresize")}var U=d.getParentTopic(c);var N=U.boundaries||[];var S=true;if(N.length>1){for(var R=0;R<N.length;R++){var Q=N[R];if(Q.id!=a.id){if(Q.part&&a.part&&Q.part!=a.part){continue}var W=Q.range+"";var T=Number(W.indexOf(",")>0?W.split(",")[0]:W);var P=Number(W.indexOf(",")>0?W.split(",")[1]:W);if(M==T&&H==P){S=false;break}}}}if(!S){$.showTip("当前位置无法修改外框",2000);$(".resize-boundary").remove();$(".boundary-dot").remove();return}var O=e.copy(a);a.range=M+","+H;g.boundary.updateBoundary.call(g,a,O)});J.preventDefault();J.stopPropagation()})},initEvent:function(c){var m=this,k=m.model,l=m.util,f=m.boundary;var d=k.getTopicById(c),a=d.style;var e=$(".mind-boundary-menu");e.find(".active").removeClass("active");var p=f.model.styles.fill,q=f.model.styles.lineColor,h=f.model.styles.dasharray,b=f.model.styles.lineWidth,n=f.model.styles.lineType;var o={1:"0",2:"6,3"};if(a!=null){if(a.lineColor!=null){q=a.lineColor}if(a.fill!=null){p=a.fill}if(a.lineWidth!=null){b=a.lineWidth}if(a.dasharray){h=a.dasharray}if(a.lineType!=null){n=a.lineType}}if(q.indexOf("rgb")>=0){q="#"+l.getHexColor(q).hex}if(p.indexOf("rgb")>=0){p="#"+l.getHexColor(p).hex}e.find("[alt=line_color] > [ac="+q+"]").addClass("active");e.find("[alt=bg_color] > [ac="+p+"]").addClass("active");e.find("[alt=width] > [ac="+b+"]").addClass("active");e.find("[alt=type] > [ac="+n+"]").addClass("active");for(var g in o){if(o[g]==h){e.find("[alt=line_style] > [ac="+g+"]").addClass("active")}}e.find("div[alt]").children().off("click").on("click",function(w){var u=$(this),x=u.parent(),z=u.attr("ac");var v=x.attr("alt");var s=k.getTopicById(c);var r=l.copy(s);var i=s.style||{};if(v=="width"){if(i.lineWidth==z){return}s.style=$.extend(i,{lineWidth:z})}else{if(v=="line_color"){if(i.lineColor==z){return}s.style=$.extend(i,{lineColor:z})}else{if(v=="bg_color"){if(i.fill==z){return}s.style=$.extend(i,{fill:z})}else{if(v=="line_style"){var t=o[z];if(i.dasharray==t){return}s.style=$.extend(i,{dasharray:t})}else{if(v=="type"){if(i.lineType==z){return}s.style=$.extend(i,{lineType:z})}}}}}u.addClass("active").siblings().removeClass("active");m.boundary.updateBoundary.call(m,d,r);var y=l.copy(f.model.styles);f.model.currentStyle=$.extend(y,d.style)});$(".del-boundary-box").off().on("click",function(i){i.stopPropagation();m.boundary.model.removeBoundary.call(m,[d]);m.plugins.hideBoundaryTip()})},getBoundariesPos:function(l,k,s){var h=this,d=h.model,t=h.currentRoot||d.topic,z=h.boundary,f=t.structure=="mind_org",q=t.structure=="mind_tree";var o=[];if(f||q){s="right";return}D(t);function D(F){var y=F.boundaries;if(F.root){var I=s=="left"?F.leftChildren||[]:F.children}else{var I=F.children}var H=F.summaries;if(F.collapsed){return}if(F.boundaries&&F.boundaries.length>0){for(var G=0,x=y.length;G<x;G++){var K=y[G];if(K.part&&K.part!=s){continue}var J=z.pointerInBoundary.call(h,{x:l,y:k},K,s);if(J!=-1){o.push(K)}}}if(H&&H.length>0){for(var G=0;G<H.length;G++){if(H[G]){D(H[G])}}}if(I&&I.length>0){for(var G=0;G<I.length;G++){if(I[G]){D(I[G])}}}}var r=o.length;if(r>0){var v=[0,0,0,0],e=0,c=0,C=0,B=0;for(var u=0;u<r;u++){var E=o[u],g=E.pos,A=Math.abs(l-g.minx),w=Math.abs(l-g.maxX),b=Math.abs(k-g.miny),a=Math.abs(k-g.maxY);if(u==0){e=A;c=b;C=w;B=a;continue}if(b<=c){c=b;v[0]=u}if(a<=B){B=a;v[1]=u}if(A<=e){e=A;v[2]=u}if(w<=C){C=w;v[3]=u}}var p=0,m=v.length;var n=v.some(function(i){return i==v[0]});if(n){p=v[0];z.resizeEventBoundary(h,o[p],s)}return}$(".resize-boundary").remove();$(".boundary-dot").remove()},pointerInBoundary:function(n,s,m){var g=this,b=g.util,d=g.model,o=g.currentRoot||d.topic,h=g.operation,a=h.zoomVal/100,i=d.getTopicById(s.parent),p=g.boundary;var f=p.getChunkPos.call(g,s,i,m,true);var l=n.x,k=n.y;var e=f.minx,c=f.miny,r=f.maxX,q=f.maxY;if(l>=e&&l<=r&&k>=c&&k<=q){s.pos={minx:e,miny:c,maxX:r,maxY:q};return s}return -1}};mindDesigner.prototype.connection={currentLine:null,tempLine:null,loadConnections:function(d){var i=this,h=i.model,l=h.topic,q=l.lines,g=i.connection;if(d!=null){q=d}if(q==null){return}var p=false;for(var c in q){var o=q[c];var n=h.getTopicById(o.from);var m=h.getTopicById(o.to);var k=h.checkParentIsCollapsed(o.from);var a=h.checkParentIsCollapsed(o.to);if(n==null||m==null||k||a){continue}if($("#"+n.id).length==0||$("#"+m.id).length==0){continue}if(o.start.x==null){delete l.lines[c];continue}if(o.realEnd==null){if(o.start.x<0.1&&Math.abs(o.end.x)>1){o.end.x=0.5;o.end.y=0.5}var f=i.util.getTopicRealPos.call(i,o.to);o.realEnd={x:f.x,y:f.y}}g.renderConnectionDom(o,true);if(o.label&&o.label!="label"){g.renderConnectionText(i,o)}if(o.points!=null&&o.points.length==0&&o.realStart!=null){}if(o.pts==null&&o.points.length>0){o.pts=[{x:0,y:0},{x:0,y:0}];var e=i.util.getTopicRealPos.call(i,o.from);e.x+=e.w/2;var b=i.util.getTopicRealPos.call(i,o.to);b.x+=b.w/2;o.pts[0]["x"]=o.points[0].x-e.x;o.pts[0]["y"]=o.points[0].y-e.y;o.pts[1]["x"]=o.points[1].x-b.x;o.pts[1]["y"]=o.points[1].y-b.y;p=true;delete o.start.p;delete o.end.p}}g.resetAllConnectionPos.call(i,l,null,true);if(p){$.ajax({url:"/mindmap/updatedef",type:"post",data:{id:i.opts.chartId,def:JSON.stringify(l),ignore:"def"},success:function(r){},error:function(){}})}},setConnectionD:function(m){var a=m.realStart,c=m.realEnd,l=m.points;var h=[];if(l==null||l.length==0){h.push("M "+a.x+" "+a.y);h.push("L "+c.x+" "+c.y)}else{var b=[];for(var f=0;f<l.length;f++){var k=l[f];b.push({x:k.x,y:k.y})}h.push("M "+a.x+" "+a.y);h.push("C "+b[0].x+" "+b[0].y);h.push(" "+b[1].x+" "+b[1].y);h.push(" "+c.x+" "+c.y)}var g=document.getElementById("line_"+m.id);var e=g.querySelector(".connection-line");e.setAttributeNS(null,"d",h.join(""))},createConnection:function(i,a,h){var f=this,e=f.util,d=f.model,b=f.connection,k=f.styles,h=h||e.getSelectedId();var l=$.extend(true,{styles:k.connectionStyle},{id:d.newId()});var c=e.getRealPos.call(f,i.pageX,i.pageY);var g=b.getPointInSVG(f,a,c);l.start=g;l.realEnd=c;l.realStart={x:a.x,y:a.y};b.renderConnectionDom(l);return l},createConnectionByLines:function(e,b){var d=e.connection;for(var c=0;c<b.length;c++){var a=b[c];d.renderConnectionDom(a);d.renderArrow(e,a);d.renderConnectionText(e,a);d.renderConnControls(e,a)}},getCanvasPos:function(g,c){var b,f,e,d;if(g.x<=c.x){b=g.x;e=c.x}else{b=c.x;e=g.x}if(g.y<c.y){f=g.y;d=c.y}else{f=c.y;d=g.y}var a={};if(c.x<g.x&&c.y>g.y){return{x:b,y:f-10,w:e-b+10,h:d-f+10,start:{x:e-b,y:10},end:{x:10,y:d-f}}}else{if(c.x<g.x&&c.y<g.y){return{x:b,y:f,w:e-b+10,h:d-f+10,start:{x:e-b,y:d-f},end:{x:10,y:10}}}else{if(c.x>g.x&&c.y<g.y){return{x:b-10,y:f,w:e-b+10,h:d-f+10,start:{x:10,y:d-f},end:{x:e-b,y:10}}}}}return{x:b-10,y:f-10,w:e-b+10,h:d-f+10,start:{x:10,y:10},end:{x:e-b,y:d-f}}},getSvgPos:function(e,k,h,d){var f={x:k.x-k.w/2,y:k.y-k.h/2,w:k.w,h:k.h};var b={x:e.x-e.w/2,y:e.y-e.h/2,w:e.w,h:e.h};var i,g,c,a;if(b.x<=f.x){i=b.x}else{i=f.x}if(b.y<f.y){g=b.y}else{g=f.y}if(b.x+b.w>f.x+f.w){c=b.x+b.w}else{c=f.x+f.w}if(b.y+b.h>f.y+f.h){a=b.y+b.h}else{a=f.y+f.h}if(h!=null){if(h.x<i){i=h.x}else{if(h.x>c){c=h.x}}if(h.y<g){g=h.y}else{if(h.y>a){a=h.y}}if(d.x<i){i=d.x}else{if(d.x>c){c=d.x}}if(d.y<g){g=d.y}else{if(d.y>a){a=d.y}}}var l={x:i,y:g,w:c-i,h:a-g};return l},resetConnectionsOnMoving:function(e){var g=this,f=g.util,d=g.connection;for(var a in e){var l=e[a];var k=document.getElementById("line_"+l.id);if(k==null){continue}var b=f.getTopicRealPos.call(g,l.from);b.x+=b.w/2;var c=f.getTopicRealPos.call(g,l.to);c.x+=c.w/2;var i=d.getPointInSVG(g,b,c);l.start=i;var h=d.getPointInSVG(g,c,b);l.end=h;l.realStart={x:b.x-b.w/2+b.w*i.x,y:b.y-b.h/2+b.h*i.y};l.realEnd={x:c.x-c.w/2+c.w*h.x,y:c.y-c.h/2+c.h*h.y};l.angle=f.getAngle(l.realStart,l.realEnd);if(l.points!=null&&l.points.length>0){l.points=[];l.pts=[]}d.setConnectionD(l);d.renderArrow(g,l);d.hideOrShowConnectionText(l,"hide")}},resetAllConnectionPos:function(q,l,g){var m=this,c=q.lines,f=m.model;if(m.currentRoot!=null){c=m.model.topic.lines}if(c==null||$.isEmptyObject(c)){return}if(l!=null){c=l}var b=m.util,k=m.connection;for(var p in c){var n=c[p],a=n.canvasPos;var v=document.getElementById("line_"+n.id);if(v==null){continue}var h,u;try{h=b.getTopicRealPos.call(m,n.to);h.x+=h.w/2;u=b.getTopicRealPos.call(m,n.from);u.x+=u.w/2}catch(t){continue}var r=n.points,i={x:u.x-u.w/2+n.start.x*u.w,y:u.y-u.h/2+n.start.y*u.h},d={x:h.x-h.w/2+n.end.x*h.w,y:h.y-h.h/2+n.end.y*h.h};n.realStart=i;n.realEnd=d;if(r!=null&&r.length>0){var w=n.pts;if(w.length==0){}else{r[0]={x:w[0].x+u.x,y:w[0].y+u.y};r[1]={x:w[1].x+h.x,y:w[1].y+h.y}}}var o={};if(r.length==0){o={x:(d.x+i.x)/2,y:(d.y+i.y)/2}}else{o={x:r[1].x,y:r[1].y}}var s={x:d.x,y:d.y};n.angle=b.getAngle(o,s);k.setConnectionD(n);k.renderArrow(m,n);k.renderConnectionText(m,n,false)}},renderConnectionDom:function(c,b){var f="http://www.w3.org/2000/svg";var a=document.getElementsByClassName("svg-connection-con")[0];var h=document.getElementById("line_"+c.id),e,d;var g=c.styles;if(h){e=h.querySelector(".connection-line");d=h.querySelector(".connection-end-arrow")}else{h=document.createElementNS(f,"g");e=document.createElementNS(f,"path");d=document.createElementNS(f,"path");h.appendChild(e);h.appendChild(d);a.appendChild(h);e.setAttributeNS(null,"fill","none");e.setAttributeNS(null,"d","");e.setAttributeNS(null,"class","connection-line");d.setAttributeNS(null,"class","connection-end-arrow");e.setAttributeNS(null,"stroke-linejoin","round");h.setAttributeNS(null,"id","line_"+c.id);h.setAttributeNS(null,"class","connection-svg")}if(g.lineType=="dashed"){e.setAttributeNS(null,"stroke-dasharray","10,8")}else{e.removeAttribute("stroke-dasharray")}if(g.lineWidth>3){d.setAttributeNS(null,"stroke-linejoin","round");d.setAttributeNS(null,"stroke-linecap","round")}else{d.removeAttribute("stroke-linejoin");d.removeAttribute("stroke-linecap")}if(g.lineArrow!=1){d.setAttributeNS(null,"fill",g.lineColor)}else{d.removeAttribute("fill")}e.setAttributeNS(null,"stroke",g.lineColor);e.setAttributeNS(null,"stroke-width",g.lineWidth);d.setAttributeNS(null,"stroke",g.lineColor);d.setAttributeNS(null,"stroke-width",g.lineWidth);if(b!=true){this.setConnectionD(c)}return h},creating:false,render:function(t){var k=this,b=k.util,f=k.model,i=b.getSelectedId(),h=k.connection,m=k.styles,n=k.operation,a=n.zoomVal/100;if(i==0){return}if(k.creating){return}k.creating=true;var u=b.getTopicRealPos.call(k,i);u.x=u.x+u.w/2;var l=$("#"+i);var o=h.createConnection.call(k,t,u,i);var r=document.getElementById("line_"+o.id);var s=r.querySelector(".connection-line");k.designer.css("cursor","move");n.initScrollPos();var q,p,g={},d=l.offset().left+l.outerWidth()/2,c=l.offset().top+l.outerHeight()/2;k.designer.off("mousemove.connection").on("mousemove.connection",function(w){if($(".mind-tip").length==0){$.showTip("点击其他主题，即可设置关联连线",null)}n.isScroll(w.pageX,w.pageY);q=w.pageX,p=w.pageY;var v=b.getRealPos.call(k,q,p);o.realEnd=v;var e=h.getPointInSVG(k,u,v);o.start=e;o.realStart={x:u.x-u.w/2+u.w*e.x,y:u.y-u.h/2+u.h*e.y};h.setConnectionD(o)});k.designer.off("mouseup.connection").on("mouseup.connection",function(z){k.designer.off("mousemove.connection");k.designer.off("mouseup.connection");n.stopScroll();var y=$(z.target);var B=y.parents(),w="";k.creating=false;for(var x=0;x<B.length;x++){var C=$(B[x]);if(C.hasClass("topic")||C.hasClass("topic-box")){y=C;break}}if(y.hasClass("topic")||y.hasClass("topic-box")){var e=y.attr("id");if(e==null){e=y.parent().attr("id")}if(e==i){r.remove();return}o.from=i;o.to=e;var v=b.getTopicRealPos.call(k,e);v.x+=v.w/2;var A=h.getPointInSVG(k,v,u);o.end=A;o.realEnd={x:v.x-v.w/2+v.w*A.x,y:v.y-v.h/2+v.h*A.y};o.angle=b.getAngle(o.realStart,o.realEnd);o.points=[];h.currentLine=o;h.setConnectionD(o);h.renderArrow(k,o);h.renderConnControls(k,o);h.renderConnectionText(k,o);h.renderConnectionTip(o);h.addConnection(k,b.copy(o))}else{r.remove()}$.showTip("close");k.designer.css("cursor","default")})},renderArrow:function(f,n){var c=document.getElementById("line_"+n.id);var k=c.querySelector(".connection-end-arrow");var b=n.realEnd,m=n.styles,a=n.angle,i=m.lineType,e=m.lineWidth;var l=f.util.getArrowPoints(a,b,e);var h=[];h.push("M"+b.x+" "+b.y);switch(m.lineArrow){case"1":h.push("L"+l.x1+" "+l.y1);h.push("M"+b.x+" "+b.y);h.push("L"+l.x2+" "+l.y2);h.push("Z");break;case"2":h.push("L"+l.x1+" "+l.y1);h.push("M"+b.x+" "+b.y);h.push("L"+l.x2+" "+l.y2);h.push("L"+l.x1+" "+l.y1);h.push("Z");break;case"3":h=[];break;default:h.push("L"+l.x1+" "+l.y1);h.push("M"+b.x+" "+b.y);h.push("L"+l.x2+" "+l.y2);h.push("Z");break}var g=h.join(" ");k.setAttributeNS(null,"d",g)},getSvgPosProperty:function(i,f,b){var h=i.util,l={},k={};var c=h.getTopicRealPos.call(i,b);var g={x:c.x,y:c.y-c.h/2};var d={x:c.x,y:c.y+c.h/2};var e={x:c.x+c.w,y:c.y-c.h/2};var a={x:c.x+c.w,y:c.y+c.h/2};if(f.x<g.x&&f.y<g.y){l.x=f.x;l.y=f.y;l.w=g.x+c.w-f.x;l.h=g.y+c.h-f.y;k.x=0;k.y=0}else{if(f.x<g.x&&f.y>=g.y&&f.y<=d.y){l.x=f.x;l.y=g.y;l.w=g.x+c.w-f.x;l.h=c.h;k.x=0;k.y=f.y-g.y}else{if(f.x<g.x&&f.y>d.y){l.x=f.x;l.y=g.y;l.w=g.x+c.w-f.x;l.h=f.y-g.y;k.x=0;k.y=f.y-g.y}else{if(f.x>=g.x&&f.x<=e.x&&f.y<g.y){l.x=g.x;l.y=f.y;l.w=c.w;l.h=d.y-f.y;k.x=f.x-g.x;k.y=0}else{if(f.x>=g.x&&f.x<=e.x&&f.y>d.y){l.x=g.x;l.y=g.y;l.w=c.w;l.h=f.y-g.y;k.x=f.x-g.x;k.y=f.y-g.y}else{if(f.x>e.x&&f.y<e.y){l.x=g.x;l.y=f.y;l.w=f.x-g.x;l.h=d.y-f.y;k.x=l.w;k.y=0}else{if(f.x>e.x&&f.y>=e.y&&f.y<=a.y){l.x=g.x;l.y=g.y;l.w=f.x-g.x;l.h=c.h;k.x=l.w;k.y=f.y-e.y}else{if(f.x>e.x&&f.y>a.y){l.x=g.x;l.y=g.y;l.w=f.x-g.x;l.h=f.y-g.y;k.x=l.w;k.y=l.h}else{return null}}}}}}}}l.end=k;return l},initEvent:function(h){var f=h.util,a=h.connection,e=a.currentLine;var l=f.getTopicRealPos.call(h,e.from),i=f.getTopicRealPos.call(h,e.to);var g={x:l.x+l.w/2,y:l.y,w:l.w,h:l.h};var c={x:i.x+i.w/2,y:i.y,w:i.w,h:i.h};var d=document.getElementById("line_"+e.id);var k=h.designer;var b=f.copy(e);k.off("mousedown.points").on("mousedown.points",".connection_point",function(t){var r=$(this),w=t.pageX,v=t.pageY,s=h.operation,C=s.zoomVal/100;var p=$(".connection_point[tp=from]"),m=$(".connection_point[tp=to]"),u=$(".mind-connection-con[conn="+e.id+"]"),B=u.find(".mind-connection-label"),q,A,z;h.plugins.hideConnectionTip();u.find(".mind-connection-label-icons").hide();k.off("selectstart").on("selectstart",function(){return false});B.attr("contenteditable",false);h.util.clearSelect();a.currentLine=e;var o=r.position().left+r.width()/2,n=r.position().top+r.height()/2;k.off("mousemove.points").on("mousemove.points",function(D){var y=D.pageX,x=D.pageY,J=y-w,I=x-v;if(Math.abs(J)>2||Math.abs(I)>2){m=$(".connection_point[tp=to]");p=$(".connection_point[tp=from]");var F=f.getRealPos.call(h,y,x);var H=r.attr("tp");a.resetControls(H,F,e,h);if(H=="from"){A=F;z={x:m.position().left/C+m.outerWidth()/2,y:m.position().top/C+m.outerHeight()/2}}else{A={x:p.position().left/C+p.outerWidth()/2,y:p.position().top/C+p.outerHeight()/2};z=F}if(H=="from"){var G=a.getPointInSVG(h,g,F);e.start=G;e.realStart={x:g.x-g.w/2+g.w*G.x,y:g.y-g.h/2+g.h*G.y};e.points[0]={x:F.x,y:F.y};e.points[1]={x:z.x,y:z.y};q=f.getAngle({x:z.x,y:z.y},c)}else{q=f.getAngle(F,c);var E=a.getPointInSVG(h,c,F);e.end=E;e.realEnd={x:c.x-c.w/2+c.w*E.x,y:c.y-c.h/2+c.h*E.y};e.points[1]={x:F.x,y:F.y};e.points[0]={x:A.x,y:A.y}}e.pts=[];e.pts[0]={x:e.points[0].x-g.x,y:e.points[0].y-g.y};e.pts[1]={x:e.points[1].x-c.x,y:e.points[1].y-c.y};e.angle=q;a.setConnectionD(e);a.renderArrow(h,e);a.renderConnectionTextPos(h,u,e)}D.preventDefault()});k.off("mouseup.points").on("mouseup.points",function(x){B.attr("contenteditable",true);a.updateConnection(h,e,b);k.off("mousemove.points");k.off("mouseup.points");k.off("selectstart").on("selectstart",function(){return true});u.find(".mind-connection-label-icons").show();t.stopPropagation()});t.stopPropagation()});$(".mind-connection-menu").find("div[alt]").children().off("click").on("click",function(q){var o=$(this),r=o.parent(),t=o.attr("ac");var p=r.attr("alt");var v=a.currentLine;if(v==null){return}var n=f.copy(v);var u=v.styles||{},m;if(p=="width"){if(u.lineWidth==t){return}v.styles=$.extend(u,{lineWidth:t})}else{if(p=="color"){if(u.lineColor==t){return}v.styles=$.extend(u,{lineColor:t})}else{if(p=="type"){if(u.lineType==t){return}v.styles=$.extend(u,{lineType:t})}else{if(p=="arrow"){if(u.lineArrow==t){return}v.styles=$.extend(u,{lineArrow:t})}}}}o.addClass("active").siblings().removeClass("active");var s=f.copy(v);a.updateConnection(h,s,n);a.createConnectionByLines(h,[s])});$(".mind-connection-menu").find(".mind-button").off().on("click",function(m){if(a.currentLine){a.deleteConnection(h,e)}m.stopPropagation()})},setSVGPos:function(e,a,b){var c={},d=1;if(e.x<a.x&&e.y<a.y){c.x=e.x;c.y=e.y;d=3}else{if(e.x<=a.x&&e.y>=a.y){c.x=e.x;c.y=a.y;d=2}else{if(a.x<e.x&&a.y>e.y){c.x=a.x;c.y=e.y;d=4}else{if(a.x<=e.x&&a.y<=e.y){c.x=a.x;c.y=a.y;d=1}}}}c.w=Math.abs(a.x-e.x);c.h=Math.abs(a.y-e.y);this.setSVGPosByPos(c,b);return d},setSVGPosByPos:function(b,a){a.style.cssText="left:"+b.x+"px;top:"+b.y+"px;width:"+b.w+"px;height:"+b.h+"px"},focusConnection:function(b,a){this.currentLine=a;this.renderConnControls(b,a);this.renderConnectionText(b,a);this.renderConnectionTip(a);b.util.clearSelect()},blurConnection:function(a){setTimeout(function(){var b=a.connection;b.clearControls();var c=$(".mind-connection-con[conn]");c.each(function(e,f){var d=$.trim($(f).find(".mind-connection-label").html());if(d==""||d=="label"){$(f).remove()}});b.currentLine=null;b.renderConnectionTip(false);a.plugins.hideConnectionTip()},10)},renderConnectionText:function(b,a,e){var f=$(".mind-connection-con[conn="+a.id+"]");if(f.length==0&&e==null){var f=$("<div conn='"+a.id+"' class='mind-connection-con'><div class='mind-connection-label' spellcheck='false' contenteditable='true'>label</div><span class='mind-icons mind-connection-label-icons'>&#xe663;</span></div>");b.designer.append(f)}var d=f.children(".mind-connection-label"),c=f.children(".mind-connection-label-icons");if(a.label){d.html(a.label)}this.renderConnectionTextPos(b,f,a)},hideOrShowConnectionText:function(a,c){if(c=="show"){$(".mind-connection-label").show();return}var d=$(".mind-connection-con[conn="+a.id+"]");if(d.length){var b=d.children(".mind-connection-label");b.hide()}},renderConnectionTip:function(a){if(a==false){$(".mind-connection-label-icons").hide()}else{var b=$(".mind-connection-con[conn="+a.id+"]");b.find(".mind-icons").show()}},renderConnectionTextPos:function(d,a,c){var b=this.getConnectionMidPoint(c);a.css({left:b.x,top:b.y,background:c.styles.lineColor,color:c.styles.color})},renderConnControls:function(f,e){var o=f.designer,c=f.connection,m=e.points,g=e.canvasPos,b=e.realStart,d=e.realEnd;var k={x:(b.x+d.x)/2,y:(b.y+d.y)/2};function a(r,s){$(".connection_line[tp="+r+"]").remove();$(".connection_point[tp="+r+"]").remove();var q=$("<div tp='"+r+"' class='connection_line'></div>").appendTo(o);var p=$("<div tp='"+r+"' class='connection_point'></div>").appendTo(o);if(s==null){s={};if(r=="from"){s.x=(k.x+b.x)/2;s.y=(k.y+b.y)/2}else{s.x=(d.x+k.x)/2;s.y=(d.y+k.y)/2}}return s}var n=m[0];var l=m[1];var i=a("from",n);var h=a("to",l);c.resetControls("from",i,e,f);c.resetControls("to",h,e,f);c.currentLine=e;this.initEvent(f)},resetControls:function(m,k,e,h){var f=h.util,b=h.connection,e=e||b.currentLine,o=e.styles;var p=$(".connection_line[tp="+m+"]"),n=$(".connection_point[tp="+m+"]"),g=0;n.css({left:k.x,top:k.y,border:"1px solid "+o.lineColor});var a=e.realStart;var d=e.realEnd;var l,i,c;if(m=="from"){g=f.calcDistance(a,k);l=(k.x+a.x)/2;i=(k.y+a.y)/2;c=f.getAngle(a,k)}else{l=(k.x+d.x)/2;i=(k.y+d.y)/2;g=f.calcDistance(d,k);c=f.getAngle(d,k)}p.css({left:l,top:i-g/2,height:g,"-webkit-transform":"rotate("+(90+c)+"deg)",transform:"rotate("+(90+c)+"deg)",background:o.lineColor})},clearControls:function(a){$(".connection_point").remove();$(".connection_line").remove();$(".mind-connection-label-icons").hide()},getConnectionMidPoint:function(b){var f=b.points,c=[];var g=b.realStart,a=b.realEnd;if(f.length==0){var e=(a.x+g.x)/2;var d=(a.y+g.y)/2;c=[{x:e,y:d},{x:e,y:d}]}else{c=[{x:f[0].x,y:f[0].y},{x:f[1].x,y:f[1].y}]}return{x:0.125*g.x+0.375*c[0].x+0.375*c[1].x+0.125*a.x,y:0.125*g.y+0.375*c[0].y+0.375*c[1].y+0.125*a.y}},getConnectionByPoint:function(h,f){var d=this,g=d.model.topic,b=g.lines,c=d.connection;var e,k=[];for(var a in b){var i=b[a];e=c.pointInConnection({x:h,y:f},i,7);if(e>0){k.push(i);break}}return{inline:e,lines:k}},pointInConnection:function(h,n,e){var k=this.getConnectionPoints(n),f=k.length;var c={x:h.x-e,y:h.y};var b={x:h.x+e,y:h.y};var a={x:h.x,y:h.y-e};var m={x:h.x,y:h.y+e};for(var d=1;d<f;d++){var l=k[d-1];var i=k[d];var g=this.checkCross(c,b,l,i);if(g){return d}g=this.checkCross(a,m,l,i);if(g){return d}}return -1},getConnectionPoints:function(l){var h=[];var a=l.points,k={};var c=l.realStart,e=l.realEnd;if(a.length==0){var g=(e.x+c.x)/2;var f=(e.y+c.y)/2;k=[{x:g,y:f},{x:g,y:f}]}else{k=[{x:a[0].x,y:a[0].y},{x:a[1].x,y:a[1].y}]}var d=0.05;var i=0;while(i<=1){var b={x:(1-i)*(1-i)*(1-i)*c.x+3*(1-i)*(1-i)*i*k[0].x+3*(1-i)*i*i*k[1].x+i*i*i*e.x,y:(1-i)*(1-i)*(1-i)*c.y+3*(1-i)*(1-i)*i*k[0].y+3*(1-i)*i*i*k[1].y+i*i*i*e.y};h.push(b);i+=d}h.push(l.end);return h},checkCross:function(i,g,f,e){var a=false;var h=(g.x-i.x)*(e.y-f.y)-(g.y-i.y)*(e.x-f.x);if(h!=0){var c=((i.y-f.y)*(e.x-f.x)-(i.x-f.x)*(e.y-f.y))/h;var b=((i.y-f.y)*(g.x-i.x)-(i.x-f.x)*(g.y-i.y))/h;if((c>=0)&&(c<=1)&&(b>=0)&&(b<=1)){a=true}}return a},getPointInSVG:function(d,b,c){var a=this.getActivePosOnTopic(b,c);return a},getActivePosOnTopic:function(a,f){var d=a.h/2;var i=a.w/2;var b=(f.y-a.y)/(f.x-a.x);var h=0,g=0,e=1,l={};if(f.x>a.x&&f.y<a.y){var c=-d/b;h=(i+c)/a.w;g=0;if(c>i){h=1;g=(d+b*i)/a.h}e=2}else{if(f.x>=a.x&&f.y>=a.y){var c=d/b;h=(i+c)/a.w;g=1;if(c>i){h=1;g=(d+b*i)/a.h}e=3}else{if(f.x<=a.x&&f.y>=a.y){var c=-d/b;h=(i-c)/a.w;g=1;if(c>i){h=0;g=(d-b*i)/a.h}e=4}else{if(f.x<=a.x&&f.y<=a.y){var c=d/b;h=(i-c)/a.w;g=0;if(c>i){h=0;g=(d-b*i)/a.h}e=1}}}}return{x:h.toFixed(1),y:g.toFixed(1),index:e}},getConnectionsByTopic:function(b){var h=this,e=h.model,k=e.topic,n=k.lines,f=h.util,c=h.connection;if(n==null||$.isEmptyObject(n)){return}var l=e.getTopicById(b);var a=e.getChildrenIds(l);a.push(b);var g=a.join(",");var d=[];for(var i in n){var m=n[i];if(g.indexOf(m.from)>=0||g.indexOf(m.to)>=0){d.push(m)}}return d},addConnection:function(b,a){this.addConnectionMulti(b,[a])},addConnectionMulti:function(d,a,e){for(var c=0;c<a.length;c++){var b=a[c];this.saveConnection(d,b);this.currentLine=b}if(e==null){d.messageSource.send.call(d,"addConnection",{content:a})}},updateConnection:function(c,b,a,d){this.saveConnection(c,b);if(d==null){c.messageSource.send.call(c,"updateConnection",{content:b,original:a})}},saveConnection:function(d,c){var b=d.model,a=b.topic;if(a.lines==null){a.lines={}}a.lines[c.id]=c},saveConnectionText:function(e,c,b){var d=e.model,a=d.topic;a.lines[c.id]=c;e.messageSource.send.call(e,"updateConnection",{content:c,original:b})},deleteConnection:function(b,a){this.deleteConnectionMulti(b,[a])},deleteConnectionMulti:function(f,b,a){if(b.length==0){return}var e=f.model,h=e.topic,k=h.lines;for(var c=0,g=b.length;c<g;c++){var d=b[c];$("g[id=line_"+d.id+"]").remove();$(".mind-connection-con[conn="+d.id+"]").remove();delete k[d.id]}if($.isEmptyObject(k)){delete h.lines}this.clearControls();e.topicList.resetTopicList.call(f);this.currentLine=null;if(a==null){f.messageSource.send.call(f,"deleteConnection",{content:b})}},deleteConnectionByTopics:function(b,l){var m=this,h=m.model,n=h.topic,d=m.connection,o=n.lines;if(b.length>0&&o!=null){var f=[];if(l==false){for(var e=0,k=b.length;e<k;e++){var g=b[e];var a=h.getChildrenIdsWithoutSelf(g);var c=a.join(",");$.each(o,function(q,p){if(c.indexOf(p.from)>=0||c.indexOf(p.to)>=0){f.push(p)}})}d.hideConnectionMulti(m,f)}else{for(var e=0,k=b.length;e<k;e++){var g=b[e];var a=h.getChildrenIds(g);var c=a.join(",");$.each(o,function(q,p){if(c.indexOf(p.from)>=0||c.indexOf(p.to)>=0){f.push(p)}})}d.deleteConnectionMulti(m,f)}}},hideConnectionMulti:function(h,d){if(d.length==0){return}var f=h.model,c=f.topic,b=c.lines;for(var g=0,a=d.length;g<a;g++){var e=d[g];$("g[id=line_"+e.id+"]").remove();$(".mind-connection-con[conn="+e.id+"]").remove()}this.clearControls()},showConnectionMulti:function(l,b){var f=[],h=l.model,m=h.topic,n=m.lines,d=this;if(n==null){return}for(var e=0,k=b.length;e<k;e++){var g=b[e];var a=h.getChildrenIdsWithoutSelf(g);var c=a.join(",");$.each(n,function(p,o){if(c.indexOf(o.from)>=0||c.indexOf(o.to)>=0){f.push(o)}})}d.loadConnections.call(l,f)}};mindDesigner.prototype.virtualTopic={setMovingRelated:function(k,s,a){$(".topic-box").append("<div class='topic-insert before'></div><div class='topic-insert after'></div><div class='topic-insert in'></div></div>");var b=$("#"+k.id),d=b.siblings(".topic-children"),e=b.siblings(".topic-children-summary");var c=b.parent();var o=mind.currentRoot||mind.model.topic;$(".topic-box[id="+o.id+"]").find(".topic-insert:not(.in)").remove();if(a!=null&&a.length>0){for(var g=0;g<a.length;g++){var p=a[g];var q=$("#"+p.id),r=q.parent();r.addClass("topic-moving-related");r.find(".topic-insert").remove()}}else{c.addClass("topic-moving-related")}b.find(".topic-insert").remove();d.find(".topic-insert").remove();e.find(".topic-insert").remove();$(".topic-box.free").children(".topic-insert:not(.in)").remove();$(".topic-box.summary").children(".topic-insert:not(.in)").remove();if(s!=null){var m=0,n=s.children.concat(s.summaries||[]);for(var g=0,l=n.length;g<l;g++){var p=n[g];if(p.id==k.id){m=g;break}}var f=n[m-1];var h=n[m+1];if(f!=null){$(".topic-box[id="+f.id+"]").children(".topic-insert.after").remove()}if(h!=null){$(".topic-box[id="+h.id+"]").children(".topic-insert.before").remove()}}},removeShape:function(){var a=document.getElementById("mind-svg-insert-temp");if(a!=null){$(a).remove()}},renderShape:function(d,f,a,c,h){this.removeShape();var g="http://www.w3.org/2000/svg";var e=document.createElementNS(g,"svg");document.body.appendChild(e);e.setAttributeNS(null,"id","mind-svg-insert-temp");var i=document.createElementNS(g,"path");if(c!=null&&c=="mind_org"||(c=="mind_tree"&&d.parent==h)){var b="z-index:2;position:fixed;stroke: rgb(80, 194, 139);";if(f.weizhi=="in"){i.setAttributeNS(null,"d","M13 0 L13 50L25 50L25 119L1 119 L1 50L13 50");b+="height:120px;width:26px;top:"+(f.y+36)+"px;left:"+(f.x-f.w/2-11)+"px"}else{if(f.weizhi=="before"){i.setAttributeNS(null,"d","M45 0 L23 40L35 40L35 99L11 99L11 40L23 40");b+="height:100px;width:46px;top:"+(f.y+f.h+5)+"px;left:"+(f.x-f.w-32)+"px"}else{if(f.weizhi=="after"){i.setAttributeNS(null,"d","M0 0 L23 40L45 40L45 99L23 99L23 40");b+="height:100px;width:46px;top:"+(f.y-20)+"px;left:"+(f.x+15)+"px"}}}e.style.cssText=b}else{if(a=="left"){e.style.cssText="z-index:2;position:fixed;width:120;height:26;stroke: rgb(80, 194, 139);left:"+(f.x-120)+"px;top:"+f.y+"px";if(f.weizhi=="in"){i.setAttributeNS(null,"d","M120 13 L90 13L90 4L88 2L4 2L2 4L2 22L4 24 L88 24L90 22L90 13")}else{if(f.weizhi=="before"){i.setAttributeNS(null,"d","M120 26 L90 13L90 4L88 2L4 2 L2 4L2 22L4 24L88 24L90 22L90 13")}else{if(f.weizhi=="after"){i.setAttributeNS(null,"d","M120 0 L90 13L90 4L88 2L4 2 L2 4L2 22L4 24L88 24L90 22L90 13")}}}}else{e.style.cssText="z-index:2;position:fixed;width:120;height:26;stroke: rgb(80, 194, 139);left:"+f.x+"px;top:"+f.y+"px";if(f.weizhi=="in"){i.setAttributeNS(null,"d","M0 13 L30 13L30 4L32 2L116 2 L118 4L118 22L116 24L32 24L30 22L30 13")}else{if(f.weizhi=="before"){i.setAttributeNS(null,"d","M0 26 L30 13L30 4L32 2L116 2 L118 4L118 22L116 24L32 24L30 22L30 13")}else{if(f.weizhi=="after"){i.setAttributeNS(null,"d","M0 0 L30 13L30 4L32 2L116 2 L118 4L118 22L116 24L32 24L30 22L30 13")}}}}}i.setAttributeNS(null,"stroke","rgb(252, 126, 0)");i.setAttributeNS(null,"fill-opacity",".4");i.setAttributeNS(null,"stroke-linecap","round");i.setAttributeNS(null,"stroke-width",2);i.setAttributeNS(null,"fill","rgb(252, 126, 0)");e.appendChild(i)},initEvent:function(d,g){var f=this,h=f.virtualTopic,c=f.model,b=f.currentRoot||c.topic,a=f.util,e=f.operation.zoomVal/100;f.designer.off("mousemove.dragmove1").on("mousemove.dragmove1",".topic-insert",function(m){var k=$(this),l=k.parent(),p=l.attr("id");if(p==b.id){var i=k.width(),n=k.offset();if(m.offsetX<i/2&&f.currentRoot==null){var o={x:n.left,y:n.top+k.height()/2*e-13,weizhi:"in"};g.pos="in";h.renderShape(b,o,"left",null,b.id);g.rootPos="left"}else{var o={x:n.left+l.outerWidth()*e,y:n.top+k.height()/2*e-13,weizhi:"in"};g.pos="in";h.renderShape(b,o,"right",null,b.id);g.rootPos="right"}}else{delete g.rootPos}});f.designer.off("mouseenter.dragmove").on("mouseenter.dragmove",".topic-insert",function(p){var o=$(this),n=o.parent(),i=n.attr("id");if(i==d.id){return}n.addClass("topic-moving-target");var r=c.getTopicById(i);var l=a.getSelectedPart(i,b.structure);var k=c.getSubTopic(r);if(k.summary){l=a.getSelectedPartByPos(i)}var m=n.offset();var q={x:l=="left"?m.left:m.left+n.outerWidth()*e-14,y:m.top-26,w:n.outerWidth()*e,h:n.outerHeight()*e,weizhi:"before"};g.id=i;g.pos="before";if(o.hasClass("in")){q={x:l=="left"?m.left:m.left+n.outerWidth()*e,y:o.offset().top+o.height()/2*e-13,w:n.outerWidth()*e,weizhi:"in"};g.pos="in"}else{if(o.hasClass("after")){q={x:l=="left"?m.left:m.left+n.outerWidth()*e-14,y:m.top+n.outerHeight()*e,w:n.outerWidth()*e,weizhi:"after"};g.pos="after"}}o.addClass("selected");h.renderShape(r,q,l,b.structure,b.id);p.stopPropagation()});f.designer.off("mouseleave.dragmove").on("mouseleave.dragmove",".topic-box",function(i){$(".topic-moving-target").removeClass("topic-moving-target");h.removeShape()});f.designer.off("mouseleave.dragmove1").on("mouseleave.dragmove1",".topic-insert",function(i){$(this).removeClass("selected")})},offEvent:function(){this.designer.off("mouseenter.dragmove");this.designer.off("mouseleave.dragmove")}};mindDesigner.prototype.model={newId:function(){return(this.newIdS4()+this.newIdS4()+this.newIdS4())},newIdS4:function(){return(((1+Math.random())*65536)|0).toString(16).substring(1)},topicDef:{id:"root",root:true,title:"中心主题",children:[],structure:"mind_right",theme:"theme3"},topic:{id:"root1",root:true,title:"中心主题",leftChildren:[],children:[],structure:"mind_right",theme:"",background:"#f4f4f4"},clipboard:{type:"copy",list:[]},persistenTopic:{},topicList:{parentTopics:{},data:{},build:function(f){var g=this;g.data[f.id]=f;var d=f.children,h=d.length;if(h>0){for(var e=0;e<h;e++){var k=d[e];g.build(k)}}var c=f.leftChildren;if(c!=null){for(var e=0,h=c.length;e<h;e++){var k=c[e];g.build(k)}}var b=f.summaries;if(b!=null){for(var e=0,h=b.length;e<h;e++){var k=b[e];g.build(k)}}var a=f.boundaries;if(a!=null){for(var e=0,h=a.length;e<h;e++){var k=a[e];g.build(k)}}},resetTopicList:function(){var b=this.model,c=b.topicList;var a=b.topic;c.data={};c.build(a)}},addTopicToList:function(a,b){this.topicList.build(a)},removeTopicFromList:function(a){delete this.topicList.data[a]},groupList:{leftList:[],rightList:[],freeList:[],justPos:"right",justTopic:null,doGroup:function(c,b){var f=this;f.clearData();f.leftList=[];f.rightList=[];var e=c.children,a=e.length;for(var d=0;d<a;d++){var g=e[d];f.setList(g,b)}},clearData:function(){this.leftList=[];this.rightList=[];this.freeList=[];this.justTopic=null;this.justPos="right"},setList:function(d,a,c,b){var e=this;if(d.free){e.freeList.push(d);e.justPos="";return}if(c!=null&&c=="right"){if(b!=null){e.rightList.splice(b,0,d)}else{e.rightList.push(d)}e.justPos="right";return}if(a=="mind_right"||a=="mind_free"||a=="mind"||a=="mind_org"||a=="mind_tree"){e.rightList.push(d);e.justPos="right"}return e.justPos}},getTopicById:function(a){return this.topicList.data[a]},getSubTopic:function(b){var d,c=this;if(b.root||b.free){return b}a(b);function a(e){var f=c.getTopicById(e.parent);if(f.root){d=e;return}else{a(f)}}return d},getSubTopicIds:function(a){var c=a.children.concat(a.leftChildren||[]);var e=[];for(var b=0;b<c.length;b++){var d=c[b];if(d.free){continue}e.push(d.id)}return e},getTopicByIndex:function(b,d){var e=[];for(var c=0,a=d.length;c<a;c++){var f=d[c];if(f.free){continue}e.push(f)}return e[b]},getTopicIndex:function(d,g,c){if(d.root){return null}var f=g.children;if(g.root&&c=="left"){f=g.leftChildren}var a=f.length,b=-1;for(var e=0;e<a;e++){var h=f[e];if(h.id==d.id){b=e;break}}return b},getNewTopicIndex:function(c,e,d,b){var a=0,h=this.groupList,g=h.rightList,f=h.leftList;if(c.root&&b=="right"){return g.length}else{if(c.root&&b=="left"){if(c.leftChildren==null){c.leftChildren=[]}return c.leftChildren.length}}if(d){a=c.children.length}else{a=this.getTopicIndex(c,e,b)+1}return a},getTopicDomById:function(b){var a=$(".topic-box[id="+b+"]");return a.parent()},getTopicDomProp:function(b){var a=$(".topic-container[id="+b+"]");return{h:a.outerHeight(),w:a.outerWidth(),x:a.position().left,y:a.position().top}},getNearTopic:function(f,l){var m=this,b=m.model,r=m.currentRoot||b.topic,c=r.structure=="mind_org",a=m.util;var p=a.getSelectedId();if(p==""){return null}var s=b.getTopicById(p),q=a.getSelectedPartByPos(p);if(f=="left"){if(c){var n=b.getParentTopic(s.parent),d=n.children;if(d.length>1){var k=0;for(var t=0,u=d.length;t<u;t++){var g=d[t];if(g.id==s.id){k=t-1;break}}if(k<0){return n}else{return d[k]}}}if(s.root){return s.leftChildren[0]}else{if(q=="left"){if(!s.collapsed){if(s.children[0]){return s.children[0]}else{var h=m.summary.getSummaryByTopic.call(m,s,"left");if(h){return h}else{return s}}}else{var h=m.summary.getSummaryByTopic.call(m,s,"left");if(h){return h}else{return s}}}else{if(s.summary){var k=s.range.split(",")[0];var e=b.getParentTopic(s.parent);if(s.part=="left"){return e.leftChildren[k]}else{return e.children[k]}}else{return b.getParentTopic(s.parent)}}}}else{if(f=="right"){if(c){var n=b.getParentTopic(s.parent),d=n.children;if(d.length>1){var k=0;for(var t=0,u=d.length;t<u;t++){var g=d[t];if(g.id==s.id){k=t+1;break}}if(k>d.length-1){if(s.children.length>0){return s.children[s.children.length-1]}else{var o=b.getSubTopic(s);return b.getNextTopic(o,q)}}else{return d[k]}}}if(q=="left"){if(s.summary){var k=s.range.split(",")[0];var e=b.getParentTopic(s.parent);if(s.part=="left"){return e.leftChildren[k]}else{return e.children[k]}}else{return b.getParentTopic(s.parent)}}else{if(!s.collapsed){if(s.children[0]){return s.children[0]}else{var h=m.summary.getSummaryByTopic.call(m,s,"right");if(h){return h}else{return s}}}else{var h=m.summary.getSummaryByTopic.call(m,s,"right");if(h){return h}else{return s}}}}else{if(f=="up"){if(s.root){return s.children[0]}var n=b.getParentTopic(s.parent),d=n.children;if(n.root&&q=="left"){d=n.leftChildren}if(d.length>1){var k=0;for(var t=0,u=d.length;t<u;t++){var g=d[t];if(g.id==s.id){k=t-1;break}}if(k<0){return n}else{return d[k]}}else{return n}}else{if(f=="down"){if(s.root){var d=s.children,u=d.length;return d[u-1]}var n=b.getParentTopic(s.parent),d=n.children;if(c){if(!s.collapsed){if(s.children[0]){return s.children[0]}else{var h=m.summary.getSummaryByTopic.call(m,s,"right");if(h){return h}else{return s}}}else{var h=m.summary.getSummaryByTopic.call(m,s,"right");if(h){return h}else{return s}}}if(n.root&&q=="left"){d=n.leftChildren}if(d.length>1){var k=0;for(var t=0,u=d.length;t<u;t++){var g=d[t];if(g.id==s.id){k=t+1;break}}if(k>d.length-1&&!s.collapsed){if(s.children.length>0){return s.children[s.children.length-1]}else{var o=b.getSubTopic(s);return b.getNextTopic(o,q)}}else{return d[k]}}else{return s}}}}}},getPrevTopicWithoutFree:function(f,d){var g=0,a=[];var k=this.getParentTopic(f.parent);var c=k.children;if(k.root&&d=="left"){c=k.leftChildren}var h=c.length;for(var e=0;e<h;e++){var b=c[e];if(b.free){continue}a.push(b);if(b.id==f.id){break}g++}return a[g-1]},getFreeCountBefore:function(f,h,c){var e=f.children;if(c=="left"){e=f.leftChildren}var a=e.length;var b=0;for(var d=0;d<a;d++){var g=e[d];if(g.free){b++;continue}if(g.id==h){break}}return b},getPrevTopic:function(f,c){var g=0,k=this.getParentTopic(f.parent);var b=k.children;if(k.root&&c=="left"){b=k.leftChildren}var h=b.length;for(var d=0;d<h;d++){var a=b[d];if(a.free){continue}if(a.id==f.id){g=d-1;break}}if(g<0){var e=this.getNextTopic(f,c);return e}else{return b[g]}},getNextTopic:function(d,c){var b=0;var g=this.getParentTopic(d.parent),f=g.children;if(g.root&&c=="left"){f=g.leftChildren}var a=f.length;for(var e=0;e<a;e++){var h=f[e];if(h.id==d.id){b=e+1;break}}if(b>a){return null}else{return f[b]}},getPreTopic:function(c){if(c.root){if(c.children.length>0){return c.children[0]}return c}var b=0;var f=this.getParentTopic(c.parent),e=f.children,a=e.length;for(var d=0;d<a;d++){var g=e[d];if(g.id==c.id){b=d-1;break}}if(b<0){if(e.length>1){return e[1]}else{return f}}else{return e[b]}},getFirstTopic:function(b){var a;c(b);function c(d){var e=d.children;a=e[0];if(a.children.length>0){c(a)}}return a},getLastTopic:function(a){var c;b(a);function b(d){var e=d.children;if(e.length==0){c=d}else{c=e[e.length-1]}if(c.children.length>0){b(c)}}return c},getLastTopicTop:function(a){var c=this.model.getLastTopic(a);var b=this.model.getTopicDomById.call(this,c.id);return b.position().top+b.outerHeight()},getStyleTopics:function(b){var d=[],c=this,a=c.util;e(b);function e(g){if(!g){return}if(g.style||g.lineStyle||(g.theme&&g.background)||g.margin){d.push(a.copy(g));if(g.summary){if(g.style!=null){for(var m in g.style){if(m=="lineWidth"||m=="lineColor"||m=="lineType"){continue}else{delete g.style[m]}}}}else{delete g.style}delete g.lineStyle}if(g.theme){delete g.background}if(g.margin){delete g.margin}var l=g.children,n=[];if(g.root){n=g.leftChildren;l=l.concat(n)}if(l.length>0){for(var k=0,f=l.length;k<f;k++){var o=l[k];e(o)}}var h=g.summaries;if(h&&h.length>0){for(var k=0,f=h.length;k<f;k++){var o=h[k];e(o)}}}return d},addTopicStyles:function(l,c){var g=this,f=g.util;var b={},a="";for(var d=0,h=c.length;d<h;d++){var e=c[d];b[e.id]=e;a+=e.id+","}k(l);function k(o){if(a.indexOf(o.id)>=0){var n=b[o.id];if(n.style){o.style=n.style}if(o.theme&&n.background){o.background=n.background}if(n.margin){o.margin=n.margin}}var q=o.children,s=[];if(o.root){s=o.leftChildren;q=q.concat(s)}if(q.length>0){for(var p=0,m=q.length;p<m;p++){var t=q[p];k(t)}}var r=o.summaries;if(r&&r.length>0){for(var p=0,m=r.length;p<m;p++){var t=r[p];k(t)}}}return c},getParentTopic:function(a){return this.getTopicById(a)},getParentTopicById:function(b){var a=this.getTopicById(b);return this.getTopicById(a.parent)},getParentTopicPos:function(b){var a=$(this.getDesigner()).find(".topic-container[id="+b+"]");return{x:a.position().left+a.outerWidth()/2,y:a.positon().top+a.outerHeight()/2}},getParentTopics:function(g,a,e){var c=this.getTopicById(g),d=this;var f=[];if(a){f.push(c)}b(c.parent);function b(i){if(e!=null&&e==i){return}var h=d.getTopicById(i);if(h!=null){f.push(h);if(!h.root){b(h.parent)}}}return f},getChildrenIds:function(a){var c=[];function b(h){var g=h.children,d=g.length;c.push(h.id);if(g!=null&&d>0){for(var f=0;f<d;f++){var e=g[f];b(e)}}if(h.summaries!=null&&h.summaries.length>0){for(var f=0;f<h.summaries.length;f++){var e=h.summaries[f];b(e)}}}b(a);return c},getChildrenTopics:function(c,e,a){var d=[];function b(g,h){d.push(g);var l=[];for(var k=0;k<g.length;k++){var f=g[k].children.length;l=l.concat(g[k].children.concat(g[k].summaries||[]))}if(l.length>0){b(l)}}b(c.children.concat(c.leftChildren).concat(c.summaries||[]))},getTopicChildrenIds:function(a,d){var c=[];if(!d){d=1}function b(l,f){var k=l.children,e=k.length;if(f==d){c.push(l.id)}if(k!=null&&e>0){f++;for(var h=0;h<e;h++){var g=k[h];b(g,f)}}}b(a,0);return c},getChildrenIdsWithoutSelf:function(a){var c=[];function b(h){var g=h.children,d=g.length;if(g!=null&&d>0){for(var f=0;f<d;f++){var e=g[f];c.push(e.id);b(e)}}if(h.summaries!=null&&h.summaries.length>0){for(var f=0;f<h.summaries.length;f++){var e=h.summaries[f];c.push(e.id);b(e)}}}b(a);return c},getParentTopicIds:function(e){var c=this,b=c.getParentTopicById(e);var d=[];a(b);function a(g){d.push(g.id);if(g.root){return}var f=c.getTopicById(g.parent);if(f.root){return}else{a(f)}}return d},checkParentIsCollapsed:function(e){var c=this,b=c.getTopicById(e);if(b==null){return false}b=c.getParentTopicById(e);var d=false;if(b==null){return d}a(b);function a(g){if(g.root){return}if(g.collapsed){d=true;return}var f=c.getTopicById(g.parent);if(f.root){return}else{a(f)}}return d},resetTopicId:function(f,e){var c=this.newId(),g=this;f.id=c;if(f.free){f.parent="root"}else{f.parent=$.trim(e)}var b=f.children,h=b.length;if(h>0){for(var d=0;d<h;d++){var l=b[d];g.resetTopicId(l,f.id)}}if(f.summaries!=null&&f.summaries.length>0){var k=f.summaries;for(var d=0;d<k.length;d++){var l=k[d];g.resetTopicId(l,f.id)}}if(f.boundaries!=null&&f.boundaries.length>0){var a=f.boundaries;for(var d=0;d<a.length;d++){var l=a[d];g.resetTopicId(l,f.id)}}},changeTopicExpand:function(d,e,c,g){var f=this,b=f.model,a=b.topic;if(g==null){f.messageSource.send.call(f,"changetopicexpand",{content:d.id,type:e,part:c})}},addTopicMulti:function(H,p,B,M,Q){if(H.length==0){return}var E=this,c=E.model,x=E.currentRoot||c.topic,b=(x.structure=="mind_org"),G=x.leftChildren,f=E.util,k=E.line,e="",g=E.messageSource;var n=[],P="",u={},l={},R={};var J=[],I=[];for(var K=0,t=H.length;K<t;K++){var A=H[K],O=B[A.id],o=M[A.id],D=A.id;var m=c.getTopicById(A.parent);if(m==null){continue}if(I.indexOf(m)<0){I.push(m)}if(A.summary){if(m.summaries==null){m.summaries=[]}if(O==null){O=0}m.summaries.splice(O,0,A)}else{var r=m.children;if(m.root&&o=="left"){r=m.leftChildren||[]}if(O==null){O=r.length}var q=0;if(m.root){q=c.getFreeCountBefore(m,A.id,o);B[A.id]=O+q}r.splice((O+q),0,A)}c.addTopicToList(A,m);var F=c.getSubTopic(A);if(F.free&&F.id!=A.id){if(l[F.id]==null){l[F.id]=0}l[F.id]+=f.getTopicContainer(F.id).outerHeight()}P+=o+",";if(m.root){if(E.styles.autoColor){var v=A.lineStyle||{};if(!v.randomLineColor){var z=E.style.getLineColor(x);A.lineStyle=$.extend(v,{randomLineColor:z})}}c.groupList.setList(A,null,o,O)}else{if(A.lineStyle){delete A.lineStyle.randomLineColor;if(JSON.stringify(A.lineStyle)=="{}"){delete A.lineStyle}}}J.push(f.copy(A));var d=null;if(!m.root){d=f.getTopicContainerProp(F.id)}if(A.children.length>0||(A.summaries!=null&&A.summaries.length>0)){E.renderSubTopic(A,m,o,O);E.renderTopicExpand(m,$("#"+m.id),o);E.range.changeTopicPos(E,A,F,o,d)}else{if(A.summary){E.renderSubTopic(A,null,o)}else{E.renderTopicDom(A,o,m,O);E.range.changeTopicPos(E,A,F,o,d)}}e=A.id;if(n.indexOf(F.id)<0){n.push(F.id)}if(F.free&&F.id!=A.id){if(u[F.id]==null){u[F.id]=0}u[F.id]+=f.getTopicContainer(F.id).outerHeight();if(R[F.id]==null){R[F.id]=0}R[F.id]=u[F.id]-l[F.id]}E.operation.updateNumber.call(E,A)}for(var s in R){var C=f.getTopicContainer(s);var L=R[s];if(L!=null){C.css("top","-="+L/2+"px")}}var a=E.summary.getUpdatedSummaries.call(E,H,B,M,null,null,p);var w=E.boundary.getUpdatedBoundries.call(E,H,B,M,null,null,p);if(P.indexOf("right")>=0){E.range.resetSubTopics.call(E,"right")}if(P.indexOf("left")>=0){E.range.resetSubTopics.call(E,"left")}k.resetLines.call(E,n,null,P);if(Q==null){var N=f.extend(a.updates,w.updates),y=f.extend(a.original,w.original);g.send.call(E,"create",{content:J,index:B,parts:M,updates:p||N,original:y,updateTps:R})}E.renderFreeSummaries(P);E.renderFreeBoundaries(P);E.connection.resetAllConnectionPos.call(E,x);if(I.length>0){E.events.push("outline-prebuild",{topics:I,rebuild:"current"})}},updateFreeTopicPos:function(a,n,s,c,d){var m=this,l=m.model,p=m.currentRoot||l.topic,k=m.util,e=m.connection;if(a.length==0){return}var f={},q=[];if(s==null){s=[];for(var g=0;g<a.length;g++){var h=a[g];if(h.free==null||h.summary){continue}var b=e.getConnectionsByTopic.call(m,h.id);if(b!=null&&b.length>0){s=s.concat(b)}}}for(var g=0;g<a.length;g++){var h=a[g];if(h.free==null||h.summary){continue}var r=k.getTopicContainer(h.id);var o=n[h.id];f[h.id]=k.copy(h.pos);h.pos=o;r.css({left:o.x,top:o.y});q.push(h.id)}l.topicList.resetTopicList.call(m);if(s.length>0){e.resetAllConnectionPos.call(m,p,s,true)}if(d==null){m.messageSource.send.call(m,"updateFreeTopic",{content:k.copy(n),original:f,topicIds:q,lines:s,oldLines:c})}},addFreeTopic:function(c,h,e,f){var b=e.util,d=e.model,a=d.topic,g=d.groupList;c.free=true;c.pos={x:h.x,y:h.y};a.children.push(c);g.doGroup(a,a.structure);d.topicList.resetTopicList.call(e);e.renderTopicDom(c);e.events.push("outline-prebuild",{topics:[a],insertChild:true});if(f==null){e.messageSource.send.call(e,"addFreeTopic",{content:c});b.selectOne.call(e,c)}},changeToFreeTopic:function(F,z,H,U){var J=this,d=J.model,D=d.topic,t=d.groupList,q=J.line,o=J.util,G=J.styles;var u=[],T=o.copy(F);var l=J.util.getMargin.call(J);var m=l.marginW,x=l.marginH;var Q=o.getTopicContainer(F.id);var g=Q.clone(false);var n=d.getSubTopic(F);var v=o.getSelectedPart(F.id,D.structure);var O=0;var C=o.getTopicContainerProp(n.id);Q.remove();q.deleteLine(F);if(n.id==F.id){O=C.h+x;var K=0;if(D.structure=="mind_org"||D.structure=="mind_tree"){K=-(C.w)-m/2}J.range.doChangeSubTopicPos(J,n,-O/2,K,v)}else{var c=o.getTopicContainerProp(n.id);O=c.h-C.h;var K=0;if(D.structure=="mind_org"||D.structure=="mind_tree"){K=(c.w-C.w)}J.range.doChangeSubTopicPos(J,n,O/2,K,v)}u.push(n.id);var r=d.getTopicById(F.parent),A=r.children;if(r.root&&v=="left"){A=r.leftChildren}var B=A.length,I=0;for(var N=0;N<B;N++){var f=A[N];if(f.id==F.id){I=N;break}}A.splice(I,1);var e={};e[F.id]=I;var P={};P[F.id]=v;var y=J.summary.getUpdatedSummaries.call(J,[F],e,P,"delete",null,z);var M=J.boundary.getUpdatedBoundries.call(J,[F],e,P,"delete",null,z);if(A.length==0){var b=o.getTopicDom(r.id);b.find(".expand_box").remove();var s=o.getTopicContainer(r.id);s.find(".topic-children:first").remove()}T.parent=D.id;D.children.push(T);T.free=true;T.pos={x:H.x,y:H.y};t.doGroup(D,D.structure);d.topicList.resetTopicList.call(J);q.resetLines.call(J,u,null,v);J.renderSubTopic(T);var k=o.getTopicContainer(T.id);var L=k.children(".topic-box");var p={},a=(D.structure=="mind_org"),S=(D.structure=="mind_tree");if(a){p={x:k.outerWidth()/2,y:L.outerHeight(),h:L.outerHeight()}}else{if(S){p={x:10,y:L.outerHeight(),h:L.outerHeight()}}else{p={x:L.outerWidth(),y:k.outerHeight()/2-0.5,h:L.outerHeight()}}}J.renderFreeSummaries(v);J.renderFreeBoundaries(v);q.renderLines.call(J,T,p);if(U==null){o.selectOne.call(J,T);var R=o.extend(y.updates,M.updates),E=o.extend(y.original,M.original);J.messageSource.send.call(J,"changeToFreeTopic",{content:T,original:F.parent,index:I,part:v,updates:z||R,updates_origi:E})}J.connection.resetAllConnectionPos.call(J,D);J.events.push("outline-prebuild",{topics:[D],rebuild:"current"});J.operation.updateNumber.call(J,F)},addTopic:function(c,e,b,a){this.addTopicToList(c,e);if(e.root){this.groupList.setList(c,null,a)}var d=e.children;d.splice(b,0,c)},unInsertParentTopic:function(p,m,n,s){var g=this,d=g.model,o=g.currentRoot||d.topic,r=d.groupList,a=g.util,i=g.line,h=g.styles;var c=d.getTopicById(p.id);var k=a.copy(c);var l=d.getTopicById(k.parent);var b=a.copy(d.getTopicById(m.id));var e=b.children;c.id=b.id;c.children=[];c.children=e;if(b.icons){c.icons=b.icons}if(b.task){c.task=b.task}if(b.style){c.style=b.style}if(b.link){c.link=b.link}if(b.free){c.free=b.free}if(b.summary){c.summary=b.summary}if(b.summaries){c.summaries=b.summaries}if(b.pos){c.pos=b.pos}if(b.image){c.image=b.image}if(b.collapsed){c.collapsed=b.collapsed}c.title=b.title;d.groupList.doGroup(o,o.structure);d.topicList.resetTopicList.call(g);$(".topic-box[id="+k.id+"]").parent().remove();i.deleteLine(k);if(l.root){g.renderSubTopic(c,null,n);g.range.resetSubTopics.call(g,n);i.renderNewLines(g,c,c.id);i.resetLines.call(g,[c.id],null,n)}else{var f=d.getSubTopic(l);g.renderSubTopic(f,null,n);g.range.resetSubTopics.call(g,n);i.renderNewLines(g,l,f.id);i.resetLines.call(g,[f.id],null,n)}g.renderFreeSummaries(n);g.renderFreeBoundaries(n);if(s==null){a.selectOne.call(g,c);var q=a.copy(b);q.children=[];k.children=[];g.messageSource.send.call(g,"unInsertParent",{content:k,original:q,part:n})}g.connection.resetAllConnectionPos.call(g,o)},insertParentTopic:function(q,n,o,v){var g=this,d=g.model,p=g.currentRoot||d.topic,t=d.groupList,a=g.util,k=g.line,h=g.styles;var l=d.getTopicById(q.parent);var m=d.topic.margin,y=null;if(m){y=m.marginH}var w=y==null?h.marginH:y;o=o||a.getSelectedPart(q.id,p.structure);var e=l.children,f=0;if(l.root&&o=="left"){e=l.leftChildren}if(n==null){var u=d.getTopicById(q.id);var b=a.copy(u);q.id=d.newId();b.parent=q.id;q.children=[];q.children.push(b);k.deleteLine(b)}else{var u=d.getTopicById(n.id);var b=a.copy(u);u.id=q.id;u.title=q.title;b.parent=q.id;u.children=[];u.children.push(b);q=u;k.deleteLine(b)}q.title="父主题";delete q.pos;delete q.free;delete q.summary;delete q.summaries;delete q.boundaries;delete q.collapsed;delete q.image;delete q.icons;delete q.task;delete q.link;delete q.style;d.groupList.doGroup(p,p.structure);d.topicList.resetTopicList.call(g);if(l.root){g.renderSubTopic(q,null,o);g.range.resetSubTopics.call(g,o);k.renderNewLines(g,q,q.id);k.resetLines.call(g,[q.id],null,o)}else{if(l.summaries!=null&&l.summaries.length>0){for(var s=0;s<l.summaries.length;s++){var c=l.summaries[s];$("div[for="+c.id+"]").remove()}}g.range.resetSubTopics.call(g,o);g.operation.showChildren.call(g,l)}g.renderFreeSummaries(o);g.renderFreeBoundaries(o);if(v==null){a.selectOne.call(g,q);var x=a.copy(q);var r=a.copy(b);r.children=[];x.children=[];g.messageSource.send.call(g,"insertParent",{content:x,original:r,part:o})}g.connection.resetAllConnectionPos.call(g,p);g.events.push("outline-prebuild",{topics:[l],rebuild:"current"});g.operation.updateNumber.call(g,q)},replaceDef:function(b,a){that.messageSource.send.call(that,"replaceDef",{content:b,original:a})},updateTopicText:function(p,v,u){var g=this,b=g.model,a=g.util,l=g.line,o=g.currentRoot||b.topic,q=b.groupList;var i=p.title;p.title=v;var e=b.getSubTopic(p);var n=a.getSelectedPart(p.id,o.structure);var c=a.getTopicContainerProp(e.id);var s=a.getTopicDom(p.id),d=s.find(".topic");d.html(v).show();g.operation.renderEquation(d);var f=a.getTopicContainerProp(e.id);var r=(f.h-c.h)/2;var k=f.w-c.w;g.range.doChangeSubTopicPos(g,e,r,k,n,true);g.resetTopicExpandPos(s,o.structure);if(u==null){g.messageSource.send.call(g,"updateTitle",{content:p.id,original:i,update:v,part:n})}if(p.root){n="left,right,";l.resetSubLines.call(g,n);var m=document.createElement("div");m.innerHTML=d.html();var t=$(m).find(".equation-text");t.html(t.data("equation"));g.events.push("savetitle",$(m).text())}else{if(e.summary&&e.part=="left"){n="left"}l.resetLines.call(g,[e.id],null,n)}a.resetSelectDom();g.events.push("outline-prebuild",{topics:[p],rebuild:"current"});g.connection.resetAllConnectionPos.call(g,o);g.renderFreeSummaries(n);g.renderFreeBoundaries(n);if(u==null){g.util.selectOne.call(g,p)}},updateTopicImage:function(r,b,y,x){var t=900,d=0;var i=this,e=i.model,a=i.util,l=i.line,q=i.currentRoot||e.topic,s=e.groupList,o=i.messageSource;var u=a.getTopicDom(r.id);var g=e.getSubTopic(r);var p=a.getSelectedPart(g.id,q.structure);var f=a.getTopicContainerProp(g.id);var m=r.image,n=$("#topic_img_"+r.id),w=n.parent();var k=false;if(y){if(m.w!=b.image.w||m.h!=b.image.h){h()}k=true;v();return}if(m==null){if(n.length>0){var c=e.getTopicById(r.id);delete c.image;w.remove();v()}}else{if(n.length==0){w=i.operation.renderTopicImage(r);w.hide()}else{n.removeAttr("style");n.attr("src",m.url)}h();w.fadeIn();v()}i.events.push("hideuploading");function h(){if(m.w<=t){t=m.w;d=m.h}else{d=t*m.h/m.w}t=t==0?100:t;d=d==0?100:d;w.css({width:t,height:d});n.css({width:t,height:d})}function v(){var C=a.getTopicContainerProp(g.id);var B=(C.h-f.h)/2;var z=C.w-f.w;i.range.doChangeSubTopicPos(i,g,B,z,p,true);i.resetTopicExpandPos(u,q.structure);if(r.root){p="left,right,";l.resetSubLines.call(i,p)}else{l.resetLines.call(i,[g.id],null,p)}var E=e.getTopicById(r.id);E=$.extend(true,E,r);var D=a.copy(r).image;var A=a.copy(b).image;if(x==null){o.send.call(i,"updateImage",{content:r.id,update:D,original:A,resize:k,part:p});a.selectOne.call(i,r)}i.connection.resetAllConnectionPos.call(i,q);i.renderFreeSummaries(p);i.renderFreeBoundaries(p)}},updateTopicNode:function(A,s,f,E,G){var m=this,g=m.model,x=m.currentRoot||g.topic,H=m.operation,b=m.util,q=m.line,z=g.groupList;var u="",c="",t={},I=[],r=false;if(!(A instanceof Array)){A=[A];s=[s]}A=b.copyArray(A);s=b.copyArray(s);for(var y=0,D=A.length;y<D;y++){var v=b.copy(A[y]);var a=b.copy(s[y]);var k=g.getSubTopic(v);u=b.getSelectedPart(k.id,x.structure);c+=u+",";t[v.id]=u;var e=b.getTopicContainerProp(k.id);var d=g.getTopicById(v.id);if(f=="note"){m.remark.renderTopicNote(b,v,u);d.note=v.note}else{if(f=="tag"){m.tags.renderTopicTag(b,v,u);d.tags=v.tags}else{if(f=="link"){H.renderTopicLink(b,v,u);d.link=v.link}else{if(f=="icon"){m.icons.renderTopicIcons(b,v,u);d.icons=v.icons}else{if(f=="style"){m.style.setTopicStyle(m,v,u);d.style=v.style}else{if(f=="line"){m.style.setTopicLineStyle(m,v,u);d.lineStyle=v.lineStyle;if(v.lineStype!=null){delete v.lineStyle.lineType;delete v.lineStyle.underLine}if(d.lineStyle!=null){delete d.lineStyle.lineType;delete d.lineStyle.underLine}}else{if(f=="task"){m.task.renderTopicTask(b,v,u);d.task=v.task}else{if(f=="clearStyle"){m.style.setTopicStyle(m,v,u);var n=b.getTopicDom(v.id);n.find(".topic").html(v.title);m.style.setTopicLineStyle(m,v,u,f)}else{if(f=="number"){m.operation.renderNumber.call(m,b,v);if(v.number){d.number=v.number}else{delete d.number;this.operation.updateNumber.call(this,v)}}else{if(f=="node"){var p=b.getTopicDom(v.id);d.title=v.title;if(p.length){m.model.updateTopicText.call(m,v,v.title,true)}}}}}}}}}}}var C=b.getTopicDom(v.id);var l=b.getTopicContainerProp(k.id);var B=(l.h-e.h)/2;var o=l.w-e.w;m.range.doChangeSubTopicPos(m,k,B,o,u,true);m.resetTopicExpandPos(C,x.structure);if(!k.root){I.push(k.id)}v.children=[];a.children=[];if(v.root&&r==false){r=true}}if(r){u="left,right,";q.resetSubLines.call(m,u)}if(r&&f=="number"){I=g.getSubTopicIds(x);c="left,right,"}q.resetLines.call(m,I,null,c);m.connection.resetAllConnectionPos.call(m,x);if(E){g.topicList.resetTopicList.call(m)}m.renderFreeSummaries(c);m.renderFreeBoundaries(c);if(G==null){b.clearSelect();if(f!="node"){b.select(A,m)}var F=[];for(var y=0;y<A.length;y++){var d=b.copy(A[y]);if(f!="number"){d.children=[]}F.push(d)}m.messageSource.send.call(m,"update",{content:F,original:s,type:f,parts:t})}},_updateTopicPos:function(L,G,s,B,W,M,T,O,N,a,V,v){var H=this,c=H.model,z=H.currentRoot||c.topic,q=c.groupList,m=H.util,n=H.line,E=H.styles;var g=H.util.getMargin.call(H);var h=g.marginW,u=g.marginH;var r=[],S="";var D={},y={},l={},d={},P=[];for(var R=0,x=s.length;R<x;R++){var C=s[R];var p=c.getParentTopic(C.parent);var t=N[C.id];var f=a[C.id];var k=c.getSubTopic(C);$(".topic-box[id="+C.id+"]").parent().remove();n.deleteLine(C);if(p.children.length==1){var b=m.getTopicDom(p.id);b.find(".expand_box").remove();b.parent().children(".topic-children").remove()}var w=p.children;if(p.root&&t=="left"){w=p.leftChildren}var J=w.length;for(var Q=0;Q<J;Q++){var e=w[Q];if(e.id==C.id){w.splice(Q,1);break}}if(r.indexOf(k.id)<0){r.push(k.id)}var K=L[R];if(K.free){K.parent=c.topic.id;c.topic.children.push(K);S+=t+","}else{var U=G[K.id];var o=c.getTopicById(K.parent);if(o.root&&f=="left"){o.leftChildren.splice(U,0,K)}else{o.children.splice(U,0,K)}S+=t+","}if(K.parent!="root"&&K.lineStyle){delete K.lineStyle.randomLineColor;if(JSON.stringify(K.lineStyle)=="{}"){delete K.lineStyle}}P.push(m.copy(K))}y=H.summary.getUpdatedSummaries.call(H,s,B,N,"delete",null,M);d=H.boundary.getUpdatedBoundries.call(H,s,B,N,"delete",null,O);c.groupList.doGroup(z,z.structure);c.topicList.resetTopicList.call(H);for(var R=0,x=L.length;R<x;R++){var C=L[R];var o=c.getTopicById(C.parent);var F=G[C.id];if(F>=o.children.length){F=o.children.length-1}var I=c.getSubTopic(C);var t=a[C.id];if(C.children.length>0||(C.summaries!=null&&C.summaries.length>0)||(C.boundaries!=null&&C.boundaries.length>0)){H.renderSubTopic(C,o,t,F);H.renderTopicExpand(o,$("#"+o.id),t)}else{H.renderTopicDom(C,t,o,F)}if(r.indexOf(I.id)<0&&I.id!=z.id){r.push(I.id)}S+=t+",";H.operation.updateNumber.call(H,C)}D=H.summary.getUpdatedSummaries.call(H,L,G,a,null,null,W);l=H.boundary.getUpdatedBoundries.call(H,L,G,a,null,null,T);H.summary.getRemovedSums(H,null,D,null,null,t);H.boundary.getRemovedBounds(H,null,l,null,null,t);if(S.indexOf("right")>=0){H.range.resetSubTopics.call(H,"right")}if(S.indexOf("left")>=0){H.range.resetSubTopics.call(H,"left")}H.renderFreeSummaries(S);H.renderFreeBoundaries(S);n.resetLines.call(H,r,null,S);H.connection.resetAllConnectionPos.call(H,z);if(V==null){H.messageSource.send.call(H,"updatePos",{content:P,original:s,newIndex:G,oldIndex:B,oldPart:N,newPart:a,oldSums:m.copy(y),newSums:m.copy(D),oldBounds:m.copy(d),newBounds:m.copy(l),});if(v!=null&&v.length>0){H.util.clearSelect();var A=[];for(var R=0;R<v.length;R++){var C=H.model.getTopicById(v[R]);A.push(C)}H.util.select(A,H)}else{H.util.selectDirect(L,H)}}H.events.push("outline-prebuild",{id:"root",rebuild:"current"})},updateTopicPos:function(ag,M,a,y,P,K,k){var ad=this,g=ad.model,R=ad.currentRoot||g.topic,B=g.groupList,v=ad.util,w=ad.line,Z=ad.styles;var q=ad.util.getMargin.call(ad);var s=q.marginW,G=q.marginH;var e=(R.structure=="mind_org")||(R.structure=="mind_tree");var C=[],H=[],D=[],ab={},X={},am="",ah={},b={};var Y={},O={},u={},n={};var h=g.getTopicById(a.id),I,m=P||v.getSelectedPart(h.id,R.structure);if(h.collapsed&&a.pos=="in"){return}if(ag.length<=0){return}for(var al=0,N=ag.length;al<N;al++){var W=ag[al];var A=g.getTopicById(W.parent);var F=v.getSelectedPart(W.id,R.structure);var aa=g.getTopicIndex(W,A,F);X[W.id]=aa;ah[W.id]=F}if(h.root){I=h}else{I=g.getParentTopicById(h.id)}var S={},ak={};for(var al=0,N=ag.length;al<N;al++){var ap=ag[al];var W=g.getTopicById(ap.id),A;if(W.free){A=R}else{A=g.getParentTopic(W.parent)}if($.isEmptyObject(S)){if(A.summaries!=null&&A.summaries.length>0){for(var aj=0;aj<A.summaries.length;aj++){var J=A.summaries[aj],z=J.range+"";var ao=-1;if(z.indexOf(",")<0){ao=Number(z)}else{ao=Number(z.split(",")[0])}if(J.part!=null&&J.part=="left"&&J.parent==R.id){S[J.id]=A.leftChildren[ao].id}else{S[J.id]=A.children[ao].id}}}}if($.isEmptyObject(ak)){if(A.boundaries!=null&&A.boundaries.length>0){for(var aj=0;aj<A.boundaries.length;aj++){var ai=A.boundaries[aj],z=ai.range+"";var ao=-1;if(z.indexOf(",")<0){ao=Number(z)}else{ao=Number(z.split(",")[0])}if(ai.part!=null&&ai.part=="left"&&ai.parent==R.id){ak[ai.id]=A.leftChildren[ao].id}else{ak[ai.id]=A.children[ao].id}}}}var af=g.getSubTopic(W);var ac=v.copy(W);var V=v.copy(g.getTopicById(W.id));D.push(V);var F=ah[W.id];var L=A.children;if(A.root&&F=="left"){L=A.leftChildren}if(W.free!=true){var t=g.getSubTopic(V);$(".topic-box[id="+V.id+"]").parent().remove();w.deleteLine(V);C.push(t.id)}else{delete ac.free;delete ac.pos}if(A.children.length==1){var f=v.getTopicDom(A.id);f.find(".expand_box").remove();f.parent().children(".topic-children").remove()}if(a.pos=="in"){ac.parent=h.id}else{ac.parent=I.id}delete ac.free;delete ac.pos;H.push(v.copy(ac));if(a.rootPos!=null){m=a.rootPos}if(e){b[ac.id]="right"}else{b[ac.id]=m}var ae=L.length;for(var aj=0;aj<ae;aj++){var p=L[aj];if(p.id==V.id){L.splice(aj,1);break}}g.removeTopicFromList(V.id);am+=F+",";ad.operation.updateNumber.call(ad,W)}if(M==null){O=ad.summary.getUpdatedSummaries.call(ad,ag,X,ah,"delete",null,null);n=ad.boundary.getUpdatedBoundries.call(ad,ag,X,ah,"delete",null,null)}var d=[],r=null;if(a.pos=="in"){if(h.root&&m=="left"){if(R.structure!="mind_org"&&R.structure!="mind_tree"){d=I.leftChildren}else{d=I.children}r=I}else{if(a.rootPos!=null){if(a.rootPos=="left"&&(R.structure!="mind_org"&&R.structure!="mind_tree")){if(!I.leftChildren){I.leftChildren=[]}d=I.leftChildren;m="left";r=I}else{if(a.rootPos=="left"&&(R.structure=="mind_org"||R.structure=="mind_tree")){d=h.children;r=h}else{d=h.children;r=h}}}else{d=h.children;r=h}}}else{if(a.pos=="before"||a.pos=="after"){if(I.root&&m=="left"){d=I.leftChildren}else{d=I.children}r=I}}var ae=d.length;if(a.pos=="in"){for(var al=0,N=H.length;al<N;al++){var c=H[al];var o=b[c.id];if(o=="right"&&m=="left"&&e){d.splice(0,0,c);ab[c.id]=0}else{d.push(c);ab[c.id]=al+ae}}}else{if(a.pos=="after"){for(var al=0;al<ae;al++){var p=d[al];if(p.id==h.id){for(var aj=1,N=H.length;aj<=N;aj++){var c=H[aj-1];d.splice((al+aj),0,c);ab[c.id]=al+aj}break}}}else{if(a.pos=="before"){for(var al=0;al<ae;al++){var p=d[al];if(p.id==h.id){var an=(al-1<0)?0:al;for(var aj=0,N=H.length;aj<N;aj++){var c=H[aj];d.splice((an+aj),0,c);ab[c.id]=an+aj}break}}}}}g.groupList.doGroup(R,R.structure);g.topicList.resetTopicList.call(ad);for(var al=0,N=H.length;al<N;al++){var ac=H[al];var aa=ab[ac.id];var x=g.getTopicById(ac.parent);var af=g.getSubTopic(ac);var E=b[ac.id];if(ac.children.length>0||(ac.summaries!=null&&ac.summaries.length>0)||(ac.boundaries!=null&&ac.boundaries.length>0)){ad.renderSubTopic(ac,x,E,aa);ad.renderTopicExpand(x,$("#"+x.id),E)}else{ad.renderTopicDom(ac,E,x,aa)}if(!x.root&&ac.lineStyle){delete ac.lineStyle.randomLineColor;if(JSON.stringify(ac.lineStyle)=="{}"){delete ac.lineStyle}}else{if(x.root&&Z.autoColor){var Q=ac.lineStyle||{};if(!Q.randomLineColor){var U=ad.style.getLineColor(R);ac.lineStyle=$.extend(Q,{randomLineColor:U})}}}if(C.indexOf(af.id)<0&&af.id!=R.id){C.push(af.id)}am+=m+","}Y=ad.summary.getUpdatedSummaries.call(ad,H,ab,b,null,r.id,M);u=ad.boundary.getUpdatedBoundries.call(ad,H,ab,b,null,r.id,M);ad.summary.getRemovedSums(ad,O,Y,S,r.id,m);ad.boundary.getRemovedBounds(ad,n,u,ak,r.id,m);if(am.indexOf("right")>=0){ad.range.resetSubTopics.call(ad,"right")}if(am.indexOf("left")>=0){ad.range.resetSubTopics.call(ad,"left")}ad.renderFreeSummaries(am);ad.renderFreeBoundaries(am);w.resetLines.call(ad,C,null,am);ad.connection.resetAllConnectionPos.call(ad,R);if(a.pos=="in"||a.id=="root"){var l=a.id}else{var l=I.id}if(!k){ad.messageSource.send.call(ad,"updatePos",{content:H,original:D,newIndex:ab,oldIndex:X,newPart:b,oldPart:ah,selectedIds:K,oldSums:O,newSums:Y,oldBounds:n,newBounds:u});ad.events.push("outline-prebuild",{id:"root",rebuild:"current"});if(K!=null&&K.length>0){ad.util.clearSelect();var T=[];for(var al=0;al<K.length;al++){var W=ad.model.getTopicById(K[al]);T.push(W)}ad.util.select(T,ad)}else{ad.util.selectDirect(H,ad)}}},addAndRemove:function(v,c,d,z,L,O){var B=this,b=B.model,w=B.currentRoot||b.topic,o=b.groupList,k=B.util,l=B.line,x=B.styles;var f=B.util.getMargin.call(B);var h=f.marginW,r=f.marginH;var e=[],p=[],a="",K={};var F={};for(var u in c){var E=c[u];for(var J=0;J<E.length;J++){var M=E[J];e.push(M);$(".topic-box[id="+M.id+"]").parent().remove();l.deleteLine(M)}}if(e.length>0){B.connection.deleteConnectionByTopics.call(B,e)}for(var J=0;J<e.length;J++){var G=e[J],A=-1;var q=z[G.id];K[G.id]=q;var m=b.getParentTopic(G.parent);var t=m.children;if(q=="left"&&m.root){t=m.leftChildren}for(var I=0;I<t.length;I++){var n=t[I];if(n.id==G.id){A=I;break}}if(A>=0){t.splice(A,1);F[G.id]=A}}for(var J=0;J<v.length;J++){var D=k.copy(v[J]);var y=L[D.id];var q=d[D.id];var m=b.getParentTopic(D.parent);var t=m.children;if(q=="left"&&m.root){t=m.leftChildren}t.splice(y,0,k.copy(D))}var s=B.summary.getUpdatedSummaries.call(B,e,F,K,"delete",null,null);var H=B.boundary.getUpdatedBoundries.call(B,e,F,K,"delete",null,null);b.topicList.resetTopicList.call(B);b.groupList.doGroup(w,w.structure);if(v.length>0){for(var J=0;J<v.length;J++){var N=v[J];var g=b.getParentTopic(N.parent);var C=b.getSubTopic(N);if(p.indexOf(C.id)<0){p.push(C.id)}var y=L[D.id];var q=d[N.id];a+=q+",";B.renderSubTopic(N,null,q,y+J)}}B.summary.getRemovedSums(B,s,s,null,null,q,true);B.boundary.getRemovedBounds(B,H,H,null,null,q,true);B.range.resetSubTopics.call(B,q);l.resetLines.call(B,p,null,a);B.renderFreeSummaries(a);B.renderFreeBoundaries(a);if(O==null){B.messageSource.send.call(B,"deleteSelfRestore",{removed:v,add:c,addPart:z,removedPart:d,removedIndex:L,addIndex:F});B.util.selectOne.call(B,N)}B.connection.resetAllConnectionPos.call(B,w)},removeAndAdd:function(D,q,k,r,E){var h=this,d=h.model,x=h.currentRoot||d.topic,a=h.util,o=h.line,m=h.styles;var w={},G=[],l="",u={};if(D.length>0){h.connection.deleteConnectionByTopics.call(h,D)}for(var A=0;A<D.length;A++){var c=D[A],g=-1;var t=d.getParentTopic(c.parent);var v=k[c.id];u[c.id]=v;var C=q[c.id];$(".topic-box[id="+c.id+"]").parent().remove();o.deleteLine(c);var e=t.children;if(v=="left"&&t.root){e=t.leftChildren}for(var z=0;z<e.length;z++){var B=e[z];if(B.id==c.id){g=z;break}}if(g>=0){e.splice(g,1);w[c.id]=g}if(C.length>0){for(var z=0;z<C.length;z++){var f=C[z];f.parent=t.id;if(m.autoColor&&f.parent=="root"){var F=f.lineStyle||{};if(!F.randomLineColor){var y=h.style.getLineColor(x);f.lineStyle=$.extend(F,{randomLineColor:y})}}e.splice(g+z,0,a.copy(f))}}}var b=h.summary.getUpdatedSummaries.call(h,D,w,u,"delete",null,null);var p=h.boundary.getUpdatedBoundries.call(h,D,w,u,"delete",null,null);d.topicList.resetTopicList.call(h);d.groupList.doGroup(x,x.structure);if(C.length>0){for(var A=0;A<C.length;A++){var H=C[A];var n=d.getParentTopic(H.parent);var s=d.getSubTopic(H);if(G.indexOf(s.id)<0){G.push(s.id)}var v=r[H.id];l+=v+",";h.renderSubTopic(H,null,v,g+A)}}b.updates=b.original;p.updates=p.original;h.summary.getRemovedSums(h,b,b,null,null,v,true);h.boundary.getRemovedBounds(h,p,p,null,null,v,true);h.range.resetSubTopics.call(h,v);o.resetLines.call(h,G,null,l);h.renderFreeSummaries(l);h.renderFreeBoundaries(l);if(E==null){h.messageSource.send.call(h,"deleteSelf",{removed:D,add:q,removedIndex:w,addPart:r,removedPart:k});h.util.selectOne.call(h,H)}h.connection.resetAllConnectionPos.call(h,x)},removeTopic:function(P,B,e,aa){if(P.length==0){return}var M=this,d=M.model,F=M.currentRoot||d.topic,s=d.groupList,n=M.util,p=M.line,I=M.styles;var k=M.util.getMargin.call(M);var l=k.marginW,y=k.marginH;var t=[],W={},V={},a="";var Z=null;M.connection.deleteConnectionByTopics.call(M,P);var z=[];for(var T=0,D=P.length;T<D;T++){z.push(P[T].id)}var b=n.getAvailableSelected(M,F,P);if(e==true){b=P}var D=b.length,Q=[],E={},q={},ab={};for(var T=D-1;T>=0;T--){var H=b[T];if(H==null||H.root){continue}var r=d.getParentTopic(H.parent);if(r==null&&H.pos==null){continue}Q.push(r);var m=d.getSubTopic(H);if(m.free&&m.id!=H.id){if(q[m.id]==null){q[m.id]=0}q[m.id]+=n.getTopicContainer(m.id).outerHeight()}var w=H.part||n.getSelectedPart(H.id,F.structure);if(H.summary){var J=$(".topic-box[id="+H.id+"]").parent().parent().prev();if(J.length){if(J.children().length>0){var o=H.range+"";var g=0;var N=0;if(o.indexOf(",")<0){g=o;N=o}else{g=o.split(",")[0];N=o.split(",")[1]}var Y=J.parent();J.children().each(function(){var h=$(this);Y.before(h)});$(".topic-summary-resize").remove();Y.remove()}}}if(r.children.length==1&&r.id!=F.id){var c=n.getTopicDom(r.id);c.find(".expand_box").remove();$(".topic-box[id="+H.id+"]").parent().parent().remove()}else{$(".topic-box[id="+H.id+"]").parent().remove()}p.deleteLine(H);if(m.free&&m.id!=H.id){if(E[m.id]==null){E[m.id]=0}E[m.id]+=n.getTopicContainer(m.id).outerHeight();if(ab[m.id]==null){ab[m.id]=0}ab[m.id]=E[m.id]-q[m.id]}if(T==D-1&&!H.free&&aa==null){if(H.summary){var v=(H.range+"").split(",")[0];if(r.id==d.topic.id&&w=="left"){Z=r.leftChildren[v]}else{Z=r.children[v]}}else{var O=d.getPrevTopic(H,w);if(O!=null){Z=O}else{Z=r}}}var A=r.children;if(H.summary){A=r.summaries}else{if(r.root&&w=="left"){A=r.leftChildren}}var u=A.length;for(var S=0;S<u;S++){var f=A[S],L=f.id;if(f.id==H.id){W[H.id]=S;A.splice(S,1);break}}if(w=="left"&&m.summary&&m.part==null){V[H.id]="right"}else{V[H.id]=w}a+=w+",";if(!H.free){if(t.indexOf(m.id)<0){t.push(m.id)}}M.operation.updateNumber.call(M,H)}for(var C in ab){var K=n.getTopicContainer(C);var U=ab[C];if(U!=null){K.css("top","-="+U/2+"px")}}var R=M.boundary.getUpdatedBoundries.call(M,P,W,V,"delete",null,B);var x=M.summary.getUpdatedSummaries.call(M,P,W,V,"delete",null,B);M.model.topicList.resetTopicList.call(M);d.groupList.doGroup(F,F.structure);if(a.indexOf("right")>=0){M.range.resetSubTopics.call(M,"right")}if(a.indexOf("left")>=0){M.range.resetSubTopics.call(M,"left")}M.renderFreeBoundaries(a);M.renderFreeSummaries(a);p.resetLines.call(M,t,null,a);if(aa==null){var X=n.extend(x.updates,R.updates),G=n.extend(x.original,R.original);M.messageSource.send.call(M,"delete",{content:b,index:W,parts:V,selectedIds:z,updates:B||X,original:G,updateTps:ab})}M.connection.resetAllConnectionPos.call(M,F);if(Q.length>0){M.events.push("outline-prebuild",{topics:Q,rebuild:"current"})}if(Z!=null){n.selectOne.call(M,Z)}else{n.clearSelect()}},removeAttr:function(d,c){for(var b=0;b<d.length;b++){var a=d[b];if(a[c]){delete a[c]}}},hideTopics:function(p,u,v){var g=this,a=g.util,c=g.model,h=g.line,q=g.currentRoot||c.topic;var o="",t=[],n={},l=[],w=[];if(p.length>0){if(u){for(var s=0;s<p.length;s++){var m=p[s];var r=c.getTopicById(m);if(r.children.length>0){r.collapsed=true;t.push(r);var f=a.getSelectedPart(r.id,q.structure);o+=f+",";n[m]=f;l.push(m)}}var e=t[0];var k=a.getTopicContainer(e.id);k.children(".topic-children").remove();h.deleteChildrenLines(e);var d=a.getTopicDom(e.id),x=d.children(".expand_box");x.html("&#xe647;").addClass("hide");var b=c.getSubTopic(e);if(w.indexOf(e.id)<0){w.push(e.id)}}else{for(var s=0;s<p.length;s++){var m=p[s];var r=c.getTopicById(m);if(r.collapsed||r.children.length==0){continue}var e=c.getSubTopic(r);var f=a.getSelectedPart(e.id,q.structure);o+=f+",";n[m]=f;l.push(m);var k=a.getTopicContainer(r.id);k.children(".topic-children").remove();h.deleteChildrenLines(r);r.collapsed=true;t.push(r);if(w.indexOf(e.id)<0){w.push(e.id)}var d=a.getTopicDom(m),x=d.children(".expand_box");x.html("&#xe647;").addClass("hide")}}if(t.length==0){return}g.model.topicList.resetTopicList.call(g);if(o.indexOf("right")>=0){g.range.resetSubTopics.call(g,"right")}if(o.indexOf("left")>=0){g.range.resetSubTopics.call(g,"left")}if(u){h.resetLines.call(g,[b.id],null,o)}else{h.resetLines.call(g,l,null,o)}h.resetLines.call(g,w,null,o);g.renderFreeSummaries(o);g.renderFreeBoundaries(o);if(v==null){g.messageSource.send.call(g,"hideTopics",{ids:l,parts:n,withChildren:u})}g.connection.deleteConnectionByTopics.call(g,t,false);g.connection.resetAllConnectionPos.call(g,q)}},showTopics:function(p,u,v){var h=this,a=h.util,c=h.model,k=h.line,q=h.currentRoot||c.topic;var o="",t=[],n={},l=[],w=[],g={};if(p.length>0){if(u){for(var s=0;s<p.length;s++){var m=p[s];var r=c.getTopicById(m);if(!r.collapsed){continue}delete r.collapsed;l.push(m);t.push(r)}if(t.length==0){return}var e=t[0];if(e.parent!=q.id){e=c.getSubTopic(e)}var f=g[e.id]||a.getSelectedPart(e.id,q.structure);o+=f+",";n[m]=f;for(var s=0;s<t.length;s++){var b=t[s];n[b.id]=f}if(w.indexOf(e.id)<0){w.push(e.id)}if(!g[e.id]){g[e.id]=f}h.renderSubTopic(e,null,f)}else{for(var s=0;s<p.length;s++){var m=p[s];var r=c.getTopicById(m);if(!r.collapsed){continue}var e=c.getSubTopic(r);delete r.collapsed;var f=g[e.id]||a.getSelectedPart(e.id,q.structure);o+=f+",";n[m]=f;l.push(m);t.push(r);if(w.indexOf(e.id)<0){w.push(e.id)}if(!g[e.id]){g[e.id]=f}h.renderSubTopic(e,null,f);var d=a.getTopicDom(m),x=d.children(".expand_box");x.html("&#xe7bb;").removeClass("hide")}}if(t.length==0){return}h.model.topicList.resetTopicList.call(h);if(o.indexOf("right")>=0){h.range.resetSubTopics.call(h,"right")}if(o.indexOf("left")>=0){h.range.resetSubTopics.call(h,"left")}k.resetLines.call(h,w,null,o);h.renderFreeSummaries(o);h.renderFreeBoundaries(o);if(v==null){h.messageSource.send.call(h,"showTopics",{ids:l,parts:n,withChildren:u})}h.connection.resetAllConnectionPos.call(h,q);h.connection.showConnectionMulti(h,t)}h.events.push("outline-prebuild",{topics:t,rebuild:"current"})},copyToClipBoard:function(){var e=this,a=e.util,c=e.model;var d=a.getSelectedId(),b=c.getTopicById(d);if(d!=""){var f=document.createElement("input");f.setAttribute("value","__mindmap__topic"+b.title);document.body.appendChild(f);f.select();document.execCommand("copy",false);document.body.removeChild(f)}},nodePasteListener:null,poPasteType:"node",domPasteListener:{},registerNodePaste:function(g){var d=this,a=d.model,f=a.domPasteListener;if(!g||g.length==0){return}var c=[];g.forEach(function(k,h){c.push(k.getAttribute("id"))});var e=g[g.length-1],b=e.getAttribute("id");if(f[b]){e.removeEventListener("paste",f[b]);f[b]=null}f[b]=function(h){a.execPaste.call(d,h,b);if(a.poPasteType!="editpaste"){e.blur()}if(!d.util.isIE()||a.poPasteType!="editpaste"){h.preventDefault()}h.stopPropagation()};setTimeout(function(){if(document.activeElement.getAttribute("id")==null){d.operation.editTopicDomInit.call(d,b)}if(e.addEventListener){e.addEventListener("paste",f[b])}else{if(element.attachEvent){e.attachEvent("onpaste",f[b])}else{e.onpaste=f[b]}}},100)},execPaste:function(k,b){var i=this,h=i.operation,g=i.util,f=i.model,m=f.poPasteType;if(!b){return}var c=k.clipboardData||window.clipboardData;if(c){var a=$(c.getData("text/html"))[1];d(c)}i.util.isPaste=true;function d(u){if(g.isIE()){var p=u.getData("text");if(p!=null&&p!=""){l(p,a)}return false}var t=u.items,s=u.types||[],o;for(var r=0;r<s.length;r++){if(s[r]==="Files"){o=t[r];break}}if(o&&o.kind==="file"&&o.type.match(/^image\//i)&&t.length!=4){var q=o.getAsFile(),e=new FileReader();e.readAsDataURL(q);e.onload=function(w){var v=e.result;h.uploadImage(v,null,function(y){if(y.result=="notmember"){i.events.push("vip-limit","pasteimg");return}if(y.result=="error"){$.showTip("close");$.showTip("粘贴截图出错了，请稍后再试",3000);return}var x=new Image();x.src=y.img_url;i.events.push("showuploading");x.onload=function(){h.setTopicImage.call(i,b,y.img_url,x);x.remove()}})};k.stopPropagation();return false}else{i.util.isPaste=true;for(var r=0;r<s.length;r++){if(s[r]=="text/plain"){o=t[r];break}}if(g.isChrome()||g.isFirefox()){o.getAsString(function(v){if(m=="editpaste"){v=v.replace("__mindmap__topic","");n(v);return}if(v.indexOf("__mindmap__topic")!=-1){i.model.doPaste.call(i,b);return}i.model.pasteStringToNodes.call(i,v,a,b)})}else{if(g.isSafari()||g.isIE()){var p=u.getData("text/plain");if(p!=null&&p!=""){l(p,a);return false}}}k.preventDefault();return false}}function l(o,e){if(m=="editpaste"){o=o.replace("__mindmap__topic","");n(o);return}if(o.indexOf("__mindmap__topic")!=-1){i.model.doPaste.call(i,b);return}i.model.pasteStringToNodes.call(i,o,e,b)}function n(p){if(a&&a.className=="mind-clipboard"){$(a).find(".equation-text").removeAttr("contenteditable");p=a.innerHTML}else{p=p.replace(/</g,"&lt;");p=p.replace(/>/g,"&gt;");p=p.replace(/\n/g,"<br>");p=p.replace(/\u2029/g,"<br>").replace(/\u2028/g,"<br>");p=p.replace(/\x0a/g,"<br>").replace(/\x0d/g,"")}var o=window.getSelection();var e=o.getRangeAt(0);if(document.queryCommandSupported("insertHTML")){document.execCommand("insertHTML",false,p)}else{if(e.pasteHTML){e.pasteHTML(p)}}if($(a).find(".equation-text").length>0){setTimeout(function(){$("#"+b).find(".equation-text").each(function(q,r){$(r).attr("data-index",q).html("<span></span><span>&#65279;</span>").attr("contenteditable",false)});i.operation.renderEquation($("#"+b))},10)}}},pasteStringToNodes:function(n,b,i,f){var m=this,k=m.util,h=m.model,o=m.currentRoot||h.topic,g=h.clipboard;if(b&&b.className=="mind-clipboard"){n=b.innerHTML;var d=true}var a=h.stringToNodes.call(m,n,d,i,f);if(h.copying){return}h.copying=true;var l={},e={},p=h.getTopicById(i);var c=k.getSelectedPart(i,o.structure);a.forEach(function(r,q){l[r.id]=p.children.length+q;e[r.id]=c});h.addTopicMulti.call(m,a,null,l,e);h.copying=false;if(!f&&(n.indexOf("<br>")>0||n.indexOf("\n")>0||n.indexOf("\x0a")>-1||n.indexOf("\x0d")>-1)&&a.length==1){h.switchMultTopicTip.call(m,i,a,d)}},switchMultTopicTip:function(i,a,d){var k=this,h=k.model,b=a[0].id;var m=$("#switch-mult-topic"),l=$("#"+b);k.util.selectOne.call(k,a[0]);if(m.length==0){m=$('<div id="switch-mult-topic" class="menu" style="position: absolute;display: none;"><div id="splitTopic-btn">分割成主题</div></div>').appendTo(l)}else{m.appendTo(l)}var c=l.outerWidth(),f=m.outerWidth(),g=l.offset().left,e=(c-f)/2;if(g+c>$(document).outerWidth()){e=2}m.css({left:e,bottom:"-55px"}).show();$("#splitTopic-btn").off("mousedown").on("mousedown",function(n){n.stopPropagation();h.switchMultTopic.call(k,i,a,d);$("#switch-mult-topic").remove()})},switchMultTopic:function(g,a,d){var k=this,f=k.model,h=k.util,o=k.currentRoot||f.topic;var e=k.util.copyArray(a);var c=f.stringToNodes.call(k,e[0].title,d,g,true);var i={},n={},q=f.getTopicById(g),l={};var b=h.getSelectedPart(g,o.structure);a.forEach(function(s,r){l[s.id]=b});c.forEach(function(s,r){i[s.id]=q.children.length+r;n[s.id]=b});var p=e[0].id,m={};m[p]=c;f.removeAndAdd.call(k,h.copyArray(a),m,l,n)},stringToNodes:function(h,d,c,g){var f=this;if(!d){h=h.replace("__mindmap__topic","");h=h.replace(/\n/g,"<br>");h=h.replace(/\u2029/g,"<br>").replace(/\u2028/g,"<br>");h=h.replace(/\x0a/g,"<br>").replace(/\x0d/g,"");h=h.replace(/[\x0d-\x1f]+/g," ")}var b=[];if(g){h=h.replace(/&lt;/g,"<");h=h.replace(/&gt;/g,">");b=h.split("<br>")}else{b.push(h)}var a=[];b.forEach(function(n,m){var k=f.model.newId();if(!n){return true}var o=e(n);var l={id:k,children:[],title:o,parent:c};a.push(l)});function e(i){if(!d){i=i.replace(/<br>/g,"\n");i=i.replace(/</g,"&lt;");i=i.replace(/>/g,"&gt;")}return i}return a},copying:false,doCopy:function(a){var h=this,g=h.util,f=h.model,l=h.currentRoot||f.topic,d=f.clipboard;if(f.copying){return}f.copying=true;var k=g.getAvailableSelectedIds(h,l,a);d.list=[];d.type="copy";for(var e=0;e<k.length;e++){var c=k[e];if(c==l.id){continue}var m=f.getTopicById(c);var b=$.extend(true,{},m);d.list.push(b)}if(typeof chartId!="undefined"){g.removeOtherDef([chartId])}$(".topic-box.cut_related").removeClass("cut_related");if(d.list.length>0){f.copyToClipBoard.call(h,a);window.localStorage.setItem("clipboard_mind",JSON.stringify(d))}f.copying=false},doCut:function(a){var l=this,h=l.util,g=l.model,n=l.currentRoot||g.topic,f=g.clipboard;if(g.copying){return}g.copying=true;var m=h.getAvailableSelectedIds(l,n,a);f.list=[];f.type="cut";var k=[];for(var e=0;e<m.length;e++){var d=m[e];if(d==n.id){continue}var o=g.getTopicById(d);var c=$.extend(true,{},o);if(c.summary){k.push(c)}else{f.list.push(c)}var b=h.getTopicDom(d);b.parent().find(".topic-box").addClass("cut_related")}if(typeof chartId!="undefined"){h.removeOtherDef([chartId])}if(f.list.length>0){g.copyToClipBoard.call(l,a);window.localStorage.setItem("clipboard_mind",JSON.stringify(f))}l.util.clearSelect();if(k.length>0){l.summary.model.removeSummary.call(l,k)}if(f.list.length>0){g.removeTopic.call(l,f.list,null)}g.copying=false},doPaste:function(k){var h=this,d=h.model,n=h.currentRoot||d.topic,t=d.clipboard,c=t.type,u=t.list,a=h.util;if(d.copying){return}d.copying=true;var o=d.getTopicById(k);if(o.collapsed){d.copying=false;return}if(c=="cut"){}else{var s=window.localStorage.getItem("clipboard_mind");if(s!=null){var g=JSON.parse(s).list;if(g.length>0){u=g}}}u.reverse();var m=a.getSelectedPart(o.id,n.structure);var f={},l={};var q=[];for(var p=0,r=u.length;p<r;p++){var b=u[p];var e=$.extend(true,{},b);d.resetTopicId(e,k);if(b.summary){delete e.summary;delete e.range;delete e.part}else{if(e.free){delete e.free;delete e.pos;e.parent=k}}q.push(e);f[e.id]=o.children.length;l[e.id]=m;h.operation.updateNumber.call(h,o)}d.addTopicMulti.call(h,a.copyArray(q),null,f,l);if(d.copyingTimer){clearTimeout(d.copyingTimer)}h.plugins.showTopicsLen.call(h);d.copyingTimer=setTimeout(function(){d.copying=false},300)}};mindDesigner.prototype.util={selectedIds:[],select:function(h,e){for(var c=0;c<h.length;c++){var b=h[c];if(b==null){continue}var f=this.getTopicDom(b.id);if(f.hasClass("cut_related")){continue}if(this.selectedIds.indexOf(b.id)>=0){var a=this.selectedIds.indexOf(b.id);this.selectedIds.splice(a,1);f.removeClass("selected");f.find(".topic-selected").remove()}else{this.selectedIds.push(b.id);this.renderSelectDom(f);f.addClass("selected")}}var g=$(".topic-box.selected").map(function(){return $(this).attr("id")}).get();$(".resize-boundary").remove();$(".boundary-dot").remove();this.selectedIds=g;e.events.push("changeOpStatus",e);if(h&&h.length>0){e.model.poPasteType="node";var d=document.getElementById(h[h.length-1].id);e.model.registerNodePaste.call(e,[d]);e.plugins.showTopicsLen.call(e)}},selectDirect:function(f,c){this.clearSelect();for(var b=0,a=f.length;b<a;b++){var e=f[b];this.selectedIds.push(e.id);var d=this.getTopicDom(e.id);this.renderSelectDom(d);d.addClass("selected")}c.events.push("changeOpStatus",c);c.plugins.showTopicsLen.call(c)},getTopicsLen:function(){var b=this.model.topicList.data,a=0;for(var c in b){if(!b[c].boundary){a++}}this.events.push("topicsLen",a);return a},copy:function(a){return $.extend(true,{},a)},copyArray:function(a){return $.extend(true,[],a)},selectOne:function(a){var d=a.id;var c=this.util.getTopicDom(d);if(c.length==0){var b=this.model.getTopicById(a.parent);if(b.children.length>0){b=b.children[b.children.length-1]}this.util.selectOne.call(this,b);return}if(c.hasClass("cut_related")){return}$(".topic-box.selected").removeClass("selected");$(".topic-selected").remove();this.util.renderSelectDom(c);c.addClass("selected");this.util.setSelectedId(d,"clear");this.operation.editTopicDomInit.call(this,d);this.summary.renderSummaryOp.call(this,a,c,d);this.events.push("changeOpStatus",this);this.events.push("outline-select",[d]);this.events.push("close-mind-topic-box",d);this.model.poPasteType="node";$("#switch-mult-topic").remove();this.model.registerNodePaste.call(this,[document.getElementById(d)]);$(".resize-boundary").remove();$(".boundary-dot").remove();this.plugins.showTopicsLen.call(this)},renderSelectDom:function(b){var a=b.find(".topic-selected");if(a.length==0){a=$('<div class="topic-selected"></div>').appendTo(b)}this.resetSelectDom(b)},resetSelectDom:function(b){var a=$(".topic-selected");if(b!=null){a=b.find(".topic-selected")}if(a.length==0){return}if(a.length>1){a.each(function(e){var d=$(e);c(d)})}else{c(a)}function c(d){var e=d.parent();if(e.css("border-width")!=null){e.css("border-width").replace("px","")}d.css({width:e.outerWidth()+3,height:e.outerHeight()+3})}},selectById:function(b){var a=this.model.getTopicById(b);this.util.selectOne.call(this,a);this.events.push("setDock",a)},unselect:function(a){a.removeClass("selected");$(".summary-dot").remove();$(".boundary-dot").remove();var b=a.attr("id");this.selectedIds.splice(this.selectedIds.indexOf(b),1)},clearSelect:function(){$(".topic-menu").remove();$("#textarea_topic_temp").remove();$(".topic-box.selected").removeClass("selected");$(".topic-selected").remove();$(".summary-dot").remove();$(".boundary-dot").remove();$(".topic-summary-resize").remove();$("#switch-mult-topic").remove();this.selectedIds=[];if(typeof mind!="undefined"){mind.plugins.showTopicsLen.call(mind)}},getPtLineColor:function(c){var b=this;function a(h){var f=b.style.getStyle.call(b,h);var d=f.lineStyle,e=d&&(d.lineColor||d.randomLineColor);if(e){return e}else{if(!h.root){var g=b.model.getTopicById(h.parent);return a(g)}}}return a(c)},getSelectedId:function(){return this.selectedIds.length==0?"":this.selectedIds[this.selectedIds.length-1]},setSelectedId:function(b,a){if(a=="clear"){this.selectedIds=[]}this.selectedIds.push(b)},removeOtherDef:function(e){if(e==null||e.length==0){return}return;var f=window.localStorage;for(var d=0;d<f.length;d++){var c=f.key(d);if(c.indexOf("def_")>=0||c.indexOf("version_local_")>=0){var a=c.lastIndexOf("_")+1;var b=c.substring(a);if(e.indexOf(b)<0){f.removeItem(c)}}}},getChildrenCount:function(b,c){var f=0,e=null,a=0;if(c=="left"){if(b.leftChildren==null){b.leftChildren=[]}e=b.leftChildren}else{e=b.children}var a=e.length;for(var d=0;d<a;d++){var g=e[d];if(g.free||g.summary){continue}f++}return f},setBrNode:function(d){var c=getSelection();var a=c.getRangeAt(0);var b=document.createElement("br");a.insertNode(b);a.setEndAfter(b);a.collapse(false);c.removeAllRanges();c.addRange(a)},setCursorEnd:function(c){if($.support.msie){var a=document.selection.createRange();this.last=a;a.moveToElementText(c);a.select();document.selection.empty()}else{var a=document.createRange();a.selectNodeContents(c);a.collapse(false);var b=window.getSelection();b.removeAllRanges();b.addRange(a)}},selectText:function(b){var d=document;if(d.body.createTextRange){var a=document.body.createTextRange();a.moveToElementText(b);a.select()}else{if(window.getSelection){var c=window.getSelection();var a=document.createRange();a.selectNodeContents(b);c.removeAllRanges();c.addRange(a)}}},unSelectText:function(a){var b=window.getSelection();b.removeAllRanges()},parentsIsSelected:function(h){var g=this,e=g.model,d=g.util.selectedIds;var b=false;var c=e.getParentTopicIds(h);for(var f=0,a=c.length;f<a;f++){var h=c[f];if(d.indexOf(h)>=0&&h!=e.topic.id){b=true;break}}return b},getAvailableSelectedIds:function(f,k,a){var h=[],d=this;for(var e=0,g=a.length;e<g;e++){var b=a[e];if(b==k.id){continue}var c=d.parentsIsSelected.call(f,b);if(c){continue}h.push(b)}return h},getAvailableSelected:function(g,l,b){var k=[],d=this,a=[];for(var e=0,h=b.length;e<h;e++){var f=b[e];if(f.id==l.id){continue}if(a.indexOf(f.id)>=0){continue}var c=d.parentsIsSelected.call(g,f.id);if(c&&!f.free){continue}a.push(f.id);k.push(f)}return k},getTopicContainer:function(a){return $("#"+a).parent()},getTopicContainerProp:function(d,a){var b=$("#"+d).parent(),c=b.position();if(b.length==0){return null}return{h:b.outerHeight(),w:b.outerWidth(),x:c.left/(a||1),y:c.top/(a||1)}},getSelectedPartByPos:function(e){var d=this.getTopicDom(e);if(d.length==0){return"right"}var b=mind.currentRoot||mind.model.topic;var a=b.id;var c=$("#"+a);if(d.offset().left<c.offset().left){return"left"}else{return"right"}},getSelectedPart:function(g,c){if(c!=null&&(c=="mind_org"||c=="mind_tree")){return"right"}var f=this.getTopicDom(g);if(f.hasClass("free")){return"right"}var d=f.parents(".topic-container");if(d.find(".free").length>0){return"right"}var b=mind.currentRoot||mind.model.topic;var a=b.id;var e=$("#"+a);if(f.offset().left<e.offset().left){return"left"}else{return"right"}},getTopicDom:function(a){return $("#"+a)},getTopicDomProp:function(e,b){var c=$("#"+e);if(c.length==0){return null}var a=c.parent();var d=a.position();return{h:a.outerHeight(),w:a.outerWidth(),x:d.left/b,y:d.top/b,dom:a}},getSubTopicDomProp:function(f,a,c){var d=$("#"+f);var b=d.parent();var e=b.position();if(a=="mind_org"){return{x:e.left/c+b.outerWidth()/2,y:e.top/c,w:d.outerWidth(),h:d.outerHeight()}}else{if(a=="mind_tree"){return{x:e.left/c+d.outerWidth()/2,y:e.top/c,w:d.outerWidth(),h:d.outerHeight()}}}return{h:b.outerHeight(),w:b.outerWidth(),x:e.left/c,y:e.top/c+b.outerHeight()/2}},getTopicsByRange:function(n,a){var k=$(".topic-box"),u=[],p=n.x+n.w,b=n.y+n.h,q=Math.max,o=Math.min;for(var r=0,s=k.length;r<s;r++){var l=$(k[r]),g=l.offset(),m=l.width(),t=l.height();var f=q(g.left/a,n.x),d=q(g.top/a,n.y),e=o((g.left+m)/a,p),c=o((g.top+t)/a,b);if(f<e&&d<c){u.push(l.attr("id"))}}return u},getTopicLinePos:function(a,f){var g=this,i=g.model.topic;var e=$(".topic-box[id="+i.id+"]"),h=e.position(),c=e.offset();var d=h.left-c.left;var b=h.top-c.top},getTopicRealPos:function(p,s){var i=this,d=i.model,m=i.container,l=i.operation,a=l.zoomVal/100,b=i.util;var r=$("#"+p),h=r.position(),f=h.left,o=h.top;if(r.attr("sub")){var k=r.parent(),e=k.position(),n=e.left,q=e.top;if(s=="mind_org"){return{x:n+r.outerWidth()/2,y:(q+o)/a,w:r.outerWidth(),h:r.outerHeight()}}return{x:(n+f)/a,y:(q+o)/a+r.outerHeight()/2,w:r.outerWidth(),h:r.outerHeight()}}else{var c=d.getTopicById(p);var g=d.getSubTopic(c);var k=$("#"+g.id).parent(),e=k.position(),n=e.left,q=e.top;if(s=="mind_org"){return{x:(f+n)/a+r.outerWidth()/2,y:(o+q)/a,w:r.outerWidth(),h:r.outerHeight()}}return{x:(f+n)/a,y:(q+o)/a+r.outerHeight()/2,w:r.outerWidth(),h:r.outerHeight()}}},getRealPos:function(h,g){var f=this,a=f.container,d=f.operation,i=d.zoomVal/100;var b=a.scrollLeft();var c=a.scrollTop();if(i==1){return{x:b+h,y:c+g}}var e=f.designer.offset();return{x:Math.abs(e.left)/i+h/i,y:Math.abs(e.top)/i+g/i}},getChildTopicRelativePos:function(f,a){var d=$(".topic-box[id="+f+"]"),e=d.position(),c=e.left,b=e.top;return{x:c/a,y:Math.floor(b/a+d.outerHeight()/2),w:d.outerWidth(),h:d.outerHeight()}},getTreeChildTopicRelativePos:function(f,a){var d=$(".topic-box[id="+f+"]"),e=d.position(),c=e.left,b=e.top;return{x:c/a,y:b/a+d.outerHeight(),w:d.outerWidth(),h:d.outerHeight()}},getOrgChildTopicRelativePos:function(f,a){var d=$(".topic-box[id="+f+"]"),e=d.position(),c=e.left,b=e.top;return{x:c/a+d.outerWidth()/2,y:b/a,w:d.outerWidth(),h:d.outerHeight()}},getSubTopicRelativePos:function(d,a){var c=$(".topic-box[id="+d+"]"),b=c.parent().outerHeight()/2-0.5;if(a=="mind_org"){return{x:c.parent().outerWidth()/2-0.5,y:c.outerHeight(),w:c.outerWidth(),h:c.outerHeight()}}else{if(a=="mind_tree"){return{x:0,y:c.outerHeight(),w:c.outerWidth(),h:c.outerHeight()}}}return{x:0,y:b,w:c.outerWidth(),h:c.outerHeight()}},getAngle:function(c,b){var a=Math.atan(Math.abs(b.y-c.y)/Math.abs(b.x-c.x))/Math.PI*180;if(c.x<=b.x&&c.y>b.y){a=180-a}else{if(c.x<b.x&&c.y<=b.y){a=180+a}else{if(c.x>=b.x&&c.y<b.y){a=360-a}}}return a},getArrowPoints:function(d,f,i){var b=30,a=i<3?10:i<5?15:20;var k=360-d+b;var l=Math.sin(Math.PI*k/180)*a;var m=Math.cos(Math.PI*k/180)*a;var h=f.x+m,g=f.y-l;k=360-d-b;l=Math.sin(Math.PI*k/180)*a;m=Math.cos(Math.PI*k/180)*a;var e=f.x+m,c=f.y-l;return{x1:h,y1:g,x2:e,y2:c}},calcDistance:function(d,b){var a=b.x-d.x;var c=b.y-d.y;return Math.sqrt(Math.pow(a,2)+Math.pow(c,2))},calcX:function(f,e,a){var c=a.y-e.y;var d=a.x-e.x;if(d==0){return null}var b=Math.abs(c/d);if(a.x<e.x&&a.y<e.y){b=-b}else{if(a.x>e.x&&a.y>e.y){b=-b}else{if(a.x>e.x&&a.y<e.y){b=Math.abs(c/d)}}}return f/b},calcY:function(a,f,b){var d=b.y-f.y;var e=b.x-f.x;if(e==0){return null}var c=d/e;var c=Math.abs(d/e);if(b.x<f.x&&b.y<f.y){c=-c}else{if(b.x>f.x&&b.y>f.y){c=-c}}return c*a},isUrl:function(b){var a=new RegExp("(http|ftp|https)://[a-z0-9-_]+(.[a-z0-9-_]+)+([a-z0-9-.,@?^=%&;:/~+#]*[a-z0-9-@?^=%&;/~+#])?","i");if(a.test(b)){return true}return false},isHexColor:function(a){return/(^[0-9A-F]{6}$)|(^#[0-9A-F]{3}$)/i.test(a)},htmlEncode:function(a){if(a.length==0){return""}a=a.replace(/</g,"&lt;");a=a.replace(/>/g,"&gt;");a=a.replace(/\'/g,"&#39;");a=a.replace(/\"/g,"&quot;");return a},htmlDecode:function(a){if(a.length==0){return""}a=a.replace(/&lt;/g,"<");a=a.replace(/&gt;/g,">");a=a.replace(/&#39;/g,"'");a=a.replace(/&quot;/g,'"');return a},getHexColor:function(c){var a={};if(c.indexOf("rgba(0")<0&&c!="transparent"){var b=c.substring(4,c.length-1);a.rgb=b;c=c.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/);function d(e){return("0"+parseInt(e).toString(16)).slice(-2)}c=d(c[1])+d(c[2])+d(c[3]);a.hex=c;return a}else{return null}},getRgbFromHex:function(b){if(b.indexOf("rgb")>=0){return b}var a=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(b);return a?{r:parseInt(a[1],16),g:parseInt(a[2],16),b:parseInt(a[3],16)}:null},getNewDef:function(A,l){if(A.root&&A.theme){}var p=false,o=false,n=false,m=false;if(A.structure.indexOf("mind_")<0){p=true}var g,x;if(A.structure=="mind"&&(A.root==null||A.classic)){A.leftChildren=[],g=A.children,x=g.length-1;var k=Math.floor(x/2),w=[];for(var v=k;v<x;v++){var d=g[v];w.push(d)}g.splice(k,x-k);A.leftChildren=A.leftChildren.concat(w);A.structure="mind_free"}if(A.classic){var B=A.classic;if(B.indexOf("defaultClassic")>=0){B="theme3"}delete A.classic;A.theme=B}if(A.root==null){A.root=true}if($.isEmptyObject(A.lines)){delete A.lines}else{var b=A.lines;for(var s in b){var q=A.lines[s];var h=q.start,f=q.end;if((h.p||f.p)&&q.canvasPos!=null){for(var v=0;v<q.points.length;v++){var t=q.points[v];if(t.x>2000){q.points=[];o=true;break}}if(h.p=="bottom"){h={x:0.5,y:1}}else{if(h.p=="top"){h={x:0.5,y:0}}else{if(h.p=="left"){h={x:0,y:0.5}}else{if(h.p=="right"){h={x:1,y:0.5}}}}}if(f.p=="bottom"){f={x:0.5,y:1}}else{if(f.p=="top"){f={x:0.5,y:0}}else{if(f.p=="left"){f={x:0,y:0.5}}else{if(f.p=="right"){f={x:1,y:0.5}}}}}if(h.x==null){h.x=0;h.y=0}if(f.x==null){f.x=0;f.y=0}if(h.x>2000){h.x=1}if(f.x>2000){f.x=1}if(h.y>2000){h.y=1}if(f.y>2000){f.y=1}}if(q.canvasPos&&q.start.p){var a=q.canvasPos;if(q.points!=null&&q.points.length>0){if(q.points[0].x!=null&&q.points[0].y!=null){q.points[0].x+=a.x;q.points[0].y+=a.y}if(q.points[0].x!=null&&q.points[0].y!=null){q.points[1].x+=a.x;q.points[1].y+=a.y}}if(Math.abs(q.start.x)>1||Math.abs(q.start.y)>1){q.realStart={};q.realStart.x=q.canvasPos.x+h.x;q.realStart.y=q.canvasPos.y+h.y;q.start.x=q.start.x/q.canvasPos.w;q.start.y=q.start.y/q.canvasPos.h}if(Math.abs(q.end.x)>1||Math.abs(q.end.y)>1){q.realEnd={};q.realEnd.x=q.canvasPos.x+f.x;q.realEnd.y=q.canvasPos.y+f.y;q.end.x=q.end.x/q.canvasPos.w;q.end.y=q.end.y/q.canvasPos.h}delete q.canvasPos}}}if(A.background==""||A.background==null){delete A.background}else{if(A.background.indexOf("niupizhi.png")>0){delete A.background}}y(A);c(A);function u(C,i){if(C.summaries!=null&&C.summaries.length>0){for(var e=0;e<C.summaries.length;e++){var E=C.summaries[e];var D=E.range+"";if(E.range!=null&&D.indexOf(",")<0){var F=$.extend(true,{},E);E.range=0+","+0;if(i){F.part="right"}n=true}c(E)}}}function c(G){if(G.free){u(G)}if(G.summaries!=null&&G.root){u(G,true)}var D=G.children;for(var F=0;F<D.length;F++){var C=D[F],M=false;if(C.parent=="root"){M=true}if(C.summaries!=null&&C.summaries.length>0){for(var E=0;E<C.summaries.length;E++){var I=C.summaries[E];var L=I.range+"";if(I.range!=null&&L.indexOf(",")<0){var H=$.extend(true,{},I);if(!C.free){H.parent=G.id;H.range=F+","+F}else{var J=I.children.length;I.range=0+","+(J-1)<0?0:(J-1);if(C.children.length==0){I.range=0+","+0;var K={id:l.model.newId(),parent:C.id,children:[],title:""};C.children.push(K)}}if(M){H.part="right"}n=true;if(!C.free){C.summaries.splice(E,1);if(G.summaries==null){G.summaries=[]}G.summaries.splice(0,0,H)}}c(I)}}c(C)}var e=G.leftChildren||[];if(e.length>0){for(var F=0;F<e.length;F++){var C=e[F],M=false;if(C.parent=="root"){M=true}if(C.summaries!=null&&C.summaries.length>0){for(var E=0;E<C.summaries.length;E++){var I=C.summaries[E];var L=I.range+"";if(I.range!=null&&L.indexOf(",")<0){var H=$.extend(true,{},I);H.parent=G.id;H.range=F+","+F;if(M){H.part="left"}n=true;C.summaries.splice(E,1);if(G.summaries==null){G.summaries=[]}G.summaries.unshift(H)}c(I)}}c(C)}}}function y(M){if(M.tag!=null){var K=M.tag;var L=[];var N={text:K,color:"#276F86",background:"#d6f0f8"};L.push(N);M.tags=L;delete M.tag}if(M.task!=null){if(M.task.start==""){delete M.task.start}if(M.task.end==""){delete M.task.end}}if(M.link!=null){if(M.link.value==""){delete M.link}}if(M.icons!=null){var e=l.icons.icons;if(e!=null){for(var F=0,H=M.icons.length;F<H;F++){var I=M.icons[F];if(I==null){continue}var J=e[I.name];if(J==null){continue}for(var E=0;E<J.length;E++){var G=J[I.index];if(G==null){G=J[J.length-1];I.text=G.text;break}else{if(G.index==I.index){I.text=G.text;break}}}}}}var D=M.children,H=D.length;for(var F=0;F<H;F++){var C=D[F];y(C)}}try{r(A)}catch(z){console.log("error="+z)}function r(G){if(!G){return}var e=G.boundaries||[];var H=G.children,L=G.leftChildren||[],C=H.concat(L);if(C.length==0){if(e.length>0){m=true;G.boundaries=[]}return}var K=[],D=false;for(var F=0;F<e.length;F++){var O=e[F],N=e[F].range,J=N.split(",")[0],I=N.split(",")[1];if(J<0){J=0;D=true}if(I>C.length-1){I=C.length-1;D=true}if(J>I){J=I}O.range=J+","+I;K.push(O)}if(D){G.boundaries=K;m=true}for(var E=0;E<C.length;E++){var M=C[E];r(M)}}if(p||o||n||m){$.ajax({url:"/mindmap/updatedef",type:"post",data:{id:l.opts.chartId,def:JSON.stringify(A),ignore:"def"},success:function(e){},error:function(){}})}return A},isChrome:function(){return navigator.userAgent.toLowerCase().indexOf("chrome")>=0},isFirefox:function(){return navigator.userAgent.toLowerCase().indexOf("firefox")>=0},isSafari:function(){var a=navigator.userAgent.toLowerCase();return a.indexOf("safari")!==-1&&a.indexOf("chrome")===-1},isIE:function(){return navigator.userAgent.toLowerCase().indexOf("trident")>=0},tipCount:function(){var b=window.localStorage;var c=b.getItem("tip_count");if(c==null){localStorage.setItem("tip_count",1);return true}else{var a=parseInt(c);if(a>20){return false}localStorage.setItem("tip_count",a+1);return true}},extend:function(h,f){if(!h||!f){return{}}var c={};for(var d in h){c[d]=h[d]}for(var g in f){if(c[g]){var b=c[g],a=f[g],e=b.concat(a);c[g]=e}else{c[g]=f[g]}}return c},getMargin:function(){var b=this;var a=b.model,c=a.topic.margin||{};return{marginH:c.marginH==null?b.styles.marginH:c.marginH,marginW:c.marginW==null?b.styles.marginW:c.marginW,childMarginH:c.childMarginH==null?b.styles.childMarginH:c.childMarginH,childMarginW:c.childMarginW==null?b.styles.childMarginW:c.childMarginW}},convert:function(e,h){function c(l,a){var i="";if(a>26){i=String.fromCharCode(l+parseInt(a%26==0?(a/26-1):a/26))+String.fromCharCode(l+parseInt(a%26==0?26:a%26))}else{i=String.fromCharCode(l+parseInt(a))}return i}switch(h){case"2":if(isNaN(e)){return e}var d=[["","I","II","III","IV","V","VI","VII","VIII","IX"],["","X","XX","XXX","XL","L","LX","LXX","LXXX","XC"],["","C","CC","CCC","CD","D","DC","DCC","DCCC","CM"],["","M","MM","MMM"]];var k="";var g=0;for(var b=0,f=10000;b<4;b++,f/=10){g=Math.floor((e%f)/(f/10));k+=d[3-b][g]}return k;break;case"3":return c(96,e);break;case"4":return c(64,e);break;default:return e}},delUndefinedTopic:function(f){var d=this,a=d.util,b=d.model;if(f){if(f.constructor==Array){var e=[];for(var c=0;c<f.length;c++){var g=f[c];if(b.getTopicById(g.id)==null){continue}else{e.push(g)}}return e}else{if(f.constructor==Object){if(b.getTopicById(f.id)==null){f=null}return f}else{if(f.constructor==String){if(b.getTopicById(f)==null){f=null}return f}}}}else{return f}}};mindDesigner.prototype.tags={setTags:function(l){var g=this,f=g.util,d=g.model,a=f.getSelectedId();if(g.opts.readonly){return}if(a==null||$.trim(a)==""||$.trim(l.text)==""){return}var i=$.trim(l.text),e=d.getTopicById(a),h=e.tags;if(h==null){e.tags=[]}var c=false;for(var k in h){if(k.text==i){c=true;break}}if(c){return}var b=f.copy(e);e.tags.push(l);d.updateTopicNode.call(g,e,b,"tag")},renderTagColors:function(h){var d={background:"#d6f0f8",color:"#276F86"};var g=[];var b=h.style.baseColor();for(var f=0,a=b.length;f<a;f++){var e=b[f];var k="#fff;";if(e=="#f4f4f4"){k="#333"}g.push("<span style='background:"+e+";color:"+k+"'></span>")}g.push("<span style='background:"+d.background+";color:"+d.color+";'></span>");return g.join("")},renderTopicTag:function(f,e,a){if(e.tags&&!$.isEmptyObject(e.tags)){var b=f.getTopicDom(e.id);var h=b.children(".topic-tags");if(h.length){if(h.children().length>0){h.children().remove()}}else{h=$("<div class='topic-tags'></div>");b.append(h)}var m=e.tags,d="";for(var c=0,g=m.length;c<g;c++){var l=m[c];if(l==null){continue}d+="<span class='topic-tag' style='background:"+l.background+";color:"+l.color+"'>"+l.text+"</span>"}h.html(d)}else{var b=f.getTopicDom(e.id);var k=b.children(".topic-tags");if(k.length){k.remove()}}},removeTag:function(l){var h=this,f=h.util,d=h.model,a=f.getSelectedId();if(a==null||$.trim(a)==""){return}var e=d.getTopicById(a),b=f.copy(e),k=e.tags;var g=0;for(var c=0;c<k.length;c++){var m=k[c];if(m.text==l){g=c;break}}k.splice(g,1);d.updateTopicNode.call(h,e,b,"tag")},setTagColor:function(d,n){var l=this,h=l.util,f=l.model,a=h.getSelectedId();if(a==null||$.trim(a)==""){return}var g=f.getTopicById(a),c=h.copy(g),m=g.tags||[];if(m.length==0){g.tags=[];g.tags.push({background:d.background,color:d.color,text:n})}else{for(var e=0,k=m.length;e<k;e++){var b=m[e];if(b.text==n){b.background=d.background;b.color=d.color;break}}}f.updateTopicNode.call(l,g,c,"tag")},checkExists:function(e,h,g){var b=e.model.getTopicById(h);var a=b.tags,f=true;if(a!=null&&a.length>0){for(var d=0;d<a.length;d++){var c=a[d];if(c.text==g){f=false;break}}}return f},selectTag:function(a){$(".mind-tags-curr").find(".active").removeClass("active");$(".mind-tags-curr").find(".tags").each(function(b,d){var c=$(d);if(c.children().eq(0).text()==a){c.addClass("active")}})},showTag:function(a,k){var l=this,h=l.util,g=l.model,b=k||h.getSelectedId(),i=l.operation,c=l.tags;if(b==null||$.trim(b)==""){return}if(l.opts.readonly){return}var d=h.getTopicDom(b);var f=$("#mind-tags-box");if(f.length==0){f=$("<div id='mind-tags-box' class='mind-topic-box'><div class='mind-tags-curr'><div>当前标签</div><div></div></div><div class='mind-tags-color'><div>标签颜色</div><div class='mt10'></div></div><div class='mind-tags-default'><div>可添加标签</div><div class='mt10'></div></div><div class='mind-tags-input'><input id='mind-topic-tag' type='text' placeholder='输入文本，回车新建标签'/></div></div>").appendTo(l.designer)}e(f);c.renderTags(l,b);$.fn.showPanel({target:d,panel:f});f.find("input").focus();if(a!=null){c.selectTag(a)}function e(t){var o=t.children(".mind-tags-color");var q=t.children(".mind-tags-default");var x=t.children(".mind-tags-input");var s={background:"#d6f0f8",color:"#276F86"};var u=[];var m=mind.style.baseColor();for(var r=0,v=m.length;r<v;r++){var p=m[r];var w="#fff;";if(p=="#f4f4f4"){w="#333"}u.push("<span style='background:"+p+";color:"+w+"'></span>")}u.push("<span style='background:"+s.background+";color:"+s.color+";'></span>");o.children().eq(1).html(u.join(""));if(q.children().eq(1).children().length==0){var n='<span class="tags" style="background:#7a00f2;">待定</span><span class="tags" style="background:#50c28b;">已确认</span><span class="tags" style="background:#6d6d6d;">已完成</span><span class="tags" style="background:#c4c4c4;">已关闭</span><span class="tags" style="background:#2760f2;">进行中</span>';q.children().eq(1).html(n)}}},renderTags:function(f,a){var k=$("#mind-tags-box");var g=k.children(".mind-tags-curr");var e=f.model.getTopicById(a);var k=e.tags;if(k!=null&&k.length>0){var d=[];for(var c=0;c<k.length;c++){var h=k[c];var b="";if(c==0){b=" active"}d.push("<span class='tags"+b+"' style='background:"+h.background+";color:"+h.color+";'><span class='mind-tags-text'>"+h.text+"</span><span class='mind-icons'>&#xe622;</span></span>")}g.children().eq(1).html(d.join(""))}else{g.children().eq(1).html("<span style='font-size:12px;color:#aaa;'>还没有标签，请在下方输入后回车新建</span>")}this.renderRecentTags();this.initTagsEvent(f,a)},renderRecentTags:function(){var a=localStorage.getItem("recentTags");if(a!=null&&a!=""){var d=JSON.parse(a),c="";for(var b=0;b<d.length;b++){c+='<span class="tags" style="background:#d6f0f8;color:#276F86;"><label>'+d[b]+'</label><i class="mind-icons">&#xe622;</i></span>'}$("#mind-tags-recent").html(c)}else{$("#mind-tags-recent").html("")}},initTagsEvent:function(d,f){var a=this;$(document).off("click.tags").on("click.tags",".mind-tags-default .tags",function(l){var k=$(".mind-tags-curr");if(k.find(".tags").length>4){$.showTip("单个主题最多支持5个标签",2000);return}var h=$("#mind-tags-box");var n=$(this),m=n.children("label").length>0?n.children("label").text():n.text();var i=a.checkExists(d,f,m);if(!i){return}var g={text:m,background:n.css("background-color"),color:n.css("color")};a.setTags.call(d,g);a.renderTags(d,f);a.selectTag(m);l.stopPropagation()});$("#mind-topic-tag").off("blur").on("blur",function(g){var h=$(this).val();h=d.util.htmlEncode(h);if($.trim(h)!=""){b($.trim(h))}});$("#mind-topic-tag").off("keyup").on("keyup",function(g){if(g.keyCode==13){var h=$(this).val();h=d.util.htmlEncode(h);if($.trim(h)!=""){b($.trim(h))}}});$("#mind-tags-box").children(".mind-tags-curr").find(".tags").off("click").on("click",function(h){var g=$(this);g.addClass("active").siblings().removeClass("active")});$("#mind-tags-box").children(".mind-tags-curr").find(".mind-icons").off("click").on("click",function(i){var h=$(this),g=h.parent();h.remove();var k=$.trim(g.text());g.remove();a.removeTag.call(d,k);a.renderTags(d,f);i.stopPropagation()});$("#mind-tags-recent").find(".mind-icons").off("click").on("click",function(i){var h=$(this),g=h.parent();var k=g.children("label").text();c(k);g.remove();i.stopPropagation()});$("#mind-tags-box").children(".mind-tags-color").find("span").off("click").on("click",function(k){var m=$(this),l=m.text();var i=$(".mind-tags-curr").find(".tags.active");if(i.length==0){d.events.push("tagTip");return}var g=i.find(".mind-tags-text").text();var h={background:m.css("background-color"),color:m.css("color")};a.setTagColor.call(d,h,g);i.css(h);k.stopPropagation()});function e(i){var g=localStorage.getItem("recentTags");if(g!=null){var h=JSON.parse(g);if(h.indexOf(i)<0){if(h.length>5){h.splice(0,1)}h.push(i);localStorage.setItem("recentTags",JSON.stringify(h));a.renderRecentTags()}}else{localStorage.setItem("recentTags","[]");e(i)}}function c(k){var h=localStorage.getItem("recentTags");if(h!=null){var i=JSON.parse(h);if(i.indexOf(k)>=0){var g=i.indexOf(k);i.splice(g,1);localStorage.setItem("recentTags",JSON.stringify(i))}}}function b(m){var k=$(".mind-tags-curr");if(k.find(".tags").length>4){$.showTip("单个主题最多支持5个标签",2000);return}var g=$("#mind-topic-tags");m=d.util.htmlEncode(m);if(m.length>20){m=m.substring(0,20)}var i=a.checkExists(d,f,m);if(!i){return}e(m);var h={color:"#276F86",background:"#d6f0f8"};var l={text:m,color:h.color,background:h.background};a.setTags.call(d,l);a.renderTags(d,f);$("#mind-topic-tag").val("");a.selectTag(m)}},resetPanel:function(a,c){var b=a.util.getTopicDom(c);$.fn.showPanel({target:b,panel:$("#mind-tags-box")})}};mindDesigner.prototype.remark={setRemark:function(g,e){var f=this,b=f.util,d=f.model,h=e||b.getSelectedId();if(f.opts.readonly){return}if(h==null||$.trim(h)==""){return}var c=d.getTopicById(h);if(c.note==null&&g==""){return}if(g!=c.note){var a=b.copy(c);c.note=g;d.updateTopicNode.call(f,c,a,"note")}},renderTopicNote:function(a,c,b){var e=this;if(c.note){var f=a.getTopicDom(c.id);if(f.children(".topic-note").length>0){f.children(".topic-note").remove()}var d=$("<span class='topic-note mind-icons'>&#xe6a6;</span>");f.children(".topic").after(d);if(b=="right"||b==null){d.addClass("right")}else{if(b=="left"){d.addClass("left")}}d.off("mouseenter.remark").on("mouseenter.remark",function(h){var g=$(this);e.renderViewBox(c,g,a)});d.off("click.remark").on("click.remark",function(g){mind.events.push("showRightMenu","remark");g.stopPropagation()});d.off("mousedown.remark").on("mousedown.remark",function(g){g.stopPropagation()})}else{var f=a.getTopicDom(c.id);if(f.children(".topic-note").length>0){f.children(".topic-note").remove()}}},renderViewBox:function(b,f,a){var e=$("#note_view_box");if(e.length){e.remove()}var d=new showdown.Converter({simpleLineBreaks:true,tables:true,tasklists:true});var g=a.htmlDecode(b.note);var c=d.makeHtml(g).replace(/<(\/)?script([^>]+)?>/g,"&lt;$1script$2&gt;");e=$("<div id='note_view_box'>"+c+"</div>").appendTo("body");e.dropdown({target:f,position:"center"});e.off("mouseup.remark").on("mouseup.remark",function(h){h.stopPropagation()})}};mindDesigner.prototype.task={showTask:function(n){var o=this,l=o.util,k=o.model,b=n||l.getSelectedId(),m=o.operation,e=o.task;if(b==null||$.trim(b)==""){return}if(o.opts.readonly){return}var g=l.getTopicDom(b);var i=k.getTopicById(b);var c=$("#mind-task");var h=$("#mind-task-box");if(h.length==0){h=$("<div id='mind-task-box' class='mind-topic-box'><h3>任务<a id='remove-task' style='cursor:pointer;font-size:13px;font-size: 13px;font-weight: normal;float: right;text-decoration: underline;'>删除</a></h3></div>").appendTo(o.designer);h.append(c)}$.fn.showPanel({target:g,panel:h});if(i.task!=null){var a=$("#mind-icons-priority-list"),r=$("#mind-icons-completion-list");var f=a.find("li[priority="+i.task.priority+"]").clone(),q=r.find("li[completion="+i.task.completion+"]").clone();f.find("span").remove();q.find("span").remove();var p=f.text();var d=q.text();if(p!=""){$("#mind-task-priority").children("span").text(p)}else{$("#mind-task-priority").children("span").text("无")}if(d!=""){$("#mind-task-completion").children("span").text(d)}else{$("#mind-task-completion").children("span").text("无")}q.remove();f.remove();$("#mind-task-start").find("span").text(i.task.start||"无");$("#mind-task-end").find("span").text(i.task.end||"无");$("#mind-task-assigned").val(i.task.assigned)}c.show();h.find("input").focus();$("#remove-task").on("click",function(){e.removeTask.call(o);$("#mind-task-assigned").val("");o.operation.hideLink();$(".mind-dock-right-task").find(".mind-select-box").text("无")})},setTask:function(d,a){var g=this,c=g.util,f=g.model,h=a||c.getSelectedId();if(h==null||$.trim(h)==""||d==null){return}if(g.opts.readonly){return}var e=f.getTopicById(h),b=c.copy(e);if(e.task==null){e.task={}}e.task=$.extend(e.task,d);f.updateTopicNode.call(g,e,b,"task")},removeTask:function(){var e=this,b=e.util,d=e.model,f=b.getSelectedId();if(f==null||$.trim(f)==""){return}if(e.opts.readonly){return}var e=this,b=e.util,d=e.model,f=b.getSelectedId();var c=d.getTopicById(f),a=b.copy(c);if(c.task==null){return}delete c.task;d.updateTopicNode.call(e,c,a,"task")},renderTopicTask:function(i,h,c){if(h.task&&!$.isEmptyObject(h.task)){var d=h.task;var f=i.getTopicDom(h.id);var e=f.children(".topic-task");if(!e.length){e=$("<div class='topic-task'></div>");if(h.tags&&!$.isEmptyObject(h.tags)){f.find(".topic-tags").before(e)}else{f.append(e)}}var g="",k=false,b=false,a=false;if(d.start){g+="<span>"+d.start+"</span>";k=true}if(d.end){if(k==false){g+="_ "}g+="<span> : "+d.end+"</span>";b=true}if(b==false){g+=" : _"}if(k==false&&b==false){g=""}if(d.assigned!=null){g+="&nbsp;<span>("+d.assigned+")</span>";a=true}e.html(g);if(e.html()==""){e.remove()}}else{var f=i.getTopicDom(h.id);f.children(".topic-task").remove()}}};mindDesigner.prototype.icons={renderTopicIcons:function(k,h,a){if(h.icons){var q=h.icons,m=this,p=m.icons;var e=k.getTopicDom(h.id);var d=e.children(".topic-icons");if(d.length){d.children().remove()}else{d=$("<span class='topic-icons'></span>");e.find(".topic").before(d)}var g="";for(var f=0,l=q.length;f<l;f++){var o=q[f];if(o==null){continue}if(!o.url){var b=p[o.name];if(b==null){continue}var n=m.getIcon(b,o.index);if(n==null){continue}var c=o.color?"style='color:"+o.color+"'":"";g+="<span n='"+o.name+"' ico='"+o.index+"' "+c+" class='mind-icons'>"+n.text+"</span>"}else{g+="<span n='"+o.name+"' ico='"+o.index+"' iconimg='"+o.url+"' class='mind-icon-url mind-icons'><img src='"+o.url+"' /></span>"}}d.html(g);if(g==""){d.remove()}if(a=="right"||a==null){d.addClass("right")}else{if(a=="left"){d.addClass("left")}}d.css({width:l*21+"px"})}else{var e=k.getTopicDom(h.id);var d=e.children(".topic-icons");if(d.length){d.remove()}}},currentIcon:{},setIcon:function(y,z,s){var e=this;var l=y.attr("ico"),k=y.text(),p=y.attr("n")==null?"":y.attr("n");var A={index:l,name:p};if(s!=null){A.color=s}else{if(e.icons.currentIcon!=null&&e.icons.currentIcon.color!=null&&e.icons.currentIcon.name==A.name){A.color=e.icons.currentIcon.color}}var e=this,c=e.util,d=e.model,q=c.selectedIds;if(e.opts.readonly){return}if(q.length==0||A.index==""||A.index==null){return}var v=[],m=[];for(var t=0,f=q.length;t<f;t++){var o=q[t];var r=d.getTopicById(o),b=c.copy(r);m.push(b);if(r.icons==null){r.icons=[]}var a=r.icons,l=-1,x=-1,h=false;for(var u=0,w=a.length;u<w;u++){var g=a[u];if(A.index==g.index){x=u;break}else{if(g.name==A.name&&A.name!=""){l=u;break}}}if(l>=0){r.icons.splice(l,1,A)}else{if(x>=0){r.icons.splice(x,1);h=true}else{r.icons.push(A)}}if(z!=null){r.task=$.extend(r.task,z)}if(h){y.removeClass("selected")}else{y.addClass("selected");if(A.name!=""){y.siblings().removeClass("selected")}}v.push(r)}d.updateTopicNode.call(e,v,m,"icon")},getIcon:function(d,b){var e=null;for(var c=0,a=d.length;c<a;c++){var f=d[c];if(b==f.index){e=f;break}}return e},removeIcon:function(g){var s=this.icons.currentIcon;if(g==null&&(s==null||s.index==null)){return}var q=this,o=q.util,n=q.model,a=o.selectedIds;if(a.length==0){return}var b=[],c=[];for(var k=0,h=a.length;k<h;k++){var d=a[k];var m=n.getTopicById(d),f=o.copy(m),r=m.icons;c.push(f);for(var l=0,p=r.length;l<p;l++){var e=r[l];if(g!=null&&e.name==g){r.splice(l,1);break}else{if(e.index==s.index){r.splice(l,1);break}else{if(g!=null){m.task[g]=null}}}}b.push(m)}n.updateTopicNode.call(q,b,c,"icon")},setIconColor:function(d){var l=this,h=l.util,f=l.model,a=h.getSelectedId();if(a==null||$.trim(a)==""){return}var n=l.icons.currentIcon;if(n.index==null){return}var g=f.getTopicById(a),c=h.copy(g),m=g.icons;for(var e=0,k=m.length;e<k;e++){var b=m[e];if(b.index==n.index){b.color=d;break}}f.updateTopicNode.call(l,g,c,"icon")},icons:{face:[{index:9,text:"&#xe6c8"},{index:11,text:"&#xe6ca"},{index:10,text:"&#xe6c6"}],priority:[{index:0,text:"&#xe67a"},{index:1,text:"&#xe625"},{index:2,text:"&#xe62a"},{index:3,text:"&#xe635"},{index:4,text:"&#xe626"},{index:5,text:"&#xe62b"},{index:6,text:"&#xe627"},{index:7,text:"&#xe628"},{index:8,text:"&#xe629"}],arrow:[{index:33,text:"&#xe68c"},{index:34,text:"&#xe68e"},{index:35,text:"&#xe68d"},{index:36,text:"&#xe68b"},{index:37,text:"&#xe6a0"}],flag:[{index:26,text:"&#xe67e"},{index:27,text:"&#xe67e"},{index:28,text:"&#xe67e"},{index:29,text:"&#xe67e"},{index:30,text:"&#xe67e"},{index:31,text:"&#xe67e"},{index:32,text:"&#xe67e"}],completion:[{index:17,text:"&#xe6d2"},{index:18,text:"&#xe6d3"},{index:19,text:"&#xe6d4"},{index:20,text:"&#xe6d5"},{index:21,text:"&#xe6d6"},{index:22,text:"&#xe6d7"},{index:23,text:"&#xe6d8"},{index:24,text:"&#xe697;"}],"":[{index:38,text:"&#xe6ab"},{index:39,text:"&#xe634"},{index:40,text:"&#xe640"},{index:41,text:"&#xe692"},{index:42,text:"&#xe6b8"},{index:43,text:"&#xe6bb"},{index:44,text:"&#xe6b9"},{index:45,text:"&#xe6bf"},{index:46,text:"&#xe663"},{index:47,text:"&#xe6bd"},{index:48,text:"&#xe621"},{index:49,text:"&#xe6bc"},{index:50,text:"&#xe6c1"},{index:51,text:"&#xe609"},{index:52,text:"&#xe688"},{index:53,text:"&#xe681"},{index:54,text:"&#xe639"},{index:55,text:"&#xe682"},{index:56,text:"&#xe67f"},{index:57,text:"&#xe695"},{index:58,text:"&#xe689"},{index:59,text:"&#xe6be"},{index:60,text:"&#xe683"},{index:61,text:"&#xe6c0"},{index:62,text:"&#xe6b6"},{index:63,text:"&#xe680"},{index:64,text:"&#xe693"}]},renderIconBox:function(b,p,o){if($("#mind-icons-box").length>0){$("#mind-icons-box").remove()}var s="";if(o!=null&&o.length>0){for(var l=0;l<o.length;l++){var p=o[l];s+="-"+p.index+","}}var d='<div id="mind-icons-box" class="mind-dropdown">';var t=this.icons,m="";var k=t[b];m+="<div>";if(k){for(var h=0;h<k.length;h++){var e=k[h];var f="";if(p==e.index){f=" selected"}if(s.indexOf("-"+e.index+",")>=0){f=" selected"}m+='<span ico="'+e.index+'" n="'+b+'" class="mind-icons'+f+'">'+e.text+"</span>"}}m+="<span remove='true' style='color:#ff0000;' class='mind-icons'>&#xe60c;</span><span style='clear:both;'></span>";m+="</div>";d+=m;var a=["#bf1e1b","#63abf7","rgb(113, 203, 45)","#ff9f1a","#30bfbf","#444444","#f4f4f4"];var r=["<div class='mind-icons-color'>"];if(k){for(var l=0,n=a.length;l<n;l++){var g=a[l];var q="#fff;";if(g=="#f4f4f4"){q="#333"}r.push("<span style='background:"+g+";color:"+q+"'></span>")}r.push["</div>"];d+=r.join("")}d+="</div>";return d},showIcons:function(e,d,b,k){var l=this,i=l.util,m=l.icons,h=l.model;var g=h.getTopicById(d);var f=m.renderIconBox(b,k,g.icons);var c={index:k,name:b,color:e.css("color")};m.currentIcon=c;var a=$(f);a.appendTo("body");$.fn.showPanel({target:e,panel:a});m.initIconEvent.call(l)},initIconEvent:function(){var a=this,b=a.icons;$(document).off("mousedown.icons").on("mousedown.icons",function(c){$("#mind-icons-box").remove();setTimeout(function(){$(document).off("mousedown.icons")},50)});$(document).on("mousedown.icons","#mind-icons-box",function(c){c.stopPropagation()});$(document).off("click.icons").on("click.icons","#mind-icons-box .mind-icons",function(c){var d=$(this);if(d.attr("remove")){b.removeIcon.call(a);$("#mind-icons-box").remove()}else{b.setIcon.call(a,d)}c.stopPropagation()});$(document).off("click.iconcolors").on("click.iconcolors",".mind-icons-color span",function(d){var f=$(this),c=f.css("background-color");b.setIconColor.call(a,c);d.stopPropagation()})}};mindDesigner.prototype.style={baseColor:function(){return["#bf1e1b","#63abf7","rgb(113, 203, 45)","#ff9f1a","#30bfbf","#444444","#f4f4f4"]},getThemeStyle:function(n){var k=this.model.topic,a=this.style,m=a.themes,g=(k.classic||k.theme),l=this.util;if(n!=null&&n!=""&&n!="null"){return n}var h=l.copy(m.theme3);if(g){if(g.indexOf("customise_")<0){if(m[g]){h=l.copy(m[g])}}else{var c=window.sessionStorage.getItem("customiseThemes");if(c!=null&&c!=""){var b=JSON.parse(c);if(b.length>0){for(var f=0;f<b.length;f++){var d=b[f];if(d.id==g){h=d;break}}}}}}var e=k.background;h=$.extend(h,{background:e||h.background});return h},setTheme:function(f,h){var g=this,e=g.model,d=g.currentRoot||e.topic;var c="";g.events.push("zoom",0);var a=g.style.checkCustomiseStyle(d);if(a){g.events.push("showThemeOperate",f)}else{g.style.setThemeDirect.call(g,f)}if(h!=null){g.operation.setWatermark.call(mind,h)}},setThemeDirect:function(i,b){var f=this,e=f.model,h=e.topic,g=f.util.copy(h);var c="";if(h.classic!=null){c=h.classic;delete h.classic;h.theme=c}c=h.theme;if(i!=null||i!=""){h.theme=i}var a=f.style.getCurrentLineColor.call(this,g),d=f.style.setRomLineColor.call(this,i);f.operation.clearCanvas.call(f);f.operation.zoomVal=100;mind=new mindDesigner("#mind_con",{chartId:chartId},h);if(b==null){f.messageSource.send.call(f,"setTheme",{newLines:d,oldLines:a,content:i,original:c});f.style.oldLines=d}},setThemeDirect_:function(e,c,q,d){var l=this,k=l.model,o=k.topic,m=l.util.copy(o);var b="";if(o.classic!=null){b=o.classic;delete o.classic;o.theme=b}b=o.theme;if(q!=null||q!=""){o.theme=q}if(e.length){for(var f=0;f<e.length;f++){var p=e[f],a=Object.keys(p)[0],h=k.getTopicById(a);var g=h.lineStyle||{};var n=$.extend({},g,p[a]);h.lineStyle=n}}$("div[tit="+q+"]").parent().addClass("selected").siblings().removeClass("selected");l.operation.clearCanvas.call(l);l.operation.zoomVal=100;mind=new mindDesigner("#mind_con",{chartId:chartId},o);if(d==null){l.messageSource.send.call(l,"setTheme",{newLines:e,oldLines:c,content:q,original:b})}},setThemeOverWrite:function(f,p){var k=this,g=k.model,m=k.currentRoot||g.topic,l=k.util.copy(m);var b="";if(m.classic!=null){b=m.classic;delete m.classic;m.theme=b}b=m.theme;if(f!=null||f!=""){m.theme=f}if(m.margin){delete m.margin}var o=g.getStyleTopics.call(k,m);g.topicList.resetTopicList.call(k);var c=[];for(var e=0,h=o.length;e<h;e++){var n=o[e];delete n.children;c.push(n)}var d=k.style.setRomLineColor.call(this,f),a=k.style.oldLines;k.operation.clearCanvas.call(k);k.operation.zoomVal=100;mind=new mindDesigner("#mind_con",{chartId:chartId},m);k.messageSource.send.call(k,"setThemeOverWrite",{newLines:d,oldLines:a,tps:c,content:f,original:b,operate:"delete"});k.style.oldLines=d;if(p!=null){p()}},setThemeOverWrite_:function(f,c,h,e,k,d){var o=this,n=o.model,q=o.currentRoot||n.topic;var b=q.theme;if(h!=null||h!=""){q.theme=h}if(k=="add"){n.addTopicStyles.call(o,q,e)}else{if(k=="delete"){n.getStyleTopics.call(o,q)}}if(f.length){for(var g=0;g<f.length;g++){var r=f[g],a=Object.keys(r)[0],m=n.getTopicById(a);var l=m.lineStyle||{};var p=$.extend({},l,r[a]);m.lineStyle=p}}n.topicList.resetTopicList.call(o);$("div[tit="+h+"]").parent().addClass("selected").siblings().removeClass("selected");o.operation.clearCanvas.call(o);o.operation.zoomVal=100;mind=new mindDesigner("#mind_con",{chartId:chartId},q);if(d==null){o.messageSource.send.call(o,"setThemeOverWrite",{newLines:f,oldLines:c,tps:e,content:h,old:b,operate:k})}o.events.push("updateMargin")},checkCustomiseStyle:function(d){var a=false;function c(l){if(e(l)||(l.lineStyle&&!f(l))||(l.background&&l.root)||(l.margin&&l.root)){a=true;return a}var k=l.children;var h=l.summaries;if(l.root){if(l.leftChildren!=null){k=k.concat(l.leftChildren)}}for(var g=0,b=k.length;g<b;g++){var n=k[g];if(c(n)){a=true;break}}if(h){for(var g=0,b=h.length;g<b;g++){var m=h[g];if(c(m)){a=true;break}}}}function e(h){var g=h.style,i=[];if(g){if(h.summary){for(var b in g){if(b=="lineWidth"||b=="lineColor"||b=="lineType"){continue}else{i.push(b)}}if(i.length==0){return false}return true}return true}}function f(b){if(b.lineStyle){if(Object.keys(b.lineStyle).length==1&&Object.keys(b.lineStyle)[0]=="randomLineColor"){return true}return false}return false}c(d);return a},getRadomColor:function(){var b=["rgb(220,220,220)","rgb(193,255,193)","rgb(254,224,198)","rgb(254,240,201)","rgb(255,204,204)","rgb(255,230,204)","rgb(230,255,204)","rgb(204,229,255)","rgb(204,204,255)","rgb(229,204,255)","rgb(255,204,255)","rgb(255,204,230)"];var a=parseInt(Math.random()*10);return b[a]},usedColors:[],colorsLen:9,getLineColor:function(a){var b=this.getRadomLineColor(a);while(this.usedColors.indexOf(b)>=0){b=this.getRadomLineColor(a)}this.usedColors.push(b);if(this.usedColors.length>=this.colorsLen){this.usedColors.length=[]}return b},getRadomLineColor:function(c){var e="",f=this.colorsLen=10;if(c){e=c.theme}var b=["rgb(255,204,204)","rgb(153,204,255)","#FDB813","#80BC42","#e85d4e","#127c97","rgb(232, 124, 37)","rgb(0, 94, 170)","rgb(51, 156, 168)","rgb(212, 164, 235)"];var d={delicate_caihong:{colors:["#FD5155","#F88A35","#FCB52A","#80BA4C","#0FBAB0","#0D7C82","#02ACF4","#0F80C4","#3D5EC2","#7549C5","#BE49C4","#DD489D","#FA5465"],num:13},dark_caihong:{colors:["#A04AFB","#7754F6","#4D69FD","#13A3ED","#74C11F","#FFCA01","#FF8502","#F4325C","#F5479C"],num:9}};if(d[e]){b=d[e].colors;f=this.colorsLen=d[e].num}var a=parseInt(Math.random()*f);return b[a]},themes:{delicate_caihong:{background:"#F7F7F7",thumbUrl:"/assets/images/mind/delicate-caihong.png",title:"曲线彩虹",unilateral:true,autoColor:true,underLine:true,newTheme:true,marginH:30,marginW:100,childMarginH:15,childMarginW:60,common:{family:"微软雅黑",italic:false,textAlign:"left",blob:true},connectionStyle:{lineWidth:3,lineColor:"rgb(113, 203, 45)",color:"#ffffff"},boundaryStyle:{lineColor:"#939aa8",lineWidth:"2",lineType:"1",dasharray:"6,3",fill:"#939aa8",opacity:"0.1"},centerTopic:{backgroundColor:"#ffffff",color:"#2A2E36","font-size":"24px","border-radius":"7px","box-shadow":"0px 2px 4px 0px rgba(0, 0, 0, 0.1)",padding:"16px 38px"},summaryTopic:{"font-size":"13px",color:"#2A2E36",padding:"5px 9px","border-bottom":"3px solid #0D0B22",lineStyle:{lineType:"curve",lineWidth:3,underLine:true,lineColor:"#0D0B22"}},secTopic:{color:"#0D0B22","font-size":"16px",padding:"4px 14px 4px 14px",lineStyle:{lineType:"curve",lineWidth:3,underLine:true}},childTopic:{"font-size":"13px",color:"#0D0B22",padding:"6px 9px","font-weight":"400",lineStyle:{lineType:"curve",lineWidth:3,underLine:true,}}},artistic_song:{background:"#ECEDE5FF",thumbUrl:"/assets/images/mind/song.png",title:"文艺宋",unilateral:true,newTheme:true,marginH:24,marginW:75,childMarginH:16,childMarginW:40,common:{family:"Songti SC, MicrosoftYaHei-Bold",italic:false,textAlign:"left"},connectionStyle:{lineWidth:2,lineColor:"#8C9291",color:"#ffffff"},centerTopic:{backgroundColor:"#C9BE8E",color:"#fff","font-size":"24px","border-radius":"4px",padding:"16px 38px"},secTopic:{backgroundColor:"#FFFFFF","border-radius":"4px",color:"#41494C","font-size":"16px",padding:"10px 22px 10px 22px",lineStyle:{lineType:"slant",lineWidth:2,lineColor:"#8C9291"}},childTopic:{"font-size":"14px",color:"#41494E",padding:"4px 9px 4px",lineStyle:{lineType:"slant",lineWidth:2,lineColor:"#8C9291"}}},delicate_dark:{background:"#ffffff",thumbUrl:"/assets/images/mind/delicate-dark.png",title:"黑色的曲线",unilateral:true,newTheme:true,marginH:24,marginW:95,childMarginH:16,childMarginW:40,common:{family:"微软雅黑",bold:true,italic:false,textAlign:"left"},connectionStyle:{lineWidth:2,lineColor:"rgb(11, 13, 34)",color:"#ffffff"},centerTopic:{backgroundColor:"rgb(13, 11, 34)",color:"#fff","font-size":"18px","border-radius":"7px",padding:"15px 40px"},secTopic:{backgroundColor:"#F3F3F4","border-radius":"7px",color:"#0D0B22","font-size":"16px",padding:"10px 22px 10px 22px",lineStyle:{lineType:"curve",lineWidth:2,lineColor:"#0D0B22"}},childTopic:{"font-size":"14px",color:"#0D0B22",padding:"4px 9px 4px","font-weight":"400",lineStyle:{lineType:"curve",lineWidth:2,lineColor:"#0D0B22"}}},theme3:{background:"#f6f6f6",thumbUrl:"/assets/images/mind/mr.jpg",thinner:false,title:"默认风格",marginH:26,marginW:80,childMarginH:8,childMarginW:12,show:false,common:{family:"微软雅黑",bold:false,italic:false,textAlign:"left"},connectionStyle:{lineWidth:2,lineColor:"rgb(113, 203, 45)",color:"#ffffff"},centerTopic:{backgroundColor:"#50C28B",color:"#fff","font-size":"25px","border-radius":"5px",border:"2px solid #50C28B",padding:"10px 12px"},secTopic:{backgroundColor:"#ffffff",border:"1px solid #444","border-radius":"5px",color:"#735C45","font-size":"15px",padding:"8px 10px 8px 10px",lineStyle:{lineType:"curve",lineWidth:2,lineColor:"#666"}},childTopic:{"font-size":"13px",color:"#666",padding:"2px 9px 2px 9px",lineStyle:{lineType:"roundBroken",lineWidth:1,lineColor:"#555",underLine:true}}},theme3_1:{background:"#f6f6f6",thumbUrl:"/assets/images/mind/mr.jpg",thinner:false,title:"默认风格",marginH:30,marginW:50,childMarginH:3,childMarginW:8,common:{family:" 微软雅黑",italic:false,textAlign:"left"},connectionStyle:{lineWidth:2,lineColor:"#8A8A8A",color:"#ffffff"},centerTopic:{backgroundColor:"#50C28B",color:"#fff","font-size":"25px","border-radius":"6px",border:"2px solid #50C28B",padding:"10px 32px"},secTopic:{backgroundColor:"#ffffff",border:"1px solid #444","border-radius":"4px",color:"#23282D","font-size":"16px",padding:"6px 20px",lineStyle:{lineType:"curve",lineWidth:2,lineColor:"#8A8A8A"}},childTopic:{"font-size":"13px",color:"#23282D",padding:"2px 8px","font-weight":400,lineStyle:{lineType:"roundBroken",lineWidth:1,lineColor:"#8A8A8A",underLine:true}}},"default":{background:"#f8f8f8",thinner:false,thumbUrl:"/assets/images/mind/wdmx.jpg",title:"文档模型",marginH:26,marginW:60,childMarginH:10,childMarginW:14,common:{family:"微软雅黑",bold:false,italic:false,textAlign:"left"},connectionStyle:{lineWidth:2,lineColor:"rgb(113, 203, 45)",color:"#ffffff"},centerTopic:{backgroundColor:"#50C28B",color:"#fff","font-size":"26px","border-radius":"5px",padding:"14px 15px 13px 15px"},secTopic:{backgroundColor:"#ffffff",border:"1px solid rgb(157,157,157)","border-radius":"5px",color:"rgb(68,68,68)","font-size":"17px",padding:"8px 12px 8px 12px",lineStyle:{lineType:"roundBroken",lineWidth:1,lineColor:"rgb(160,160,160)"}},childTopic:{"font-size":"13px",color:"rgb(68,68,68)",padding:"2px 9px 4px",lineStyle:{lineType:"roundBroken",lineWidth:1,lineColor:"rgb(140,140,140)"}}},shangwu:{background:"#f8f8f8",thinner:false,thumbUrl:"/assets/images/mind/jysw.jpg",title:"简约商务",show:false,marginH:30,marginW:80,childMarginH:10,childMarginW:18,common:{family:"微软雅黑",bold:false,italic:false,textAlign:"left"},connectionStyle:{lineWidth:2,lineColor:"rgb(113, 203, 45)",color:"#ffffff"},centerTopic:{backgroundColor:"rgb(102, 102, 255)",color:"#fff","font-size":"27px","border-radius":"5px",padding:"14px 12px 14px 12px"},secTopic:{color:"rgb(102, 102, 255)","font-size":"17px",padding:"10px 10px 10px 10px",lineStyle:{lineType:"curve",lineWidth:1,lineColor:"rgb(0, 0, 204)"}},childTopic:{"font-size":"13px",color:"rgb(102, 102, 255)",padding:"2px 9px 4px",lineStyle:{lineType:"roundBroken",lineWidth:1,lineColor:"rgb(102, 102, 255)"}}},shangwu_1:{background:"#f8f8f8",thinner:false,thumbUrl:"/assets/images/mind/jysw.jpg",title:"简约商务",marginH:25,marginW:50,childMarginH:3,childMarginW:16,common:{family:" 微软雅黑",italic:false,textAlign:"left"},connectionStyle:{lineWidth:2,lineColor:"#0B033F",color:"#ffffff"},centerTopic:{backgroundColor:"#4D34FD",color:"#fff","font-size":"25px","border-radius":"5px",padding:"14px 24px"},secTopic:{color:"#0B033F","font-size":"17px",padding:"6px 9px",lineStyle:{lineType:"curve",lineWidth:2,lineColor:"#0B033F"}},childTopic:{"font-size":"13px",color:"#0B033F",padding:"3px 8px","font-weight":400,lineStyle:{lineType:"roundBroken",lineWidth:1.6,lineColor:"#0B033F"}}},paper:{background:"#fcf5de",thumbUrl:"/assets/images/mind/paper.jpg",thinner:false,title:"简约风格",marginH:30,marginW:80,show:false,childMarginH:14,childMarginW:12,common:{family:"微软雅黑",bold:false,italic:false,textAlign:"left"},connectionStyle:{lineWidth:2,lineColor:"rgb(113, 203, 45)",color:"#ffffff"},centerTopic:{backgroundColor:"#ffffff",color:"#735C45","font-size":"30px","border-radius":"5px",border:"2px solid #3D474D",padding:"14px 12px 14px 12px"},secTopic:{backgroundColor:"#ffffff",border:"1px solid #3D474D","border-radius":"25px",color:"#735C45","font-size":"16px",padding:"10px 10px 10px 10px",lineStyle:{lineType:"curve",lineWidth:2,lineColor:"#3D474D"}},childTopic:{"font-size":"14px",color:"#735C45",padding:"2px 9px 4px 9px",lineStyle:{lineType:"roundBroken",lineWidth:1,lineColor:"#3D474D",underLine:true}}},paper_1:{background:"#fcf5de",thumbUrl:"/assets/images/mind/paper.jpg",thinner:false,title:"简约风格",marginH:30,marginW:50,childMarginH:3,childMarginW:17,common:{family:" 微软雅黑",italic:false,textAlign:"left"},connectionStyle:{lineWidth:2,lineColor:"#745D46",color:"#ffffff"},centerTopic:{backgroundColor:"#ffffff",color:"#745D46","font-size":"25px","border-radius":"16px",border:"2px solid #745D46","font-weight":"500",padding:"14px 32px"},secTopic:{backgroundColor:"#ffffff",border:"1px solid #745D46","border-radius":"20px",color:"#745D46","font-size":"16px",padding:"8px 20px",lineStyle:{lineType:"curve",lineWidth:2,lineColor:"#745D46"}},childTopic:{"font-size":"13px",color:"#745D46",padding:"3px 8px","font-weight":400,lineStyle:{lineType:"roundBroken",lineWidth:1,lineColor:"#745D46",underLine:true}}},jianbihua:{background:"rgb(255, 249, 217)",thumbUrl:"/assets/images/mind/jbxt.jpg",title:"简笔线条",thinner:false,marginH:40,marginW:80,show:false,childMarginH:20,childMarginW:20,common:{family:"Comic Sans MS,微软雅黑",bold:false,italic:false,textAlign:"left"},connectionStyle:{lineWidth:2,lineColor:"rgb(113, 203, 45)",color:"#ffffff"},centerTopic:{backgroundColor:"rgb(255, 249, 217)","border-width":"7px",color:"#333","font-size":"34px",padding:"16px 12px 15px 12px",borderStyle:"solid","-webkit-border-image":"url(https://www.processon.com/assets/images/mind/border.png) 35 60 45 60","border-image":"url(https://www.processon.com/assets/images/mind/border.png) 35 60 45 60"},secTopic:{backgroundColor:"rgb(255, 249, 217)",color:"rgb(68,68,68)","font-size":"20px",padding:"2px 9px 4px","border-width":"3px","-webkit-border-image":"url(https://www.processon.com/assets/images/mind/border.png) 35 60 45 60","border-image":"url(https://www.processon.com/assets/images/mind/border.png) 35 60 45 60",borderStyle:"solid",lineStyle:{lineType:"curve",lineWidth:3,lineColor:"rgb(70,70,70)"}},childTopic:{"font-size":"17px",color:"rgb(68,68,68)",padding:"2px 9px 2px","border-width":"2px","-webkit-border-image":"url(https://www.processon.com/assets/images/mind/border.png) 35 60 45 60","border-image":"url(https://www.processon.com/assets/images/mind/border.png) 35 60 45 60",borderStyle:"solid",lineStyle:{lineType:"roundBroken",lineWidth:1,lineColor:"rgb(110,110,110)"}}},jianbihua_1:{background:"#fff",thumbUrl:"/assets/images/mind/jbxt1.jpg",title:"简笔线条",thinner:false,marginH:24,marginW:62,childMarginH:10,childMarginW:17,common:{family:" 微软雅黑",bold:false,italic:false,textAlign:"left"},connectionStyle:{lineWidth:2,lineColor:"#000000",color:"#ffffff"},centerTopic:{backgroundColor:"#fff","border-width":"9px",color:"#000","font-size":"25px",padding:"14px 20px",borderStyle:"solid","-webkit-border-image":"url(https://www.processon.com/assets/images/mind/border.png) 35 60 45 60","border-image":"url(https://www.processon.com/assets/images/mind/border.png) 35 60 45 60"},secTopic:{color:"#000","font-size":"16px",padding:"7px 16px","border-width":"5px","-webkit-border-image":"url(https://www.processon.com/assets/images/mind/border.png) 35 60 45 60","border-image":"url(https://www.processon.com/assets/images/mind/border.png) 35 60 45 60",borderStyle:"solid",lineStyle:{lineType:"curve",lineWidth:3,lineColor:"rgb(70,70,70)"}},childTopic:{"font-size":"13px",color:"#0B033F",padding:"3px 9px","border-width":"3px","-webkit-border-image":"url(https://www.processon.com/assets/images/mind/border.png) 35 60 45 60","border-image":"url(https://www.processon.com/assets/images/mind/border.png) 35 60 45 60",borderStyle:"solid",lineStyle:{lineType:"roundBroken",lineWidth:2,lineColor:"#000"}}},niupizhi:{background:"rgb(252,246,207)",thumbUrl:"/assets/images/mind/npz.jpg",thinner:false,title:"牛皮纸",marginH:30,marginW:80,childMarginH:10,childMarginW:18,common:{family:"微软雅黑",bold:false,italic:false,textAlign:"left"},connectionStyle:{lineWidth:2,lineColor:"rgb(113, 203, 45)",color:"#ffffff"},centerTopic:{backgroundColor:"rgb(221, 170, 68)",color:"#fff","font-size":"30px","border-radius":"5px",padding:"14px 12px 14px 12px"},secTopic:{backgroundColor:"rgb(221, 170, 68)","border-radius":"5px",color:"#ffffff","font-size":"17px",padding:"10px 10px 10px 10px",lineStyle:{lineType:"curve",lineWidth:1,lineColor:"rgb(187, 136, 34)"}},childTopic:{"font-size":"13px",color:"rgb(187, 136, 34)",padding:"2px 9px 4px",lineStyle:{lineType:"roundBroken",lineWidth:1,lineColor:"rgb(187, 136, 34)"}}},caihongthinner:{background:"#f8f8f8",thumbUrl:"/assets/images/mind/chl.jpg",title:"有色彩的线条Thinner",thinner:true,autoColor:true,marginH:30,marginW:80,childMarginH:10,childMarginW:20,common:{family:" 微软雅黑",bold:false,italic:false,textAlign:"left"},connectionStyle:{lineWidth:2,lineColor:"rgb(113, 203, 45)",color:"#ffffff"},boundaryStyle:{lineColor:"#939aa8",lineWidth:"2",lineType:"1",dasharray:"6,3",fill:"#939aa8",opacity:"0.1"},centerTopic:{backgroundColor:"#50C28B",color:"#fff","font-size":"34px","border-radius":"5px",padding:"15px 12px 15px 12px"},secTopic:{backgroundColor:"#ffffff",border:"2px solid rgb(187,187,187)","border-radius":"5px",color:"rgb(68,68,68)","font-size":"17px",padding:"10px 10px 10px 10px",lineStyle:{lineType:"curve",lineWidth:8,lineColor:"rgb(170,170,170)"}},childTopic:{"font-size":"13px",color:"rgb(68,68,68)",padding:"2px 9px 3px",lineStyle:{lineType:"curve",lineWidth:2,lineColor:"rgb(140,140,140)"}}},colorLines:{background:"#f8f8f8",thumbUrl:"/assets/images/mind/colorlines.png",title:"有色彩的线条",thinner:false,autoColor:true,marginH:30,marginW:80,childMarginH:10,childMarginW:20,common:{family:" 微软雅黑",bold:false,italic:false,textAlign:"left"},connectionStyle:{lineWidth:2,lineColor:"rgb(113, 203, 45)",color:"#ffffff"},boundaryStyle:{lineColor:"#939aa8",lineWidth:"2",lineType:"1",dasharray:"6,3",fill:"#939aa8",opacity:"0.1"},centerTopic:{backgroundColor:"#fff",border:"6px solid #3aa9ce",color:"#333","font-size":"30px","border-radius":"5px",padding:"15px 12px 15px 12px"},secTopic:{backgroundColor:"#ffffff",border:"2px solid #3aa9ce","border-radius":"5px",color:"rgb(68,68,68)","font-size":"17px",padding:"10px 10px 10px 10px",lineStyle:{lineType:"curve",lineWidth:5,lineColor:"#3aa9ce"}},childTopic:{"font-size":"13px",color:"rgb(68,68,68)",padding:"2px 9px 4px",lineStyle:{lineType:"roundBroken",lineWidth:2,lineColor:"rgb(58, 169, 206)",underLine:true}}},caihong:{background:"#f8f8f8",thumbUrl:"/assets/images/mind/ch.jpg",title:"有色彩的线条",thinner:false,autoColor:true,marginH:30,marginW:80,childMarginH:10,childMarginW:20,common:{family:"微软雅黑",bold:false,italic:false,textAlign:"left"},connectionStyle:{lineWidth:2,lineColor:"rgb(113, 203, 45)",color:"#ffffff"},boundaryStyle:{lineColor:"#939aa8",lineWidth:"2",lineType:"1",dasharray:"6,3",fill:"#939aa8",opacity:"0.1"},centerTopic:{backgroundColor:"#50C28B",color:"#fff","font-size":"34px","border-radius":"5px",padding:"15px 12px 15px 12px"},secTopic:{backgroundColor:"#ffffff",border:"2px solid rgb(187,187,187)","border-radius":"5px",color:"rgb(68,68,68)","font-size":"17px",padding:"10px 10px 10px 10px",lineStyle:{lineType:"curve",lineWidth:8,lineColor:"rgb(170,170,170)"}},childTopic:{"font-size":"13px",color:"rgb(68,68,68)",padding:"3px 9px 4px",lineStyle:{lineType:"curve",lineWidth:1,lineColor:"rgb(140,140,140)"}}},caihongpao:{title:"彩虹泡",thumbUrl:"/assets/images/mind/chp.jpg",background:"#f8f8f8",thinner:false,marginH:30,marginW:80,childMarginH:8,childMarginW:20,common:{family:"微软雅黑",bold:false,italic:false,textAlign:"left"},connectionStyle:{lineWidth:2,lineColor:"rgb(113, 203, 45)",color:"#ffffff"},centerTopic:{backgroundColor:"#50C28B",color:"#fff","font-size":"26px","border-radius":"5px",padding:"9px 12px 10px 12px"},secTopic:{backgroundColor:"#ffffff","border-radius":"5px",color:"rgb(103,103,103)","font-size":"14px",padding:"6px 10px 5px 10px",boxShadow:"1px 1px 1px #ccc",lineStyle:{lineType:"curve",lineWidth:2,lineColor:"#43a9ff"}},childTopic:{"font-size":"12px","border-radius":"5px",color:"rgb(103,103,103)",padding:"3px 9px 4px",boxShadow:"1px 1px 1px #ccc",lineStyle:{lineType:"roundBroken",lineWidth:1,lineColor:"#43a9ff"}}},red:{background:"#fafafa",thumbUrl:"/assets/images/mind/red.jpg",thinner:false,title:"简约风格",marginH:30,marginW:80,childMarginH:6,childMarginW:16,common:{family:" 微软雅黑",bold:false,italic:false,textAlign:"left"},connectionStyle:{lineWidth:2,lineColor:"#eb5e41",color:"#ffffff"},centerTopic:{backgroundColor:"#eb5e41",color:"#ffffff","font-size":"30px",padding:"14px 12px 14px 12px"},secTopic:{backgroundColor:"#eb5e41",color:"#fff","font-size":"16px",padding:"10px 10px 10px 10px",lineStyle:{lineType:"straight",lineWidth:2,lineColor:"#eb5e41"}},childTopic:{"font-size":"13px",backgroundColor:"#f0f0f0","border-bottom":"1px solid #eb5e41",color:"#735C45","box-shadow":"1px 0px 0px #ccc",padding:"2px 9px 4px 9px",lineStyle:{lineType:"roundBroken",lineWidth:1,lineColor:"#eb5e41",underLine:true}}},mindmap:{background:"#f5f5f5",thumbUrl:"/assets/images/mind/mindmap.jpg",title:"标准思维导图样式",thinner:true,autoColor:true,underLine:true,marginH:20,marginW:100,childMarginH:5,childMarginW:40,common:{family:" 微软雅黑",bold:false,italic:false,textAlign:"left"},connectionStyle:{lineWidth:1,lineColor:"#98a2ab",color:"#ffffff"},boundaryStyle:{lineColor:"#939aa8",lineWidth:"2",lineType:"1",dasharray:"6,3",fill:"#939aa8",opacity:"0.1"},centerTopic:{backgroundColor:"rgb(80, 194, 139)",color:"#ffffff","font-size":"24px","border-radius":"6px",padding:"10px 16px 10px 16px"},secTopic:{color:"rgb(68, 68, 68)","font-size":"16px",padding:"2px 14px 2px 14px","border-bottom":"2px solid #888",lineStyle:{lineType:"curve",lineWidth:1,lineColor:"#8a8a8a",underLine:true}},childTopic:{"font-size":"12px",color:"rgb(68, 68, 68)",padding:"6px 9px 6px 9px",lineStyle:{lineType:"curve",lineWidth:1,lineColor:"#8a8a8a",underLine:true}}},dark_caihong:{background:"#0A0F32",thumbUrl:"/assets/images/mind/ch-dark.png",title:"五彩斑斓的黑",unilateral:true,autoColor:true,underLine:true,newTheme:true,marginH:30,marginW:100,childMarginH:15,childMarginW:60,member:true,common:{family:" 微软雅黑",italic:false,textAlign:"left",blob:true},connectionStyle:{lineWidth:3,lineColor:"#98a2ab",color:"#ffffff"},boundaryStyle:{lineColor:"#939aa8",lineWidth:"2",lineType:"1",dasharray:"6,3",fill:"#939aa8",opacity:"0.1"},centerTopic:{backgroundColor:"#ffffff",color:"#2A2E36","font-size":"24px","border-radius":"7px","box-shadow":"0px 2px 4px 0px rgba(0, 0, 0, 0.1)",padding:"16px 38px"},secTopic:{color:"#FFFFFF","font-size":"16px",padding:"4px 14px 4px 14px",lineStyle:{lineType:"curve",lineWidth:3,underLine:true}},summaryTopic:{"font-size":"14px",color:"#FFFFFF",padding:"5px 9px","border-bottom":"3px solid #ffffff",lineStyle:{lineType:"curve",lineWidth:3,underLine:true,lineColor:"#ffffff"}},childTopic:{"font-size":"14px",color:"#FFFFFF",padding:"5px 9px","font-weight":"400",lineStyle:{lineType:"curve",lineWidth:3,underLine:true,}}},mindmap_dark:{background:"#333333",thumbUrl:"/assets/images/mind/dark.jpg",title:"标准思维导图黑色",marginH:20,marginW:60,childMarginH:10,childMarginW:30,member:true,underLine:true,common:{family:"微软雅黑",bold:false,italic:false,textAlign:"left"},connectionStyle:{lineWidth:1,lineColor:"#98a2ab",color:"#ffffff"},centerTopic:{backgroundColor:"#00a5ff",color:"#ffffff","font-size":"22px","border-radius":"6px",padding:"10px 12px 10px 12px"},secTopic:{color:"#eee","font-size":"15px",padding:"10px 12px 10px 12px","border-bottom":"2px solid #eee",lineStyle:{lineType:"curve",lineWidth:2,lineColor:"#ddd",underLine:true}},childTopic:{"font-size":"12px",color:"#eee",padding:"2px 9px 4px",lineStyle:{lineType:"curve",lineWidth:1,lineColor:"#eee",underLine:true}}},black:{background:"rgb(57, 60, 65)",thumbUrl:"/assets/images/mind/black.jpg",title:"heise",thinner:false,marginH:40,marginW:80,childMarginH:12,childMarginW:20,common:{family:"微软雅黑",bold:false,italic:false,textAlign:"left"},connectionStyle:{lineWidth:2,lineColor:"#e8eaec",color:"#333"},centerTopic:{backgroundColor:"#ff8200",color:"#fff","border-radius":"35px","font-size":"34px",padding:"16px 18px 16px 18px"},secTopic:{backgroundColor:"#e8eaec",color:"rgb(68,68,68)","font-size":"17px",padding:"10px 15px 10px 15px","border-radius":"20px",lineStyle:{lineType:"curve",lineWidth:3,lineColor:"#e8eaec"}},childTopic:{"font-size":"12px",color:"#ffffff",padding:"4px 10px","border-radius":"20px",border:"1px solid #e8eaec",lineStyle:{lineType:"roundBroken",lineWidth:2,lineColor:"#e8eaec"}}},mindmap1:{background:"#f5f5f5",thumbUrl:"/assets/images/mind/mindmap1.jpg",title:"标准思维导图样式",marginH:20,marginW:60,underLine:true,childMarginH:10,childMarginW:30,common:{family:" 微软雅黑",italic:false,textAlign:"left"},connectionStyle:{lineWidth:1,lineColor:"#98a2ab",color:"#ffffff"},centerTopic:{backgroundColor:"rgb(80, 194, 139)",color:"#ffffff","font-size":"22px","border-radius":"6px",padding:"10px 12px 10px 12px"},secTopic:{color:"rgb(68, 68, 68)","font-size":"15px",padding:"10px 12px 10px 12px","border-bottom":"2px solid #888",lineStyle:{lineType:"curve",lineWidth:2,lineColor:"#8a8a8a",underLine:true}},childTopic:{"font-size":"12px",color:"rgb(68, 68, 68)",padding:"2px 9px 4px",lineStyle:{lineType:"curve",lineWidth:1,lineColor:"#8a8a8a",underLine:true}}},theme1:{background:"#ffffdd",thinner:true,thumbUrl:"/assets/images/mind/zxjx.jpg",title:"线条渐细",marginH:30,marginW:90,childMarginH:10,childMarginW:20,common:{family:"微软雅黑",bold:false,italic:false,textAlign:"left"},connectionStyle:{lineWidth:2,lineColor:"rgb(113, 203, 45)",color:"#ffffff"},centerTopic:{backgroundColor:"#50C28B",color:"#fff","font-size":"40px","border-radius":"5px",padding:"14px 12px 14px 12px"},secTopic:{backgroundColor:"#ffffff",border:"1px solid rgb(187,187,187)","border-radius":"5px",color:"rgb(68,68,68)","font-size":"17px",padding:"10px",lineStyle:{lineType:"straight",lineWidth:4,lineColor:"rgb(170,170,170)"}},childTopic:{"font-size":"13px",color:"rgb(68,68,68)",padding:"2px 9px 4px",lineStyle:{lineType:"roundBroken",lineWidth:1,lineColor:"rgb(140,140,140)"}}},simple:{background:"#f8f8f8",thinner:false,thumbUrl:"/assets/images/mind/simple.jpg",title:"简约",show:false,marginH:26,marginW:60,childMarginH:8,childMarginW:14,common:{family:"微软雅黑",bold:false,italic:false,textAlign:"left"},connectionStyle:{lineWidth:1,lineColor:"rgb(113, 203, 45)",color:"#ffffff"},centerTopic:{backgroundColor:"#50C28B",color:"#fff","font-size":"26px","border-radius":"5px",padding:"14px 15px 13px 15px"},secTopic:{backgroundColor:"#ffffff",border:"1px solid rgb(137,137,137)","border-radius":"5px",color:"rgb(68,68,68)","font-size":"17px",padding:"8px 12px 8px 12px",lineStyle:{lineType:"curve",lineWidth:2,lineColor:"rgb(130,130,130)"}},childTopic:{"font-size":"13px",color:"rgb(68,68,68)",padding:"2px 6px 3px",lineStyle:{lineType:"curve",lineWidth:1,lineColor:"rgb(130,130,130)"}}},basic:{background:"#fcf5de",thumbUrl:"/assets/images/mind/basic.png",thinner:false,title:"简约风格",marginH:30,marginW:80,childMarginH:10,childMarginW:12,common:{family:"微软雅黑",bold:false,italic:false,textAlign:"left"},connectionStyle:{lineWidth:2,lineColor:"rgb(113, 203, 45)",color:"#ffffff"},centerTopic:{backgroundColor:"#50C28B",color:"#fff","font-size":"30px","border-radius":"5px",padding:"14px 12px 14px 12px"},secTopic:{backgroundColor:"#ffffff",border:"1px solid rgb(187,187,187)","border-radius":"5px",color:"rgb(68,68,68)","font-size":"17px",padding:"10px 10px 10px 10px",lineStyle:{lineType:"curve",lineWidth:2,lineColor:"rgb(170,170,170)"}},childTopic:{"font-size":"14px",backgroundColor:"#ffffff",color:"rgb(68,68,68)",padding:"2px 9px 2px",border:"1px solid rgb(187,187,187)","border-radius":"5px",lineStyle:{lineType:"roundBroken",lineWidth:1,lineColor:"rgb(140,140,140)"}}},mobdefault:{background:"#f5f5f5",thumbUrl:"/assets/images/mind/mobdefault.png",title:"移动端主题",thinner:false,marginH:20,marginW:50,childMarginH:10,childMarginW:20,show:false,common:{family:"微软雅黑",bold:false,italic:false,textAlign:"left"},connectionStyle:{lineWidth:1,lineColor:"#98a2ab",color:"#ffffff"},centerTopic:{backgroundColor:"rgb(80, 194, 139)",color:"#ffffff","font-size":"20px","border-radius":"6px",padding:"10px 16px 12px"},secTopic:{backgroundColor:"#ffffff","border-radius":"6px",color:"rgb(68, 68, 68)","font-size":"14px",border:"1px solid rgba(138, 138, 138,.6)",padding:"6px 12px 8px",lineStyle:{lineType:"curve",lineWidth:1,lineColor:"#8a8a8a"}},childTopic:{"font-size":"12px",color:"rgb(68, 68, 68)",padding:"2px 9px 4px",lineStyle:{lineType:"roundBroken",lineWidth:1,lineColor:"#8a8a8a"}}},mobdark:{background:"rgb(57, 60, 65)",thumbUrl:"/assets/images/mind/mobdark.jpg",title:"标准思维导图黑色",marginH:20,marginW:60,childMarginH:10,childMarginW:20,show:false,common:{family:"微软雅黑",bold:false,italic:false,textAlign:"left"},connectionStyle:{lineWidth:1,lineColor:"rgb(120,123,128)",color:"#ffffff"},centerTopic:{backgroundColor:"#ff8202",color:"#fff1de","font-size":"20px","border-radius":"6px",padding:"10px 16px 12px"},secTopic:{color:"rgb(57,60,65)","font-size":"14px",padding:"6px 12px 8px","border-radius":"6px",background:"#e8eaec",lineStyle:{lineType:"curve",lineWidth:2,lineColor:"rgb(120,123,128)"}},childTopic:{"font-size":"12px",color:"#f7f7f6",padding:"2px 9px 4px",lineStyle:{lineType:"roundBroken",lineWidth:1,lineColor:"rgb(120,123,128)"}}},mobpink:{background:"#fad8df",thumbUrl:"/assets/images/mind/mobpink.jpg",title:"标准思维导图样式",marginH:20,marginW:60,childMarginH:10,childMarginW:20,show:false,common:{family:"微软雅黑",bold:false,italic:false,textAlign:"left"},connectionStyle:{lineWidth:1,lineColor:"#98a2ab",color:"#fefcfc"},centerTopic:{backgroundColor:"#ea8aba",color:"#fefcfc","font-size":"20px","border-radius":"30px",padding:"10px 16px 12px"},secTopic:{color:"rgb(89,88,89)",backgroundColor:"#fff","font-size":"14px",padding:"6px 12px 8px","border-radius":"30px",lineStyle:{lineType:"curve",lineWidth:2,lineColor:"rgb(248,248,248)"}},childTopic:{"font-size":"12px",color:"rgb(89,88,89)",padding:"2px 9px 4px",lineStyle:{lineType:"roundBroken",lineWidth:1,lineColor:"rgb(255,255,255)"}}},"mob-border-dark":{background:"#fff",thumbUrl:"/assets/images/mind/mob-border-dark.jpg",title:"标准思维导图黑色",marginH:20,marginW:60,childMarginH:14,childMarginW:20,show:false,common:{family:"微软雅黑",bold:false,italic:false,textAlign:"left"},connectionStyle:{lineWidth:1,lineColor:"#98a2ab",color:"#ffffff"},centerTopic:{backgroundColor:"#000",color:"#dad8da","font-size":"20px","border-radius":"3px",padding:"10px 16px 12px"},secTopic:{color:"rbg(37,37,37)","font-size":"14px",padding:"6px 14px 7px","border-radius":"3px",border:"2px solid rgb(55,55,55)",background:"#fff",lineStyle:{lineType:"roundBroken",lineWidth:2,lineColor:"rgb(55,55,55)"}},childTopic:{"font-size":"12px",color:"rbg(45,45,45)","border-radius":"2px",padding:"3px 9px 5px",border:"1px solid rgb(55,55,55)",lineStyle:{lineType:"roundBroken",lineWidth:1,lineColor:"rgb(55,55,55)"}}},mobcaihong:{background:"#f5f5f5",thumbUrl:"/assets/images/mind/mobcaihong.jpg",title:"标准思维导图样式",thinner:true,autoColor:true,member:true,marginH:20,marginW:60,childMarginH:14,childMarginW:40,show:false,common:{family:" 微软雅黑",bold:false,italic:false,textAlign:"left"},connectionStyle:{lineWidth:1,lineColor:"#98a2ab",color:"#ffffff"},centerTopic:{backgroundColor:"rgb(80, 194, 139)",color:"#ffffff","font-size":"24px","border-radius":"6px",padding:"8px 14px 10px"},secTopic:{color:"rgb(68, 68, 68)","font-size":"16px",padding:"6px 10px 7px","border-bottom":"2px solid #888",lineStyle:{lineType:"curve",lineWidth:1,lineColor:"#8a8a8a",underLine:true}},childTopic:{"font-size":"12px",color:"rgb(68, 68, 68)",padding:"2px 9px 4px",lineStyle:{lineType:"curve",lineWidth:1,lineColor:"#8a8a8a",underLine:true}}},gsx_notes_color:{background:"#f5f5f5",thumbUrl:"/assets/images/mind/gsxnotescolor.png",title:"标准思维导图样式",member:false,newTheme:true,unilateral:true,marginH:20,marginW:60,childMarginH:10,childMarginW:20,common:{family:"arial, 黑体",bold:false,italic:false,textAlign:"left"},connectionStyle:{lineWidth:1,lineColor:"#564d47",color:"#443f3b"},centerTopic:{backgroundColor:"#f8caad",color:"#443f3b","font-size":"14px","border-radius":"6px",padding:"8px 10px 3px 10px",border:"1px solid #cdbdb3"},secTopic:{backgroundColor:"#fee2cc",color:"#514c48","font-size":"13px",padding:"5px 10px 0px 10px","border-radius":"6px",border:"1px solid #cdbdb3",lineStyle:{lineType:"roundBroken",lineWidth:1,lineColor:"#746ea6"}},childTopic:{"font-size":"12px",color:"#4b4b4b",padding:"5px 10px 0px 10px",lineStyle:{lineType:"roundBroken",lineWidth:1,lineColor:"#746e6a"}}},gsx_notes_white:{background:"#f5f5f5",thumbUrl:"/assets/images/mind/gsxnoteswhite.png",title:"标准思维导图样式",member:false,newTheme:true,unilateral:true,marginH:20,marginW:60,childMarginH:10,childMarginW:20,common:{family:"arial, 黑体",bold:false,italic:false,textAlign:"left"},connectionStyle:{lineWidth:1,lineColor:"#564d47",color:"#443f3b"},centerTopic:{backgroundColor:"#dddddd",color:"#4e4e4e","font-size":"14px","border-radius":"6px",padding:"8px 10px 5px 10px",border:"1px solid #b2afad"},secTopic:{backgroundColor:"#fff",color:"#595959","font-size":"13px",padding:"5px 10px 2px 10px","border-radius":"6px",border:"1px solid #d1cecd",lineStyle:{lineType:"roundBroken",lineWidth:1,lineColor:"#746ea6"}},childTopic:{"font-size":"12px",color:"#606060",padding:"5px 10px 0px 10px",lineStyle:{lineType:"roundBroken",lineWidth:1,lineColor:"#746e6a"}}}},getLineStyle:function(d){var e=this.model,i=this.currentRoot||e.topic,m=this.util.copy(this.styles),a=this.style;var f={};var l=e.getTopicById(d.parent);if(m.autoColor){if(!d.root){var n=e.getParentTopic(d.parent);if(n.root||n.free){var k=document.getElementById(d.id);if(n.free){k=document.getElementById(n.id)}var g=k.style;var b=(d.lineStyle&&d.lineStyle.randomLineColor)||this.util.getPtLineColor.call(this,d)||g.borderColor;if(b!=""){if(b=="initial"){b=g.backgroundColor}if(b!="initial"){f.lineColor=b}}else{if(m.thinner||(n.free&&m.underLine)){var b=g["border-bottom-color"];if(b==""){g=document.getElementById(d.id).style;b=g["border-bottom-color"]}f.lineColor=b}else{var b=a.getLineColor(i);f.lineColor=b}}}else{var c=$("#line_"+d.parent);var h=c.attr("stroke");if(h&&h!="undefined"){f.lineColor=h}else{var b=this.util.getPtLineColor.call(this,d);f.lineColor=b}}}if(!f.linecolor){f.linecolor=f.randomLineColor}}else{window.sessionStorage.removeItem("branchLineColors")}if(l.root){f=$.extend(m.secTopic.lineStyle,f,d.lineStyle)}else{f=$.extend(m.childTopic.lineStyle,f,d.lineStyle)}return f},getStyle:function(m){var h=this.model,i=h.topic,o=this.util.copy(this.styles),c=this.style;var b=null;var n=h.getParentTopic(m.parent);if(m.root||m.classic){b=$.extend({},o.common,o.centerTopic)}else{if(n.root||m.free||m.summary){if(m.summary&&o.summaryTopic&&n.root){b=$.extend({},o.common,o.summaryTopic)}else{b=$.extend({},o.common,o.secTopic)}}else{b=$.extend({},o.common,o.childTopic)}}if(i.theme=="caihongpao"){if(!m.root){var p=h.getParentTopic(m.parent);if(p.root){var a=window.localStorage.getItem("branchTopicColors");var d=c.getRadomColor();var g={};g[m.id]=d;a=$.extend(a,g);window.localStorage.setItem("branchTopicColors",JSON.stringify(a));b.backgroundColor=d;b.border="1px solid "+d}else{var f=$(".topic-box[id="+m.parent+"]");var l=f.css("background-color");b.backgroundColor=l;b.border="1px solid "+l}}}else{window.localStorage.removeItem("branchTopicColors")}b=$.extend(b,m.style);b.lineStype=$.extend(b.lineStyle,m.lineStyle);if(o.autoColor&&b.border&&b.lineStyle&&!m.root){if(m.style==null||m.style.border==null){var e=b.lineStyle.randomLineColor;var d=e||c.getLineColor(this);if(m.summary){var p=this.model.getTopicById(m.parent);if(p.style&&p.style["border-color"]){d=p.style["border-color"]}else{if(p.lineStyle&&p.lineStyle.randomLineColor){d=p.lineStyle.randomLineColor}}}var k=b.border.substring(0,b.border.lastIndexOf(" rgb"));if(k==""||k==null){k=b.border.substring(0,b.border.lastIndexOf(" #"))}b.border=k+" "+d}}return b},setRomLineColor:function(q){var h=this,g=h.model,o=g.topic,r=h.styles;var l=[];var k=o.children,n=o.leftChildren||{};var a=k.concat(n);if(r&&r.autoColor){for(var f=0;f<a.length;f++){var p=a[f],d=p.id,b=p.lineStyle||{},e={};var c=h.style.getLineColor(o);var m=$.extend({},b,{randomLineColor:c});p.lineStyle=m;e[d]={randomLineColor:c};l.push(e)}}else{for(var f=0;f<a.length;f++){var p=a[f],d=p.id,e={};if(p.lineStyle&&p.lineStyle.randomLineColor){delete p.lineStyle.randomLineColor;if(JSON.stringify(p.lineStyle)=="{}"){delete p.lineStyle}}}}return l},oldLines:[],getCurrentLineColor:function(g){var h=g.children,k=g.leftChildren||{};var a=h.concat(k),b=[];for(var f=0;f<a.length;f++){var l=a[f],d=l.id,c=l.lineStyle&&l.lineStyle.randomLineColor,e={};if(c){e[d]={randomLineColor:c};b.push(e)}}return b},setTopicStyle:function(h,e,b){var f=h.util,i=h.style.getStyle.call(h,e),a=e.style;if(h.opts.readonly){return}if(e.style){var k=$.extend(i,a);var d=f.getTopicDom(e.id);k["font-family"]=k["font-family"]!=null?k["font-family"]:k.family;k["font-style"]=k["font-style"]!=null?k["font-style"]:k.italic?"italic":"normal";k["font-weight"]=k["font-weight"]!=null?k["font-weight"]:k.bold?"bold":"normal";if(k.lineStyle&&k.lineStyle.underLine&&!k["border-width"]){var l=k.lineStyle.lineWidth||1;var c=f.getPtLineColor.call(h,e);k["border-bottom"]=l+"px solid "+c}delete k.family;delete k.italic;delete k.bold;if(k["border-style"]!=null&&k["border-width"]==null){k["border-width"]="0px"}d.removeAttr("style");d.css(k);if(k["text-decoration"]!=null&&k["text-decoration"]!="none"){d.children(".topic").css("text-decoration",k["text-decoration"])}else{d.children(".topic").removeAttr("style")}}else{var k=h.styles;var d=f.getTopicDom(e.id);var g=h.style.getStyle.call(h,e);h.renderTopicStyle(d,e,g,k)}},setTopicLineStyle:function(h,f,b,k){var g=h.util,l=h.currentRoot||h.model.topic,i=h.style.getStyle.call(h,f),a=f.lineStyle;if(h.opts.readonly||f.id==l.id){return}if(a==null&&i.lineStyle==null){return}var e=$.extend(i.lineStyle,a);var c=e.lineColor||e.randomLineColor;if(k=="clearStyle"){c=e.randomLineColor||e.lineColor}var d=document.getElementById("line_"+f.id);if(d!=null){d.removeAttribute("stroke");d.removeAttribute("stroke-width");d.setAttribute("stroke-width",e.lineWidth);d.setAttribute("stroke",c)}else{if(!c){c=g.getPtLineColor.call(h,f)}var d=$("#"+f.id);d.css({borderBottomStyle:"solid",borderBottomColor:c,borderBottomWidth:e.lineWidth})}},setTopicStyles:function(m,i,r,a,b){var l=m.util,s=m.line,k=m.model,n=m.currentRoot||m.model.topic;var q=m.operation.zoomVal/100;if(m.opts.readonly){return}r=l.copy(r);var c=k.getSubTopic(i);var f=l.getTopicContainerProp(c.id,q);var d=m.style.getStyle.call(m,i);i.style=l.copy(r);i.lineStyle=l.copy(r.lineStyle);if(i.lineStyle!=null){delete i.lineStyle.lineType;delete i.lineStyle.underLine}r=m.style.getStyle.call(m,i);var e=l.getTopicDom(i.id);r["font-family"]=r["font-family"]!=null?r["font-family"]:r.family;r["font-style"]=r["font-style"]!=null?r["font-style"]:r.italic?"italic":"normal";r["font-weight"]=r["font-weight"]!=null?r["font-weight"]:r.bold?"bold":"normal";delete r.family;delete r.italic;delete r.bold;delete r.lineStyle.lineType;delete r.lineStyle.underLine;e.removeAttr("style");e.css(r);if(r["text-decoration"]!=null&&r["text-decoration"]!="none"){e.children(".topic").css("text-decoration",r["text-decoration"])}else{e.children(".topic").removeAttr("style")}m.style.setTopicLineStyle(m,i,a);var p=l.getTopicContainerProp(c.id,q);var g=(p.h-f.h)/2;var o=p.w-f.w;m.range.doChangeSubTopicPos(m,c,g,o,a,true);m.resetTopicExpandPos(e,n.structure);m.connection.resetAllConnectionPos.call(m,n);if(i.root){a="left,right,";s.resetSubLines.call(m,a)}else{s.resetLines.call(m,[c.id],g,a)}if(b==null){m.messageSource.send.call(m,"setTopicStyle",{content:i.id,original:d,update:l.copy(r),part:a})}l.resetSelectDom()}};mindDesigner.prototype.messageSource={checkLocalStorage:function(){if(window.localStorage){return true}else{return false}},saveLocal:function(d){var b=d.model,a=b.topic,c=d.opts;if(c.readonly){return}var e=a.id;localStorage.setItem("def_"+c.chartId,JSON.stringify(a))},checkLocalValue:function(b){var a=localStorage.getItem("def_"+b);return a?a:null},isUndo:true,messages:[],send:function(e,d,b){var c=this,a=c.messageSource;if(this.currentRoot!=null){d.focus=true}a.messages.push({action:e,content:d});c.events.push("savelocal");a.submit(c,b)},submit:function(c,a){var b=this;if(b.messages.length>0){if(b.isUndo){b.undoStack.push(b,b.messages)}}if(typeof mindColla!="undefined"&&a==null){mindColla.send(b.messages)}b.messages=[]},undoStack:{stack:[],push:function(c,b,a){this.stack.push(b);if(typeof a=="undefined"){a=true}if(a){c.redoStack.stack=[]}mind.events.push("undoStackChanged",this.stack.length)},pop:function(e){var d=this,b=d.stack,a=b.length;if(a==0){return null}var c=b[a-1];b.splice(a-1,1);e.messageSource.redoStack.push(c);e.events.push("undoStackChanged",this.stack.length);return c}},redoStack:{stack:[],push:function(a){this.stack.push(a);mind.events.push("redoStackChanged",this.stack.length)},pop:function(e){var d=this,b=d.stack,a=b.length;if(a==0){return null}var c=b[a-1];b.splice(a-1,1);e.messageSource.undoStack.push(e.messageSource,c,false);e.events.push("redoStackChanged",this.stack.length);return c}},undo:function(f){var d=f.messageSource,e=f.connection,c=f.model,g=f.operation;var b=d.undoStack.pop(f);if(b==null){return}var a=b.length;d.doWithoutUndo(function(){for(var am=0;am<a;am++){var ae=b[am],m=ae.action,A=ae.content;if(m=="create"){var af=A.content;var aq=A.original;if(aq!=null&&$.isEmptyObject(aq)){aq=null}f.model.removeTopic.call(f,f.util.copyArray(af),aq,true)}else{if(m=="delete"){var af=A.content,K=A.index,ao=A.parts;var D=A.selectedIds;var aq=A.original;if(aq!=null&&$.isEmptyObject(aq)){aq=null}f.model.addTopicMulti.call(f,f.util.copyArray(af),aq,K,ao);var ak=af.length-1;if(D.length>0){f.util.clearSelect();var P=[];for(var am=0;am<D.length;am++){var O=f.model.getTopicById(D[am]);P.push(O)}f.util.select(P,f)}}else{if(m=="updateTitle"){var ab=A.content,N=A.original;var O=c.getTopicById(ab);f.model.updateTopicText.call(f,O,N)}else{if(m=="updateImage"){var ab=A.content,N=A.original,U=A.update,E=A.resize;var O=c.getTopicById(ab);var ag=f.util.copy(O);ag.image=N;f.model.updateTopicImage.call(f,ag,O,E);f.util.selectOne.call(f,O)}else{if(m=="setTheme"){var N=A.original,Y=A.newLines,au=A.oldLines;f.style.setThemeDirect_.call(f,au,Y,N)}else{if(m=="updateStructure"){var N=A.original;var H=A.oldSums;var r=A.oldBounds;g.changeStructure.call(f,N,H,r)}else{if(m=="deleteConnection"){var V=A.content;f.connection.createConnectionByLines(f,V);f.connection.addConnectionMulti(f,V)}else{if(m=="addConnection"){var V=A.content;f.connection.deleteConnectionMulti(f,V)}else{if(m=="updateConnection"){var y=A.content,aj=A.original;e.updateConnection(f,aj,y);e.createConnectionByLines(f,[aj])}else{if(m=="updatePos"){var I=A.content,x=A.original,W=A.newIndex,ar=A.oldIndex,ai=A.oldPart,k=A.newPart;var D=A.selectedIds;var H=A.oldSums;var Q=A.newSums;var r=A.oldBounds;var u=A.newBounds;if(H!=null&&$.isEmptyObject(H)){H=null}else{H=H.original}if(Q!=null&&$.isEmptyObject(Q)){Q=null}else{Q=Q.original}if(r!=null&&$.isEmptyObject(r)){r=null}else{r=r.original}if(u!=null&&$.isEmptyObject(u)){u=null}else{u=u.original}f.model._updateTopicPos.call(f,x,ar,I,W,H,Q,r,u,k,ai,null,D)}else{if(m=="changeToFreeTopic"){var t=A.content,L=A.original,T=A.index,C=A.part;var aq=A.updates_origi;if(aq!=null&&$.isEmptyObject(aq)){aq=null}var at=f.util.copy(t),z=c.getTopicById(L),ac=z.children,h={};at.parent=L;if(C=="left"&&z.root){ac=z.leftChildren}delete at.pos;delete at.free;if(T==0){var G=c.getTopicByIndex(T,ac);if(G==null){h.pos="in";h.id=L}else{h.id=G.id;h.pos="before"}h.index=T}else{var G=c.getTopicByIndex(T-1,ac);if(G==null){h.id=L;h.pos="in";h.index=T}else{h.id=G.id;h.pos="after"}}f.model.updateTopicPos.call(f,[at],aq,h,true,C);f.util.selectOne.call(f,at)}else{if(m=="updateFreeTopic"){var o=A.original,aw=A.topicIds;var af=[];for(var am=0;am<aw.length;am++){var aa=aw[am];var at=c.getTopicById(aa);af.push(at)}var au=A.oldLines,V=A.lines;c.updateFreeTopicPos.call(f,af,o,au,V)}else{if(m=="update"){var af=A.content,B=A.original,at=A.type;c.updateTopicNode.call(f,B,af,at,true)}else{if(m=="addFreeTopic"){var O=A.content;f.model.removeTopic.call(f,[O],null,true)}else{if(m=="updateBg"){var M=A.original;f.operation.setBackground.call(f,M,true)}else{if(m=="setThemeOverWrite"){var S=A.original;var ah=A.tps;var Y=A.newLines,au=A.oldLines;f.style.setThemeOverWrite_.call(f,au,Y,S,ah,"add")}else{if(m=="setTopicStyle"){var R=A.original;var aa=A.content;var at=c.getTopicById(aa);var C=A.part;f.style.setTopicStyles(f,at,R,C)}else{if(m=="changetopicexpand"){var av=A.type=="show"?"hide":"show";var aa=A.content;f.operation.showOrHideChildren.call(f,aa,av)}else{if(m=="insertParent"){var O=A.content,al=A.original,C=A.part;f.model.unInsertParentTopic.call(f,O,al,C)}else{if(m=="addSummary"){var an=A.content,ao=A.parts;var aq=A.original;if(aq!=null&&$.isEmptyObject(aq)){aq=null}f.model.removeTopic.call(f,f.util.copyArray(an),aq,true)}else{if(m=="deleteSummary"){var an=A.content;f.summary.model.addSummary.call(f,an)}else{if(m=="updateSummary"){var aj=A.original;var A=A.content;f.summary.updateSummary.call(f,aj,A)}else{if(m=="addBoundary"){var w=A.content,ao=A.parts;var aq=A.original;if(aq!=null&&$.isEmptyObject(aq)){aq=null}f.boundary.model.removeBoundary.call(f,f.util.copyArray(w),ao)}else{if(m=="deleteBoundary"){var w=A.content,ao=A.parts;f.boundary.model.addBoundary.call(f,w)}else{if(m=="updateBoundary"){var aj=A.original;var A=A.content;f.boundary.updateBoundary.call(f,aj,A)}else{if(m=="focus"){var aj=A.sourceId;var ad=A.local;if(aj==null){aj="root"}if(ad==null){f.operation.focusTopic.call(f,aj,true)}else{f.operation.focusTopic.call(f,aj)}}else{if(m=="deleteSelf"){var J=A.removed,n=A.add,X=A.addPart,p=A.removedPart,ap=A.removedIndex;f.model.addAndRemove.call(f,J,n,p,X,ap)}else{if(m=="deleteSelfRestore"){var J=A.removed,n=A.add,X=A.addPart,p=A.removedPart;f.model.removeAndAdd.call(f,J,n,p,X)}else{if(m=="hideTopics"){var Z=A.ids,ao=A.parts,v=A.withChildren;f.model.showTopics.call(f,Z,v)}else{if(m=="showTopics"){var Z=A.ids,ao=A.parts,v=A.withChildren;f.model.hideTopics.call(f,Z,v)}else{if(m=="updatePage"){var s=A.content,N=A.original;mind.operation.setMargin.call(f,N)}else{if(m=="insertTemp"){var F=A.original;var q=A.tempId;f.operation.insertTemp.call(f,F,null,q)}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}})},redo:function(f){var d=f.messageSource,e=f.connection,c=f.model,g=f.operation;var b=d.redoStack.pop(f);if(b==null){return}var a=b.length;d.doWithoutUndo(function(){for(var ag=0;ag<a;ag++){var Z=b[ag],k=Z.action,y=Z.content;if(k=="create"){var aa=y.content,P=y.index,ai=y.parts;var ak=y.updates;if(ak!=null&&$.isEmptyObject(ak)){ak=null}f.model.addTopicMulti.call(f,aa,ak,P,ai);f.util.selectDirect(aa,f)}else{if(k=="delete"){var aa=y.content;var ak=y.updates;if(ak!=null&&$.isEmptyObject(ak)){ak=null}f.model.removeTopic.call(f,aa,ak,true)}else{if(k=="updateTitle"){var X=y.content,Q=y.update;var K=c.getTopicById(X);f.model.updateTopicText.call(f,K,Q)}else{if(k=="updateImage"){var X=y.content,Q=y.update,J=y.original,C=y.resize;var K=c.getTopicById(X);var ab=f.util.copy(K);ab.image=Q;f.model.updateTopicImage.call(f,ab,K,C);f.util.selectOne.call(f,K)}else{if(k=="setTheme"){var U=y.newLines,an=y.oldLines,y=y.content;f.style.setThemeDirect_.call(f,U,an,y)}else{if(k=="updateStructure"){var y=y.content;var L=y.newSums;var s=y.newBounds;g.changeStructure.call(f,y,L,s)}else{if(k=="deleteConnection"){var R=y.content;f.connection.deleteConnectionMulti(f,R)}else{if(k=="addConnection"){var R=y.content;f.connection.createConnectionByLines(f,R);f.connection.addConnectionMulti(f,R)}else{if(k=="updateConnection"){var w=y.content,ae=y.original;e.updateConnection(f,w,ae);e.createConnectionByLines(f,[w])}else{if(k=="updatePos"){var F=y.content,v=y.original,S=y.newIndex,al=y.oldIndex,ad=y.oldPart,h=y.newPart;var B=y.selectedIds;var E=y.oldSums;var L=y.newSums;var p=y.oldBounds;var s=y.newBounds;if(E!=null&&$.isEmptyObject(E)){E=null}else{E=E.updates}if(L!=null&&$.isEmptyObject(L)){L=null}else{L=L.updates}if(p!=null&&$.isEmptyObject(p)){p=null}else{p=p.updates}if(s!=null&&$.isEmptyObject(s)){s=null}else{s=s.updates}f.model._updateTopicPos.call(f,F,S,v,al,L,E,s,p,ad,h,null,B)}else{if(k=="changeToFreeTopic"){var r=y.content,H=y.original,P=y.index;var ak=y.updates;if(ak!=null&&$.isEmptyObject(ak)){ak=null}var x=f.util.copy(r);var N=x.pos;delete x.pos;delete x.free;x.parent=H;c.changeToFreeTopic.call(f,x,ak,N)}else{if(k=="updateFreeTopic"){var N=y.content,ap=y.topicIds;var aa=[];for(var ag=0;ag<ap.length;ag++){var W=ap[ag];var am=c.getTopicById(W);aa.push(am)}c.updateFreeTopicPos.call(f,aa,N)}else{if(k=="update"){var aa=y.content,z=y.original,am=y.type;c.updateTopicNode.call(f,aa,z,am,true)}else{if(k=="addFreeTopic"){var K=y.content;c.addFreeTopic(K,K.pos,f)}else{if(k=="updateBg"){var I=y.content;f.operation.setBackground.call(f,I,true)}else{if(k=="setThemeOverWrite"){var U=y.newLines,an=y.oldLines;var O=y.content;var ac=y.tps;f.style.setThemeOverWrite_.call(f,U,an,O,ac,"delete")}else{if(k=="setTopicStyle"){var M=y.update;var W=y.content;var am=c.getTopicById(W);var A=y.part;f.style.setTopicStyles(f,am,M,A)}else{if(k=="changetopicexpand"){var ao=y.type;var W=y.content;f.operation.showOrHideChildren.call(f,W,ao)}else{if(k=="insertParent"){var K=y.content,af=y.original,A=y.part;f.model.insertParentTopic.call(f,K,af,A)}else{if(k=="addSummary"){var ah=y.content;f.summary.model.addSummary.call(f,ah)}else{if(k=="deleteSummary"){var ah=y.content,ai=y.parts;f.summary.model.removeSummary.call(f,ah,ai)}else{if(k=="updateSummary"){var ae=y.original;var y=y.content;f.summary.updateSummary.call(f,y,ae)}else{if(k=="addBoundary"){var u=y.content;f.boundary.model.addBoundary.call(f,u)}else{if(k=="deleteBoundary"){var u=y.content,ai=y.parts;f.boundary.model.removeBoundary.call(f,u,ai)}else{if(k=="updateBoundary"){var ae=y.original;var y=y.content;f.boundary.updateBoundary.call(f,y,ae)}else{if(k=="focus"){var n=y.targetId;var Y=y.local;if(Y==null){f.operation.focusTopic.call(f,n,true)}else{f.operation.focusTopic.call(f,n)}}else{if(k=="deleteSelf"){var G=y.removed,l=y.add,T=y.addPart,m=y.removedPart;f.model.removeAndAdd.call(f,G,l,m,T)}else{if(k=="deleteSelfRestore"){var G=y.removed,l=y.add,T=y.addPart,m=y.removedPart,aj=y.removedIndex;f.model.addAndRemove.call(f,G,l,m,T,aj)}else{if(k=="hideTopics"){var V=y.ids,ai=y.parts,t=y.withChildren;f.model.hideTopics.call(f,V,t)}else{if(k=="showTopics"){var V=y.ids,ai=y.parts,t=y.withChildren;f.model.showTopics.call(f,V,t)}else{if(k=="updatePage"){var q=y.content,J=y.original;mind.operation.setMargin.call(f,q)}else{if(k=="insertTemp"){var D=y.content;var o=y.tempId;f.operation.insertTemp.call(f,D,null,o)}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}})},doWithoutUndo:function(a){this.isUndo=false;a();this.isUndo=true},excuteMsgDirect:function(ac,X){var W=this,d=W.model,U=ac.uk,ad=ac.client,K=ac.msg,aq=[],J=W.operation;if(ac.type!=null&&ac.type=="forceRefresh"){W.events.push("refresh");return}for(var ah=0;ah<K.length;ah++){var Y=K[ah],c=Y.action,t=Y.content;if(c=="create"){var Z=t.content,M=t.index,aj=t.parts;var al=t.updates;if(al!=null&&$.isEmptyObject(al)){al=null}d.addTopicMulti.call(W,Z,al,M,aj,true);aq.push(Z[0].id)}else{if(c=="delete"){var Z=t.content;var al=t.updates;if(al!=null&&$.isEmptyObject(al)){al=null}W.model.removeTopic.call(W,Z,al,true,true)}else{if(c=="updateTitle"){var V=t.content,N=t.update;var E=d.getTopicById(V);W.model.updateTopicText.call(W,E,N,true);aq.push(E.id)}else{if(c=="updateImage"){var V=t.content,N=t.update,F=t.original,x=t.resize;var E=d.getTopicById(V);var aa=W.util.copy(E);aa.image=N;W.model.updateTopicImage.call(W,aa,E,x,true);aq.push(E.id)}else{if(c=="setTheme"){var R=t.newLines,ao=t.oldLines;var t=t.content;W.style.setThemeDirect_.call(W,R,ao,t,true)}else{if(c=="updateStructure"){var t=t.content;var G=t.newSums;var n=t.newBounds;J.changeStructure.call(W,t,G,n,null,true)}else{if(c=="deleteConnection"){var O=t.content;W.connection.deleteConnectionMulti(W,O,true)}else{if(c=="addConnection"){var O=t.content;W.connection.createConnectionByLines(W,O);W.connection.addConnectionMulti(W,O,true)}else{if(c=="updateConnection"){var r=t.content,af=t.original;W.connection.updateConnection(W,r,af,true);W.connection.createConnectionByLines(W,[r])}else{if(c=="updatePos"){var A=t.content;if(t.moveFromOutline){var b=t.target;d.updateTopicPos.call(W,A,null,b,null,null,null,true);continue}var q=t.original,P=t.newIndex,am=t.oldIndex,ae=t.oldPart,a=t.newPart;var w=t.selectedIds;var z=t.oldSums;var G=t.newSums;var k=t.oldBounds;var n=t.newBounds;if(z!=null&&$.isEmptyObject(z)){z=null}else{z=z.updates}if(G!=null&&$.isEmptyObject(G)){G=null}else{G=G.updates}if(k!=null&&$.isEmptyObject(k)){k=null}else{k=k.updates}if(n!=null&&$.isEmptyObject(n)){n=null}else{n=n.updates}W.model._updateTopicPos.call(W,A,P,q,am,G,z,n,k,ae,a,true,w)}else{if(c=="changeToFreeTopic"){var m=t.content,C=t.original,M=t.index;var al=t.updates;if(al!=null&&$.isEmptyObject(al)){al=null}var s=W.util.copy(m);var I=s.pos;delete s.pos;delete s.free;s.parent=C;d.changeToFreeTopic.call(W,s,al,I,true)}else{if(c=="updateFreeTopic"){var I=t.content,f=t.original,aq=t.topicIds;var Z=[];for(var ah=0;ah<aq.length;ah++){var T=aq[ah];var an=d.getTopicById(T);Z.push(an)}d.updateFreeTopicPos.call(W,Z,I,null,null,true)}else{if(c=="update"){var Z=t.content,u=t.original,an=t.type;d.updateTopicNode.call(W,Z,u,an,true,true)}else{if(c=="addFreeTopic"){var E=t.content;d.addFreeTopic(E,E.pos,W,true);aq.push(E.id)}else{if(c=="updateBg"){var D=t.content;W.operation.setBackground.call(W,D,true,true)}else{if(c=="setThemeOverWrite"){var L=t.content;var ab=t.tps;var R=t.newLines,ao=t.oldLines;W.style.setThemeOverWrite_.call(W,R,ao,L,ab,"delete",true)}else{if(c=="setTopicStyle"){var H=t.update;var T=t.content;var an=d.getTopicById(T);var v=t.part;W.style.setTopicStyles(W,an,H,v,true);aq.push(an.id)}else{if(c=="changetopicexpand"){var ap=t.type;var T=t.content;W.operation.showOrHideChildren.call(W,T,ap,true);aq.push(T)}else{if(c=="insertParent"){var E=t.content,ag=t.original,v=t.part;W.model.insertParentTopic.call(W,E,ag,v,true)}else{if(c=="addSummary"){var ai=t.content;W.summary.model.addSummary.call(W,ai,true)}else{if(c=="deleteSummary"){var ai=t.content,aj=t.parats;W.summary.model.removeSummary.call(W,ai,aj,true)}else{if(c=="updateSummary"){var af=t.original;var t=t.content;W.summary.updateSummary.call(W,t,af,true)}else{if(c=="addBoundary"){var p=t.content;W.boundary.model.addBoundary.call(W,p,true)}else{if(c=="deleteBoundary"){var p=t.content,aj=t.parts;W.boundary.model.removeBoundary.call(W,p,aj,true)}else{if(c=="updateBoundary"){var af=t.original;var t=t.content;W.boundary.updateBoundary.call(W,t,af,true)}else{if(c=="focus"){var h=t.targetId;W.operation.focusTopic.call(W,h,true,true)}else{if(c=="deleteSelf"){var B=t.removed,e=t.add,Q=t.addPart,g=t.removedPart;W.model.removeAndAdd.call(W,B,e,g,Q,true)}else{if(c=="deleteSelfRestore"){var B=t.removed,e=t.add,Q=t.addPart,g=t.removedPart,ak=t.removedIndex;W.model.addAndRemove.call(W,B,e,g,Q,ak,true)}else{if(c=="hideTopics"){var S=t.ids,aj=t.parts,o=t.withChildren;W.model.hideTopics.call(W,S,o,true);mind.plugins.navigator.init.call(mind)}else{if(c=="showTopics"){var S=t.ids,aj=t.parts,o=t.withChildren;W.model.showTopics.call(W,S,o,true);mind.plugins.navigator.init.call(mind)}else{if(c=="updatePage"){var l=t.content,F=t.original;mind.operation.setMargin.call(W,l,true)}else{if(c=="insertTemp"){var y=t.content,F=t.original;mind.operation.insertTemp.call(W,y,null,null,true)}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}if(X!=null){X(aq,U)}W.util.getTopicsLen.call(W)}};mindDesigner.prototype.plugins={showContextMenu:function(k,b){var o=this,m=o.model,n=o.util,e=o.connection,g=o.operation,h=o.plugins;o.events.push("hidepopeditor");o.operation.hideLink();var i=$(window).width(),f=$(window).height();var c=$(".mind-context-menu");if(c.is(":visible")){return}c.attr("activeId",b);c.hide();var d=g.zoomVal/100;var r=n.getRealPos.call(o,k.offset().left,k.offset().top);var a={x:r.x,y:r.y,h:k.outerHeight(),w:k.outerWidth()};c.appendTo(o.designer);c.css({left:a.x+a.w,top:a.y-30,opacity:0}).show();var q=a.x+a.w;var p=a.y-30;if(k.offset().top-30+c.outerHeight()>f){}if(k.offset().left+a.w+c.outerWidth()>i){}c.stop().animate({left:q,top:p,opacity:1,"z-index":9},10);var l=m.getTopicById(b);mind.events.push("setContextMenu",l);if(l.number){$("[op=level][type="+l.number.level+"]").addClass("selected").siblings("[op=level]").removeClass("selected");$("[op=number][type="+l.number.type+"]").addClass("selected").siblings("[op=number]").removeClass("selected")}else{$("[op=level][type='1']").addClass("selected").siblings("[op=level]").removeClass("selected");$("[op=number][type=none]").addClass("selected").siblings("[op=number]").removeClass("selected");$("[op=level]").addClass("disable")}if(l.summary){$("[op=expand-all]").addClass("disable")}if(l.collapsed){$("[op=expand]").text("展开主题");$("[op=expand-all]").text("展开同级全部主题")}else{$("[op=expand]").text("收起主题");$("[op=expand-all]").text("收起同级全部主题")}c.children(".mind-context-menu-content").find("li").off().on("click",function(z){z.stopPropagation();var w=$(this),x=w.attr("op");if(w.hasClass("disable")){return}if(x=="copy"){var u=n.selectedIds;if(u.length>0){m.doCopy.call(o,u)}}else{if(x=="cut"){var u=n.selectedIds;if(u.length>0){var F=$(".topic-box.selected").map(function(){return $(this).attr("id")}).get();m.doCut.call(o,F)}}else{if(x=="paste"){var u=n.getSelectedId();if(u!=""){m.doPaste.call(o,u)}var C=m.getTopicById(u);n.selectOne.call(o,C)}else{if(x=="insert-child"){var C=g.appendTopic.call(o,true);mind.events.push("setDock",C)}else{if(x=="remark"){mind.events.push("showRightMenu","remark")}else{if(x=="link"){mind.events.push("showRightMenu","link")}else{if(x=="tag"){mind.events.push("showRightMenu","tag")}else{if(x=="task"){mind.events.push("showRightMenu","task")}else{if(x=="image"){mind.events.push("showRightMenu","image")}else{if(x=="icon"){mind.events.push("showRightMenu","icon")}else{if(x=="insert-siblings"){g.appendTopic.call(o,false)}else{if(x=="insert-parent"){g.insertParent.call(o,l)}else{if(x=="insert-connection"){e.render.call(mind,z)}else{if(x=="delete"){g.removeTopic.call(o)}else{if(x=="delete-self"){g.removeTopicSelf.call(o)}else{if(x=="focus"){g.focusTopic.call(o)}else{if(x=="hideall"){g.hideTopics.call(o,true)}else{if(x=="openall"){g.showTopics.call(o,true)}else{if(x=="number"){var A=w.attr("type"),s=$("[op=level].selected").attr("type");var u=n.selectedIds;if(u.length==0||w.hasClass("selected")){return false}$("[op=level]").removeClass("disable");if(A=="none"){$("[op=level]").addClass("disable")}w.addClass("selected").siblings("[op=number]").removeClass("selected");o.operation.setNumber.call(o,u,A,s);return false}else{if(x=="level"){var A=$("[op=number].selected").attr("type"),s=w.attr("type");var u=n.selectedIds;if(u.length==0||w.hasClass("selected")){return false}w.addClass("selected").siblings("[op=level]").removeClass("selected");o.operation.setNumber.call(o,u,A,s);return false}else{if(x=="download-part"){mind.events.push("downloadPart",o.util.getSelectedId())}else{if(x=="expand"){var A=l.collapsed?"show":"hide";var E=A=="show"?"收起主题":"展开主题";w.text(E);o.operation.showOrHideChildren.call(o,b,A)}else{if(x=="expand-all"){var A=l.collapsed?"show":"hide";var y=o.currentRoot||m.topic;var B=o.model.getParentTopics(b);var D=0;for(var v=0;v<B.length;v++){D++;if(B[v].summary){y=B[v];break}}o.operation.showOrHideLevelChildren.call(o,D,A,y)}else{if(x=="equation"){poCollect("点击-右键菜单-LaTeX方程式",{"来源":"思维导图","用户属性":typeof mindUI!="undefined"?mindUI.member?"会员用户":"普通用户":""});o.operation.editTopicDom.call(o,b);o.model.poPasteType="editpaste";var t=$("#area_"+b);if(t.find("li").length>0){t.find("li").textMoveToEnd()}else{t.textMoveToEnd()}o.operation.equationInit(t)}}}}}}}}}}}}}}}}}}}}}}}}h.hideContextMenu()})},hideContextMenu:function(){var a=$(".mind-context-menu");a.hide()},showSummaryTip:function(b,h){var g=$("#"+h).find(".summary-dot");if(g.length>0){var a=b.util.getSelectedPartByPos(h);var f=$(".mind-summary-menu"),e=g.offset();var d=e.left+20;var c=e.top+f.height()/2;if(a=="left"){d=e.left-f.width()}if(d<10){d=10}f.css({left:d,top:c});f.show();b.summary.initEvent.call(b,h)}},showBoundaryTip:function(b,h){var g=$(".boundary-dot[bound-id="+h+"]");if(g.length>0){var a=b.util.getSelectedPartByPos(h);var f=$(".mind-boundary-menu"),e=g.offset();var d=e.left+20;var c=e.top+f.height()/2;if(a=="left"){d=e.left-f.width()}if(d<10){d=10}f.css({left:d,top:c});f.show();b.boundary.initEvent.call(b,h)}},hideSummaryTip:function(){var a=$(".mind-summary-menu");a.hide()},hideBoundaryTip:function(){var a=$(".mind-boundary-menu");a.hide()},showConnectionTip:function(a,d){var g=$(".mind-connection-menu");var f=$(".mind-connection-con[conn="+a.id+"]").find(".mind-icons"),e=f.offset();g.css({left:e.left+f.outerWidth()+10,top:e.top+f.outerHeight()/2-4});g.find(".active").removeClass("active");var c=a.styles;var b=c.lineColor;if(b!=null&&b.indexOf("rgb")>=0){b=d.util.getHexColor(b).hex}if(b!=null){g.find("[ac="+b+"]").addClass("active")}g.find("[alt=type] [ac="+c.lineType+"]").addClass("active");g.find("[alt=width] [ac="+c.lineWidth+"]").addClass("active");g.find("[alt=arrow] [ac="+c.lineArrow+"]").addClass("active");g.show()},hideConnectionTip:function(){var a=$(".mind-connection-menu");a.hide();this.hideSummaryTip();this.hideBoundaryTip()},showIconsMenu:function(h,e){var f=this,c=f.icons;$("#mind-icons-box").remove();var a=$("<div id='mind-icons-box'></div>").appendTo(f.designer);var b=c.icons;var i=b[h.name];d(i,e);function k(l){$(document).off("mouseup.icons").on("mouseup.icons",function(m){$("#mind-icons-box").remove();l.removeClass("selected")});$(document).on("mouseup.icons","#mind-icons-box",function(m){m.stopPropagation()});$(document).on("mousedown.icons","#mind-icons-box",function(m){m.stopPropagation()});$(document).off("click.icons").on("click.icons","#mind-icons-box .mind-icons",function(m){var n=$(this);if(n.attr("remove")){c.removeIcon.call(f);a.remove()}else{c.setIcon.call(f,n,true)}m.stopPropagation()});$(document).off("click.iconcolors").on("click.iconcolors",".mind-icons-color span",function(n){var o=$(this),m=o.css("background-color");c.setIconColor.call(f,m);n.stopPropagation()})}function d(q,s){var p=["<div>"];for(var o=0,l=q.length;o<l;o++){var r=q[o];p.push("<span n='"+h.name+"' ico='"+r.index+"' class='mind-icons'>"+r.text+"</span>")}p.push("<span remove='true' style='color:#ff0000;' class='mind-icons'>&#xe60c;</span><span style='clear:both;'></span></div>");a.css({left:s.offset().left,top:s.offset().top+36});p.push("<div style='clear:both;min-height:1px;'></div><div class='mind-icons-color'>");var m=mind.style.baseColor();for(var o=0,l=m.length;o<l;o++){var n=m[o];p.push("<span style='background:"+n+";'></span>")}p.push("</div>");a.html(p.join(""));g(h,a,s);k(s)}function g(m,l,n){l.find("span").removeClass("selected");if(m.name==""){n.parent().find("span[n='']").each(function(){var o=$(this);l.find("span[ico="+o.attr("ico")+"]").addClass("selected")})}else{l.find("span[ico="+m.index+"]").addClass("selected")}}},selectDefaultIcon:function(){},hideIconsMenu:function(){},showTopicsLen:function(){var f=this,c=f.util,e=$("#mind_topics_details"),a=e.find(".topics_details_len"),d=c.selectedIds.length,b=c.getTopicsLen.call(this);if(d&&d>0){b=d+"/"+c.getTopicsLen.call(this)}a.html(b);f.events.push("initSearchEvent")},showGlobalMenu:function(c,a,d){var b=$(".mind-context-global-menu");if(b.length){b.css({left:a,top:d,opacity:1}).show();if(c.currentRoot!=null){}mind.events.push("setContextMenuGlobal",c);b.find("li").off().on("click",function(g){var f=$(this),h=f.attr("op");if(f.hasClass("disable")){return}if(h=="torefresh"){window.location.reload()}else{if(h=="tonew"){c.events.push("toNew")}else{if(h=="insert-free"){}else{if(h=="tocenter"){c.operation.moveToCenter.call(c)}else{if(h=="hideall"){c.operation.hideTopics.call(c,false)}else{if(h=="openall"){c.operation.showTopics.call(c,false)}}}}}}c.plugins.closeGlobalMenu()})}},closeGlobalMenu:function(a,c){var b=$(".mind-context-global-menu");if(b.length){b.hide().css({opacity:0})}},navigator:{baseCalc:null,globalPos:null,init:function(){if(typeof showCanvas=="undefined"){return}var g=this,k=g.plugins.navigator;var a=$(".mind-canvas-con");if(a.length==0){var d="",h="关闭视图导航";if(showCanvas=="false"){d='style="display:none;"';h="显示视图导航"}a=$('<div class="mind-canvas-con"><div id="mind_topics_details" class="mind_topics_details">主题：<span class="topics_details_len">1</span></div><div id="brain-power" class="mind-help-menu brainpower" title_pos="top" title="帮助"><span class="mind-icons">&#xe748;</span></div><div style="position:absolute;bottom:32px;right:10px"><div '+d+' class="mind-canvas"><canvas></canvas></div></div><div class="mind-canvas-op"></div></div>');$("body").append(a);var f=a.children(".mind-canvas-op");var c='<span style="display: none;" tit="power" title_pos="top" title="帮助" class="mind-icons">&#xe677;</span><span tit="full" title="全屏" title_pos="top" class="mind-icons">&#xe665;</span><span title="'+h+'" title_pos="top" tit="close" class="mind-icons">&#xe705;</span><span title="定位到中心主题" title_pos="top" tit="focus" class="mind-icons">&#xe60e;</span><span title="缩小" title_pos="top" tit="zoomout" class="mind-icons mind-zoomout">&#xe615;</span><span title_pos="top" title="重置缩放" tit="zoomtext" class="mind-zoomtxt">100%</span><span title="放大" title_pos="top" tit="zoomin" class="mind-icons mind-zoomin" style="margin-right:0;">&#xe630;</span><span><label class="sep" style="height:12px"></label></span>';f.append(c);if(showCanvas=="false"){f.children("[tit=close]").addClass("active");f.children("[tit=close]").html("&#xe706;")}}var i=k.calcPos(false,true),e=245,b=171;k.globalPos=i;var l=k.calcCanvasSize(i,e,b);k.setCanvasStyle(l.w,l.h);k.render(i,l,e,b);g.plugins.showTopicsLen.call(g);k.initEvent(g)},initEvent:function(c){var d=$(".mind-canvas-con"),e=d.children(".mind-canvas-op");var b=$("#mind_con").children(".mind-designer");var a=this;e.children().off("mousedown").on("mousedown",function(i){$(document).on("selectstart",function(){return false});var h=$(this),f=h.attr("tit");if(f=="full"){var g=document.documentElement;if(g.requestFullscreen){g.requestFullscreen()}else{if(g.mozRequestFullScreen){g.mozRequestFullScreen()}else{if(g.webkitRequestFullscreen){g.webkitRequestFullscreen()}else{$.showTip("当前浏览器不支持全屏操作，请使用其他浏览器尝试",2000)}}}$(document).off("selectstart");i.stopPropagation()}else{if(f=="focus"){c.operation.moveToCenter.call(c)}else{if(f=="zoomout"){c.operation.zoomOut.call(c,c.designer);var k=c.operation.zoomVal;d.find(".mind-zoomtxt").text(k+"%")}else{if(f=="zoomin"){c.operation.zoomIn.call(c,c.designer);var k=c.operation.zoomVal;d.find(".mind-zoomtxt").text(k+"%")}else{if(f=="zoomtext"){c.operation.zoomVal=85;c.operation.zoomIn.call(c,c.designer);d.find(".mind-zoomtxt").text("100%")}else{if(f=="close"){if(h.hasClass("active")){a.showCanvas();h.removeClass("active");c.operation.setConfig("canvas","true");h.attr("title","关闭视图导航");h.html("&#xe705;")}else{a.hideCanvas();h.addClass("active");h.html("&#xe706;");c.operation.setConfig("canvas","false");h.attr("title","显示视图导航")}}else{if(f=="power"){$("#brain-power").trigger("click")}}}}}}}});$("#brain-power").off().on("click",function(){$("#btn_brain_power").trigger("click")});e.children().off("mouseup").on("mouseup",function(){$(document).off("selectstart")})},resetCanvas:true,showCanvas:function(){var a=$(".mind-canvas");a.show()},hideCanvas:function(){var a=$(".mind-canvas");a.hide()},render:function(h,m,i,f){if(!this.resetCanvas){return}var d=$("#mind_con"),l=d.children(".mind-designer"),a=l.find(".topic-box");var b=$(".mind-canvas").children("canvas")[0];var k=b.getContext("2d");k.clearRect(0,0,b.width,b.height);var c=m.w/h.w;var e=mind,g=e.currentRoot||e.model.topic;this.baseCalc=c;a.each(function(s,q){var u=$(q),r=u.offset(),n=u.attr("id");var A=r.left,v=r.top,B=u.outerWidth()*(c),t=u.outerHeight()*(c);var p=(A-h.x)*(c);var o=(v-h.y)*(c);var z=u[0].style.backgroundColor;k.save();if(n==g.id){if(z=="rgb(255, 255, 255)"){z="#57a8ca"}k.fillStyle=z}else{k.fillStyle="#d0d0d0"}k.fillRect(p,o,B,t);k.restore()});this.renderViewport(h,c)},renderViewport:function(){if(!this.resetCanvas){return}var b=$(".mind-canvas"),c=b.find("canvas");if(c.length==0){return}var e=this.baseCalc;var i=this.calcPos(false,true);this.globalPos=i;var g=this.calcPos(true,false);if(isNaN(g.w)||isNaN(g.h)){$(".viewport").hide();return}else{$(".viewport").show()}var d=c.position().left,h=c.position().top;var a=g.x-i.x,l=g.y-i.y;var k=b.children(".viewport");if(k.length==0){k=$('<div class="viewport"></div>');$(".mind-canvas").append(k)}f();function f(){var m=g.w*e;var n=g.h*e;k.css({left:a*e+d,top:l*e+h,width:m-4,height:n-4})}this.initViewportEvent()},initViewportEvent:function(f){var d=$(".mind-canvas"),b=d.find("canvas");var f=d.children(".viewport");var c=this.baseCalc;var a=this;var e=$(document);f.on("mousedown",function(m){var p=m.pageX,o=m.pageY;var s=f.position().left,r=f.position().top;var t=f.outerWidth(),n=f.outerHeight();var i=f.parent(),q=i.width(),k=i.height();var l=$("#mind_con"),h=l.scrollLeft(),g=l.scrollTop();e.on("selectstart",function(){return false});e.off("mousemove.nav").on("mousemove.nav",function(A){var y=A.pageX,z=A.pageY;var w=y-p,u=z-o;var x=s+w;var v=r+u;f.css({left:x,top:v});l.scrollLeft(h+w/c);l.scrollTop(g+u/c);A.stopPropagation()});e.off("mouseup.nav").on("mouseup.nav",function(u){e.off("mousemove.nav");e.off("mouseup.nav");e.off("selectstart");u.stopPropagation()});m.stopPropagation()});d.off("mousedown").on("mousedown",function(o){var n=$("#mind_con"),k=n.scrollLeft(),g=n.scrollTop();var s=d.children(".viewport");if(!s.is(":visible")){s.css({width:120,height:60,left:65,top:55.5}).show();mind.operation.moveToCenter.call(mind);o.stopPropagation();return}var l=s.position().left;var i=s.position().top;var r=s.width();var m=s.height();var q=o.offsetX-r/2,p=o.offsetY-m/2;s.css({left:q,top:p});n.scrollLeft(k+(q-l)/c);n.scrollTop(g+(p-i)/c);a.renderViewport();o.stopPropagation()});d.off("mouseup").on("mouseup",function(g){e.off("mousemove.nav");e.off("mouseup.nav");e.off("selectstart");a.renderViewport();g.stopPropagation()})},setCanvasStyle:function(a,e){var b=$("#mind_con"),d=b.children(".mind-designer");var c=$(".mind-canvas").children("canvas")[0];c.width=a;c.height=e},calcCanvasSize:function(e,a,c){var b=e.w*c/e.h,d=c;if(b>a){b=a;d=e.h*a/e.w}return{w:b,h:d}},calcPos:function(h,d){var b=null;if(d){b=$(".mind-designer").children(".topic-container")}else{b=$(".mind-designer").find(".topic-box")}var f="first",e=0,c=0,a=0;var i=$(window).width(),g=$(window).height();b.each(function(l,n){var k=$(n),m=k.offset();if(h&&m.left<0){return true}else{if(h&&m.top<0){return true}else{if(h&&m.top+k.outerHeight()>g){return true}else{if(h&&m.left+k.outerWidth()>i){return true}}}}if(f=="first"){f=m.left;e=m.top}if(m.left<f){f=m.left}if(m.top<e){e=m.top}if(m.left+k.outerWidth()>c){c=m.left+k.outerWidth()}if(m.top+k.outerHeight()>a){a=m.top+k.outerHeight()}});return{x:f,y:e,w:c-f,h:a-e}}},presenter:{sliders:[],sliderIndex:0,selecting:false,presenting:false,presentingIndex:0,beforeSelecting:false,ready:function(a){if(this.sliders.length==0){$.showTip("close");$.showTip("[ Ctrl + 拖拽 ] 选择并添加幻灯片",2000);return}a.util.clearSelect();a.events.push("hideElements");this.renderControls(a);this.presenting=true},calcScale:function(d){var e=$(window).width()-80,c=$(window).height()-40;var b=e/d.w,a=c/d.h;if(b<=a){return b}else{return a}},keyEvent:function(b,a){if(b.keyCode==37||b.keyCode==38){if(this.presenting){this.prevSlide(a)}}else{if(b.keyCode==39||b.keyCode==40){if(this.presenting){this.nextSlide(a)}}else{if(b.keyCode==46||b.keyCode==8){this.deleteSlider(this.sliderIndex);this.saveSliders(a)}else{if(b.keyCode==27){this.exitShowSlide(a)}}}}},nextSlide:function(a){this.presentingIndex++;this.toSlide(a,this.presentingIndex)},prevSlide:function(a){this.presentingIndex--;this.toSlide(a,this.presentingIndex)},toSlide:function(h,i){var l=this.sliders,g=l[i];if(g==null){if(i>=l.length){this.presentingIndex=l.length-1}else{if(i<0){this.presentingIndex=0}}return}else{this.presentingIndex=i}var d=g.pos;var e=this.calcScale(d);var c=$(window).width(),m=$(window).height();var b=h.container,k=h.designer;var f=d.x-c/2+d.w/2;var a=d.y-m/2+d.h/2;b.stop().animate({scrollLeft:f,scrollTop:a},500);k.css({"transform-origin":(d.x+d.w/2)+"px "+(d.y+d.h/2)+"px 0px",transition:"all 1s",transform:"scale("+(e)+")"});h.operation.zoomVal=e*100;$(".mind-slide-controls").children().removeClass("active");$(".mind-slide-controls").children().eq(i).addClass("active");this.changeTopicStatus(i,h)},exitShowSlide:function(c){var a=c.container,b=c.designer;b.css({"transform-origin":"50% 50%",transition:"all 1s",transform:"scale(1)"});c.operation.moveToCenter.call(c);c.events.push("showElements");c.operation.zoomVal=100},changeTopicStatus:function(h,g){var k=this.sliders;$(".topic-box").addClass("mind-slide-disable");var p=$("g").children("path");p.css({opacity:"0.06"});for(var e=0;e<k.length;e++){if(e==h){var b=k[e].ids;$(b).removeClass("mind-slide-disable");var a=b.split(",");for(var d=0,f=a.length;d<f;d++){var c=a[d],n=c.substring(1);var o=g.connection.getConnectionsByTopic.call(g,n);$("#line_"+n).css({opacity:1});if($("#sum_"+n).length>0){$("#sum_"+n).css({opacity:1})}if(o.length>0){for(var m=0;m<o.length;m++){var l=o[m].id;$("#line_"+l).children("path").css({opacity:1})}}}}}},renderSelections:function(f){var e=this.sliders,b=e.length,g=this;$(".mind-slide-selection").remove();if(b>0){for(var c=0;c<b;c++){var a=e[c];var d=$("<div idx="+a.index+" class='mind-slide-selection'><span class='selection-index'>"+(a.index+1)+"</span></div>");d.appendTo(".mind-designer");d.css({left:a.pos.x,top:a.pos.y,width:a.pos.w,height:a.pos.h});d.find(".selection-index").show()}$(document).off("click.mss",".mind-slide-selection").on("click.mss",".mind-slide-selection",function(){var h=$(this);g.focusSelection(h)});g.initDotEvent(f)}return b},renderControls:function(e){var a=this;var d=this.sliders,c="<div class='mind-slide-controls'>";for(var b=0;b<d.length;b++){c+="<span idx='"+b+"'></span>"}c+="</div>";var f=$(c);f.appendTo("body").css({left:"50%"});$(document).off("click.slidecontrols",".mind-slide-controls > span").on("click.slidecontrols",".mind-slide-controls > span",function(){var h=$(this),g=h.attr("idx");a.toSlide(e,g)})},renderSelection:function(){var b=this;var a=$("<div class='mind-slide-selection'><span class='selection-index'></span></div>");a.appendTo(".mind-designer");this.focusSelection(a);$(document).off("click.mss",".mind-slide-selection").on("click.mss",".mind-slide-selection",function(){var c=$(this);b.focusSelection(c)});return a},focusSelection:function(b){$(".selection-dot").remove();$(".selection-del").remove();b.addClass("active");b.siblings(".mind-slide-selection").removeClass("active");var a=$("<span title='删除' onclick='mind.plugins.presenter.deleteOneSlider.call(mind)' class='selection-del mind-icons'>&#xe622;</span><span class='selection-dot lt'></span><span class='selection-dot rt'></span><span class='selection-dot lb'></span><span class='selection-dot rb'></span>");this.sliderIndex=b.attr("idx");a.appendTo(b)},setSelectionPos:function(a,b){a.css({left:b.x-0,top:b.y-0,width:b.w+0,height:b.h+0})},deleteOneSlider:function(){var a=this,b=a.plugins.presenter;b.deleteSlider(b.sliderIndex);b.saveSliders(a);$("#mind_hover_tip").remove()},deleteSlider:function(c){$(".mind-slide-selection[idx="+c+"]").remove();this.sliders.splice(c,1);var b=this.sliders.length;for(var d=0;d<b;d++){if(d>=c){var a=this.sliders[d];a.index-=1;$(".mind-slide-selection[idx="+(d+1)+"]").attr("idx",d);$(".mind-slide-selection[idx="+d+"]").children("span").text(d+1)}}},resetSelectionByTopics:function(k,c,a,v,b){var u=$(".topic-box.selected");var d={},s=k.x,q=k.y,r=k.x+k.w,p=k.y+k.h;for(var l=0,m=u.length;l<m;l++){var o=$(u[l]),e=o.offset(),g=o.outerWidth(),n=o.outerHeight();var t=e.left/b,f=e.top/b;if(c+t<s){s=c+t}if(c+t+g>r){r=c+t+g}if(a+f<q){q=a+f}if(a+f+n>p){p=a+f+n}}var e={x:s,y:q,w:r-s,h:p-q};this.setSelectionPos(v,e);return e},setSelectedRealTime:function(f,c,b,e,d){var a={x:f.x-c,y:f.y-b,w:f.w,h:f.h};var h=d.util.getTopicsByRange(a,e);if(h.length==0){return h}h[0]="#"+h[0];var g=h.join(",#");$(".topic-box").removeClass("selected");$(g).addClass("selected");return g},saveSliders:function(b){var a=this.sliders;b.events.push("saveSliders",a)},initEvent:function(m,p,o,n){var s=m.designer,c=m.container,l=m.plugins.presenter,r=m.operation.zoomVal/100;var q=this.renderSelection();var k=p/r,h=o/r,b,a;var f=c.scrollLeft(),d=c.scrollTop();if(r!=1){f=Math.abs(s.offset().left)/r;d=Math.abs(s.offset().top)/r}var i={},g;$(document).off("mousemove.presenter").on("mousemove.presenter",function(e){var u=e.pageX/r,t=e.pageY/r;if(u<p){k=u;b=p}else{b=u}if(t<o){h=t;a=o}else{a=t}i.x=f+k;i.y=d+h;i.w=b-k;i.h=a-h;q.css({left:i.x,top:i.y,width:i.w,height:i.h});g=l.setSelectedRealTime(i,f,d,r,m)});$(document).off("mouseup.presenter").on("mouseup.presenter",function(){$(document).off("mousemove.presenter");$(document).off("mouseup.presenter");l.selecting=false;if(g.length==0){q.remove();return}var t=l.sliders.length;var e={index:t};l.sliders.push(e);l.sliderIndex=t;q.attr("idx",t);q.children(".selection-index").text(t+1);i=l.resetSelectionByTopics(i,f,d,q,r);l.sliders[l.sliderIndex].pos=i;l.sliders[l.sliderIndex].ids=g;l.saveSliders(m);$(".selection-index").fadeIn();m.events.push("startPreview");l.initDotEvent(m)})},initDotEvent:function(e){var i=e.designer;var c=null,f={},k=Math.abs;var h=e.operation.zoomVal/100;var d=this;var b=e.container.scrollLeft(),a=e.container.scrollTop();if(h!=1){b=Math.abs(i.offset().left)/h;a=Math.abs(i.offset().top)/h}var g=null;$(document).off("mousedown.selectiondot",".selection-dot").on("mousedown.selectiondot",".selection-dot",function(q){var p=$(this),m=p.attr("class"),o,l=e.container;b=l.scrollLeft(),a=l.scrollTop();g=$(".mind-slide-selection[idx="+d.sliderIndex+"]");var n=d.sliders[d.sliderIndex].pos;f.x=b+q.pageX;f.y=a+q.pageY;$(document).on("selectstart",function(){return false});$(document).off("mousemove.selectiondot").on("mousemove.selectiondot",function(u){if(m==null){return}var x=b+u.pageX,r=x-f.x,v=a+u.pageY,w=v-f.y;if(m.indexOf("rt")>0){var s=n.y+n.h;n.y=v;n.w=x-n.x;n.h=s-v}else{if(m.indexOf("lt")>0){var t=n.x+n.w;var s=n.y+n.h;n.y=v;n.x=x;n.w=t-x;n.h=s-v}else{if(m.indexOf("rb")>0){n.w=k(x-n.x);n.h=k(v-n.y)}else{if(m.indexOf("lb")>0){var t=n.x+n.w;n.x=x;n.w=t-x;n.h=k(v-n.y)}}}}d.setSelectionPos(g,n);o=d.setSelectedRealTime(n,b,a,h,e);u.stopPropagation()});$(document).off("mouseup.selectiondot").on("mouseup.selectiondot",function(r){$(document).off("mousemove.selectiondot");d.resetSelectionByTopics(n,b,a,g,h);$(document).off("mouseup.selectiondot");$(document).off("selectstart");d.sliders[d.sliderIndex].pos=n;d.sliders[d.sliderIndex].ids=o;d.saveSliders(e);r.stopPropagation()});q.stopPropagation()})}}};mindDesigner.prototype.events={push:function(c,a){var b=this.listeners[c];if(b){return b(a)}return null},listeners:{},addEventListener:function(b,a){this.listeners[b]=a}};